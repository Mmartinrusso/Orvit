# Daily Log ‚Äî 2026-02-26

---

## üìã RESUMEN EJECUTIVO *(para Notion / seguimiento de proyecto)*

### ‚úÖ Mantenimiento ‚Äî Machine Detail Dialog (continuaci√≥n sesi√≥n anterior)
- **"Ult vez / Pr√≥xima" en cards preventivos**: Cada card de mantenimiento preventivo ahora muestra la √∫ltima fecha de ejecuci√≥n y la pr√≥xima fecha calculada correctamente.
- **Fix "Vencida" falsa**: Un mantenimiento ejecutado dejaba de mostrar el badge "Vencida" al d√≠a siguiente. Corregido con `isCoveredByLastExecution` ‚Äî verifica si el per√≠odo est√° cubierto por la √∫ltima ejecuci√≥n.
- **Fix fecha "Pr√≥xima" estancada**: Mostraba `23/02 (1d vencido)` cuando el mantenimiento ya fue hecho el 18/02 y es cada 360 d√≠as. Ahora recalcula `nextScheduledDate = lastCompletedDate + frequencyDays`.
- **Bot√≥n "Ejecutar" desde el modal de m√°quina**: Se puede ejecutar un mantenimiento preventivo directamente desde la tarjeta sin ir a otra pantalla.
- **Tab "Ejecuciones" ahora muestra datos**: Estaba vac√≠o por usar el campo `work_orders?.type` en vez de `maintenanceType`. Corregido.
- **"Cambio de Carro" aparece en Ejecuciones**: La API de historial ahora hace una 5ta query paralela para obtener el `executionHistory` de todos los templates preventivos de la m√°quina.
- **Eliminado ghost "21:00"**: Un registro fantasma en el tab Ejecuciones proven√≠a de `nextMaintenanceDate` de un Document legacy. Se skipean documentos cuyo ID aparece como `legacyDocumentId` en PreventiveTemplate.
- **Fix dedup timezone-safe**: Entradas duplicadas por cruce de medianoche UTC eliminadas usando ventana de 10 horas entre entradas con el mismo t√≠tulo.

### ‚úÖ Build / Deploy
- **Fix import `auth-context`**: `app/mantenimiento/ideas/page.tsx` importaba `@/contexts/auth-context` (no existe) en vez de `@/contexts/AuthContext`. Reparado. Deploy de Vercel desbloqueado.

### ‚úÖ Puestos de Trabajo ‚Äî Auditor√≠a completa
- **3 bugs corregidos:**
  - PUT instructivo perd√≠a `scope`, `contentHtml`, `machineIds`, `componentIds` al editar ‚Äî campos ignorados en el update.
  - Sort `recent-desc` no funcionaba ‚Äî ca√≠a al default `name-asc` en `getOrderBy()`.
  - `GET/POST /machines` y `GET/POST/DELETE /components` sin ning√∫n check de autenticaci√≥n.
- **3 mejoras implementadas:**
  - Estado `MAINTENANCE` agregado al formulario de creaci√≥n/edici√≥n ‚Äî antes se convert√≠a silenciosamente a `ACTIVE` al guardar.
  - Interfaz TypeScript `WorkStation` completada con `instructivesCount`, `machinesCount`, `activeWorkOrdersCount`.
  - Card muestra badge "N OTs activas" en color warning cuando hay √≥rdenes de trabajo abiertas en ese puesto.

### ‚úÖ Costos de Mantenimiento ‚Äî Auditor√≠a completa
- **3 bugs corregidos:**
  - `getBudgetComparison` filtraba por `calculatedAt` (fecha del c√°lculo) en vez de `workOrder.completedDate` ‚Äî recalcular costos de una OT antigua la hac√≠a aparecer en el per√≠odo actual distorsionando el presupuesto.
  - GET `work-order/[id]` mostraba `sp.quantity` en `sparePartsUsed` pero el calculator usa `usedQuantity ?? quantity` ‚Äî el desglose visualizado no coincid√≠a con el costo calculado.
  - POST `technician-rates` no validaba `overtimeRate > 0` ‚Äî se pod√≠a guardar una tarifa de horas extra negativa.
- **M√≥dulo en buen estado**: auth JWT en todos los endpoints, validaciones Zod, c√°lculo paralelo con Promise.all, upsert at√≥mico de MaintenanceCostBreakdown.
- **4 mejoras de frontend:**
  - Barras apiladas en Tendencia mensual ‚Äî labor (azul) / repuestos (verde) / terceros (naranja) con leyenda de colores.
  - Card "Top 3 M√°quinas M√°s Costosas" en tab Resumen ‚Äî mostraba los datos pero nunca se renderizaban; ahora aparecen con barra de porcentaje y conteo de OTs.
  - Desglose por categor√≠a en Presupuesto vs Real ‚Äî labor/repuestos/terceros con barra individual y color rojo si excede presupuesto (solo visible si hay presupuesto por categor√≠a).
  - Fila de totales en tabla Recientes ‚Äî suma de MO, repuestos, terceros y total de las 10 OTs mostradas.

### ‚úÖ Ideas ‚Äî Auditor√≠a completa (Sonnet + Opus)

**Sonnet fixes:**
- C1: Status endpoint ‚Äî guard de rol admin (ADMIN/SUPERADMIN/ADMIN_ENTERPRISE)
- C2: PUT endpoint ‚Äî retorna 403 si no es creador
- C3: GET detail ‚Äî strip del array raw `votes`; se agrega `commentCount`
- M3: Vote mutation invalida `['idea', ideaId]` para refrescar el detalle
- M5: Bot√≥n Delete oculto para no-creadores (usa `useAuth()`)
- M8: Validaci√≥n enum `priority` en POST
- B1: Import `Star` no usado ‚Äî eliminado
- B2: `topVoted`/`recentIdeas` en stats ‚Äî removidos (no existen en schema)
- B3: Comentarios `orderBy: asc`

**Opus fixes:**
- O1: DELETE admin bypass con lookup `systemRole` en DB
- O2: PUT valida `category` y `priority` en update
- O3: Comment GET `orderBy: asc` (consistencia)
- O4: Vote toggle + count en `$transaction` (race condition fix)
- O5: Comment POST m√°x 2000 chars
- O6: Vote lookup usa `select: { id: true }` (eficiencia)

### ‚úÖ Unidades M√≥viles ‚Äî Auditor√≠a completa

**Seguridad (cr√≠tico):**
- C1: GET/PUT/DELETE `[id]` sin `companyId` ‚Üí data leak cross-tenant. Fix: `findFirst({ where: { id, companyId } })`
- C2: GET list + POST usaban `companyId` del body/query ‚Üí ahora siempre del JWT
- C3: batch PUT/DELETE sin `companyId` ‚Üí `updateMany/deleteMany` filtrado por `companyId`
- C4: `/api/maintenance/unidad-movil` sin auth en ning√∫n endpoint ‚Üí agregado `verifyToken`

**Medio:**
- M1 export: `companyId` del query param ‚Üí del JWT
- M2 kilometraje: `findUnique` ‚Üí `findFirst({ where: { id, companyId } })`

**Bajo:**
- B1 batch: sin l√≠mite de IDs ‚Üí `.max(50)` en schema Zod
- B2 sector chip: mostraba ID en vez de nombre ‚Üí `sectorName?` field en `UnitsFilters`

**Mejoras:**
- M1: `tiposUnidad` duplicado entre page.tsx y validations ‚Üí `TipoUnidadEnum.options`
- M2: PUT body enviaba `companyId` innecesario (servidor lo ignora desde JWT) ‚Üí removido

### ‚úÖ Dashboard de Mantenimiento por Rol ‚Äî Implementaci√≥n completa (4 fases)
- **Hero Section por rol**: Secci√≥n fija arriba del dashboard customizable
  - Operador: 4 KPI cards (Mis OTs Pendientes, En Progreso, Controles Pendientes, Pr√≥ximos Preventivos)
  - Supervisor: 5 KPI cards (OTs Activas, OTs Vencidas, M√°quinas Paradas, Controles Pendientes, Fallas Abiertas)
  - Gerente: 6 gauge cards (MTTR, MTBF, Disponibilidad, Completitud, SLA, Preventivo)
- **4 APIs nuevas**: `/api/maintenance/dashboard/hero`, `/api/maintenance/controls/pending`, `/api/maintenance/team-workload`, `/api/maintenance/cross-sector-stats`, `/api/maintenance/solution-effectiveness`
- **13 widgets nuevos para DashboardBuilder**:
  - Operador: MyWorkOrdersWidget, MyControlsTimelineWidget, MyRecentCompletionsWidget
  - Supervisor: TeamWorkloadWidget, FailuresOpenWidget, TeamControlsTimelineWidget
  - Gerente: TrendCompletion6mWidget, TopFailingMachinesWidget, CostByMonthWidget, CrossSectorComparisonWidget, SolutionEffectivenessWidget, HealthScoresOverviewWidget
  - Compartido: PreventiveComplianceWidget
- **Cat√°logo actualizado**: 2 nuevas categor√≠as (team, analytics), `area-chart` style, defaults por rol actualizados
- **WidgetRenderer**: 13 nuevos componentes registrados

### üìä Estado del proyecto hoy
| M√≥dulo | Estado | Nota |
|--------|--------|------|
| Machine Detail ‚Äî Preventivos | ‚úÖ Completo | Ult vez, Pr√≥xima, Ejecutar, Ejecuciones, dedup |
| Puestos de Trabajo | ‚úÖ Auditado y mejorado | 3 bugs + 3 mejoras |
| Costos de Mantenimiento | ‚úÖ Auditado y mejorado | 3 bugs + 4 mejoras frontend |
| Build / Deploy | ‚úÖ Desbloqueado | Fix import auth-context |
| Ideas | ‚úÖ Auditado y mejorado | 10 fixes Sonnet + 6 Opus |
| Unidades M√≥viles | ‚úÖ Auditado y mejorado | 8 security fixes + 2 mejoras |
| Confiabilidad | ‚úÖ Completo | 2 bugs cr√≠ticos + layout tabs + Salud implementada + Componentes + Soluciones + 2 nuevas APIs |
| Seguridad (PTW/LOTO/MOC) | ‚úÖ Auditado y corregido | 4 categor√≠as de bugs: cookie, auth faltante, companyId, params await |
| Gesti√≥n (Calibraci√≥n/Lubricaci√≥n/Contratistas/Contadores) | ‚úÖ Auditado y corregido | C1: auth faltante en Contadores, H1: cookie 'auth-token'‚Üí'token', H6: companyId del JWT, H5: Prisma.sql fix |
| Gesti√≥n ‚Äî Mejoras funcionales | ‚úÖ Completado | Dialogs de Calibraci√≥n/Lubricaci√≥n/Contratistas conectados a API; `includeCounters` en machines API; 4 KPI cards de Skills con datos reales |
| Skills y Certificaciones | ‚úÖ Auditado y corregido | C1: endpoint `/api/certifications` creado; C2: cache key `['skill-matrix', companyId]`; C3: badge "Por Vencer" din√°mico; S1: permiso `certifications.view` en GET; S2: companyId del JWT en skill-requirements |
| Pa√±ol (Herramientas/Inventario) | ‚úÖ Auditado y corregido | C1: `tools/[id]` sin auth en 4 handlers + cross-tenant; C2: `loans` GET sin auth, companyId de query; C3: `movements` GET sin auth, companyId de query; M1: params Promise en return route; M2: invalidation keys en prestamos/reservas |
| Ejecuci√≥n ‚Äî Recursos utilizados | ‚úÖ Completo | Fix `NewRoutineExecutionForm` crash `items.filter not a function`; Plan "Herramientas/Repuestos en Ejecuci√≥n" completamente implementado en sesi√≥n anterior (schema, API, UI, calculator, historial) |
| Dashboard Mantenimiento por Rol | ‚úÖ Redise√±ado | **3 dashboards fijos profesionales** (Operador/Supervisor/Gerente) reemplazando DashboardBuilder personalizable. Hero + secciones con gr√°ficos AreaChart, BarChart H/V, DonutChart, PieChart, GaugeChart, ProgressBar. Data hooks consolidados con useQueries. |

---
---

## üõ†Ô∏è LOG T√âCNICO *(para desarrollo / Claude Code)*

### Session Overview
- **Date**: 2026-02-26
- **Focus Area**: Machine Detail preventivos + Auditor√≠a Puestos de Trabajo

### What Was Done

#### Completed
- [x] `hooks/use-machine-detail.ts` ‚Äî usar `template.lastMaintenanceDate` como fuente de verdad para `_lastCompletedDate`
- [x] `MachineMaintenanceTab.tsx` ‚Äî `isCoveredByLastExecution`, `nextScheduledDate`, "Ult vez", "Pr√≥xima", bot√≥n "Ejecutar", fix `filteredHistory`, fix `renderHistoryTimeline`
- [x] `app/api/maintenance/history/route.ts` ‚Äî 5ta query para `machinePreventiveTemplates`, skip `migratedLegacyDocIds`, dedup timezone-safe por t√≠tulo ¬±10h
- [x] `app/mantenimiento/ideas/page.tsx` ‚Äî fix import `auth-context` ‚Üí `AuthContext`
- [x] `app/api/work-stations/[id]/instructives/[instructiveId]/route.ts` ‚Äî PUT incluye `scope`, `contentHtml`, `machineIds`, `componentIds`
- [x] `app/api/work-stations/route.ts` ‚Äî `getOrderBy` agrega case `recent-desc`
- [x] `app/api/work-stations/[id]/machines/route.ts` ‚Äî auth en GET y POST
- [x] `app/api/work-stations/[id]/components/route.ts` ‚Äî auth en GET, POST y DELETE
- [x] `components/work-stations/WorkstationUpsertSheet.tsx` ‚Äî estado `MAINTENANCE` en form
- [x] `components/work-stations/WorkstationCard.tsx` ‚Äî interfaz + badge OTs activas

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/hooks/use-machine-detail.ts` | modified | `_lastCompletedDate` desde `template.lastMaintenanceDate` |
| `orvit-v1/components/maintenance/MachineMaintenanceTab.tsx` | modified | isCoveredByLastExecution, nextScheduledDate, UI Ult vez/Pr√≥xima, Ejecutar, Ejecuciones fix |
| `orvit-v1/app/api/maintenance/history/route.ts` | modified | 5ta query templates, skip legacy docs, dedup timezone-safe |
| `orvit-v1/app/mantenimiento/ideas/page.tsx` | modified | fix import auth-context ‚Üí AuthContext |
| `orvit-v1/app/api/work-stations/[id]/instructives/[instructiveId]/route.ts` | modified | PUT incluye scope/contentHtml/machineIds/componentIds |
| `orvit-v1/app/api/work-stations/route.ts` | modified | getOrderBy case recent-desc |
| `orvit-v1/app/api/work-stations/[id]/machines/route.ts` | modified | auth en GET/POST |
| `orvit-v1/app/api/work-stations/[id]/components/route.ts` | modified | auth en GET/POST/DELETE |
| `orvit-v1/components/work-stations/WorkstationUpsertSheet.tsx` | modified | MAINTENANCE en status form |
| `orvit-v1/components/work-stations/WorkstationCard.tsx` | modified | interfaz + badge OTs activas |
| `orvit-v1/app/mantenimiento/puestos-trabajo/page.tsx` | modified | tipo handleSaveWorkStation incluye MAINTENANCE |

### Decisions Made
- **Dedup ghost 21:00**: Se identific√≥ que el registro fantasma ven√≠a de `Document.nextMaintenanceDate` en UTC ("2026-02-20T00:00:00.000Z" = 19/02 21:00 AR). Soluci√≥n: skip documentos cuyo `id` sea `legacyDocumentId` de un PreventiveTemplate activo.
- **Dedup timezone-safe**: En vez de comparar `date.substring(0,10)` (fallaba en cruce de medianoche UTC), se compara diferencia en horas `< 10` entre entradas con el mismo t√≠tulo.
- **`isCoveredByLastExecution`**: Condici√≥n: `differenceInDays(scheduledDate, lastCompletedDate) <= frequencyDays` ‚Äî si la instancia PENDING cae dentro del per√≠odo cubierto por la √∫ltima ejecuci√≥n, no es "vencida".

### Issues Encountered
- **`git add` con brackets en paths**: Los paths con `[id]` necesitan comillas simples en zsh para evitar glob expansion. Ej: `git add 'path/[id]/route.ts'`
- **Commit rechazado por usuario**: El primer intento de `git commit` fue rechazado. Se procedi√≥ despu√©s de confirmar staging correcto.

### Skills Used
- `orvit-maintenance` ‚Äî contexto de mantenimiento preventivo, history API, MachineMaintenanceTab
- `Explore` agent ‚Äî an√°lisis exhaustivo de todos los archivos del m√≥dulo Puestos de Trabajo

---

### Session 1c ‚Äî Confiabilidad (bugs + arquitectura + implementaci√≥n)

#### Bugs corregidos
- **C1 CR√çTICO**: `lib/maintenance/health-score-calculator.ts` ‚Äî `calculateDowntimePercent` usaba `startTime`/`endTime` (no existen en schema). Corregido a `startedAt`/`endedAt`. La funci√≥n fallaba silenciosamente (`.catch` retornaba 0), lo que hac√≠a que `downtimePenalty` siempre fuera 0.
- **C2 CR√çTICO**: `app/api/metrics/reliability/route.ts` ‚Äî `status: 'completed'` (lowercase) para query de WorkOrders. El enum `WorkOrderStatus` usa `COMPLETED` (uppercase). MTTR nunca se calculaba desde OTs, siempre ca√≠a al fallback de downtime promedio.

#### Arquitectura
- **Decisi√≥n**: Usar layout.tsx con tab navigation (como sub-sidebar) en vez de consolidar en una sola p√°gina con `<Tabs>`. Raz√≥n: las p√°ginas ya existen como rutas Next.js, la URL refleja el tab activo, y cada p√°gina carga su data independientemente.
- Creado `app/mantenimiento/confiabilidad/layout.tsx` ‚Äî tabs: M√©tricas MTBF/MTTR | Salud de Activos | Por Componentes | Base de Soluciones. Responsive: labels cortos en m√≥vil.

#### Implementaciones
- `app/mantenimiento/confiabilidad/salud/page.tsx` ‚Äî **reemplazado placeholder** con implementaci√≥n real:
  - Fetch a `/api/maintenance/health-score`
  - 4 KPIs: √ìptimo (‚â•80) / Atenci√≥n (50-79) / Cr√≠tico (<50) / Score Promedio
  - Barra visual de distribuci√≥n horizontal (verde/amarillo/rojo)
  - Tabla de m√°quinas ordenada por peor score, con `Progress` bar + badge
  - Bot√≥n "Actualizar" con spinner

#### Mejoras de frontend (M√©tricas)
- `TrendChart` refactorizado: barras con tooltip completo (MTBF/fallas/downtime), leyenda actualizada, casos "Sin fallas" en verde, meses sin data muestran l√≠nea horizontal
- `MachineReliabilityTable`: ordenado de PEOR a MEJOR disponibilidad (problem√°ticas primero), `Progress` bar con colores sem√°foro, `AlertTriangle` en m√°quinas con >3 fallas, columnas MTBF/MTTR ocultas en m√≥vil

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/lib/maintenance/health-score-calculator.ts` | modified | C1: startTime ‚Üí startedAt, endTime ‚Üí endedAt |
| `orvit-v1/app/api/metrics/reliability/route.ts` | modified | C2: 'completed' ‚Üí 'COMPLETED' (√ó2, per√≠odo + tendencia) |
| `orvit-v1/app/mantenimiento/confiabilidad/layout.tsx` | created | Tab navigation para todas las sub-p√°ginas |
| `orvit-v1/app/mantenimiento/confiabilidad/salud/page.tsx` | replaced | Implementaci√≥n real con health-score API |
| `orvit-v1/app/mantenimiento/confiabilidad/metricas/page.tsx` | modified | TrendChart + MachineReliabilityTable mejorados |

---

### Session 1b ‚Äî Costos de Mantenimiento (bugs + mejoras frontend)

#### Completed
- [x] `lib/maintenance-costs/calculator.ts` ‚Äî getBudgetComparison usa `workOrder.completedDate` en vez de `calculatedAt`
- [x] `app/api/maintenance/costs/work-order/[id]/route.ts` ‚Äî `sparePartsUsed` usa `usedQuantity ?? quantity` (consistente con calculator)
- [x] `app/api/maintenance/costs/technician-rates/route.ts` ‚Äî validaci√≥n `overtimeRate > 0`
- [x] `app/api/maintenance/costs/route.ts` ‚Äî recentCosts filtra por per√≠odo + ordena por `completedDate` + extrasTotal en distribution
- [x] `app/mantenimiento/costos/page.tsx` ‚Äî barras apiladas, Top 3 M√°quinas card, desglose presupuesto, fila totales

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/lib/maintenance-costs/calculator.ts` | modified | getBudgetComparison date fix |
| `orvit-v1/app/api/maintenance/costs/work-order/[id]/route.ts` | modified | usedQuantity consistency |
| `orvit-v1/app/api/maintenance/costs/technician-rates/route.ts` | modified | overtimeRate > 0 validation |
| `orvit-v1/app/api/maintenance/costs/route.ts` | modified | recentCosts period + extrasTotal |
| `orvit-v1/app/mantenimiento/costos/page.tsx` | modified | 4 frontend improvements |

---

### Session 2 ‚Äî Ideas + Unidades M√≥viles

#### Completed

**Ideas ‚Äî Sonnet:**
- [x] `app/api/ideas/[id]/status/route.ts` ‚Äî C1: admin role guard
- [x] `app/api/ideas/[id]/route.ts` ‚Äî C2: PUT 403 non-creator, C3: strip votes, M1: commentCount, B3: comments asc
- [x] `app/api/ideas/route.ts` ‚Äî M8: priority enum validation
- [x] `app/api/ideas/stats/route.ts` ‚Äî B2: remove topVoted/recentIdeas
- [x] `app/mantenimiento/ideas/page.tsx` ‚Äî M3: vote invalidation, M5: delete guard, B1: remove Star import

**Ideas ‚Äî Opus:**
- [x] `app/api/ideas/[id]/route.ts` ‚Äî O1: DELETE admin bypass, O2: PUT category/priority validation
- [x] `app/api/ideas/[id]/comment/route.ts` ‚Äî O3: orderBy asc, O5: max 2000 chars
- [x] `app/api/ideas/[id]/vote/route.ts` ‚Äî O4: $transaction atomic, O6: select: { id: true }

**Unidades M√≥viles ‚Äî Seguridad:**
- [x] `app/api/mantenimiento/unidades-moviles/route.ts` ‚Äî companyId del JWT
- [x] `app/api/mantenimiento/unidades-moviles/[id]/route.ts` ‚Äî findFirst con companyId en GET/PUT/DELETE
- [x] `app/api/mantenimiento/unidades-moviles/batch/route.ts` ‚Äî companyId en updateMany/deleteMany + max(50)
- [x] `app/api/mantenimiento/unidades-moviles/export/route.ts` ‚Äî companyId del JWT
- [x] `app/api/mantenimiento/unidades-moviles/[id]/kilometraje/route.ts` ‚Äî findFirst con companyId
- [x] `app/api/maintenance/unidad-movil/route.ts` ‚Äî auth agregado a POST y GET
- [x] `components/unidades-moviles/useUnitsFilters.ts` ‚Äî sectorName en chip

**Unidades M√≥viles ‚Äî Mejoras:**
- [x] `app/mantenimiento/unidades-moviles/page.tsx` ‚Äî TipoUnidadEnum.options (M1), remove companyId from PUT body (M2)

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `app/api/ideas/[id]/status/route.ts` | modified | admin role guard C1 |
| `app/api/ideas/[id]/route.ts` | modified | C2, C3, M1, O1, O2, B3 |
| `app/api/ideas/route.ts` | modified | M8 priority validation |
| `app/api/ideas/stats/route.ts` | modified | B2 remove invalid fields |
| `app/mantenimiento/ideas/page.tsx` | modified | M3, M5, B1 |
| `app/api/ideas/[id]/comment/route.ts` | modified | O3, O5 |
| `app/api/ideas/[id]/vote/route.ts` | modified | O4, O6 |
| `app/api/mantenimiento/unidades-moviles/route.ts` | modified | C2 companyId from JWT |
| `app/api/mantenimiento/unidades-moviles/[id]/route.ts` | modified | C1 findFirst+companyId |
| `app/api/mantenimiento/unidades-moviles/batch/route.ts` | modified | C3+B1 companyId+max50 |
| `app/api/mantenimiento/unidades-moviles/export/route.ts` | modified | M1 companyId from JWT |
| `app/api/mantenimiento/unidades-moviles/[id]/kilometraje/route.ts` | modified | M2 findFirst+companyId |
| `app/api/maintenance/unidad-movil/route.ts` | modified | C4 auth added |
| `components/unidades-moviles/useUnitsFilters.ts` | modified | B2 sectorName chip |
| `app/mantenimiento/unidades-moviles/page.tsx` | modified | M1 TipoUnidadEnum, M2 remove companyId from PUT |

---

### Session 1d ‚Äî Confiabilidad (Componentes + Soluciones)

#### Objetivo
Reemplazar los 2 placeholders "En desarrollo" de las tabs Componentes y Soluciones con implementaciones reales.

#### APIs creadas
- **`app/api/metrics/components-reliability/route.ts`** ‚Äî nueva:
  - Combina `FailureOccurrence.subcomponentId` (fallas por componente) con `WorkOrder.componentId` (MTTR de OTs correctivas cerradas)
  - Params: `period` (default 90d), `machineId` (opcional)
  - KPIs: total componentes con fallas, safety-critical afectados, componente top, MTTR promedio
  - Resultado ordenado por failureCount desc

- **`app/api/metrics/solutions/route.ts`** ‚Äî nueva:
  - Consulta `FailureSolution` filtrando por `occurrence.companyId`
  - Include: occurrence (machineId, failureCategory, machine.name), appliedBy (name), applications (id, effectiveness)
  - Param `search` para filtrar por t√≠tulo, causa ra√≠z, descripci√≥n, m√°quina o categor√≠a
  - KPIs: total, preferred, avgEffectiveness, mostUsedTitle/Count (por SolutionApplication.count)
  - Respuesta paginada (max 200, default 100)

#### P√°ginas implementadas
- **`app/mantenimiento/confiabilidad/componentes/page.tsx`**:
  - Selector de per√≠odo (30/60/90/180 d√≠as)
  - 4 KPIs: Componentes con Fallas, Cr√≠ticos de Seguridad (con color rojo si > 0), Componente Top, MTTR Promedio
  - Tabla con barra de frecuencia relativa (Progress), badge de fallas, MTTR, MTBF, columnas responsive
  - √çconos: ShieldAlert para safety-critical, AlertTriangle para ‚â•3 fallas
  - Banner de alerta si hay safety-critical fallando
  - Empty state con gu√≠a para vincular componentes a OTs

- **`app/mantenimiento/confiabilidad/soluciones/page.tsx`**:
  - 4 KPIs: Soluciones Registradas, Preferidas, Efectividad Promedio (N/5), M√°s Reutilizada (con count)
  - B√∫squeda en tiempo real con debounce 300ms
  - Tabla: t√≠tulo + causa ra√≠z, m√°quina/categor√≠a, estrellas de efectividad (1-5), badge de reusos, tiempo de reparaci√≥n, fecha + t√©cnico
  - CheckCircle2 verde para soluciones preferidas (isPreferred=true)
  - CategoryBadge con mapeo de categor√≠as EN ‚Üí ES
  - Empty state diferenciado (sin resultados vs sin datos)

#### Files Created/Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/app/api/metrics/components-reliability/route.ts` | created | API de confiabilidad por componente |
| `orvit-v1/app/api/metrics/solutions/route.ts` | created | API de base de conocimiento de soluciones |
| `orvit-v1/app/mantenimiento/confiabilidad/componentes/page.tsx` | replaced | Implementaci√≥n real (era placeholder) |
| `orvit-v1/app/mantenimiento/confiabilidad/soluciones/page.tsx` | replaced | Implementaci√≥n real (era placeholder) |

---

### Session 3 ‚Äî Seguridad: PTW / LOTO / MOC ‚Äî Auditor√≠a completa

#### Bugs encontrados y corregidos

**C1 ‚Äî CR√çTICO: Cookie name 'auth-token' ‚Üí 'token' (9 archivos)**
- Login route setea `'token'` pero TODOS los endpoints de seguridad le√≠an `'auth-token'`
- Efecto: m√≥dulo PTW/LOTO/MOC devolv√≠a 401 para TODOS los usuarios autenticados ‚Äî completamente roto
- Fix: reemplazo `'auth-token'` ‚Üí `'token'` en:
  - `app/api/ptw/route.ts` (GET + POST)
  - `app/api/ptw/[id]/route.ts` (GET + PATCH + DELETE)
  - `app/api/loto/procedures/route.ts` (GET + POST)
  - `app/api/loto/procedures/[id]/route.ts` (GET + PATCH + DELETE)
  - `app/api/loto/executions/route.ts` (GET + POST)
  - `app/api/loto/executions/[id]/route.ts` (GET + PATCH)
  - `app/api/moc/route.ts` (POST)
  - `app/api/moc/[id]/route.ts` (PATCH)
  - `app/api/moc/[id]/tasks/route.ts` (PATCH)

**C2 ‚Äî CR√çTICO: Endpoints sin autenticaci√≥n en MOC**
- `GET /api/moc` ‚Äî sin auth (cualquier persona pod√≠a listar MOCs)
- `GET /api/moc/[id]` ‚Äî sin auth (datos completos de un MOC espec√≠fico)
- `GET /api/moc/[id]/tasks` ‚Äî sin auth
- `POST /api/moc/[id]/tasks` ‚Äî sin auth (cualquier persona pod√≠a crear tareas)
- `DELETE /api/moc/[id]/tasks` ‚Äî sin auth (cualquier persona pod√≠a eliminar tareas)
- Fix: agregado bloque est√°ndar `cookies().get('token')` + `verifyToken` en cada handler

**C3 ‚Äî companyId desde query params en lugar del JWT (cross-tenant vulnerability)**
- PTW GET: `parseInt(searchParams.get('companyId') || '0')` ‚Üí cualquier usuario pod√≠a pedir datos de otra empresa
- PTW POST: `companyId` ven√≠a del body
- LOTO procedures GET: misma vulnerabilidad
- LOTO procedures POST: `companyId` del body
- LOTO executions GET: `companyId` del query param
- LOTO executions POST: `companyId` del body
- Fix: `companyId = payload.companyId as number` en todos los endpoints afectados

**M1 ‚Äî params.id no awaited (Next.js 15 incompatibilidad)**
- `moc/[id]/route.ts`: `params: { id: string }` (s√≠ncr.) ‚Üí debe ser `Promise<{ id: string }>`
- `moc/[id]/tasks/route.ts`: mismo problema
- Fix: interfaz ‚Üí `Promise<{ id: string }>`, cada handler hace `const { id } = await params`

#### Seguridad detectada como correcta
- PTW: segregaci√≥n de duties (approver ‚â† requester), m√°quina de estados estricta, bloqueo si LOTO activos
- LOTO: verificationStep requiere persona diferente al que bloque√≥, check de aprobaci√≥n del procedimiento
- MOC: historial de cambios de estado, DELETE solo para DRAFT/CANCELLED
- Auth JWT: `verifyToken` en todos los handlers (post-fixes)

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/app/api/ptw/route.ts` | modified | C1 cookie, C3 companyId from JWT (GET + POST) |
| `orvit-v1/app/api/ptw/[id]/route.ts` | modified | C1 cookie (GET + PATCH + DELETE) |
| `orvit-v1/app/api/loto/procedures/route.ts` | modified | C1 cookie, C3 companyId from JWT (GET + POST) |
| `orvit-v1/app/api/loto/procedures/[id]/route.ts` | modified | C1 cookie (GET + PATCH + DELETE) |
| `orvit-v1/app/api/loto/executions/route.ts` | modified | C1 cookie, C3 companyId from JWT (GET + POST) |
| `orvit-v1/app/api/loto/executions/[id]/route.ts` | modified | C1 cookie (GET + PATCH) |
| `orvit-v1/app/api/moc/route.ts` | modified | C1 cookie, C2 auth GET, C3 companyId from JWT |
| `orvit-v1/app/api/moc/[id]/route.ts` | modified | C1 cookie, C2 auth GET, M1 params await |
| `orvit-v1/app/api/moc/[id]/tasks/route.ts` | modified | C1 cookie, C2 auth GET+POST+DELETE, M1 params await |

---

### Session 4 ‚Äî Gesti√≥n: Calibraci√≥n / Lubricaci√≥n / Contratistas / Contadores ‚Äî Auditor√≠a de seguridad

#### Bugs encontrados y corregidos

**C1 ‚Äî CR√çTICO: Contadores sin autenticaci√≥n (auth importado pero nunca llamado)**
- `app/api/counters/[id]/route.ts`: `cookies` y `verifyToken` importados, NUNCA llamados ‚Äî GET/PATCH/DELETE completamente abiertos
- `app/api/counters/[id]/triggers/route.ts`: sin import de `cookies`/`verifyToken` ‚Äî GET/POST/DELETE completamente abiertos
- `app/api/counters/[id]/readings/route.ts`: GET sin auth, POST usaba `'auth-token'`
- Fix: auth est√°ndar agregado a todos los handlers en los 3 archivos

**H1 ‚Äî Cookie 'auth-token' ‚Üí 'token' (3 archivos)**
- Login route setea `'token'` pero Calibraci√≥n, Lubricaci√≥n y Contratistas le√≠an `'auth-token'`
- Efecto: m√≥dulos devolv√≠an 401 para todos los usuarios autenticados
- Fix: `'auth-token'` ‚Üí `'token'` en GET + POST de:
  - `app/api/calibration/route.ts`
  - `app/api/lubrication/route.ts`
  - `app/api/contractors/route.ts`

**H6 ‚Äî companyId desde query params en lugar del JWT (cross-tenant)**
- GET de los 3 m√≥dulos: `parseInt(searchParams.get('companyId') || '0')` ‚Äî cualquier usuario pod√≠a pedir datos de otra empresa
- POST de los 3 m√≥dulos: `companyId` ven√≠a del body
- Fix: `companyId = payload.companyId as number` en GET y POST de los 3 archivos
- Validaci√≥n actualizada: se elimina `!companyId` de las validaciones (siempre viene del JWT)

**H5 ‚Äî Prisma.sql anidado en template literals (queries rotas)**
- Calibraci√≥n, Lubricaci√≥n y Contratistas usaban `prisma.$queryRaw\`AND col = ${val}\`` dentro de otro template literal
- Esto produce un `Promise` embebido en el string SQL ‚Äî no es v√°lido, los filtros condicionales nunca funcionaban
- Fix: `import { Prisma } from '@prisma/client'` + construcci√≥n previa:
  ```ts
  const statusCondition = status ? Prisma.sql\`AND c.status = ${status}\` : Prisma.sql\`\`
  ```
  y luego interpolado limpio en el template principal

**M1 ‚Äî params s√≠ncronos (Next.js 15 incompatibilidad) ‚Äî Contadores**
- `counters/[id]/route.ts`, `triggers/route.ts`, `readings/route.ts`: `params: { id: string }` (s√≠nc.)
- Fix: `params: Promise<{ id: string }>` + `const { id } = await params` en todos los handlers

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/app/api/calibration/route.ts` | modified | H1 cookie, H6 companyId JWT, H5 Prisma.sql (GET + POST) |
| `orvit-v1/app/api/lubrication/route.ts` | modified | H1 cookie, H6 companyId JWT, H5 Prisma.sql (GET + POST) |
| `orvit-v1/app/api/contractors/route.ts` | modified | H1 cookie, H6 companyId JWT, H5 Prisma.sql (GET + POST) |
| `orvit-v1/app/api/counters/[id]/route.ts` | modified | C1 auth GET+PATCH+DELETE, M1 params Promise |
| `orvit-v1/app/api/counters/[id]/triggers/route.ts` | modified | C1 auth GET+POST+DELETE, M1 params Promise |
| `orvit-v1/app/api/counters/[id]/readings/route.ts` | modified | C1 auth GET, H1 cookie POST, M1 params Promise |

---

### Session 4b ‚Äî Gesti√≥n: Mejoras funcionales

#### Dialogs conectados a la API (C3/C4/C5 cr√≠ticos)
Los 3 dialogs de "Nueva Calibraci√≥n / Lubricaci√≥n / Contratista" mostraban la UI pero al guardar no llamaban a ninguna API.

- **calibracion/page.tsx**: form con `FORM_DEFAULT` + `patchForm`, `machines` dropdown query, `createMutation` POST `/api/calibration`
- **lubricacion/page.tsx**: mismo patr√≥n con campos machineId, name, location, lubricantType, lubricantBrand, quantity, quantityUnit, method, frequencyDays, instructions; POST `/api/lubrication`
- **contratistas/page.tsx**: form name/legalName/taxId/contactName/contactEmail/contactPhone/address/notes/type; POST `/api/contractors`

#### machines API ‚Äî `includeCounters`
- `app/api/machines/route.ts`: `includeCounters` param nunca procesado. Fix: `const includeCounters = searchParams.get('includeCounters') === 'true'` + spread condicional en select con `counters: { select: { ..., triggers: { where: { isActive: true }, ... } } }`

#### Skills ‚Äî 4 KPI cards conectadas
- `app/mantenimiento/skills/page.tsx`: Agregado `useQuery` para `/api/skills?companyId=X`
- Reemplazados 4 cards hardcodeados con datos reales: skillsCount, totalUserSkillAssignments, `skills.filter(s.isCertificationRequired).length`, `skillsData?.categories?.length`

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `app/mantenimiento/calibracion/page.tsx` | modified | Dialog conectado a API, form controlado, machines dropdown |
| `app/mantenimiento/lubricacion/page.tsx` | modified | Dialog conectado a API, form controlado completo |
| `app/mantenimiento/contratistas/page.tsx` | modified | Dialog conectado a API, form controlado completo |
| `app/api/machines/route.ts` | modified | includeCounters con triggers activos |
| `app/mantenimiento/skills/page.tsx` | modified | 4 KPI cards con datos reales |

---

### Session 5 ‚Äî Skills y Certificaciones ‚Äî Auditor√≠a y fixes

#### Bugs encontrados y corregidos

**C1 ‚Äî CR√çTICO: Endpoint `/api/certifications` faltante**
- `CertificationTracker` llama `/api/certifications?companyId=X` cuando no tiene `userId` (vista company-wide y pesta√±a "Por Vencer")
- El endpoint no exist√≠a ‚Üí error 404, componente roto en modo company-wide
- Fix: creado `app/api/certifications/route.ts`
  - Auth JWT (`payload.companyId` ‚Äî ignora query param del cliente)
  - Soporta `?expiringSoon=true` para filtrar vencimientos en 30 d√≠as
  - Mapea campos del schema (`name` ‚Üí `certificationName`, `code` ‚Üí `certificationNumber`, `issuedBy` String ‚Üí `issuingOrganization`, `PENDING_RENEWAL` ‚Üí `PENDING`)
  - Include `user: { id, name }` para vista de empresa
  - `summary` con total/active/expired/pending/revoked/expiringSoon

**C2 ‚Äî Cache invalidation rota en UserSkillAssignDialog**
- `UserSkillAssignDialog.tsx` (l√≠nea 110): `queryClient.invalidateQueries({ queryKey: ['skill-matrix'] })`
- `SkillMatrix.tsx` usa `queryKey: ['skill-matrix', companyId]`
- Sin el `companyId` en la key, la invalidaci√≥n nunca hac√≠a refetch de la matriz
- Fix: `['skill-matrix', companyId]`

**C3 ‚Äî Badge "Por Vencer" hardcodeado en 0**
- `skills/page.tsx` l√≠nea 210: `<Badge>0</Badge>` ‚Äî siempre mostraba 0
- Fix: query a `/api/certifications?companyId=X` para obtener `summary.expiringSoon`
- Badge solo visible cuando hay certifications por vencer (> 0)

**S1 ‚Äî GET /api/users/[id]/certifications sin permiso check**
- El GET ten√≠a auth JWT pero no verificaba `certifications.view`
- Fix: self-view gratuito; para ver otras personas ‚Üí check `certifications.view` en `UserOnCompany.role.permissions`

**S2 ‚Äî GET /api/skill-requirements: companyId del query param + sin permiso**
- `const companyId = searchParams.get('companyId') || payload.companyId` ‚Äî cross-tenant
- Sin ning√∫n check de permisos para lectura
- Fix: `companyId = payload.companyId as number` (ignora query param); guard con `skills.view` OR `skills.requirements.manage`

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `app/api/certifications/route.ts` | **created** | C1: endpoint company-wide faltante |
| `components/skills/UserSkillAssignDialog.tsx` | modified | C2: queryKey incluye companyId |
| `app/mantenimiento/skills/page.tsx` | modified | C3: badge din√°mico + query certSummaryData |
| `app/api/users/[id]/certifications/route.ts` | modified | S1: self-view + certifications.view check |
| `app/api/skill-requirements/route.ts` | modified | S2: companyId del JWT + permiso skills.view |

---

### Session 7 ‚Äî Fix runtime crash NewRoutineExecutionForm + verificaci√≥n plan recursos

#### Bugs corregidos
- **`TypeError: flatItems.filter is not a function`** (l√≠nea 2373, useMemo durante render):
  - `selectedTemplate?.items || []` ‚Äî si la API retorna `items` como `{}` (objeto, no array), `|| []` no se activa (el objeto es truthy). Llamar `.filter()` sobre un objeto falla.
  - Fix: `Array.isArray(selectedTemplate?.items) ? selectedTemplate!.items : []`
- **`TypeError: items.filter is not a function`** (l√≠nea 2505, `getAllItems` en useEffect):
  - Mismo root cause en la funci√≥n `getAllItems` dentro del save-draft callback
  - Fix: `Array.isArray(selectedTemplate.items) ? selectedTemplate.items : []`

#### Verificaci√≥n plan "Herramientas y Repuestos en Ejecuci√≥n"
- Todos los 5 fixes del plan ya estaban implementados en sesiones anteriores:
  - Fix 1: schema `usedQuantity Int?` + `returnedDamaged Boolean` en `SparePartReservation` ‚úÖ
  - Fix 2: UI "Recursos utilizados" en `ExecuteMaintenanceDialog` ‚úÖ (herramientas/repuestos separados, checkbox da√±ada, stepper cantidad, b√∫squeda ad-hoc)
  - Fix 3: `execute/route.ts` procesa recursos (casos A/B/C, devoluci√≥n stock, herramienta da√±ada) ‚úÖ
  - Fix 4: `calculator.ts` usa `usedQuantity ?? quantity` + `damagedReservations ‚Üí extrasCost` ‚úÖ
  - Fix 5: `MaintenanceDetailDialog` muestra "Recursos utilizados" en timeline del historial ‚úÖ

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/components/produccion/NewRoutineExecutionForm.tsx` | modified | L√≠neas 2369 y 2327: `|| []` ‚Üí `Array.isArray()` guard |

---

### Session 6 ‚Äî Pa√±ol: Herramientas/Inventario ‚Äî Auditor√≠a de seguridad

#### Bugs encontrados y corregidos

**C1 ‚Äî CR√çTICO: `GET/PUT/PATCH/DELETE /api/tools/[id]` sin autenticaci√≥n**
- Los 4 handlers ten√≠an CERO imports de auth ‚Äî cualquier usuario an√≥nimo pod√≠a leer, editar o eliminar cualquier herramienta del sistema
- Sin companyId check ‚Äî un usuario autenticado pod√≠a operar sobre herramientas de otra empresa
- Fix: Reescrito con `verifyToken` + `companyId = payload.companyId` en los 4 handlers
- Cada query SQL ahora incluye `AND "companyId" = ${companyId}`
- params: `{ id: string }` ‚Üí `Promise<{ id: string }>` (Next.js 15)

**C2 ‚Äî GET /api/tools/loans sin autenticaci√≥n + companyId del query param**
- `getCurrentUser()` estaba definido pero NO LLAMADO en el GET handler
- `companyId = searchParams.get('companyId')` ‚Äî cualquier usuario pod√≠a consultar pr√©stamos de otra empresa
- Fix: `verifyToken` a√±adido al GET handler + `companyId = payload.companyId as number`
- Tambi√©n: `cookies().get()` s√≠ncr. ‚Üí `(await cookies()).get()` en el helper

**C3 ‚Äî GET /api/tools/movements sin autenticaci√≥n + companyId del query param**
- `getCurrentUserId()` definido pero NO LLAMADO en GET
- `companyId = searchParams.get('companyId')` ‚Äî cross-tenant
- Fix: `verifyToken` a√±adido al GET + `companyId = payload.companyId`
- `getCurrentUserId()` helper actualizado con `await cookies()`

**M1 ‚Äî params s√≠ncronos (Next.js 15) ‚Äî loans/[id]/return**
- `{ params }: { params: { id: string } }` ‚Üí `Promise<{ id: string }>` + `await params`
- `getCurrentUser()` actualizado con `await cookies()`

**M2 ‚Äî Query invalidation keys incorrectas (frontend)**
- `app/panol/prestamos/page.tsx`: invalidaba `['tool-loans']` ‚Üí queryKey incluye `currentCompany?.id` ‚Üí fix: `['tool-loans', currentCompany?.id]`
- `app/panol/reservas/page.tsx`: invalidaba `['reservations']` ‚Üí queryKey incluye `statusFilter` ‚Üí fix: `['reservations', statusFilter]`

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `app/api/tools/[id]/route.ts` | **rewritten** | C1: auth GET+PUT+PATCH+DELETE, companyId check, params Promise |
| `app/api/tools/loans/route.ts` | modified | C2: auth GET, companyId from JWT, async cookies in helper |
| `app/api/tools/movements/route.ts` | modified | C3: auth GET, companyId from JWT, async cookies in helper |
| `app/api/tools/loans/[id]/return/route.ts` | modified | M1: params Promise, async cookies in helper |
| `app/panol/prestamos/page.tsx` | modified | M2: invalidation key `['tool-loans', companyId]` |
| `app/panol/reservas/page.tsx` | modified | M2: invalidation key `['reservations', statusFilter]` |

---

### Session 8 ‚Äî Dashboard: Plantillas completas

#### Lo que se hizo
- Reescritura completa de `DASHBOARD_TEMPLATES` en `widget-catalog.ts` (de 8 plantillas pobres a 13 plantillas completas y ricas)

#### Plantillas creadas (13 total)
| Plantilla | Rol | Widgets | Highlights |
|-----------|-----|---------|------------|
| Mi D√≠a | USER, SUP | 12 | KPIs + listas + donas + calendario |
| Operador Completo | USER, SUP | 14 | 360¬∞ con cards, barras, donas y calendario |
| Operador Visual | USER, SUP | 13 | Foco en gr√°ficos: donas, barras, tarjetas |
| Vista de Equipo | SUP, ADMIN | 14 | Carga equipo, fallas, controles sector, m√°quinas |
| Supervisor Operativo | SUP | 16 | Balance gesti√≥n equipo + trabajo propio |
| Supervisor Anal√≠tico | SUP | 14 | M√©tricas sector con gr√°ficos avanzados |
| Vista Estrat√©gica | ADMIN, SA, AE | 12 | KPIs MTTR/MTBF, tendencias, costos, sectores |
| Gerente 360 | ADMIN, SA | 18 | Visi√≥n completa con TODO incluido |
| Control de Costos | ADMIN, SA | 14 | Foco financiero: costos, efectividad, tendencias |
| Confiabilidad & Fallas | ADMIN, SA | 13 | An√°lisis fallas, health scores, preventivo |
| Resumen Ejecutivo | TODOS | 12 | KPIs + listas + gr√°ficos esenciales |
| Anal√≠tico Avanzado | SUP, ADMIN, SA | 14 | Todos los gr√°ficos y m√©tricas disponibles |
| Operaciones Diarias | TODOS | 13 | Lo operativo: vencidas, progreso, tareas, calendario |

#### Principios de dise√±o aplicados
- M√≠nimo 12 widgets por plantilla (antes eran 5-10)
- Variedad de estilos: stat-card + donut-chart + bar-chart + area-chart + list + cards + progress
- Cada plantilla tiene los 4 KPIs r√°pidos arriba como "header row"
- Los gr√°ficos se alternan para generar variedad visual (dona ‚Üí barra ‚Üí lista ‚Üí dona)
- Supervisores tienen 3 plantillas diferenciadas (equipo / operativo / anal√≠tico)
- Gerentes tienen 4 plantillas diferenciadas (estrat√©gica / 360 / costos / confiabilidad)

#### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `lib/dashboard/widget-catalog.ts` | modified | DASHBOARD_TEMPLATES reescrito: 8 ‚Üí 13 plantillas, todas con 12-18 widgets |

---
*Log mantenido seg√∫n `.claude/rules/workflow-rules.md` Regla 1*
