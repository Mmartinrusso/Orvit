# Daily Log ‚Äî 2026-02-23

---

## üìã RESUMEN EJECUTIVO *(para Notion / seguimiento de proyecto)*

> *Una sola lectura da el panorama completo del d√≠a. Se actualiza acumulativamente ‚Äî no se crea un segundo bloque.*
> *Organizado por m√≥dulo/sector. Solo aparece lo que est√° completo. Sin secci√≥n de pendientes.*

### ‚úÖ Mantenimiento Preventivo ‚Äî 9 fixes
- **Fechas pasadas en creaci√≥n**: Eliminada validaci√≥n que bloqueaba crear mantenimientos con fecha anterior a hoy. Ayuda a registrar mantenimientos ya realizados con fecha correcta.
- **Operadores obligatorios en ejecuci√≥n**: Campo multi-select con b√∫squeda (Popover+Command) para registrar qui√©n ejecut√≥ el mantenimiento. Requerido. Fuente: `/api/costos/empleados`. Mostrado en historial con √≠cono `Users`.
- **Fecha/hora de ejecuci√≥n con DateTimePicker**: Reemplazado `datetime-local` nativo por `DateTimePicker` (calendario + inputs hora/min), con `maxDate=hoy` para bloquear fechas futuras. Default: ahora.
- **Actualizaci√≥n en tiempo real en Detalle de M√°quina**: `MachineDetailDialog` ahora invalida queries de React Query tras guardar; y `MachineMaintenanceTab` llama `refetchWorkOrders` (no solo el refetch de history). API con `cache: 'no-store'` para evitar cache HTTP del browser.
- **"Asignado a" en historial**: Corregido ‚Äî ya no muestra "Sin asignar". `newHistoryEntry` persiste `assignedToName`; display lee del historial o del template.
- **Fix historia mezclada**: API `/api/maintenance/history` mezclaba √≥rdenes de trabajo con plantillas preventivas por colisi√≥n de IDs num√©ricos. Fix: cuando se filtra por `maintenanceId`, solo usar `preventiveTemplateHistory`.
- **Fix operadores en historial**: Faltaba mapear `operators` en `preventiveTemplateHistory` de `history/route.ts`. Fix: `operators: Array.isArray(entry.operators) ? entry.operators : []`.
- **√çcono en cards de ejecuci√≥n**: `PlayCircle` ‚Üí `Check` (tilde solo, `h-4 w-4`) en `PreventivoHoyView`, `PreventivoPlanesView` y `EnhancedMaintenancePanel` (√ó2 botones).
- **DELETE 404 en mantenimiento preventivo**: `DELETE /api/maintenance/[id]` solo buscaba `WorkOrder` y `Document`. Agregado tercer caso para `PreventiveTemplate` ‚Äî ahora elimina correctamente las plantillas preventivas.

### ‚úÖ Sidebar ‚Äî Sistema de Favoritos (por usuario)
- **API `GET/PUT /api/user/sidebar/favorites`**: Nuevo endpoint que lee/escribe `sidebarPreferences.favorites` (array de moduleIds). Sigue el patr√≥n existente de `ventas/collapsed`. Sin cambios de schema (campo `Json?` ya exist√≠a en `User`).
- **Hook `useSidebarFavorites()`**: Query + mutation con optimistic updates. Expone `favorites`, `isFavorite(moduleId)`, `toggleFavorite(moduleId)`. Sin toast en toggle exitoso (demasiado verbose).
- **Secci√≥n "Favoritos" en el sidebar**: Aparece encima de todos los nav items en cualquier m√≥dulo (Admin, Mantenimiento, Producci√≥n). Solo visible cuando hay favoritos y sidebar expandido. Items resueltos v√≠a `getAllLeafItems()` filtrados por favorites. Estrella amarilla en el √≠tem para quitar.
- **Estrella en hover de items hoja**: En items expandidos (dentro de grupos y top-level), aparece estrella `h-3 w-3` a la derecha en hover. Si ya es favorito ‚Üí siempre visible y amarilla. `moduleId` propagado desde `buildModuleNodes()` via `mod.id`.
- **TypeScript**: 0 errores en archivos propios (errores pre-existentes en `vincular-recepcion-modal.tsx`).

### ‚úÖ Sidebar ‚Äî Modo edici√≥n directo (admin)
- **Bot√≥n editar** movido al √≠cono de l√°piz junto al √≠tem "Configuraci√≥n" en el footer del sidebar (no ocupa espacio extra)
- **Permisos**: visible para roles de empresa que contengan "ADMIN" (no solo roles de sistema)
- **Soporte para Mantenimiento y Producci√≥n**: el modo edici√≥n tambi√©n funciona en esos m√≥dulos (solo edita la estructura interna del m√≥dulo actual, prop `moduleOnly`)
- **Fix `__flat__`**: grupos sin header ahora muestran los nombres de sus √≠tems separados por " ¬∑ " en lugar de mostrar `__flat__` literalmente
- **√çtems hu√©rfanos al eliminar grupo**: los √≠tems del grupo eliminado van a un panel "Pendiente de asignar" en lugar de perderse
- **Fix sidebar cierre al asignar**: Radix Select abr√≠a un portal que causaba cierre del sidebar ‚Üí reemplazado por men√∫ inline sin portal
- **Remover √≠tem de grupo**: bot√≥n √ó en cada √≠tem para devolverlo al pool de hu√©rfanos
- **Opci√≥n "Sin grupo"**: bot√≥n en el panel de hu√©rfanos para dejar un √≠tem sin agrupar (aparece directamente en el sidebar como `__flat__`)
- **Tab "Navegaci√≥n" eliminado** de `administracion/configuracion/page.tsx`; `sidebar-editor.tsx` eliminado

### ‚úÖ General / Infraestructura
- **Auditor√≠a completa del frontend ‚Äî Fases 1 a 4 completadas** (~350 archivos modificados):
  - **Fase 1 (Colores)**: Tokens sem√°nticos `accent-purple` y `accent-cyan` en globals.css + tailwind.config.ts. Reemplazo de colores hardcodeados (purple-100, emerald-100, cyan-100, etc.) por tokens en ~50 archivos. Badge predictive migrado a tokens. Fix 5 imports rotos pre-existentes.
  - **Fase 2 (Headers)**: 19 p√°ginas estandarizadas al patr√≥n Tier 1 de Tesorer√≠a: title `text-xl font-semibold`, subtitle `text-sm text-muted-foreground mt-1`, header `px-4 md:px-6 pt-4 pb-3 border-b border-border`.
  - **Fase 3 (Patrones)**: 5 `confirm()` nativos ‚Üí `useConfirm()`. Toast chains sin ID corregidos. ~210 archivos con `text-[10px]`/`text-[11px]` ‚Üí `text-xs` (WCAG AA). Badges `h-4` ‚Üí `h-5`.
  - **Fase 4 (Formateo)**: Fechas: ~36 archivos de p√°ginas + ~5 de componentes migrados a `formatDate()`/`formatDateTime()`. N√∫meros: ~45 archivos con `.toFixed()` ‚Üí `formatNumber()`, 7 funciones `formatNumber` locales eliminadas, 24 bugs de script automatizado corregidos.
- **Build verificado**: Compilaci√≥n exitosa sin errores nuevos.

- **Auditor√≠a completa del frontend ‚Äî Fases 2C-2G + 5 completadas** (~130 archivos adicionales):
  - **Fase 2C (KPI Cards)**: Todas las KPI cards estandarizadas al patr√≥n Tesorer√≠a (flat, sin gradientes). Ventas, Compras, Almac√©n, Mantenimiento, Producci√≥n y Superadmin. Gradientes removidos, labels/values/icons normalizados.
  - **Fase 2D (Filtros)**: Cotizaciones: Select redundante eliminado. Solicitudes: KPIs separados de filtros. Comprobantes: search sizing fijo. WorkOrders: Selects con width fijo, alturas h-8.
  - **Fase 2E (Mantenimiento chrome)**: Separadores `border-t` entre zonas en ordenes y fallas. Dividers verticales antes de view toggle. SavedViewsBar restyled como pill-tabs.
  - **Fase 2F (Producci√≥n)**: Section headers "Producci√≥n y Paradas" y "Calidad y Actividad". OEE header migrado a `bg-primary`.
  - **Fase 2G (Sticky headers)**: Base `TableHeader` ahora tiene `sticky top-0 z-10 bg-background`. 3 raw `<thead>` fijados manualmente. 3 instancias duplicadas limpiadas.
  - **Fase 5A (Responsive)**: ~72 grids cambiados de `grid-cols-1 md:grid-cols-4` ‚Üí `grid-cols-2 md:grid-cols-4`. Bare `grid-cols-4` ‚Üí responsive en ~13 instancias.
  - **Fase 5C (Dark mode)**: 20 overrides `dark:bg/text/border-purple-*` ‚Üí tokens sem√°nticos `accent-purple-muted`. 3 gradientes dark ‚Üí flat sem√°ntico.
- **Build verificado**: Compilaci√≥n exitosa sin errores nuevos.

### ‚úÖ Formularios ‚Äî Enter Navigation + Auto-avance Select
- **Enter avanza al siguiente campo**: En todos los formularios del sistema (~96+), presionar Enter avanza al siguiente campo en vez de enviar. √öltimo campo ‚Üí env√≠a formulario normalmente. Implementado en `Input` base ‚Äî 0 formularios tocados.
- **Select auto-avance**: Al seleccionar un valor en cualquier `Select`, el foco avanza autom√°ticamente al siguiente campo. Escape hatch: `autoAdvance={false}`. Implementado en `Select` wrapper.
- **Utilidad `focusNextFormField`**: Busca siguiente campo focusable (input, textarea, combobox) dentro del `<form>`. Excluye `data-no-advance` y submit buttons.
- **Hook obsoleto eliminado**: `hooks/use-enter-navigation.ts` eliminado (nunca se us√≥ en ning√∫n formulario).

### ‚úÖ CRUD Instant√°neo ‚Äî Migraci√≥n de fetch manuales (Paso 1)
- **`useApiMutation` hook creado**: Wrapper centralizado sobre `useMutation` con toast autom√°tico (sonner), invalidaci√≥n de queries, y soporte para optimistic updates con rollback.
- **`createFetchMutation` helper**: Factory function para `mutationFn` est√°ndar con JSON fetch.
- **~60 mutations migradas en 17 archivos**: Todos los `fetch()` manuales sin invalidaci√≥n ahora pasan por `useApiMutation` con `invalidateKeys` ‚Äî la UI se actualiza autom√°ticamente.
  - TaskGroupsSidebar (4), FeedbackModal (3), proveedores (3), recepciones (1), panol (3)
  - quote-editor-modal (2), MachineSchemaView (5), ComponentDetailsModal (1)
  - produccion/rutinas (2), produccion/recursos (1), mantenimiento/maquinas (1), mantenimiento/loto (1)
  - configuracion (10), MachineDetailDialog (14), proveedor-cuenta-corriente (5)
  - cotizaciones config (3), ptw (4)
- **FormData uploads** dejados como est√°n (el hook asume JSON content type).
- **Build verificado**: Compilaci√≥n exitosa sin errores nuevos.

### ‚úÖ CRUD Instant√°neo ‚Äî Optimistic Updates (Paso 2)
- **10 mutations con optimistic updates** en 7 hooks ‚Äî la UI se actualiza al instante, rollback autom√°tico si falla:
  - `use-agenda-tasks.ts`: delete (filtra tarea del cache) + update (merge parcial)
  - `use-client-analytics.ts`: delete note + update note
  - `use-tax-control.ts`: delete record + delete base + update status
  - `use-load-templates.ts`: delete template
  - `use-price-comparisons.ts`: delete comparison
  - `use-sidebar-preferences.ts`: update preferences (merge objeto)
- **Patr√≥n**: `onMutate` (cancel + snapshot + update cache) ‚Üí `onError` (rollback) ‚Üí `onSettled` (invalidate siempre)
- **Multi-filter aware**: Agenda y client notes usan `setQueriesData` (plural) para actualizar todas las variantes de cache con distintos filtros.
- **Build verificado**: Compilaci√≥n exitosa sin errores nuevos.

### ‚úÖ Mantenimiento ‚Äî Herramientas y Repuestos en Ejecuci√≥n (5 fixes)
- **Schema**: `usedQuantity Int?` + `returnedDamaged Boolean @default(false)` en `SparePartReservation`. Tabla `spare_part_reservations` creada completa (no exist√≠a en DB). Migraci√≥n idempotente.
- **execute/route.ts**: Funci√≥n `processResources()` con 3 casos: (A) reservaci√≥n existente ‚Üí confirmar usedQuantity + devolver sobrante al stock + marcar herramientas da√±adas, (B) ad-hoc con toolId ‚Üí deducir stock directo, (C) preventivo sin toolId ‚Üí solo historial. Flujo correctivo ahora en `$transaction` at√≥mica. `maintenance_history.spareParts` (campo Json? existente, antes null) ahora se usa para guardar recursos.
- **ExecuteMaintenanceDialog**: Secci√≥n "Recursos Utilizados" con dos flujos: correctivo carga desde `/api/tools/reservations?workOrderId=X`, preventivo desde `toolsRequired` JSON. Herramientas con checkbox "Da√±ada", repuestos con spinner ¬±qty y badge "Devolver: N". B√∫squeda ad-hoc de pa√±ol para recursos no planificados.
- **calculator.ts**: `usedQuantity ?? quantity` para costo real de repuestos (antes usaba picked qty). Herramientas da√±adas ‚Üí costo de reposici√≥n sumado a `extrasCost`.
- **MaintenanceDetailDialog**: Secci√≥n "Recursos utilizados" en timeline (~l√≠nea 2382), separando herramientas/repuestos con badges "Da√±ada" y "No planificado".

### ‚úÖ Unidades M√≥viles ‚Äî Carga masiva de kilometraje con planilla imprimible
- **`KilometrajeMasivoDialog.tsx`** (nuevo): Dialog `max-w-4xl` con lista de todas las unidades activas, input de nuevo km por fila, validaci√≥n inline (verde = v√°lido, rojo = menor al actual). Badge "Vencida" para unidades con lectura atrasada. Toggle "Solo vencidas" para filtrar. Resultado post-submit: lista de √©xitos/errores por unidad con opci√≥n "Cargar nuevamente".
- **Planilla imprimible**: Bot√≥n "Imprimir planilla" genera una nueva ventana con HTML limpio ‚Äî tabla con N¬∞, unidad, patente, tipo, sector, km anterior, columna vac√≠a para completar a mano y firma. Instrucciones en el encabezado. `window.print()` autom√°tico tras 600ms.
- **Batch submit**: POST secuencial a `/api/mantenimiento/unidades-moviles/[id]/kilometraje` por cada unidad con valor > km actual. `onKilometrajesGuardados` callback para refresh de la lista.
- **Integraci√≥n en `page.tsx`**: Import, estado `showKilometrajeMasivo`, bot√≥n "Cargar Km" (con √≠cono `Gauge`) en la barra de acciones junto a "Seleccionar" y "Mostrar resumen".

### ‚úÖ Unidades M√≥viles ‚Äî Mantenimiento Preventivo + Fix alerta + Reescritura completa del modal
- **Mantenimiento preventivo**: El backend exist√≠a completo pero sin entrada desde la UI. Implementado tab "Preventivos" en `UnitDetailSheet.tsx` con lista, bot√≥n "Nuevo", y `UnidadMovilMaintenanceDialog` integrado. `handleScheduleService` en `page.tsx` ahora abre el sheet en tab "Preventivos" en lugar de redirigir a ordenes.
- **AlertTriangle en UnitCard**: Movido de `absolute top-2 right-2` (se superpon√≠a al badge "Activo") a dentro del flex row del header junto al badge, con tooltip. √çcono `h-3.5 w-3.5`, sin `animate-pulse`.
- **Reescritura completa `UnidadMovilMaintenanceDialog.tsx`**: Modal rehecho desde cero con estilo V0/Orvit. Fixes: bot√≥n X siempre visible (removido `sm:hidden` en `dialog.tsx`), Select pre-selecci√≥n (fallback `unidadesForSelect`), reset de form al reabrir, footer limpio sin "Ver historial". Dise√±o: labels `text-xs uppercase tracking-wider`, selects `h-9`, info row de unidad como div compacto (no Card), plantillas r√°pidas como `<button>`, empty states en Recursos, upload de archivos accesible via `<label>`. Tab Programaci√≥n: trigger condicional por tipo (KM/HOURS/DAYS), sin campos duplicados de frecuencia.

### ‚úÖ Ventas ‚Äî `aplicaComision` por √≠tem (stack completo)
- **DB**: 4 columnas SQL ‚Äî `products.aplicaComision`, `quote_items.aplicaComision`, `sale_items.aplicaComision`, `seller_liquidacion_items.baseComision`
- **Prisma schema**: 4 modelos actualizados + generate ejecutado
- **APIs actualizadas**: cotizaciones POST (hereda del producto), ordenes POST (√≠dem), convertir (copia de QuoteItem), ventas-disponibles (calcula `baseComision`), liquidaciones POST (comisi√≥n = `baseComision * %` en lugar de `total * %`)
- **API productos**: acepta y persiste `aplicaComision` en create/update
- **product-form.tsx**: Switch "Aplica comisi√≥n al vendedor" con descripci√≥n
- **quote-editor-modal.tsx**: toggle "% com." / "sin com." por √≠tem, badge amber, muestra "Base comisi√≥n" en totales cuando difiere
- **liquidaciones/nueva/page.tsx**: `baseComision` por OV en card + resumen sticky, Step 3 con columna y c√°lculo correcto

### ‚úÖ Ventas ‚Äî Cotizador Perfecto (modal unificado)
- **API nueva**: `GET /api/ventas/cotizaciones/permisos` ‚Äî retorna `{canViewCosts, canViewMargins, canOverrideMargins}` usando `checkPermission` para el usuario autenticado
- **quote-editor-modal.tsx**: 5 features agregados sin romper lo existente:
  - **Vendedor**: selector `<Select>` en panel General, fuente `/api/ventas/vendedores`. Guarda `sellerId` al API
  - **Lista de precios del cliente**: detecta `client.defaultPriceList.id` ‚Üí fetch `/api/ventas/listas-precios/{id}/items` ‚Üí Map<productId, precio>. Badge "LP" verde en precio del √≠tem. Precio auto-sugerido en dropdown de b√∫squeda. Indicador "Lista de precios: [nombre]" bajo el combobox de cliente
  - **Permisos**: estado `permisos` disponible para gate de m√°rgenes/costos en futuras adiciones. Carga paralela en `loadData`
  - **Ver PDF**: bot√≥n `ghost` que aparece cuando existe `savedQuoteId` (post-save o modo edici√≥n). `window.open(/api/.../pdf, _blank)`
  - **Historial de versiones**: collapsible en sidebar derecho (solo en modo edici√≥n). Lista versi√≥n, fecha, usuario, motivo. Carga en parallel con datos principales
- **cotizaciones/page.tsx**: `QuoteQuickModal` ‚Üí `QuoteEditorModal` (modal unificado y completo)

### üìä Estado del proyecto hoy
| √Årea | Estado | Nota |
|------|--------|------|
| Tokens de color sem√°nticos | ‚úÖ Completo | Purple/cyan en 4 temas, ~50+ archivos migrados |
| Headers de p√°gina | ‚úÖ Completo | 19 p√°ginas estandarizadas |
| Patrones de componente | ‚úÖ Completo | confirm, toast, font sizes |
| Formateo de fechas | ‚úÖ Completo | formatDate/formatDateTime can√≥nico |
| Formateo de n√∫meros | ‚úÖ Completo | formatNumber can√≥nico |
| KPI cards consistentes | ‚úÖ Completo | Todos los m√≥dulos al patr√≥n Tesorer√≠a |
| Table headers sticky | ‚úÖ Completo | Base component + raw theads |
| Filtros desapretados | ‚úÖ Completo | Cotizaciones, solicitudes, comprobantes, ordenes |
| Mantenimiento chrome | ‚úÖ Completo | Separadores + pill-tabs |
| Producci√≥n sections | ‚úÖ Completo | Section headers agregados |
| Responsive grids | ‚úÖ Completo | ~85 grids normalizados a 2-col mobile |
| Dark mode cleanup | ‚úÖ Completo | 23 overrides ‚Üí tokens sem√°nticos |
| Console cleanup | üî≤ Pendiente | ~733 console.log (baja prioridad) |
| Enter navigation formularios | ‚úÖ Completo | Input base + Select wrapper, 0 forms tocados. Fix: dialogs sin `<form>` |
| CRUD instant√°neo (Paso 1) | ‚úÖ Completo | useApiMutation + ~60 mutations migradas en 17 archivos |
| CRUD instant√°neo (Paso 2) | ‚úÖ Completo | Optimistic updates en 7 hooks (10 mutations) |
| Comisiones por √≠tem (`aplicaComision`) | ‚úÖ Completo | Stack completo: DB + APIs + UI (producto, cotizaci√≥n, liquidaci√≥n) |
| Cotizador Perfecto | ‚úÖ Completo | Modal unificado: vendedor, LP, permisos, PDF, historial |
| Fix productos 500 + UX tipeo cotizador | ‚úÖ Completo | Columna `aplicaComision` faltaba en tabla `Product` ‚Üí migraci√≥n + fix typing |
| Cotizador ‚Äî Flete + Plantillas de texto | ‚úÖ Completo | Toggle "Nosotros hacemos el flete" + plantillas NOTA/PAGO/ENTREGA por empresa (DB+API+UI+PDF) |
| Herramientas/Repuestos en ejecuci√≥n | ‚úÖ Completo | usedQuantity, returnedDamaged, devoluci√≥n stock, herramientas da√±adas, costos corregidos |
| Compras ‚Äî Fix DELETE comprobante 500 | ‚úÖ Completo | Tablas `credit_debit_notes` + `credit_debit_note_items` faltaban en DB ‚Üí migraci√≥n aplicada |
| Compras ‚Äî Cascade DELETE factura | ‚úÖ Completo | Al eliminar una factura ahora se eliminan sus remitos, devoluciones y NCAs (antes solo desvinculaba). StockMovements y FKs nulificados en orden correcto |
| Compras ‚Äî Cleanup Holcim | ‚úÖ Completo | Script de limpieza total: 1 factura, 3 devoluciones, 1 remito, 5 OPs, 8 OCs eliminados. OC revertida a APROBADA. Stock revertido |
| Compras ‚Äî DELETE OP revierte tesorer√≠a | ‚úÖ Completo | `DELETE /api/compras/ordenes-pago/[id]` ahora elimina CashMovements + BankMovements + SupplierAccountMovements antes de borrar la OP (fondos vuelven a las cuentas) |

---
---

## üõ†Ô∏è LOG T√âCNICO *(para desarrollo / Claude Code)*

### Session 1: Date formatting (early morning)
- Completed Pattern 4 date-fns ‚Üí formatDate/formatDateTime in 5 maintenance/task component files
- Removed local formatDate helper functions in 4 preventive views

### Session 2: Full frontend audit ‚Äî Fases 1-4 (main session)
**Scope**: ~350 archivos modificados across 5 phases

#### Fase 1 ‚Äî Fundaci√≥n + Colores
- Added `--accent-purple` and `--accent-cyan` CSS variables to all 4 themes in globals.css
- Mapped to Tailwind tokens in tailwind.config.ts
- Badge `predictive` variant migrated to semantic tokens
- 4 parallel agents replaced hardcoded colors in ~50 files (compras, ventas, panol+superadmin, maintenance+tasks)
- Fixed 5 pre-existing broken imports (HealthScoreBadge, QRCodeGenerator, InstructiveDialog, validation/accounting, validation/duplicates)
- Removed debug CSS artifact `.machines-scroll-force`

#### Fase 2 ‚Äî Headers estandarizados
- Analyzed Tier 1 pattern from Tesorer√≠a/N√≥minas pages
- 4 parallel agents standardized 19 pages: vendedores, liquidaciones(ventas), proveedores, compras dashboard, solicitudes, comprobantes, m√°quinas, WorkOrdersHeader, WorkstationsToolbar, fallas, ideas, puntos-medici√≥n, produccion/dashboard, ordenes, paradas, reportes, registro-diario, rutinas, almacen

#### Fase 3 ‚Äî Patrones de componente
- 4 files: `confirm()` ‚Üí `useConfirm()` (maquinas, cotizaciones config, sidebar-edit-mode, TaskGroupsSidebar)
- 2 files: Toast chains missing `{ id }` (proveedor-cuenta-corriente, google-drive-picker)
- ~160 files: `text-[10px]` ‚Üí `text-xs`, ~50 files: `text-[11px]` ‚Üí `text-xs`
- 27+ files: Badge `h-4` ‚Üí `h-5` for text-xs fit
- Preserved `print:text-[10px]` in MaintenanceReportDocument

#### Fase 4 ‚Äî Fechas + N√∫meros
- 31 page files: `.toLocaleDateString()`, `.toLocaleString()`, inline `format()` ‚Üí `formatDate()`/`formatDateTime()`
- 5 component files: Same patterns + local function removal
- ~45 files: `.toFixed()` ‚Üí `formatNumber()` in display contexts
- 7 files: Local `formatNumber` definitions removed
- 24 files: Fixed `Math.absformatNumber` / `NumberformatNumber` bugs from automated script

#### Build verification
- `next build` passes with "Compiled with warnings" (all warnings pre-existing)
- Zero new errors introduced

### Decisions Made
- Print-specific CSS (`@media print`, `.report-print-root`) never touched
- Gradient colors (`from-purple-500 to-purple-600`) in superadmin left as decorative gradients
- `lib/helpers/format.ts` marked deprecated (zero importers)
- Sticky headers kept sticky, only classes standardized
- Icons removed from h1 titles per Tier 1 pattern

### Session 3: Sidebar edit mode ‚Äî UX refinements

#### Completado
- Pencil icon next to Configuraci√≥n link (expanded + collapsed sidebar states)
- `canModifySidebar`: changed from role enum array to `.toUpperCase().includes('ADMIN')` substring check
- `moduleOnly` prop on `SidebarEditMode` for Mantenimiento/Producci√≥n (no top-level section DnD, just internal groups)
- `isEditableArea` + `editModeModuleOnly` computed in Sidebar.tsx
- `__flat__` display fix: `displayLabel = isFlat ? items.map(i => i.name).join(' ¬∑ ') : group.name`
- `localOrphanedItems: Partial<Record<SidebarModuleKey, SidebarNode[]>>` state
- `handleDeleteGroup`: collects leaf items recursively ‚Üí orphaned pool
- `handleAssignOrphanedItem`: orphaned ‚Üí named group
- `handleRemoveFromGroup`: item ‚Üí orphaned pool (X button on each item)
- `handleLeaveOrphanedUngrouped`: orphaned ‚Üí `__flat__` group (creates if needed)
- `OrphanedItemsPanel`: amber panel, "Sin grupo" button + named group buttons (no Radix portal)
- Fixed both usages of `OrphanedItemsPanel` (SortableSectionRow + moduleOnly path) to pass `onLeaveUngrouped`
- Removed Navegaci√≥n tab from configuracion/page.tsx
- Deleted components/ventas/configuracion/sidebar-editor.tsx
- Fixed stale `.next` cache after deletion (`rm -rf .next`)

### Session 6: Fases 2C-2G + 5 ‚Äî KPIs, Filtros, Sticky, Responsive, Dark Mode

#### Fase 2C ‚Äî KPI Cards (todas las m√≥dulos)
- Ventas page: Gradient `from-blue-50` ‚Üí flat `bg-primary/5`. Colores neutralizados en 6 cards.
- Seller KPI cards: 5 gradients removed, iconBg ‚Üí `bg-muted`, value `text-xl` ‚Üí `text-2xl`
- Compras page: MetricCard (`font-semibold` ‚Üí `font-bold`, `mt-1`, `bg-muted`), Health Score (flat), Executive KPIs (de-gradient), Resumen R√°pido (flat), Alertas header (de-gradient)
- Almac√©n: `border-l-4` removed, icon wrapped in container
- Mantenimiento KpiStatWidget: Wrapped in Card, imported Card/CardContent, removed colored values
- Producci√≥n: Labels `uppercase tracking-wider` ‚Üí `font-medium`, icon `h-10 w-10 rounded-full` ‚Üí `p-2 rounded-lg bg-muted`
- Superadmin: `text-3xl` ‚Üí `text-2xl`, `w-12 h-12` ‚Üí `p-2`, `CardContent pt-6` ‚Üí `p-4`

#### Fase 2D ‚Äî Filtros
- Cotizaciones: Removed redundant `<Select>` (7 buttons + dropdown both controlled `statusFilter`)
- Cotizaciones: Search `max-w-sm` ‚Üí `min-w-[200px]`, gap `gap-3` ‚Üí `gap-2`
- Solicitudes: Search `max-w-xs` ‚Üí removed, KPIs separated to own row
- Comprobantes: Search `max-w-[280px]` ‚Üí removed, `text-sm` ‚Üí `text-xs`
- WorkOrdersFiltersBar: 5 Selects `flex-1 min-w-*` ‚Üí fixed widths, all `h-9` ‚Üí `h-8`

#### Fase 2E ‚Äî Mantenimiento Chrome
- Ordenes page: 2 `border-t` separators (after presets, after KPIs)
- Fallas page: 2 `border-t` separators + vertical divider before ViewToggle
- WorkOrdersFiltersBar: Vertical divider `h-6 w-px bg-border` before ToggleGroup
- WorkOrdersSavedViewsBar: Restyled as pill-tabs (`bg-muted/50 p-1 rounded-lg`, active `bg-background shadow-sm`)

#### Fase 2F ‚Äî Producci√≥n Dashboard
- Charts already in Cards (no change needed)
- Added "Producci√≥n y Paradas" section header before charts grid
- Added "Calidad y Actividad" section header before bottom grid
- OEE header: inline `style={{ backgroundColor: userColors.chart1 }}` ‚Üí `className="bg-primary"`

#### Fase 2G ‚Äî Sticky Table Headers
- Base `TableHeader` in `components/ui/table.tsx`: added `sticky top-0 z-10 bg-background`
- Cleaned 3 files with redundant sticky (proveedor-cuenta-corriente √ó2, product-import-dialog)
- Fixed 3 raw `<thead>`: cuenta-corriente, LoadsManager, TrucksManager

#### Fase 5A ‚Äî Responsive Grids
- Pattern A: 48 files `grid-cols-1 md:grid-cols-4` ‚Üí `grid-cols-2 md:grid-cols-4`
- Pattern B: 14 instances `grid gap-4 md:grid-cols-4` ‚Üí `grid grid-cols-2 gap-4 md:grid-cols-4`
- Pattern F: 16 instances bare `grid-cols-4` ‚Üí `grid-cols-2 md:grid-cols-4`

#### Fase 5C ‚Äî Dark Mode Cleanup
- 9 files: `dark:bg/text/border-purple-*` ‚Üí semantic tokens `accent-purple-muted`
- 2 files: Green-emerald gradients ‚Üí `bg-success-muted`
- 1 file: Blue-indigo gradient ‚Üí `bg-info-muted`

#### Build Verification
- `next build` passes (all warnings pre-existing)
- Zero new errors

### Next Session
- [ ] Console cleanup (~733 instances, lower priority)
- [ ] Configuraci√≥n page audit (2149 lines, Tier 3)

---

### Session 4: Editor de Cotizaciones ‚Äî Mejoras completas

#### Contexto
El usuario pidi√≥ mejorar la creaci√≥n de cotizaciones: d√≥nde se sube el logo de empresa, notas con posici√≥n flexible (arriba/abajo), condiciones de pago din√°micas desde el template, y un editor completo con API real.

#### Cambios realizados

**1. DB ‚Äî Migraci√≥n directa SQL**
```sql
ALTER TABLE quote_templates
  ADD COLUMN IF NOT EXISTS "notasPosition" VARCHAR(20) NOT NULL DEFAULT 'after_totals'
```

**2. `prisma/schema.prisma`**
- Agregado `notasPosition String @default("after_totals") @db.VarChar(20)` en `model QuoteTemplate`
- Ejecutado `npx prisma generate`

**3. API templates ‚Äî Zod schemas**
- `app/api/configuracion/cotizaciones/route.ts`: `notasPosition: z.enum(['before_items', 'after_totals'])` + campo en Prisma create
- `app/api/configuracion/cotizaciones/[id]/route.ts`: `notasPosition: z.enum(['before_items', 'after_totals']).optional()`

**4. Validation + API quotes**
- `lib/ventas/validation-schemas.ts`: `templateId: z.coerce.number().int().positive().optional().nullable()`
- `app/api/ventas/cotizaciones/route.ts`: `templateId: data.templateId ?? null` en `prisma.quote.create()`

**5. Template builder (`app/administracion/configuracion/cotizaciones/page.tsx`)**
- Nueva secci√≥n "Logo de la empresa" ANTES de presets: preview del logo actual + bot√≥n cambiar
- `handleLogoUpload`: sube a S3 via `POST /api/upload`, actualiza empresa via `PUT /api/companies/[id]`, actualiza contexto con `updateCurrentCompany()`
- Nueva secci√≥n en tab "Dise√±o": picker `notasPosition` con 2 botones (Arriba de productos / Al pie del documento)
- Interface `QuoteTemplate` extendida con `notasPosition: 'before_items' | 'after_totals'`

**6. Quote editor modal ‚Äî Reescritura completa (`components/ventas/quote-editor-modal.tsx`)**
- Antes: 542 l√≠neas, prototipo con `Math.random()` para IDs, sin llamadas reales a API
- Despu√©s: componente completo funcional
  - `ItemRow` subcomponente para edici√≥n inline en tabla
  - `loadData()`: carga clientes + productos + templates en paralelo
  - Selector de template con checkmarks y badge de preset
  - `applyTemplate()`: pre-llena `notas` desde `notasFooter` solo si est√° vac√≠o
  - Chips de condiciones de pago desde `template.paymentConditionPresets`
  - Posici√≥n din√°mica de notas: `before_items` ‚Üí sobre la tabla; `after_totals` ‚Üí al pie
  - Todos los campos: `titulo`, `moneda`, `fechaValidez`, `discriminarIva`, `descuentoGlobal`, `condicionesPago`, `diasPlazo`, condiciones entrega, `notas`, `notasInternas`
  - `handleSave('draft' | 'send')` ‚Üí `POST/PUT /api/ventas/cotizaciones`
  - Botones: "Guardar borrador" + "Guardar y Enviar"

#### Nota arquitectural
- `quote-quick-modal.tsx` ‚Üí desde la lista (ya ten√≠a API real, no se toc√≥)
- `quote-editor-modal.tsx` ‚Üí desde `/cotizaciones/nueva` (era prototipo, ahora reescrito)

---

### Session 5: KPI cards standardization ‚Äî Compras page (Tesorer√≠a pattern)

#### Contexto
Standardize all KPI cards in the Compras dashboard to match the flat, no-gradient Tesorer√≠a pattern.

#### Cambios realizados

**File**: `orvit-v1/app/administracion/compras/page.tsx`

1. **MetricCard component** (~line 446-504):
   - `colorClasses.default`: `'bg-card'` ‚Üí `''` (no forced background)
   - Label `<p>`: Added `font-medium`
   - Value `<p>`: `font-semibold` ‚Üí `font-bold`, added `mt-1`
   - Icon container: `bg-muted/50` ‚Üí `bg-muted`

2. **Health Score Card** (~line 710):
   - Removed gradient classes + decorative div
   - `border-2 shadow-lg` ‚Üí `border shadow-sm`
   - 4 health factor tiles: gradient + border classes ‚Üí `bg-muted/50`

3. **Executive KPI cards** (~lines 770-895):
   - Compras del Mes: gradient ‚Üí flat `bg-primary/5`, label de-uppercased + font-medium, icon `p-1.5` ‚Üí `p-2`
   - Deuda Total: removed gradients (both vencidas & al-d√≠a branches), kept semantic borders
   - OC Pendientes: removed gradient on alert branch, kept warning border
   - Solicitudes: label de-uppercased + font-medium

4. **Resumen R√°pido tiles** (~lines 1150-1167):
   - All 4 tiles: gradient + colored border ‚Üí `bg-muted`
   - All 4 values: colored text ‚Üí `text-foreground`

5. **Alertas Cr√≠ticas CardHeader** (~line 993):
   - Removed `bg-gradient-to-r from-background to-muted/20`

#### Skills Used
- `orvit-frontend` (KPI card patterns)

---

### Session 7: Mantenimiento Preventivo ‚Äî 4 fixes

#### Fix 1 ‚Äî Fechas pasadas en creaci√≥n
- **Archivo**: `components/work-orders/PreventiveMaintenanceDialog.tsx`
- Eliminado bloque de validaci√≥n (l√≠neas 903-912) que bloqueaba fechas anteriores a hoy en modo `create`
- Actualizado helper text: "puede ser una fecha pasada si el mantenimiento ya fue realizado"

#### Fix 2 ‚Äî Operadores en ejecuci√≥n (multi-select con b√∫squeda)
- **Archivo**: `components/maintenance/ExecuteMaintenanceDialog.tsx`
  - Import: `Popover/PopoverContent/PopoverTrigger`, `Command/CommandEmpty/CommandGroup/CommandInput/CommandItem/CommandList`, `Users`, `Check`, `ChevronsUpDown`, `useCompany`
  - States: `employees[]`, `loadingEmployees`, `selectedOperators[]`, `operatorPopoverOpen`, `executionDateTime`
  - Fetch: `/api/costos/empleados?companyId=X&limit=200` ‚Üí `data.items`
  - UI: Combobox que NO cierra al seleccionar (multi-select), con buscador por nombre, checkmarks en seleccionados
  - Validaci√≥n requerida: `if (selectedOperators.length === 0) newErrors.operators = ...`
  - Payload: `operators: selectedOperators`, `executedAt: executionDateTime ? new Date(executionDateTime).toISOString() : new Date().toISOString()`
- **Archivo**: `app/api/maintenance/execute/route.ts`
  - Extra√≠do `operators` del body
  - Guardado en `newHistoryEntry`: `operators: Array.isArray(operators) ? operators : []`
- **Archivo**: `components/maintenance/MaintenanceDetailDialog.tsx`
  - Importado `Users` de lucide
  - Mostrado operadores en timeline tras "Asignado a"
  - `fetchExecutionHistory`: cache busted siempre (`cache.remove(cacheKey)`) antes de fetch

#### Fix 3 ‚Äî Actualizaci√≥n en tiempo real en Detalle de M√°quina
- **Archivo**: `components/maquinas/MachineDetailDialog.tsx`
  - Importado `useQueryClient` de `@tanstack/react-query`
  - `onSave` de `PreventiveMaintenanceDialog` y `CorrectiveMaintenanceDialog`: `invalidateQueries({ queryKey: ['preventive-maintenance', 'machine', machine.id] })` + `['work-orders', 'machine', machine.id]`

#### Fix 4 ‚Äî Fecha/hora de ejecuci√≥n configurable
- **Archivo**: `components/maintenance/ExecuteMaintenanceDialog.tsx`
  - Helper `getNowLocal()`: fecha/hora actual en formato `datetime-local`
  - State `executionDateTime` inicializado con `getNowLocal()`, reseteado al abrir di√°logo
  - Campo `datetime-local` con `max={getNowLocal()}` ‚Äî no permite fechas futuras
  - Texto gu√≠a: "Pod√©s registrar una fecha pasada si el mantenimiento ya fue realizado"

#### Bugs adicionales resueltos
- **Historia mezclada** (`history/route.ts`): colisi√≥n num√©rica de IDs entre WorkOrder e PreventiveTemplate. Cuando `maintenanceId` est√° presente, se usa solo `preventiveTemplateHistory`. Fix en l√≥gica de `combinedHistory`.
- **`operators` no mapeados** (`history/route.ts`): faltaba `operators: Array.isArray(entry.operators) ? entry.operators : []` en mapping de `preventiveTemplateHistory`.
- **Endpoint auth** (`ExecuteMaintenanceDialog.tsx`): `/api/nominas/empleados` requiere rol payroll-admin ‚Üí silently devolv√≠a array vac√≠o. Cambiado a `/api/costos/empleados` (endpoint abierto).
- **√çcono cards**: `PlayCircle` ‚Üí `CheckCircle` en `EnhancedMaintenancePanel.tsx` (√ó2, ambos botones "Realizar mantenimiento").

---

### Session 8: Comisiones por √≠tem ‚Äî `aplicaComision` en todo el stack

#### Contexto
El usuario pidi√≥ que la base de comisi√≥n del vendedor NO se calcule sobre el total de la venta, sino solo sobre los √≠tems marcados como "con comisi√≥n". Algunos productos (fletes, seguros, materiales de costo directo) no deben generar comisi√≥n. Se implement√≥ el flujo completo: producto ‚Üí cotizaci√≥n ‚Üí venta ‚Üí liquidaci√≥n.

#### DB ‚Äî 4 migraciones SQL directas
```sql
ALTER TABLE products ADD COLUMN IF NOT EXISTS "aplicaComision" BOOLEAN NOT NULL DEFAULT true;
ALTER TABLE quote_items ADD COLUMN IF NOT EXISTS "aplicaComision" BOOLEAN NOT NULL DEFAULT true;
ALTER TABLE sale_items ADD COLUMN IF NOT EXISTS "aplicaComision" BOOLEAN NOT NULL DEFAULT true;
ALTER TABLE seller_liquidacion_items ADD COLUMN IF NOT EXISTS "baseComision" DECIMAL(15,2) NOT NULL DEFAULT 0;
```

#### Prisma schema + generate
- `Product`: `aplicaComision Boolean @default(true)`
- `QuoteItem`: `aplicaComision Boolean @default(true)`
- `SaleItem`: `aplicaComision Boolean @default(true)`
- `SellerLiquidacionItem`: `baseComision Decimal @default(0) @db.Decimal(15, 2)`
- `npx prisma generate` ejecutado

#### Validation schemas (`lib/ventas/validation-schemas.ts`)
- `quotationItemSchema`: `aplicaComision: z.boolean().default(true)`
- `saleItemSchema`: `aplicaComision: z.boolean().default(true)`
- `createProductSchema`: `aplicaComision: z.boolean().optional().default(true)`

#### APIs modificadas (backend)
- **`cotizaciones/route.ts`** (POST): hereda `aplicaComision` del producto (con override desde body)
- **`cotizaciones/[id]/convertir/route.ts`** (POST): copia `quoteItem.aplicaComision` ‚Üí `SaleItem`
- **`ordenes/route.ts`** (POST): hereda `aplicaComision` del producto (con override desde body)
- **`liquidaciones/ventas-disponibles/route.ts`**: incluye `aplicaComision` en items select, calcula y retorna `baseComision` por venta
- **`liquidaciones/route.ts`** (POST): c√°lculo de `comisionMonto = baseComision √ó (comisionPct/100)` donde `baseComision = sum(items con aplicaComision=true)`. Guarda `baseComision` en `SellerLiquidacionItem`.
- **`productos/route.ts`** (POST): acepta y persiste `aplicaComision` en `prisma.product.create()`

#### Frontend modificado
- **`product-form.tsx`**: Switch "Aplica comisi√≥n al vendedor" en Informaci√≥n B√°sica. Zod local actualizado. `defaultValues` y `watch` incluyen `aplicaComision`.
- **`quote-editor-modal.tsx`**:
  - `DraftItem`: `aplicaComision: boolean`
  - `Product`: `aplicaComision?: boolean`
  - `ItemRow`: nueva prop `onToggleComision` + bot√≥n "% com." / "sin com." en columna nueva del header
  - `toggleItemComision()`: toggle por √≠tem
  - `addQuickItem()`: hereda `aplicaComision` del producto seleccionado (default `true` para texto libre)
  - Totales: l√≠nea "Base comisi√≥n" amber cuando hay √≠tems sin comisi√≥n
  - Body `handleSave`: `aplicaComision` incluido en cada √≠tem
- **`liquidaciones/nueva/page.tsx`**:
  - `VentaDisponible`: campo `baseComision: number` + `items.aplicaComision: boolean`
  - `Computed`: `baseComisionTotal = selectedVentas.reduce(sum, v.baseComision)` ‚Üí `totalComisiones = baseComisionTotal √ó comisionPct`
  - Panel izq. (card OV): muestra "Base com.: $X" en amber cuando `baseComision < total`
  - Resumen sticky: l√≠nea "Base comisi√≥n" en amber cuando hay OVs con √≠tems sin comisi√≥n
  - Step 3 tabla: columna nueva "Base com." (amber cuando < total, "= total" en gris si igual)
  - Step 3 KPI Comisi√≥n: subtitle muestra "Sobre $X base" cuando hay √≠tems sin comisi√≥n
  - Step 3 footer: "Base comisi√≥n: $X" visible entre Total ventas y Comisi√≥n total

---
### Session 9: Enter Navigation + CRUD Instant√°neo (Paso 1)

#### Feature 1 ‚Äî Enter Navigation en formularios

**Archivos creados/modificados**:
- `lib/form-navigation.ts` (CREADO): `focusNextFormField(current)` ‚Äî busca siguiente campo focusable en el `<form>` padre
- `components/ui/input.tsx` (MODIFICADO): `onKeyDown` intercepta Enter ‚Üí `focusNextFormField()`. Si avanz√≥, `preventDefault()`. Shift+Enter ignorado.
- `components/ui/select.tsx` (MODIFICADO): Wrapper sobre `SelectPrimitive.Root` con `onValueChange` interceptado ‚Üí `requestAnimationFrame` ‚Üí `focusNextFormField()`. Prop `autoAdvance={false}` como escape hatch.
- `hooks/use-enter-navigation.ts` (ELIMINADO): Hook nunca usado (0 de 96+ formularios lo importaban).

**Decisiones**:
- Modificar componentes base en vez de tocar 96+ formularios ‚Üí cobertura 100% autom√°tica
- `data-no-advance` como escape hatch para campos que necesiten Enter para otra cosa
- Submit buttons excluidos del ciclo de avance ‚Äî Enter en √∫ltimo campo env√≠a el form

#### Feature 2 ‚Äî CRUD Instant√°neo (Paso 1: wrapper + migraci√≥n)

**Archivos creados**:
- `hooks/use-api-mutation.ts`: Hook gen√©rico `useApiMutation<TData, TVariables>` + helper `createFetchMutation<TData, TVariables>`

**17 archivos migrados** (~60 mutations individuales) via 11 agentes paralelos:

| Archivo | Mutations | T√©cnica |
|---------|-----------|---------|
| `components/tasks/TaskGroupsSidebar.tsx` | 4 | `invalidateKeys: [['task-groups']]` |
| `components/feedback/FeedbackModal.tsx` | 3 | `onSuccess` ‚Üí `fetchFeedbacks()` (sin useQuery) |
| `app/administracion/compras/proveedores/page.tsx` | 3 | `onSuccess` ‚Üí `loadProveedores()` |
| `app/administracion/compras/recepciones/page.tsx` | 1 | `onSuccess` ‚Üí `loadRecepciones()` |
| `app/panol/page.tsx` | 3 | `onSuccess` ‚Üí `refetch()` |
| `components/ventas/quote-editor-modal.tsx` | 2 | `mutateAsync` para save flow |
| `components/maquinas/MachineSchemaView.tsx` | 5 | `invalidateKeys: [['machines'], ['components']]` |
| `components/maquinas/ComponentDetailsModal.tsx` | 1 | `mutation.isPending` reemplaza loading state |
| `app/produccion/rutinas/page.tsx` | 2 | Custom `mutationFn` para success-check API |
| `app/produccion/configuracion/recursos/page.tsx` | 1 | Dynamic URL/method (create vs update) |
| `app/mantenimiento/maquinas/page.tsx` | 1 | `Promise.all` pattern preservado |
| `app/mantenimiento/loto/page.tsx` | 1 | `mutateAsync` (form awaits promise) |
| `app/administracion/configuracion/page.tsx` | 10 | 3 FormData uploads left as-is; 9 loading states eliminados |
| `components/maquinas/MachineDetailDialog.tsx` | 14 | FormData uploads left as-is; m√°s complejo |
| `components/compras/proveedor-cuenta-corriente.tsx` | 5 | 4 loading states eliminados |
| `app/administracion/configuracion/cotizaciones/page.tsx` | 3 | FormData logo upload left as-is |
| `app/mantenimiento/ptw/page.tsx` | 4 | `mutateAsync` para form contract |

**Patrones de migraci√≥n**:
- Archivos con `useQuery` ‚Üí `invalidateKeys` directo
- Archivos sin `useQuery` (fetch manual para listar) ‚Üí `onSuccess` llama `refetch()`/`loadData()`
- Toast: archivos con `sonner` ‚Üí `successMessage` del hook. Archivos con `useToast` (shadcn) ‚Üí `successMessage: null` + toast manual en `onSuccess`
- `mutate()` para fire-and-forget, `mutateAsync()` cuando el caller necesita await
- FormData uploads no migrados (hook asume JSON)

**Build**: `next build` exitoso, 0 errores nuevos

---

-
### Session 9b: CRUD Instantaneo Paso 2 (Optimistic Updates)

7 hooks modificados, 10 mutations con optimistic updates. Build exitoso.

---

---

### Session 9c: Bug Fixes ‚Äî Enter Navigation en Dialogs + CRUD Fallas

#### Bug 1 ‚Äî Enter navigation no funciona en modales sin `<form>`
- **Root cause**: `focusNextFormField()` usaba `current.closest('form')` que retorna null en 72% de los modals (124 archivos) que usan `<DialogContent>` sin `<form>` wrapper
- **Fix** (`lib/form-navigation.ts`): `findContainer()` ahora busca en cascada: `closest('form')` ‚Üí `closest('[role="dialog"]')` ‚Üí `closest('[data-form-navigation]')`
- Todos los Radix Dialog/Sheet renderizan autom√°ticamente `role="dialog"` ‚Üí cobertura 100%

#### Bug 2 ‚Äî Select auto-advance no funciona en dialogs sin `<form>`
- **Root cause**: `select.tsx` l√≠nea 27 ten√≠a `trigger.closest('form')` como guard ‚Äî solo avanzaba dentro de `<form>`
- **Fix** (`components/ui/select.tsx`): Removido el check `trigger.closest('form')`. `focusNextFormField()` ya maneja internamente la detecci√≥n del container (form, dialog, data-form-navigation)

#### Bug 3 ‚Äî Fallas: editar/eliminar no refresca la grilla
- **Root cause**: `EditFailureDialog` y `DeleteFailureDialog` en `fallas/page.tsx` solo cerraban el dialog sin invalidar queries
- **Fix** (`app/mantenimiento/fallas/page.tsx`): Agregado `queryClient.invalidateQueries({ queryKey: ['failures-grid'] })` en ambos `onSuccess`

#### Bug 4 ‚Äî FailureQuickReportDialog: crear falla no refresca grilla
- **Root cause**: El dialog invalidaba `failure-occurrences`, `failure-stats`, `failure-kpis`, `work-orders` pero NO `failures-grid`
- **Fix** (`components/corrective/failures/FailureQuickReportDialog.tsx`): Agregado `queryClient.invalidateQueries({ queryKey: ['failures-grid'] })` al bloque de invalidaci√≥n

**Build**: `next build` exitoso, 0 errores nuevos

---

### Session 10: Mantenimiento Preventivo ‚Äî 5 fixes + UnitCard

#### Fix 1 ‚Äî Lista no actualiza tras crear (MachineMaintenanceTab)
- **Root cause**: `MachineMaintenanceTab.tsx` ten√≠a `onSave={() => { ...; refetch(); }}` pero ese `refetch` era el de `useMachineMaintenanceHistory` (history hook), NO el de `useMachineWorkOrders`
- **Fix**: Extra√≠do `refetch: refetchWorkOrders` de `useMachineWorkOrders`, y `onSave` llama ambos: `refetch()` + `refetchWorkOrders()`
- **Fix adicional (browser cache)**: `hooks/use-machine-detail.ts` l√≠nea 288 ‚Äî la API retorna `Cache-Control: private, max-age=30`. Agregado `{ cache: 'no-store' }` al fetch de preventivos para que React Query siempre consulte el servidor

#### Fix 2 ‚Äî "Asignado a: Sin asignar" en historial de ejecuci√≥n
- **Root cause 1**: `newHistoryEntry` en `app/api/maintenance/execute/route.ts` nunca guardaba `assignedToName`
  - Fix: `assignedToName: assignedToName || null` + `assignedToId: assignedToId || null` en `newHistoryEntry`
- **Root cause 2**: `ExecuteMaintenanceDialog.tsx` le√≠a `maintenance.assignedTo?.name || maintenance.assignedWorker?.name || maintenance.assignedToName` para el display, pero en el payload enviaba `null`
  - Fix: `assignedToName: maintenance.assignedTo?.name || maintenance.assignedWorker?.name || maintenance.assignedToName`
- **Display fix** `MaintenanceDetailDialog.tsx` l√≠nea 2364: `{execution.assignedToName || maintenance.assignedToName || assignedTo}` donde `assignedTo` ya computa `maintenance.assignedTo?.name || 'Sin asignar'`

#### Fix 3 ‚Äî √çcono de ejecuci√≥n: Tilde solo (Check), m√°s grande
- `PreventivoHoyView.tsx`: `PlayCircle h-3 w-3` ‚Üí `Check h-4 w-4`, removed `PlayCircle` import
- `PreventivoPlanesView.tsx`: `PlayCircle h-3 w-3` ‚Üí `Check h-4 w-4`, import actualizado
- `EnhancedMaintenancePanel.tsx`: √ó2 botones "Realizar mantenimiento" ‚Üí `Check h-4 w-4`

#### Fix 4 ‚Äî DateTimePicker en formulario de ejecuci√≥n
- **Componente**: `components/ui/datetime-picker.tsx` ‚Äî agregado `maxDate?: Date` a la interface y al `disabled` del `Calendar`
- **Dialog**: `ExecuteMaintenanceDialog.tsx`
  - Import: `DateTimePicker` de `@/components/ui/datetime-picker`
  - Estado: `executionDate: Date` (antes era string `executionDateTime`)
  - Inicializaci√≥n: `useState<Date>(() => new Date())`, reset en `useEffect` con `new Date()` al abrir
  - UI: `<DateTimePicker value={executionDate} onChange={(date) => date && setExecutionDate(date)} maxDate={new Date()} />`
  - Payload: `executedAt: executionDate ? executionDate.toISOString() : new Date().toISOString()`

#### Fix 5 ‚Äî DELETE 404 en plantillas preventivas
- **Archivo**: `app/api/maintenance/[id]/route.ts`
- El handler solo buscaba `WorkOrder` y `Document` (modelos legacy)
- Agregado tercer bloque: busca `PreventiveTemplate`, si existe ‚Üí `prisma.preventiveTemplate.delete()`
- `PreventiveInstance` tiene `onDelete: Cascade` en schema ‚Üí se elimina en cascada autom√°ticamente

#### Fix 6 ‚Äî AlertTriangle superpuesto en UnitCard
- **Archivo**: `components/unidades-moviles/UnitCard.tsx`
- Antes: `div absolute top-2 right-2 z-10` con `AlertTriangle h-3 w-3 animate-pulse` ‚Äî tapaba el badge "Activo"
- Despu√©s: `AlertTriangle h-3.5 w-3.5` dentro del flex header row (`flex items-center gap-1.5 shrink-0`), junto al badge. Envuelto en `Tooltip`. Eliminado `animate-pulse`.

---

---

### Session 11: UnidadMovilMaintenanceDialog ‚Äî Dise√±o + Reescritura completa

#### Contexto
El usuario report√≥ que el modal no "cerraba el dise√±o" (X invisible en desktop, Select no pre-seleccionaba, footer asim√©trico). Despu√©s de varios fixes incrementales, pidi√≥ reescribirlo desde cero con los skills de frontend.

#### Fixes previos al rewrite
1. **`dialog.tsx`**: Removido `sm:hidden` del bot√≥n X ‚Üí ahora visible en todos los tama√±os
2. **`unidadesForSelect` fallback**: Cuando el modal abre con `selectedUnidad` pero `unidades` a√∫n no carg√≥ (async), el Select mostraba placeholder en vez de la unidad. Fix: `unidadesForSelect = unidades.length > 0 ? unidades : selectedUnidad ? [selectedUnidad] : []`
3. **Reset al reabrir**: Movido reset completo de `formData` al `useEffect([isOpen])` ‚Üí form limpio en cada apertura modo create
4. **Footer limpio**: Eliminado "Ver historial" + todo el c√≥digo del modal de historial (`showHistoryModal`, `loadMaintenanceHistory`, `maintenanceHistory`, `History` import, Dialog JSX)
5. **Badge color veh√≠culo**: `getPriorityColor(estado)` ‚Üí nueva funci√≥n `getEstadoColor()` con mapping correcto (ACTIVO‚Üígreen, INACTIVO‚Üíred, MANTENIMIENTO‚Üíyellow)
6. **Tab Programaci√≥n ‚Äî campos duplicados**: Eliminados `maintenanceIntervalType` + `maintenanceInterval` (duplicados de `maintenanceTrigger` + `triggerValue`). `frequency` select + "Pr√≥ximo Mantenimiento" box ahora condicionales a `maintenanceTrigger === 'DAYS'`
7. **SelectTrigger height**: `replace_all` para agregar `className="h-9"` a todos los SelectTrigger

#### Reescritura completa (Write tool)
**Archivo**: `components/maintenance/UnidadMovilMaintenanceDialog.tsx`
**Toda la l√≥gica preservada, JSX rehecho completo**

Cambios clave:
- Helper functions extra√≠das fuera del componente: `getEstadoColor`, `getPriorityColor`, `getTypeColor`
- `QUICK_TEMPLATES` constante fuera del componente
- `UserOption` (renombrado de `User` para evitar conflicto con lucide `User` icon)
- `cn` importado de `@/lib/utils`
- √çconos nuevos: `Wand2`, `AlertCircle`, `Package`, `Gauge`, `Clock`, `User`
- Removidos: `Card`, `CardContent`, `CardHeader`, `CardTitle` (no se usan)

**Tab General:**
- Unidad M√≥vil selector (primer campo, required)
- Info row compacto de unidad seleccionada (div con bg-muted/50, no Card)
- T√≠tulo con bot√≥n Wand2 auto-generar
- 2-col: Tipo + Prioridad
- Textarea descripci√≥n
- Plantillas r√°pidas como `<button>` con hover effect

**Tab Programaci√≥n:**
- 2-col: Fecha inicio (DatePicker) + Asignar a
- 2-col: Unidad de tiempo + Duraci√≥n estimada
- Separador con label "Programaci√≥n del trigger"
- Trigger: solo si hay unidad seleccionada (si no ‚Üí mensaje con AlertCircle)
  - 2-col: Tipo (km/horas/d√≠as) + Valor
  - KILOMETERS: grid con "Kilometraje actual" + "Pr√≥ximo mantenimiento"
  - DAYS: Select frecuencia + cards frecuencia/pr√≥xima-fecha
  - HOURS: solo el input de valor

**Tab Recursos:**
- Herramientas: inline add form (Enter to submit), empty state
- Repuestos: 4-col grid (nombre/cantidad/costo/button), Badge √óqty, empty state

**Tab Detalles:**
- Textarea notas
- Instructivos: t√≠tulo + textarea + add button, list con line-clamp-2
- Archivos: label-based upload (accesible), list con FileText icons

**Footer:**
- Cancelar + Crear/Actualizar con Loader2 spinner

---

### Session 12: Unidades M√≥viles ‚Äî Carga de Kilometraje + Frecuencia configurada

#### Contexto
El usuario pidi√≥ agregar un bot√≥n para cargar km desde la card, y configurar con qu√© frecuencia se deben registrar las lecturas de km. Esto permite saber cu√°ndo un mantenimiento por km est√° pr√≥ximo a vencer.

#### Infraestructura pre-existente (no se toc√≥)
- `KilometrajeLog` model en Prisma ‚úÖ
- `KilometrajeHistory.tsx` con di√°logo integrado ‚úÖ
- API `/api/mantenimiento/unidades-moviles/[id]/kilometraje` GET + POST ‚úÖ
- Tab "km" en `UnitDetailSheet` ‚úÖ

#### Cambios implementados

**DB ‚Äî 2 columnas nuevas:**
```sql
ALTER TABLE "UnidadMovil" ADD COLUMN "kmUpdateFrequencyDays" INTEGER;
ALTER TABLE "UnidadMovil" ADD COLUMN "ultimaLecturaKm" TIMESTAMP WITH TIME ZONE;
```

**Prisma schema:**
- `kmUpdateFrequencyDays Int?` ‚Äî cada cu√°ntos d√≠as registrar km
- `ultimaLecturaKm DateTime?` ‚Äî cu√°ndo se registr√≥ el √∫ltimo km

**`lib/unidades-moviles/validations.ts`:**
- `kmUpdateFrequencyDays: z.number().int().min(1).max(365).optional().nullable()` en `createUnidadMovilSchema`

**API `[id]/kilometraje/route.ts` (POST):**
- En la transacci√≥n: `ultimaLecturaKm: new Date()` al actualizar la unidad
- Post-transacci√≥n: query de `PreventiveTemplate` con `maintenanceTrigger: 'KILOMETERS'` y `nextMaintenanceKilometers <= newKm`
- Retorna `alertasMantenimiento: [{ id, title, kmDue, kmActual }]`

**API `[id]/route.ts` (PUT):**
- `...(data.kmUpdateFrequencyDays !== undefined && { kmUpdateFrequencyDays: data.kmUpdateFrequencyDays })`

**API `route.ts` (POST create):**
- `kmUpdateFrequencyDays: data.kmUpdateFrequencyDays || null`

**`UnitCard.tsx`:**
- `UnidadMovil` interface: `kmUpdateFrequencyDays?: number | null; ultimaLecturaKm?: string | Date | null;`
- Prop `onLoadKilometraje?: (unidad: UnidadMovil) => void`
- Import `RefreshCw` de lucide-react
- En el body: badge "Actualizar km" (RefreshCw) + tooltip si lectura vencida (d√≠as atrasado)
- Dropdown: item "Cargar Kilometraje" con `Gauge` icon

**`UnitsGrid.tsx` + `UnitsTable.tsx`:**
- Prop `onLoadKilometraje` agregada y pasada a `UnitCard` / dropdown

**`KilometrajeHistory.tsx`:**
- Props: `kmUpdateFrequencyDays?`, `ultimaLecturaKm?`
- Header: badge con "Pr√≥xima lectura: DD MMM" o "Cada X d√≠as" (amarillo si vencida)
- `handleSubmit`: despu√©s del POST, itera `data.alertasMantenimiento` y muestra toast destructive por cada plantilla vencida

**`UnitDetailSheet.tsx`:**
- `KilometrajeHistory` recibe `kmUpdateFrequencyDays` y `ultimaLecturaKm` de la unidad (cast as any)

**`page.tsx`:**
- `formData` incluye `kmUpdateFrequencyDays: null as number | null`
- `openEditDialog`, `openCreateDialog`, `handleDuplicate`: incluyen `kmUpdateFrequencyDays`
- Handler `handleLoadKilometraje`: `setDetailDefaultTab('km')` + abre sheet
- `UnitsGrid` + `UnitsTable`: reciben `onLoadKilometraje={handleLoadKilometraje}`
- Form tab "Datos T√©cnicos": campo num√©rico "Cargar km cada (d√≠as)" con descripci√≥n

---

### Session 13: Herramientas y Repuestos en Ejecuci√≥n de Mantenimiento

#### Contexto
Auditor√≠a de la l√≥gica de herramientas/repuestos en mantenimiento. Problemas: PICKED ‚â† INSTALADO, sin tracking de herramientas da√±adas, costos calculados con cantidad picked en vez de usada.

#### Fix 1 ‚Äî Schema + Migraci√≥n
- **`prisma/schema.prisma`**: 2 campos nuevos en `SparePartReservation`: `usedQuantity Int?`, `returnedDamaged Boolean @default(false)`
- **Discovery**: tabla `spare_part_reservations` NO exist√≠a en la DB (solo en `full_schema.sql`). Creada completa con FK + indexes + los 2 campos nuevos
- **Migraci√≥n**: `prisma/migrations/20260223_add_reservation_confirmation/migration.sql` ‚Äî idempotente con `CREATE TABLE IF NOT EXISTS` + `ADD COLUMN IF NOT EXISTS`
- `npx prisma generate` ejecutado

#### Fix 2 ‚Äî ExecuteMaintenanceDialog.tsx
- Tipo `ResourceConfirmation` + constantes `CONSUMABLE_TYPES` / `TOOL_TYPES`
- Estados: `resources`, `loadingResources`, `showAdHocSearch`, `adHocSearch`, `adHocResults`, `searchingAdHoc`
- `useEffect` para cargar recursos: correctivo ‚Üí `GET /api/tools/reservations?workOrderId=X` (PICKED/PENDING); preventivo ‚Üí `maintenance.toolsRequired` JSON
- Helpers: `updateResource()`, `removeResource()`, `searchAdHocTool()`, `addAdHocResource()`
- UI entre Operadores y Notas: herramientas con checkbox "Da√±ada", repuestos con spinner ¬±qty y badge "Devolver: N"
- B√∫squeda ad-hoc: input ‚Üí `GET /api/tools?companyId=X&search=Y` ‚Üí resultados con tipo/stock
- Payload: `resources[]` en `executionPayload` (despu√©s de `operators`)

#### Fix 3 ‚Äî execute/route.ts
- `processResources()` funci√≥n top-level con 3 casos
- Helpers: `isConsumableType()`, `isToolItemType()`
- Tipo `ResourceInput`
- `resources` extra√≠do del body
- Preventivo: `resourcesUsed` en `newHistoryEntry`
- Correctivo: `$transaction` wrapping WorkOrder update + `processResources()` + `maintenance_history` (con `spareParts` JSON)
- `ToolMovement` con `type: 'IN'` (devoluci√≥n), `'OUT'` (ad-hoc consumo), `'ADJUSTMENT'` (herramienta da√±ada)

#### Fix 4 ‚Äî calculator.ts
- `calculateSparePartsCost`: query incluye `tool.itemType`, c√°lculo usa `usedQuantity ?? quantity`
- `calculateWorkOrderCost`: nuevo bloque `damagedReservations` ‚Üí `extrasCost` (costo de reposici√≥n de herramientas da√±adas)
- `totalCost` incluye `extrasCost`

#### Fix 5 ‚Äî MaintenanceDetailDialog.tsx
- Secci√≥n "Recursos utilizados" entre m√©tricas y notas (~l√≠nea 2382)
- `resourcesUsed || spareParts` normalizado para ambos tipos de mantenimiento
- Herramientas con Wrench icon + badge "Da√±ada"
- Repuestos con Package icon + "xN" + badge "No planificado"

#### Build
- `next lint` ‚Üí 0 errores en archivos modificados
- `tsc --noEmit` OOM en full project (normal, codebase grande) ‚Äî errores de archivos propios = 0

### Session N: Sidebar Favoritos
- `app/api/user/sidebar/favorites/route.ts` ‚Äî GET retorna `sidebarPreferences?.favorites ?? []`; PUT hace merge sin tocar otras claves
- `hooks/use-sidebar-favorites.ts` ‚Äî Query `['sidebar-favorites']`, mutation con optimistic update, helpers `isFavorite`/`toggleFavorite`
- `components/layout/Sidebar.tsx`:
  - Import `Star` + `getAllLeafItems` + `useSidebarFavorites`
  - `moduleId?: string` a√±adido a `SidebarItem` interface
  - `moduleId: mod.id` en `buildModuleNodes()` items hoja
  - `favoriteItems` memo filtrando `allLeafItems` por `favorites`
  - Secci√≥n JSX encima de `navItems.map()`: solo cuando `isOpen && favoriteItems.length > 0`
  - Estrella en child items y top-level items (expanded): `group/item` + button con `opacity-0 group-hover/item:opacity-100` ‚Üí amarilla si `isFavorite`
  - TypeScript: 0 errores propios (OOM del full check es pre-existente)

### Session N: Fix DELETE comprobante 500

**Bug**: `DELETE /api/compras/comprobantes/103?docType=T1` ‚Üí 500 Internal Server Error

**Investigaci√≥n**:
1. DB checks: `supplier_credit_allocations`, `credit_note_requests`, `goods_receipts`, `purchase_returns` ‚Üí todos existen con campos correctos
2. Verificado `PurchaseComment` schema: `userId` correcto, `logDeletion` tiene try/catch ‚Üí no pod√≠a ser estos
3. Corr√≠ query con todos los counts ‚Üí `prisma.creditDebitNote.count()` falla con P2021 "table `credit_debit_notes` does not exist"
4. Tambi√©n verificado: `SupplierAccountMovement` existe como `"SupplierAccountMovement"` (PascalCase con comillas)

**Root cause**: Tablas `credit_debit_notes` y `credit_debit_note_items` nunca fueron creadas en la BD (schema Prisma las tiene pero sin migration aplicada)

**Fix**:
- Creado `prisma/migrations/add_credit_debit_notes.sql` con ambas tablas + FKs + √≠ndices
- Aplicado via `prisma.$executeRawUnsafe()` (no hay psql instalado)
- Verificado: todos los counts del transaction corren sin error

*Log mantenido seg√∫n `.claude/rules/workflow-rules.md` Regla 1*
