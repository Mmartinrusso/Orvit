# Daily Log ‚Äî 2026-02-21

---

## üìã RESUMEN EJECUTIVO *(para Notion / seguimiento de proyecto)*

> *Organizado por m√≥dulo. Solo lo que est√° completo. Se actualiza acumulativamente ‚Äî sin repetir el bloque.*

### ‚úÖ Ventas
- **Desglose de costos por item**: en cotizaciones ahora se registra el desglose de cada precio unitario (ej: material + flete + tarima). Se copia autom√°ticamente al convertir a venta. Incluye gr√°ficos de composici√≥n.
- **Resumen por vendedor**: nueva p√°gina con KPIs (cotizaciones, tasa de conversi√≥n, comisiones, avance de cuota), gr√°fico de evoluci√≥n mensual (√∫ltimos 6 meses), distribuci√≥n de estados y tabla con detalle por venta. Exportable a CSV.
- **Sistema de liquidaciones**: ciclo completo de comisiones ‚Äî crear liquidaci√≥n (wizard de 3 pasos), listado con KPIs globales, detalle con timeline visual, estados (Borrador ‚Üí Confirmada ‚Üí Pagada), descarga de PDF con desglose. Alerta en el dashboard principal cuando hay liquidaciones sin pagar.
- **Redise√±o frontend liquidaciones (sesi√≥n actual)**:
  - **Lista**: hover preview con HoverCard (N¬∞, estado, vendedor, A Pagar, ventas) al pasar el mouse por las filas
  - **Detalle**: split layout completo ‚Äî panel izquierdo con OV cards (badge cobranza + barra progreso) y timeline compacto; panel derecho con OV seleccionada mostrando header documento + secci√≥n cobranza (badge+barra+3stats) + chips de facturas expandibles (fechas, cobrado, saldo) + desglose de productos con chips de costos; composici√≥n de costos como secci√≥n colapsable al fondo
  - **Wizard Step 2**: badge "Liq." reemplazado por n√∫mero real (LIQ-2025-XXXXX), cards de OVs con badge de cobranza (COBRADA/PARCIAL/EMITIDA), facturas como chips expandibles con secci√≥n cobranza completa, stats bar ahora muestra 3 columnas (Incluidas / Total / Comisi√≥n estimada)
- **Bug cotizaciones**: corregidos 2 errores en la pantalla de cotizaciones (c√°lculo incorrecto de porcentajes y datos que no se mostraban).

### ‚úÖ N√≥minas
- **Bug acceso 401**: todos los usuarios con un rol de empresa personalizado (distinto de los roles del sistema) no pod√≠an entrar al m√≥dulo de n√≥minas. Corregido ‚Äî ahora el m√≥dulo reconoce correctamente el nivel de acceso del usuario.

### ‚úÖ General / Infraestructura
- **Mensajes de carga contextuales**: en toda la app, el mensaje gen√©rico "Cargando..." fue reemplazado por mensajes espec√≠ficos seg√∫n la pantalla. Auditados 228 mensajes, actualizados 42 en 39 archivos. Mejora la experiencia en conexiones lentas.
- **Bug manifest.json**: el navegador mostraba un error al cargar la app (archivos del sistema eran interceptados por el sistema de autenticaci√≥n). Corregido.
- **Limpieza estructural**: eliminadas carpetas duplicadas en ingl√©s (`maintenance/`, `production/`, `users/`). Todo el c√≥digo ahora usa nombres en espa√±ol de forma consistente. Sin impacto en funcionalidades.

### ‚úÖ Discord / Infraestructura
- **Bot de Discord extra√≠do a servicio standalone**: el bot de Discord ahora corre como proceso Node.js independiente (preparado para Railway), solucionando el problema de desconexi√≥n en Vercel. La app ORVIT se comunica con el bot v√≠a HTTP API con autenticaci√≥n. Toda la funcionalidad existente (DMs, reportar fallas por voz, crear tareas, notificaciones a canales) se mantiene intacta. Listo para deploy.

### üìä Estado del proyecto hoy
| M√≥dulo | Estado | Nota |
|--------|--------|------|
| Ventas ‚Äî Liquidaciones | ‚úÖ Redise√±o completo | Split layout detalle, HoverCard lista, wizard mejorado |
| Ventas ‚Äî Resumen vendedor | ‚úÖ Completo | API + p√°gina con charts + CSV |
| Ventas ‚Äî Desglose costos | ‚úÖ Completo | DB + backend + frontend |
| N√≥minas | ‚úÖ Correcto | Bug de acceso resuelto |
| UX ‚Äî mensajes de carga | ‚úÖ Completo | ~42 mensajes contextualizados |
| Infraestructura | ‚úÖ Completo | Sin duplicados, naming consistente |
| Discord Bot ‚Äî Standalone | ‚úÖ C√≥digo listo | Falta deploy en Railway + testing e2e |

---

## üõ†Ô∏è LOG T√âCNICO *(para desarrollo / Claude Code)*

### Session Overview
- **Date**: 2026-02-21
- **Focus Area**: Resoluci√≥n de m√≥dulos duplicados ingl√©s/espa√±ol, consistencia de nombres

### What Was Done

#### Completed
- [x] `app/maintenance/checklist-print/` ‚Üí movido a `app/mantenimiento/checklist-print/`, carpeta `app/maintenance/` eliminada
- [x] URLs `/maintenance/checklist-print/` actualizadas ‚Üí `/mantenimiento/checklist-print/` en 2 componentes
- [x] `components/production/` (8 archivos) ‚Üí movidos a `components/produccion/`, imports actualizados en 5 p√°ginas + 1 componente interno
- [x] `lib/validation/` (3 archivos) ‚Üí mergeados en `lib/validations/`, carpeta eliminada (0 imports externos)
- [x] `hooks/maintenance/` ‚Üí renombrado a `hooks/mantenimiento/`, todos los imports actualizados globalmente
- [x] `hooks/production/` ‚Üí renombrado a `hooks/produccion/`, todos los imports actualizados globalmente
- [x] 4 hooks en `useCamelCase` ‚Üí renombrados a `use-kebab-case`
- [x] `components/users/` ‚Üí renombrado a `components/usuarios/`, import actualizado
- [x] `CLAUDE.md` actualizado: ruta checklist-print corregida

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/app/maintenance/` | deleted | Contenido movido a app/mantenimiento/ |
| `orvit-v1/app/mantenimiento/checklist-print/` | created | Moved from app/maintenance/ |
| `orvit-v1/components/maintenance/ChecklistExecutionTableDialog.tsx` | modified | URL /maintenance ‚Üí /mantenimiento |
| `orvit-v1/components/maintenance/ChecklistHistoryTab.tsx` | modified | URL /maintenance ‚Üí /mantenimiento |
| `orvit-v1/components/production/` | deleted | 8 archivos movidos a components/produccion/ |
| `orvit-v1/components/produccion/*.tsx` (8 archivos) | created | Moved from components/production/ |
| `orvit-v1/app/produccion/` (5 p√°ginas) | modified | Imports ‚Üí @/components/produccion |
| `orvit-v1/components/produccion/EmployeeDashboard.tsx` | modified | Import interno corregido |
| `orvit-v1/lib/validation/` | deleted | 3 archivos mergeados en lib/validations/ |
| `orvit-v1/lib/validations/` (3 archivos nuevos) | created | Moved from lib/validation/ |
| `orvit-v1/hooks/maintenance/` | deleted | Renamed to hooks/mantenimiento/ |
| `orvit-v1/hooks/mantenimiento/` | created | Renamed from hooks/maintenance/ |
| `orvit-v1/hooks/production/` | deleted | Renamed to hooks/produccion/ |
| `orvit-v1/hooks/produccion/` | created | Renamed from hooks/production/ |
| `orvit-v1/hooks/useAdminDashboardSummary.ts` | deleted | ‚Üí use-admin-dashboard-summary.ts |
| `orvit-v1/hooks/use-admin-dashboard-summary.ts` | created | kebab-case rename, 7 imports actualizados |
| `orvit-v1/hooks/useAssistant.ts` | deleted | ‚Üí use-assistant.ts (0 imports) |
| `orvit-v1/hooks/useFileDelete.ts` | deleted | ‚Üí use-file-delete.ts (0 imports) |
| `orvit-v1/hooks/useLogoUpload.ts` | deleted | ‚Üí use-logo-upload.ts (0 imports) |
| `orvit-v1/components/users/` | deleted | Renamed to components/usuarios/ |
| `orvit-v1/components/usuarios/` | created | Renamed from components/users/ |
| `orvit-v1/app/administracion/usuarios/page.tsx` | modified | Import ‚Üí @/components/usuarios |
| `orvit-v1/CLAUDE.md` | modified | checklist-print path + permissions legacy note |
| `/Users/martinrusso10/Orvit/.claude/settings.json` | modified | Agregados permisos Write/Edit para daily-logs/ |

### Decisions Made
- **Decision**: No renombrar `lib/payroll/` ni `lib/nominas/` ‚Äî **Reason**: Son dos APIs distintas activas. payroll sirve `app/api/payroll/`, nominas sirve `app/api/nominas/`.
- **Decision**: No renombrar rutas de URL como `/login`, `/api`, `/ai` ‚Äî **Reason**: Convenciones universales o requerimientos del framework. Costo > beneficio.

### Issues Encountered
- **Issue**: Settings de permisos para daily-logs en lugar incorrecto ‚Äî el archivo estaba en `Orvit/.claude/settings.json` pero Claude Code lee desde `/Users/martinrusso10/Orvit/.claude/settings.json`.
  **Resolution**: Agregados permisos en el settings.json correcto.

### Skills Used
- Ninguno (sesi√≥n de limpieza estructural)

#### Completado (tarde de sesi√≥n)
- [x] Eliminados archivos temp recurrentes: `CUsersUsuarioDesktopMawirtemp_files.txt`, `Ctemp_datefns_files.txt`
- [x] Eliminada `.bolt/` ‚Äî metadatos de Bolt.new scaffolding sin utilidad
- [x] Eliminada `__tests__/` ‚Äî ning√∫n vitest config la referenciaba, tests nunca corr√≠an

### Next Session
- [ ] Retomar desarrollo de funcionalidades
- [ ] Investigar `migrate-checklists-to-table.js` faltante (referenciado en 3 npm scripts)
- [ ] Verificar que el proyecto buildea correctamente tras todos los cambios estructurales

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Sesi√≥n tarde/noche

### Session Overview
- **Date**: 2026-02-21 (segunda sesi√≥n)
- **Focus Area**: Bug fixes en cotizaciones + loading messages contextuales (auditor√≠a completa)

### What Was Done

#### Completed
- [x] Bug fix: `kpis?.tasaAceptacion.toFixed()` fallaba ‚Äî la API retorna `{valor, variacion, tendencia}`, no un n√∫mero. Corregido en `useMemo` extrayendo `.valor` para cada KPI.
- [x] Bug fix: `Objects are not valid as a React child` ‚Äî `kpis.total` / `kpis.montoTotal` / `kpis.tasaAceptacion` eran objetos pasados directamente al JSX. Corregido extrayendo `.valor` en el mismo `useMemo`.
- [x] Auditor√≠a de 228 instancias de mensajes de carga en toda la app ‚Äî ~170 ya eran espec√≠ficos, ~42 gen√©ricos actualizados, ~17 en categor√≠as excluidas (botones, select placeholders, default props).
- [x] Loading messages actualizados: 5 archivos de rutas/layouts, 26 pages de app/, 21+ components (compras, maintenance, work-orders, costos, maquinas, ventas, pa√±ol, configuracion, produccion, etc.)

#### Excluidos intencionalmente
- Texto en `<Button disabled>` con spinner (estado de procesamiento, no de carga de datos)
- `<SelectItem value="loading" disabled>` en dropdowns
- `<SelectValue placeholder>` en selects
- Default `message='Cargando...'` en `components/ui/loading-state.tsx`

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/app/administracion/ventas/cotizaciones/page.tsx` | modified | Bug fix: useMemo extrae .valor; Number() wrapper para toFixed |
| `orvit-v1/app/administracion/loading.tsx` | modified | "Cargando administraci√≥n..." |
| `orvit-v1/app/produccion/loading.tsx` | modified | "Cargando producci√≥n..." |
| `orvit-v1/app/mantenimiento/loading.tsx` | modified | "Cargando mantenimiento..." |
| `orvit-v1/app/administracion/layout.tsx` | modified | "Cargando administraci√≥n..." |
| `orvit-v1/app/maquinas/layout.tsx` | modified | "Cargando m√°quinas..." |
| `orvit-v1/app/administracion/agenda/page.tsx` | modified | "Cargando agenda..." |
| `orvit-v1/app/administracion/ventas/clientes/page.tsx` | modified | "Cargando clientes..." |
| `orvit-v1/app/administracion/ventas/productos/page.tsx` | modified | "Cargando productos..." |
| `orvit-v1/app/administracion/ventas/aprobacion-pagos/page.tsx` | modified | "Cargando aprobaciones..." |
| `orvit-v1/app/administracion/costos/page.tsx` | modified | "Cargando costos..." |
| `orvit-v1/app/administracion/costos/empleados/page.tsx` | modified | "Cargando empleados..." |
| `orvit-v1/app/administracion/compras/centros-costo/page.tsx` | modified | "Cargando centros de costo..." |
| `orvit-v1/app/administracion/compras/match/page.tsx` | modified | "Cargando comprobantes..." |
| `orvit-v1/app/administracion/compras/proyectos/page.tsx` | modified | "Cargando proyectos..." |
| `orvit-v1/app/administracion/compras/notas-credito-debito/page.tsx` | modified | "Cargando notas de cr√©dito/d√©bito..." |
| `orvit-v1/app/administracion/compras/comprobantes/carga-masiva/page.tsx` | modified | "Cargando art√≠culos del proveedor..." |
| `orvit-v1/app/administracion/controles/page.tsx` | modified | "Cargando controles...", "Cargando empresa..." |
| `orvit-v1/app/produccion/ordenes/nueva/page.tsx` | modified | "Cargando datos del pedido..." |
| `orvit-v1/app/mantenimiento/garantias/page.tsx` | modified | "Cargando garant√≠as..." |
| `orvit-v1/app/mantenimiento/contratistas/page.tsx` | modified | "Cargando contratistas..." |
| `orvit-v1/app/mantenimiento/lubricacion/page.tsx` | modified | "Cargando puntos de lubricaci√≥n...", "Cargando registros de lubricaci√≥n..." |
| `orvit-v1/app/mantenimiento/calibracion/page.tsx` | modified | "Cargando calibraciones..." |
| `orvit-v1/app/mantenimiento/puntos-medicion/page.tsx` | modified | "Cargando puntos de medici√≥n..." |
| `orvit-v1/app/mantenimiento/ideas/page.tsx` | modified | "Cargando ideas..." |
| `orvit-v1/app/mantenimiento/monitoreo/page.tsx` | modified | "Cargando monitoreo..." |
| `orvit-v1/app/panol/lotes/page.tsx` | modified | "Cargando lotes..." |
| `orvit-v1/app/empresas/page.tsx` | modified | "Cargando empresas..." |
| `orvit-v1/app/qr/[code]/page.tsx` | modified | "Cargando informaci√≥n del equipo..." |
| `orvit-v1/app/tracking/[numero]/page.tsx` | modified | "Cargando seguimiento..." |
| `orvit-v1/components/ventas/cotizaciones-dashboard.tsx` | modified | "Cargando cotizaciones..." |
| `orvit-v1/components/recetas/Recetas.tsx` | modified | "Cargando recetas..." |
| `orvit-v1/components/maquinas/MachineDetailDialog.tsx` | modified | "Cargando m√°quina..." |
| `orvit-v1/components/unidades-moviles/UnitDetailSheet.tsx` | modified | "Cargando unidad m√≥vil..." |
| `orvit-v1/components/work-stations/WorkstationDetailSheet.tsx` | modified | "Cargando puesto de trabajo..." |
| `orvit-v1/components/maintenance/WorkStationDetailModal.tsx` | modified | "Cargando puesto de trabajo..." |
| `orvit-v1/components/maintenance/ManualServiceCompletionDialog.tsx` | modified | "Cargando servicio..." |
| `orvit-v1/components/maintenance/ChecklistHistoryTab.tsx` | modified | "Cargando historial..." |
| `orvit-v1/components/maintenance/EnhancedMaintenancePanel.tsx` | modified | 4 instancias: plan, historial, repuestos, documentos |
| `orvit-v1/components/configuracion/CostDistributionMatrix.tsx` | modified | "Cargando distribuci√≥n de costos..." |
| `orvit-v1/components/configuracion/EmployeeCostDistributionMatrix.tsx` | modified | "Cargando distribuci√≥n de costos..." |
| `orvit-v1/components/costos/CostVersionToggle.tsx` | modified | "Cargando versiones..." |
| `orvit-v1/components/skills/UserSkillAssignDialog.tsx` | modified | "Cargando habilidades..." |
| `orvit-v1/components/produccion/input-item-linker.tsx` | modified | "Cargando insumos..." |
| `orvit-v1/components/feedback/FeedbackModal.tsx` | modified | "Cargando destinatarios..." |
| `orvit-v1/components/dashboard/MonthSelectorCompact.tsx` | modified | "Cargando meses..." |
| `orvit-v1/components/tax-control/TaxControlModal.tsx` | modified | "Cargando impuestos..." |
| `orvit-v1/components/panol/MovementDialog.tsx` | modified | "Cargando art√≠culos..." |
| `orvit-v1/components/compras/crear-oc-modal.tsx` | modified | "Cargando art√≠culos..." |
| `orvit-v1/components/compras/orden-compra-form-modal.tsx` | modified | "Cargando art√≠culos de la OC..." |
| `orvit-v1/components/compras/relaciones-documento-modal.tsx` | modified | "Cargando documentos relacionados..." |
| `orvit-v1/components/compras/recepcion-detalle-modal.tsx` | modified | "Cargando recepci√≥n..." |
| `orvit-v1/components/compras/urgent-payments-section.tsx` | modified | "Cargando pagos urgentes..." |
| `orvit-v1/components/compras/pedido-compra-detail-modal.tsx` | modified | "Cargando pedido de compra..." |
| `orvit-v1/components/compras/comprobante-form-modal.tsx` | modified | "Cargando devoluciones..." |
| `orvit-v1/components/compras/proveedor-cuenta-corriente.tsx` | modified | "Cargando cuenta corriente..." |
| `orvit-v1/components/compras/cargar-remito-desde-factura-modal.tsx` | modified | "Cargando factura..." |
| `orvit-v1/components/work-orders/PreventiveMaintenanceDialog.tsx` | modified | "Cargando componentes...", "Cargando subcomponentes...", "Cargando herramientas...", "Cargando repuestos..." |
| `orvit-v1/components/maintenance/preventive/PreventivoCalendarioView.tsx` | modified | Import `@/hooks/maintenance` ‚Üí `@/hooks/mantenimiento` (build error fix) |
| `orvit-v1/components/maintenance/preventive/PreventivoChecklistsView.tsx` | modified | Import `@/hooks/maintenance` ‚Üí `@/hooks/mantenimiento` (build error fix) |
| `orvit-v1/components/maintenance/preventive/PreventivoHoyView.tsx` | modified | Import `@/hooks/maintenance` ‚Üí `@/hooks/mantenimiento` (build error fix) |
| `orvit-v1/components/maintenance/EnhancedMaintenancePanel.tsx` | modified | Import `@/hooks/maintenance` ‚Üí `@/hooks/mantenimiento` (build error fix) |
| `orvit-v1/components/maquinas/MachineDetailDialog.tsx` | modified | Import `@/hooks/maintenance` ‚Üí `@/hooks/mantenimiento` (build error fix) |

### Decisions Made
- **Decision**: No cambiar `Cargando...` en `<Button disabled>` ‚Äî **Reason**: Son estados de acci√≥n (submit), no de carga de datos. Es convenci√≥n UX est√°ndar.
- **Decision**: No cambiar `<SelectItem value="loading" disabled>Cargando...</SelectItem>` ‚Äî **Reason**: Son opciones de dropdown de UI, no mensajes de p√°gina.
- **Decision**: No cambiar default `message='Cargando...'` en `loading-state.tsx` ‚Äî **Reason**: Es un fallback intencional; todas las instancias ya pasan `message=` con texto espec√≠fico.

### Issues Encountered
- **Issue**: `Edit: File has not been read yet` ‚Äî los reads de turns anteriores no persisten entre context compressions.
  **Resolution**: Siempre leer y editar en el mismo turn.
- **Issue**: Indentaci√≥n de 1 espacio en `ChecklistHistoryTab.tsx` y `EnhancedMaintenancePanel.tsx` hac√≠a fallar el Edit tool.
  **Resolution**: Scripts Python con reemplazo por n√∫mero de l√≠nea.
- **Issue**: Build error `Module not found: Can't resolve '@/hooks/maintenance'` en 5 archivos ‚Äî la carpeta fue renombrada a `hooks/mantenimiento/` en sesi√≥n anterior pero 5 imports quedaron sin actualizar.
  **Resolution**: Corregidos los 5 imports en `PreventivoCalendarioView`, `PreventivoChecklistsView`, `PreventivoHoyView`, `EnhancedMaintenancePanel`, `MachineDetailDialog`.

### Skills Used
- `orvit-frontend` ‚Äî referenciado para convenciones de mensajes de loading en componentes shadcn/ui

### Next Session
- [ ] Desarrollo de funcionalidades nuevas
- [ ] Investigar `migrate-checklists-to-table.js` faltante
- [ ] Verificar build completo

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Sesi√≥n Features (Desglose + Liquidaciones)

### Session Overview
- **Date**: 2026-02-21 (tercera sesi√≥n)
- **Focus Area**: Feature 1 (cost breakdown), Feature 2 (seller summary), Feature 3 (liquidations system)

### What Was Done

#### Prisma Schema (Phase 1 ‚Äî done in prior session)
- `LiquidacionStatus` enum, `QuoteItemCostBreakdown`, `SaleItemCostBreakdown`, `SellerLiquidacion`, `SellerLiquidacionItem` models
- Relations added to `QuoteItem`, `SaleItem`, `Sale`, `User`, `Company`
- `prisma validate` and `prisma generate` successful

#### Backend APIs Created/Modified
| File | Action |
|------|--------|
| `lib/ventas/validation-schemas.ts` | Added `costBreakdownItemSchema`, liquidation schemas |
| `lib/ventas/auth.ts` | 7 new permissions (LIQUIDACIONES_*, VENDEDORES_RESUMEN) |
| `lib/ventas/document-number.ts` | Added LIQ type + `generateLiquidacionNumber()` |
| `api/ventas/cotizaciones/route.ts` | POST: create breakdowns per item + sum validation |
| `api/ventas/cotizaciones/[id]/route.ts` | GET/PUT: include/update breakdowns |
| `api/ventas/cotizaciones/[id]/convertir/route.ts` | Copy breakdowns to SaleItemCostBreakdown |
| `api/ventas/cotizaciones/[id]/duplicar/route.ts` | Copy breakdowns on duplicate |
| `api/ventas/vendedores/[id]/resumen/route.ts` | **NEW** ‚Äî Full seller summary API |
| `api/ventas/liquidaciones/route.ts` | **NEW** ‚Äî GET list + POST create |
| `api/ventas/liquidaciones/[id]/route.ts` | **NEW** ‚Äî GET detail + PATCH + DELETE |
| `api/ventas/liquidaciones/[id]/action/route.ts` | **NEW** ‚Äî State machine (confirmar/pagar/anular) |
| `api/ventas/liquidaciones/[id]/pdf/route.ts` | **NEW** ‚Äî PDF generation |
| `api/ventas/liquidaciones/ventas-disponibles/route.ts` | **NEW** ‚Äî Available sales for liquidation |
| `api/ventas/liquidaciones/stats/route.ts` | **NEW** ‚Äî Global liquidation KPIs |
| `lib/ventas/pdf/liquidacion-pdf-generator.ts` | **NEW** ‚Äî jsPDF generator with tables + breakdowns |

#### Frontend Components Created
| Component | Description |
|-----------|-------------|
| `components/ventas/cost-breakdown-editor.tsx` | Inline editor per item (done prior session) |
| `components/ventas/quote-cost-composition.tsx` | Aggregated BarChart (done prior session) |
| `components/ventas/seller-kpi-cards.tsx` | 5 gradient KPI cards |
| `components/ventas/seller-evolution-chart.tsx` | AreaChart (ventas + comisiones, 6 months) |
| `components/ventas/seller-funnel-chart.tsx` | PieChart donut (quotation states) |
| `components/ventas/seller-detail-tables.tsx` | Tabbed tables with expandable rows + mini donuts |
| `components/ventas/liquidacion-status-badge.tsx` | Colored badge per state |
| `components/ventas/liquidacion-timeline.tsx` | Visual timeline (created ‚Üí confirmed ‚Üí paid) |

#### Frontend Pages Created
| Page | Description |
|------|-------------|
| `app/administracion/ventas/vendedores/[id]/page.tsx` | Seller summary with KPIs + charts + tables + CSV export |
| `app/administracion/ventas/liquidaciones/page.tsx` | Liquidation list with stat cards + filters + pagination |
| `app/administracion/ventas/liquidaciones/nueva/page.tsx` | 3-step wizard (vendor ‚Üí select sales ‚Üí confirm) |
| `app/administracion/ventas/liquidaciones/[id]/page.tsx` | Detail with timeline + expandable items + cost composition + actions |

#### Integration
| File | Action |
|------|--------|
| `components/layout/Sidebar.tsx` | Added "Liquidaciones" link (Receipt icon) |
| `app/administracion/ventas/page.tsx` | Added alert for pending liquidations + useEffect fetch |
| `app/administracion/ventas/vendedores/page.tsx` | Added "Ver resumen" (Eye) button per vendor |

### Build Status
- Build errors are all **pre-existing** (compras/facturas/procesar-ia, maquinas HealthScoreBadge/QRCodeGenerator, work-stations InstructiveDialog) ‚Äî none from our changes
- TypeScript check on our files: 0 errors

### Migration & Seed Data (sesi√≥n continuaci√≥n)

#### Migration Applied
- SQL migration aplicada via Node.js `pg` client
- Fixed FK: `"users"` ‚Üí `"User"`, `"companies"` ‚Üí `"Company"`
- 4 tablas + 1 enum creados exitosamente

#### Seed Data (`scripts/seed-liquidaciones.js`)
- 3 Sales Reps, 18 sales con comisi√≥n, 5 sales reasignadas
- 51 quote breakdowns, 201 sale breakdowns
- 4 liquidaciones (PAGADA, CONFIRMADA, BORRADOR, ANULADA) con 21 items

### Next Session
- [ ] Testing end-to-end en browser
- [ ] Sparklines en tabla de vendedores (opcional)

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Bug fixes de consola

### Session Overview
- **Date**: 2026-02-21 (cuarta sesi√≥n)
- **Focus Area**: 3 errores detectados en consola del browser

### What Was Done

#### Completed
- [x] **manifest.json Syntax error**: Middleware interceptaba `/manifest.json` con `token` ausente y redirig√≠a a `/login` (HTML). Browser intentaba parsear HTML como JSON del manifest ‚Üí syntax error. Fix: agregar `manifest.json` e `icons/` a las exclusiones del matcher en `middleware.ts`.
- [x] **401 en `/api/nominas/empleados/bulk`**: `getUserFromToken()` devuelve el nombre del rol de empresa (puede ser un nombre custom). `hasPayrollAccess()` llama a `isAdminRole()` que solo acepta `SUPERADMIN`, `ADMIN`, `ADMIN_ENTERPRISE`. Usuario con rol de empresa custom fallaba aunque tuviera `User.role = ADMIN` en el sistema. Fix: `getPayrollAuth()` ahora hace query a `User.role` directamente (sistema), no el rol de empresa. Afecta todos los endpoints de n√≥minas.
- [x] **500 en `/api/areas`**: Error transitorio durante Fast Refresh. El server se reiniciaba y el request lleg√≥ en medio del rebuild. No es un bug de c√≥digo ‚Äî confirmado.

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/middleware.ts` | modified | Matcher excluye `manifest.json` e `icons/` ‚Äî evita interceptar archivos p√∫blicos est√°ticos |
| `orvit-v1/lib/nominas/auth-helper.ts` | modified | `getPayrollAuth()` usa `User.role` del sistema v√≠a prisma query, no el nombre de rol de empresa |

### Decisions Made
- **Decision**: No cambiar `getUserFromToken()` ‚Äî **Reason**: La funci√≥n tiene uso amplio en toda la app. El fix aislado en `getPayrollAuth()` es m√°s seguro.
- **Decision**: No cambiar `isAdminRole()` ‚Äî **Reason**: Es correcto que solo acepte roles de sistema. El problema era que se le pasaba el nombre de un rol custom.

### Issues Encountered
- **Issue**: `manifest.json` syntax error parec√≠a ser un JSON inv√°lido, pero Python confirm√≥ que el JSON es v√°lido. El problema era upstream (middleware retornando HTML).
  **Resolution**: Exclusi√≥n del matcher en middleware.ts.
- **Issue**: El 401 en nominas afecta TODOS los endpoints de n√≥minas, no solo `/bulk` ‚Äî cualquier usuario con rol de empresa custom no pod√≠a usar n√≥minas en absoluto.
  **Resolution**: Fix centralizado en `getPayrollAuth()` ‚Äî se propaga a todos los endpoints autom√°ticamente.

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî 3 Features Cotizaciones (Sesi√≥n Continuaci√≥n)

### Session Overview
- **Date**: 2026-02-21 (quinta sesi√≥n ‚Äî continuaci√≥n de sesi√≥n anterior)
- **Focus Area**: Feature 1 (Step 2 wizard redise√±o), Feature 2 (cotizaci√≥n A/B), Feature 3 (bundle items)

### What Was Done

#### Bug Fixes
- [x] `fecha` ‚Üí `fechaEmision` en m√∫ltiples API routes y componentes (campo correcto del modelo `Sale`)
  - `api/ventas/liquidaciones/ventas-disponibles/route.ts`
  - `api/ventas/liquidaciones/route.ts`
  - `api/ventas/liquidaciones/[id]/route.ts`
  - `api/ventas/vendedores/[id]/resumen/route.ts`
  - `components/ventas/seller-detail-tables.tsx`

#### Feature 1 ‚Äî Step 2 Wizard Redise√±o
- [x] Redise√±o completo de `app/administracion/ventas/liquidaciones/nueva/page.tsx` Step 2
- [x] Split layout (sidebar w-72 + documento flex-1, height 600px)
- [x] Sidebar: filtro por cliente, stats row, lista scrollable con highlight del activo
- [x] Documento: cabecera con ‚Üê N/M ‚Üí navegaci√≥n, toggle "Incluida/No incluida", header completo con numero + cliente + fecha + total, tabla de items con breakdown chips, totals block, barra de cobranza

#### Feature 2 ‚Äî Cotizaci√≥n A/B (discriminarIva)
- [x] Schema: `discriminarIva Boolean @default(false)` agregado a `Quote` y `Sale`
- [x] DB migration: `ALTER TABLE quotes/sales ADD COLUMN discriminarIva`
- [x] `prisma generate` ‚Äî client regenerado
- [x] `lib/ventas/validation-schemas.ts` ‚Äî `discriminarIva: z.boolean().default(false)` en `createQuotationSchema`
- [x] `api/ventas/cotizaciones/route.ts` POST ‚Äî c√°lculo IVA condicional
- [x] `api/ventas/cotizaciones/[id]/route.ts` PUT ‚Äî `usarDiscriminarIva` + c√°lculo
- [x] `api/ventas/cotizaciones/[id]/convertir/route.ts` ‚Äî copia `discriminarIva` a Sale
- [x] `components/ventas/cotizacion-detail-sheet.tsx` ‚Äî l√≠nea IVA condicional + "IVA incluido en precios"
- [x] `components/ventas/quote-editor-modal.tsx` ‚Äî toggle A/B (Tipo B = default, Tipo A = discriminado)

#### Feature 3 ‚Äî Bundle Items
- [x] Schema: `ProductBundle` + `ProductBundleComponent` models en `prisma/schema.prisma`
- [x] Back-relations en `User`, `Company`, `Product`
- [x] DB: tablas `product_bundles` + `product_bundle_components` creadas
- [x] `prisma generate` ‚Äî client regenerado
- [x] `app/api/ventas/bundles/route.ts` ‚Äî GET (listar) + POST (crear) bundles
- [x] `app/api/ventas/bundles/[id]/route.ts` ‚Äî GET + PATCH + DELETE (soft)
- [x] `components/ventas/bundle-builder-dialog.tsx` ‚Äî **NUEVO** Dialog para armar item combinado:
  - Selector de plantilla guardada (desde `/api/ventas/bundles`)
  - Nombre del item
  - Filas de componentes (producto opcional + concepto + monto)
  - Total auto-calculado
  - Checkbox "Guardar como plantilla" ‚Üí POST `/api/ventas/bundles`
  - `onAdd(BundleResult)` callback para el parent
- [x] `components/ventas/quote-quick-modal.tsx` ‚Äî integraci√≥n bundle builder:
  - `QuoteItem.productId` ‚Üí `string | null`
  - Nuevos campos `isBundle?`, `costBreakdown?`
  - `handleBundleAdd()` handler
  - Bot√≥n "Combinar productos" (Layers icon)
  - `handleSubmit` incluye `descripcion` y `costBreakdown` en API call
  - Tabla de items: bundle items muestran Layers icon + chips de componentes
  - `BundleBuilderDialog` montado al final del componente

### Files Modified/Created
| File | Action | Feature |
|------|--------|---------|
| `api/ventas/liquidaciones/ventas-disponibles/route.ts` | modified | Bug fix |
| `api/ventas/liquidaciones/route.ts` | modified | Bug fix |
| `api/ventas/liquidaciones/[id]/route.ts` | modified | Bug fix |
| `api/ventas/vendedores/[id]/resumen/route.ts` | modified | Bug fix |
| `components/ventas/seller-detail-tables.tsx` | modified | Bug fix |
| `app/administracion/ventas/liquidaciones/nueva/page.tsx` | modified | Feature 1 |
| `prisma/schema.prisma` | modified | Feature 2 + 3 |
| `lib/ventas/validation-schemas.ts` | modified | Feature 2 |
| `api/ventas/cotizaciones/route.ts` | modified | Feature 2 |
| `api/ventas/cotizaciones/[id]/route.ts` | modified | Feature 2 |
| `api/ventas/cotizaciones/[id]/convertir/route.ts` | modified | Feature 2 |
| `components/ventas/cotizacion-detail-sheet.tsx` | modified | Feature 2 |
| `components/ventas/quote-editor-modal.tsx` | modified | Feature 2 |
| `app/api/ventas/bundles/route.ts` | **created** | Feature 3 |
| `app/api/ventas/bundles/[id]/route.ts` | **created** | Feature 3 |
| `components/ventas/bundle-builder-dialog.tsx` | **created** | Feature 3 |
| `components/ventas/quote-quick-modal.tsx` | modified | Feature 3 |

### Resumen Ejecutivo (para agregar al m√≥dulo Ventas)
- **Step 2 liquidaciones redise√±ado**: vista profesional de cotizaci√≥n con panel izquierdo (lista filtrable) y panel derecho (documento completo con items, totales y estado de cobranza). Navegaci√≥n por flechas.
- **Cotizaci√≥n Tipo A/B**: Tipo B = IVA incluido en precio (default). Tipo A = IVA discriminado (se agrega el 21% sobre el subtotal y se muestra separado). El tipo se conserva al convertir a venta.
- **Bundle de items**: en la cotizaci√≥n r√°pida, el bot√≥n "Combinar productos" abre un builder donde se combinan productos individuales en un solo item con desglose de componentes. Se puede guardar como plantilla reutilizable para futuras cotizaciones.
- **Facturas en wizard liquidaciones**: al revisar una OV en el Step 2, se ven las facturas asociadas (n√∫mero, monto, estado, saldo pendiente). Si no hay facturas, indica claramente.
- **Wizard Step 2 ‚Äî layout mejorado**: ancho completo (`max-w-none`), panel split din√°mico (`calc(100vh - 340px)`), sidebar con KPIs de 2 columnas, borde izquierdo activo en lista, layout plano sin Card (V0 style).

### TypeScript
- 0 errores en archivos modificados (verificado con tsc --noEmit --skipLibCheck)

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Facturas en wizard liquidaciones (Sesi√≥n 6)

### Session Overview
- **Date**: 2026-02-21 (sexta sesi√≥n)
- **Focus Area**: Mostrar facturas relacionadas dentro del wizard de liquidaciones (Step 2)

### What Was Done

#### Completed
- [x] `VentaDisponible` interface ‚Äî agregado campo `invoices: InvoiceRef[]` (el API ya retornaba los datos, solo faltaba el tipo)
- [x] Nuevo tipo `InvoiceRef` con `id, numeroCompleto, estado, total, saldoPendiente`
- [x] `INVOICE_ESTADO_COLORS` ‚Äî mapa de colores para badge de estado de factura (BORRADOR/EMITIDA/COBRADA/ANULADA)
- [x] Badge de estado en header del documento (OV estado como outline badge junto al label "Orden de Venta")
- [x] Secci√≥n **Facturas** en el documento del Step 2, reemplazando el bloque de cobranza anterior:
  - Si hay facturas: lista de cards con icono FileText + n√∫mero + total + badge de estado + saldo pendiente si > 0
  - Barra de cobranza integrada debajo (% cobrado + alerta saldo pendiente)
  - Si no hay facturas: card punteado "Sin facturas emitidas para esta orden"
- [x] TypeScript: 0 errores tras los cambios

### Files Modified
| File | Action |
|------|--------|
| `app/administracion/ventas/liquidaciones/nueva/page.tsx` | Added InvoiceRef interface, INVOICE_ESTADO_COLORS, invoices display in Step 2 document |

### Resumen Ejecutivo
- **Facturas en wizard de liquidaciones**: en el Step 2 del wizard, al ver el documento de una OV, ahora se muestra la secci√≥n de facturas asociadas con n√∫mero, monto, estado y saldo pendiente. Si no tiene facturas a√∫n, muestra un indicador claro.

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Extracci√≥n Discord Bot a Servicio Standalone (Sesi√≥n 7)

### Session Overview
- **Date**: 2026-02-21 (s√©ptima sesi√≥n ‚Äî continuaci√≥n de sesi√≥n larga con 3 context compactions)
- **Focus Area**: Extraer Discord bot de Next.js a servicio standalone Node.js para Railway

### Problema Original
El bot de Discord (`discord.js`) corr√≠a dentro del proceso Next.js en Vercel v√≠a `instrumentation.ts`. Vercel es serverless y mata instancias inactivas, cortando la conexi√≥n WebSocket del bot. El bot quedaba offline intermitentemente, perd√≠a DMs e interacciones.

### Arquitectura Nueva
```
ORVIT App (Vercel) ‚îÄ‚îÄHTTP POST‚îÄ‚îÄ‚Üí Bot Service (Railway) ‚îÄ‚îÄWebSocket‚îÄ‚îÄ‚Üí Discord
                                       ‚Üë
Discord Users ‚îÄ‚îÄDMs/Interactions‚îÄ‚îÄ‚Üí Bot Service ‚îÄ‚îÄPrisma‚îÄ‚îÄ‚Üí Misma Supabase DB
```

### What Was Done (Fases 1-5 completas)

#### Fase 1 ‚Äî Scaffold `discord-bot/` (completada)
- [x] Creado `/Users/martinrusso10/Orvit/Orvit/discord-bot/` como proyecto standalone
- [x] `package.json` con deps: discord.js, @prisma/client, express, openai, date-fns, tsx
- [x] `tsconfig.json` ‚Äî target ES2022, imports relativos (sin @/ aliases)
- [x] Symlink `prisma/schema.prisma` ‚Üí `../orvit-v1/prisma/schema.prisma`
- [x] `src/lib/prisma.ts` ‚Äî singleton sin globalThis hack

#### Fase 2 ‚Äî Migrar c√≥digo del bot (completada)
- [x] `src/bot/client.ts` ‚Äî discord.js client con imports est√°ticos (sin webpackIgnore)
- [x] `src/bot/listeners.ts` ‚Äî messageCreate + interactionCreate extra√≠dos
- [x] `src/handlers/failure-voice-handler.ts` ‚Äî handler de fallas por voz
- [x] `src/handlers/voice-handler.ts` ‚Äî handler de compras por voz
- [x] `src/handlers/task-handler.ts` ‚Äî handler de tareas + getUserPendingTasks + formatTasksEmbed
- [x] `src/discord/` ‚Äî voice-session, failure-voice-queue, voice-queue, machine-matcher, component-matcher, discord-components
- [x] `src/services/` ‚Äî notifications, agenda-notifications, permissions-sync
- [x] `src/ai/` ‚Äî failure-extractor, purchase-extractor, config, types
- [x] `src/lib/corrective/priority-calculator.ts` ‚Äî copiado

#### Fase 3 ‚Äî HTTP API Express (completada)
- [x] `src/http-server.ts` ‚Äî Express con auth middleware (x-api-key)
- [x] Endpoints: `/health`, `/api/status`, `/api/send-dm`, `/api/send-channel`, `/api/send-notification`, `/api/send-bulk-dm`, `/api/manage-channels`, `/api/sync-permissions`, `/api/check-channel-access`, `/api/guild-operations`
- [x] `src/index.ts` ‚Äî entry point: conecta bot + levanta HTTP server

#### Fase 4a ‚Äî Actualizar lib/discord en ORVIT (completada)
- [x] `lib/discord/bot-service-client.ts` ‚Äî **NUEVO** HTTP client con callBotService(), sendDMViaBotService(), sendDMByDiscordIdViaBotService(), sendToChannelViaBotService(), sendNotificationViaBotService(), getBotServiceStatus(), manageBotChannels(), syncBotPermissions(), checkChannelAccessViaBotService(), guildOperationsViaBotService()
- [x] `lib/discord/notifications.ts` ‚Äî eliminados todos los isBotReady()/sendToChannel()/ensureBotConnected() ‚Üí reemplazados con bot-service-client
- [x] `lib/discord/agenda-notifications.ts` ‚Äî sendDM() ‚Üí sendDMByDiscordIdViaBotService()
- [x] `lib/discord/permissions-sync.ts` ‚Äî reescrito completo, usa syncBotPermissions() y callBotService()
- [x] `lib/discord/index.ts` ‚Äî re-exports de bot-service-client (no de bot.ts)
- [x] `instrumentation-node.ts` ‚Äî no-op (bot corre en Railway)

#### Fase 4b ‚Äî Actualizar API routes y crons (completada)
- [x] 10 API routes de Discord admin actualizadas en 2 batches paralelos:
  - Batch 1: bot/connect, bot/guilds, bot/members, bot/send-dm, bot/create-sector-channels
  - Batch 2: bot/make-private, bot/make-all-private, test-notifications, users/test-dm, cron/discord-day-start
- [x] 3 crons actualizados: agenda-due-soon, agenda-reminders, tasks/check-overdue
- [x] sync-from-discord ‚Äî reescrito con checkChannelAccessViaBotService()
- [x] users/link ‚Äî reescrito con guildOperationsViaBotService()
- [x] scripts/setup/setup-discord-permissions.ts ‚Äî reescrito

#### Fase 5 ‚Äî Verificaci√≥n de compilaci√≥n (completada)
- [x] discord-bot: `npm install` + `prisma generate` + `tsc --noEmit`
  - Errores resueltos: copiar types.ts, priority-calculator.ts, implementar getUserPendingTasks/formatTasksEmbed
  - Errores restantes: pre-existentes (Buffer/BlobPart, Prisma relation types) ‚Äî no bloquean tsx runtime
- [x] orvit-v1: `tsc --noEmit --skipLibCheck` ‚Äî **0 errores en archivos de discord/instrumentation**
  - √önicos errores: pre-existentes en vincular-recepcion-modal.tsx (JSX mal cerrado)
- [x] Verificado: 0 imports del viejo `@/lib/discord/bot` en toda la app

### Files Created (discord-bot/)
| File | Description |
|------|-------------|
| `discord-bot/package.json` | Dependencias del servicio |
| `discord-bot/tsconfig.json` | Config TS sin @/ aliases |
| `discord-bot/.env.example` | Variables de entorno requeridas |
| `discord-bot/src/index.ts` | Entry point |
| `discord-bot/src/http-server.ts` | Express API (11 endpoints) |
| `discord-bot/src/lib/prisma.ts` | Singleton Prisma |
| `discord-bot/src/bot/client.ts` | Discord.js client |
| `discord-bot/src/bot/listeners.ts` | Event handlers |
| `discord-bot/src/handlers/failure-voice-handler.ts` | Handler fallas |
| `discord-bot/src/handlers/voice-handler.ts` | Handler compras |
| `discord-bot/src/handlers/task-handler.ts` | Handler tareas |
| `discord-bot/src/discord/*.ts` | 6 archivos utilidades Discord |
| `discord-bot/src/services/*.ts` | 3 archivos servicios |
| `discord-bot/src/ai/*.ts` | 4 archivos IA |
| `discord-bot/src/lib/corrective/priority-calculator.ts` | C√°lculo prioridad |

### Files Modified (orvit-v1/)
| File | Action |
|------|--------|
| `lib/discord/bot-service-client.ts` | **NUEVO** ‚Äî HTTP client al bot service |
| `lib/discord/notifications.ts` | Eliminados 8 isBotReady(), reemplazados sendToChannel() |
| `lib/discord/agenda-notifications.ts` | sendDM ‚Üí sendDMByDiscordIdViaBotService |
| `lib/discord/permissions-sync.ts` | Reescrito completo |
| `lib/discord/index.ts` | Re-exports de bot-service-client |
| `instrumentation-node.ts` | No-op |
| `app/api/discord/bot/connect/route.ts` | Proxy a bot service |
| `app/api/discord/bot/guilds/route.ts` | Proxy a bot service |
| `app/api/discord/bot/members/route.ts` | Proxy a bot service |
| `app/api/discord/bot/send-dm/route.ts` | Proxy a bot service |
| `app/api/discord/bot/create-sector-channels/route.ts` | Proxy a bot service |
| `app/api/discord/bot/make-private/route.ts` | Proxy a bot service |
| `app/api/discord/bot/make-all-private/route.ts` | Proxy a bot service |
| `app/api/discord/test-notifications/route.ts` | Proxy a bot service |
| `app/api/discord/users/test-dm/route.ts` | Proxy a bot service |
| `app/api/discord/users/link/route.ts` | Reescrito con guildOperationsViaBotService |
| `app/api/discord/sync-from-discord/route.ts` | Reescrito con checkChannelAccessViaBotService |
| `app/api/cron/discord-day-start/route.ts` | Removido connectBot, usa bot-service-client |
| `app/api/cron/agenda-due-soon/route.ts` | Removido connectBot/isBotReady |
| `app/api/cron/agenda-reminders/route.ts` | Removido connectBot/isBotReady |
| `app/api/tasks/check-overdue/route.ts` | Removido isBotReady guard |
| `scripts/setup/setup-discord-permissions.ts` | Reescrito |

### Resumen Ejecutivo (para agregar al m√≥dulo General)
- **Bot de Discord extra√≠do a servicio standalone**: el bot de Discord ahora corre como proceso independiente (preparado para Railway), solucionando el problema de desconexi√≥n en Vercel. ORVIT se comunica con el bot v√≠a HTTP API. Toda la funcionalidad existente (DMs, fallas por voz, tareas, notificaciones) se mantiene. Cero imports del c√≥digo viejo permanecen en la app.

### Next Session
- [ ] Deploy del bot service en Railway (configurar env vars, health check)
- [ ] Crear endpoint `/api/webhooks/bot-callback/route.ts` para reemplazar instant-notifications en task-handler
- [ ] Limpieza: eliminar archivos de ORVIT que ahora viven en discord-bot (bot.ts, voice-session.ts, handlers, etc.)
- [ ] Eliminar dependencia `discord.js` de orvit-v1/package.json (~13MB menos)
- [ ] Testing end-to-end: DMs, fallas por voz, notificaciones, crons
- [ ] Agregar env vars en Vercel: BOT_SERVICE_URL, BOT_API_KEY

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Facturas seed + Overhaul frontend liquidaciones (Sesi√≥n 8)

### Session Overview
- **Date**: 2026-02-21 (octava sesi√≥n ‚Äî continuaci√≥n)
- **Focus Area**: Cargar facturas de ejemplo en OVs seed + redise√±o completo de lista y detalle de liquidaciones

### What Was Done

#### Completed
- [x] **Script seed de facturas** (`scripts/seed-invoices.js` + `scripts/fix-and-seed-invoices.js`)
  - Se detect√≥ que las 10 facturas existentes en DB no estaban vinculadas a ninguna venta (`saleId = NULL`)
  - Se detect√≥ un FK stale: `sales_invoices_saleId_fkey` ‚Üí `"Sale"` (tabla vac√≠a del modelo viejo)
  - Fix: `ALTER TABLE sales_invoices DROP CONSTRAINT "sales_invoices_saleId_fkey"` (hay otra FK nueva hacia `sales` que s√≠ funciona)
  - 18 facturas creadas para los 18 OVs de las liquidaciones seed (IDs 10‚Äì27)
  - COBRADA (9): las de liquidaci√≥n PAGADA ‚Äî LIQ-2025-00001
  - EMITIDA (5): OVs en liquidaci√≥n CONFIRMADA (10, 12, 20, 22, 24)
  - PARCIALMENTE_COBRADA (4): OVs en liquidaci√≥n CONFIRMADA (11, 13, 21, 23) ‚Äî 50% cobrado
  - Numeraci√≥n: FC-B 00001-00000003 a FC-B 00001-00000020

- [x] **Overhaul lista de liquidaciones** (`app/administracion/ventas/liquidaciones/page.tsx`)
  - KPI cards: V0 style (icon en c√≠rculo con opacidad 15%, sin gradient hardcodeado)
  - Toolbar con clear button (X) en b√∫squeda y bot√≥n "Limpiar filtros" contextual
  - Tabla: header con √≠cono + total count, avatar inicial del vendedor, periodo con formato "dd MMM ‚Äì dd MMM yy", badge monoespacio para cantidad de ventas, flecha ArrowUpRight en hover, empty state V0 (icono en c√≠rculo + CTA)
  - Paginaci√≥n integrada al pie de la Card (sin card separado)

- [x] **Overhaul detalle de liquidaci√≥n** (`app/administracion/ventas/liquidaciones/[id]/page.tsx`)
  - Info bar: pills con N√∫mero, Vendedor, Periodo, Ventas (nuevo)
  - KPI cards: icons en c√≠rculo, "A Pagar" con borde emerald (highlight visual)
  - Timeline en card con header muted
  - Tabla items: invoice badges coloreados por estado (igual que wizard), breakdown chips con color-coded pills, summary footer con separators
  - Cost composition: Separator entre leyenda + total
  - Dropdown acciones: √≠cono coloreado (CheckCircle verde, Wallet verde, XCircle destructivo) + separator antes de Anular
  - Ajustes: muestra "‚Äî" si es 0, rojo si negativo, verde si positivo

### Files Created
| File | Description |
|------|-------------|
| `scripts/seed-invoices.js` | Script seed original (base) |
| `scripts/fix-and-seed-invoices.js` | Fix FK stale + seed 18 facturas linked a OVs |
| `scripts/check-tables.js` | Utilidad de diagn√≥stico de tablas + FKs |
| `scripts/check-sale-client.js` | Utilidad de diagn√≥stico de clientId en sales |

### Files Modified
| File | Action |
|------|--------|
| `app/administracion/ventas/liquidaciones/page.tsx` | Overhaul completo V0 style |
| `app/administracion/ventas/liquidaciones/[id]/page.tsx` | Overhaul completo V0 style |

### Issues Encountered
- **Issue**: `Node_TLS_REJECT_UNAUTHORIZED` ‚Äî pg falla con SSL en Node 25 sin `ssl: { rejectUnauthorized: false }`
  **Resolution**: Agregar tanto `ssl` en client config como `NODE_TLS_REJECT_UNAUTHORIZED=0` en el comando
- **Issue**: pg devuelve column names en camelCase cuando se usan quoted identifiers (`"clientId"` ‚Üí `clientId`)
  **Resolution**: usar `sale.clientId` no `sale.clientid`
- **Issue**: FK stale `sales_invoices_saleId_fkey` ‚Üí `"Sale"` vac√≠a bloqueaba INSERT
  **Resolution**: DROP CONSTRAINT + verificar FK nueva activa

### Resumen Ejecutivo (para agregar a Ventas)
- **Facturas de ejemplo cargadas**: 18 facturas vinculadas a los OVs de las liquidaciones seed (COBRADA para liquidaci√≥n PAGADA, mixtas para CONFIRMADA). Se pueden ver en el wizard Step 2 de nueva liquidaci√≥n.
- **Lista de liquidaciones redise√±ada**: KPIs V0 (iconos en c√≠rculo), toolbar con clear button y "limpiar filtros", tabla con avatar de vendedor, formato de periodo corto, badge de ventas y flecha de navegaci√≥n en hover. Empty state V0 con CTA.
- **Detalle de liquidaci√≥n redise√±ado**: info bar con pills de metadata, KPI "A Pagar" destacado con borde emerald, badges de facturas coloreados por estado, breakdown chips coloreados, summary footer calculado, acciones con iconos de color.

### Skills Used
- `orvit-frontend` ‚Äî V0 style: KPI cards, empty state, toolbar con clear X, no inline CSS, cn(), Lucide

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Redise√±o profundo wizard Nueva Liquidaci√≥n (Sesi√≥n 9)

### Session Overview
- **Date**: 2026-02-21 (novena sesi√≥n ‚Äî continuaci√≥n)
- **Focus Area**: Redise√±o completo de los 3 pasos del wizard `/nueva` con estilo denso (toda la info visible sin clicks)

### What Was Done

#### Completed
- [x] **Plan aprobado**: redise√±o de los 3 pasos del wizard con 10 subtareas
- [x] **Step 1 ‚Äî Vendedor y Periodo**: dividido en 3 cards separados (Vendedor / Periodo / Comisi√≥n)
  - Mini-profile card al seleccionar vendedor (avatar inicial, email, comisi√≥n base)
  - Botones de atajo de fecha: "√öltimo mes" / "√öltimos 3 meses" / "Este a√±o" (calcula fechaDesde + fechaHasta)
  - Card de Comisi√≥n: input centrado grande, bot√≥n "Restaurar (X%)" si se cambi√≥ del valor base
- [x] **Step 2 ‚Äî Seleccionar Ventas**: mejoras de UX e informaci√≥n
  - Sort dropdown (6 opciones: Fecha‚Üë/‚Üì, Monto‚Üì/‚Üë, Cliente A-Z, Cobranza) debajo del buscador
  - Mini barra de cobranza debajo de cada OV card en el sidebar (visible solo si tiene facturas)
  - Header del documento: 3 mini-stats (Total OV / Comisi√≥n X% / N¬∞ Facturas) en lugar de Separator
  - Tabla de items: `<tfoot>` con Total en lugar de div separado
- [x] **Step 3 ‚Äî Resumen**: reorganizado en 5 zonas
  - Zona 1: 4 KPI cards (Total Ventas / Comisi√≥n / Ajustes con input inline / A Pagar con borde emerald)
  - Zona 2: Cobranza global (bar + 3 stats: Facturado / Cobrado / Saldo) ‚Äî `useMemo`, visible solo si hay facturas
  - Zona 3: Tabla completa de ventas incluidas (N¬∞ OV / Cliente / Fecha / Total / Comisi√≥n / Cobranza) + footer de totales
  - Zona 4: Alerta amber detallada ‚Äî lista cada OV con saldo pendiente (n√∫mero + cliente + saldo)
  - Zona 5: Notas textarea + acciones (Guardar Borrador / Confirmar y Guardar)

### New Imports
- `useMemo`, `ArrowUpDown`, `Mail`, `TrendingUp`, `Percent`, `BadgeDollarSign`, `Wallet`
- `DropdownMenu`, `DropdownMenuContent`, `DropdownMenuItem`, `DropdownMenuTrigger`
- `Table`, `TableBody`, `TableCell`, `TableHead`, `TableHeader`, `TableRow`

### New State
- `sortBy: SortOption` ‚Äî tipo union de 6 opciones
- `expandedInvoices: Set<string>` ‚Äî chips de facturas expandibles en Step 2
- `cobranzaGlobal` ‚Äî `useMemo` que suma totalFacturado / cobrado / saldoPendiente / pct de selectedVentas
- `sortedVentas` ‚Äî `useMemo` que filtra + ordena ventas para el sidebar

### Files Modified
| File | Action |
|------|--------|
| `app/administracion/ventas/liquidaciones/nueva/page.tsx` | Reescritura completa (2x) ‚Äî todos los 3 pasos redise√±ados |
| `app/api/ventas/liquidaciones/[id]/route.ts` | Agregados `fechaEmision: true`, `fechaVencimiento: true` en select de invoices |

### Resumen Ejecutivo (para agregar a Ventas ‚Äî Liquidaciones)
- **Wizard Nueva Liquidaci√≥n ‚Äî redise√±o profundo**: los 3 pasos ahora son densos y muestran toda la informaci√≥n sin clicks innecesarios. Step 1: mini-profile del vendedor seleccionado + atajos de fecha. Step 2: ordenamiento de OVs (6 criterios), barra de cobranza visible en cada card, documento con 3 mini-stats en header. Step 3: 4 KPIs arriba, cobranza global calculada autom√°ticamente, tabla de todas las ventas incluidas con totales, alerta detallada por venta con saldo pendiente.

### TypeScript
- El typecheck global del proyecto sale OOM (esperado en proyectos Next.js grandes). No hay errores de tipo en los archivos modificados.

---
*Log mantenido seg√∫n `.claude/rules/workflow-rules.md` Regla 1*
