# Daily Log â€” 2026-02-25

## Resumen Ejecutivo

### Sidebar â€” ReubicaciÃ³n de Favoritos y limpieza del bottom
- Favoritos movidos del top de la nav al **bottom section**, arriba de Feedback
- Estado expandido: lista compacta con Ã­cono + nombre + botÃ³n quitar (hover)
- Estado colapsado: Ã­conos individuales con tooltip, separador visual antes de Feedback
- BotÃ³n **Buscar** eliminado del sidebar (âŒ˜K sigue funcionando)
- Notificaciones se mantiene en el bottom (importante para el usuario)
- Feedback se deja por ahora, se eliminarÃ¡ en el futuro

### Mobile Bottom Bar â€” ProducciÃ³n y AdministraciÃ³n
- `/produccion/*` y `/administracion/*` ahora usan el mismo bottombar simple que `/mantenimiento/*`
- Un Ãºnico botÃ³n centrado con Ã­cono de menÃº para abrir el sidebar
- El bottombar complejo (`MobileBottomBar.tsx`) ya no aparece en producciÃ³n ni administraciÃ³n
- **Archivos modificados:**
  - `components/layout/MainLayout.tsx` â€” extendido el bloque del botÃ³n simple a `/produccion` y `/administracion`
  - `components/layout/MobileBottomBar.tsx` â€” agregados `/produccion` y `/administracion` a la lista de exclusiÃ³n

### Comprobante Form â€” Fixes crÃ­ticos (sesiÃ³n 2, cont. de ayer)
- `hasPermission()` crash: `ROLE_PERMISSIONS["Administrador"]` â†’ `undefined` â†’ `.includes()` lanzaba TypeError. Fix: `ROLE_PERMISSIONS[role] ?? []` con guard
- `systemRole` propagation: login API + `/api/auth/me` ahora retornan `systemRole: user.role` (rol del sistema, no de empresa). AuthContext almacena `systemRole`. `UserEditDialog` usa `currentUser.systemRole || currentUser.role` para `hasPermission`
- Lucas Russo y Mariano Russo (Pretensados CÃ³rdoba): `systemRole` actualizado de `USER` â†’ `ADMIN_ENTERPRISE` en DB vÃ­a Prisma Studio
- Webpack chunk corruption (3 veces): borrar `.next` + reiniciar dev server. Causa: modificar archivos grandes como `permissions.ts` o `Sidebar.tsx` invalida chunk IDs

### AlmacÃ©n â€” Mejoras Inventario completas (sesiÃ³n 9)
- **Bug crÃ­tico fix**: `userId: 1` hardcodeado reemplazado con `useAuth()` real en SolicitudesTab, DespachosTab y DevolucionesTab (4 instancias en 3 archivos)
- **Mobile cards** en todos los tabs del AlmacÃ©n: SolicitudesTab, DespachosTab, DevolucionesTab, InventarioTab, KardexTab y ReservasTab â€” vista dual `md:hidden` / `hidden md:block`
- **Date range filter** en KardexTab: inputs "Desde / Hasta" con botÃ³n clear, pasan `dateFrom/dateTo` a los filtros de la query
- **CSV export** en InventarioTab, KardexTab y SolicitudesTab: botÃ³n `Download` en toolbar, usa `downloadCSV` de `lib/cargas/utils`
- **Detail Sheet** en InventarioTab: click en fila abre Sheet lateral con stock actual/disponible/reservado, reorden, criticidad, ubicaciÃ³n y botÃ³n despacho rÃ¡pido
- **QR Label printing** conectado en `/panol`: reemplazados 3 `toast.info('QR prÃ³ximamente')` con `ToolQRLabel` usando `DialogTrigger asChild` dentro del DropdownMenuItem
- **Build**: âœ… sin errores TypeScript en archivos modificados

### PaÃ±ol â€” MigraciÃ³n completa TanStack Query v5 + Mobile responsive
- **Las 3 pÃ¡ginas restantes** del paÃ±ol migradas de `useState+useEffect+fetch` â†’ TanStack Query v5: **forecast**, **repuestos** y **dashboard**
- Las 9 pÃ¡ginas del mÃ³dulo paÃ±ol ahora usan TanStack Query con cache automÃ¡tico y staleTime configurado (2-3 min segÃºn la pÃ¡gina)
- **Vista dual mobile/desktop** agregada en forecast y repuestos: cards compactas en mobile (`md:hidden`), tablas en desktop (`hidden md:block`)
- **Forecast mobile**: cards con grid 3-col (Stock/Necesidad/Pedir) + badge de prioridad por color
- **Repuestos mobile**: cards clickeables que abren detalle, con botÃ³n editar + menÃº dropdown inline, sort y CSV export ocultos en mobile
- `console.error` eliminados de repuestos y dashboard (solo queda el legÃ­timo en `error.tsx`)
- **Build exitoso** â€” `next build` sin errores TypeScript

### Agenda â€” Mobile overhaul completo (sesiÃ³n 6)
- `AgendaPage.tsx`: padding `px-6` â†’ `px-3 sm:px-6`
- `AgendaPage.tsx`: header responsive â€” tÃ­tulo `text-xl sm:text-2xl`, subtÃ­tulo `hidden sm:block`, botÃ³n Discord `hidden sm:flex`, "Nueva Tarea" â†’ Ã­cono solo en mobile con `<span className="hidden sm:inline">`
- `AgendaPage.tsx`: Sidebar Grupos â†’ wrapper `hidden sm:block flex-shrink-0` (oculto en mobile)
- `AgendaPage.tsx`: Sidebar Personas â†’ `hidden sm:flex` en Card (oculto en mobile, content Ã¡rea toma 100% del ancho)
- `AgendaPage.tsx`: Toolbar â€” search `min-w-0 sm:min-w-[200px]`, Origin/Status/Priority/Refresh â†’ `hidden sm:block` wrappers
- `AgendaPage.tsx`: Mobile quickfilters row (`flex sm:hidden`) â€” Select para Grupos + Select para Persona, justo debajo del toolbar
- `AgendaKPICards.tsx`: "Top Asignados" card â†’ `col-span-2 md:col-span-1` (ocupa fila completa en mobile, 1/5 en desktop)
- `AgendaKPICards.tsx`: grid `gap-4` â†’ `gap-3 md:gap-4`

### Discord â€” NotificaciÃ³n automÃ¡tica de cambio de estado de mÃ¡quina
- Cuando una mÃ¡quina pasa a **Fuera de servicio** o **En mantenimiento**, se envÃ­a notificaciÃ³n automÃ¡tica al canal de Discord del sector
- La notificaciÃ³n incluye: estado anterior, estado nuevo, nombre de la mÃ¡quina y quiÃ©n hizo el cambio
- No afecta la operaciÃ³n normal: si Discord falla, el cambio de estado se completa igual

### Unidades MÃ³viles â€” Audit + Security fixes (sesiÃ³n 21)

**Audit completo: 8 issues encontrados y corregidos**

#### ðŸ”´ CrÃ­ticos (security / multi-tenancy breach)
- **C1** `GET|PUT|DELETE /[id]`: Sin `companyId` en WHERE â†’ cross-tenant data leak. Fix: `findFirst` con `companyId = payload.companyId` del JWT
- **C2** `GET list + POST`: `companyId` del cliente en vez del JWT. Fix: `payload.companyId as number`
- **C3** `batch PUT|DELETE`: `updateMany/deleteMany` sin `companyId`. Fix: `{ id: { in: ids }, companyId }` en WHERE
- **C4** `/api/maintenance/unidad-movil` GET+POST: Sin ningÃºn `verifyToken`. Fix: auth completo con cookies + verifyToken en ambos handlers

#### ðŸŸ  Medios
- **M1** `export`: `companyId` del query param. Fix: `payload.companyId`
- **M2** `kilometraje GET+POST`: `findUnique({ id })` sin company scope. Fix: `findFirst({ id, companyId })`

#### ðŸŸ¡ Bajos
- **B1** batch schemas: sin `.max(50)` â†’ DoS. Fix: lÃ­mite de 50 IDs por operaciÃ³n
- **B2** `useUnitsFilters`: chip de sector mostraba ID. Fix: campo `sectorName?` + `filters.sectorName || filters.sectorId`

### Ideas â€” Audit fixes Opus (sesiÃ³n 20)
- **O1** `DELETE /api/ideas/[id]`: Admin bypass implementado â€” admins (ADMIN/SUPERADMIN/ADMIN_ENTERPRISE) ahora pueden eliminar cualquier idea, no solo el creador. DB lookup de `systemRole`
- **O2** `PUT /api/ideas/[id]`: ValidaciÃ³n de `category` y `priority` en update â€” antes aceptaba valores arbitrarios sin validar contra los enums permitidos
- **O3** `GET /api/ideas/[id]/comment`: Order cambiado de `desc` â†’ `asc` para consistencia con el detalle de idea (B3 del Sonnet)
- **O4** `POST /api/ideas/[id]/vote`: Toggle + count envueltos en `$transaction` atÃ³mico â€” elimina race condition en el conteo de votos
- **O5** `POST /api/ideas/[id]/comment`: LÃ­mite de 2000 caracteres en contenido de comentarios
- **O6** `POST /api/ideas/[id]/vote`: Query de verificaciÃ³n de idea usa `select: { id: true }` en vez de fetch completo

### Ideas â€” Audit fixes Sonnet (sesiÃ³n 19)
- **C1** `PUT /api/ideas/[id]/status`: Implementado guard de roles â€” solo ADMIN/SUPERADMIN/ADMIN_ENTERPRISE pueden cambiar estado. DB lookup de `systemRole` del actor antes de proceder
- **C2** `PUT /api/ideas/[id]`: Empty `if` block completado â€” retorna 403 para no-creadores
- **C3** `GET /api/ideas/[id]`: Raw `votes` array removido de la respuesta (destructuring `{ votes, ...rest }`); solo se exponen `voteCount` y `hasVoted`
- **M1** `GET /api/ideas/[id]`: Agrega `commentCount` al response del detalle
- **M3** `page.tsx`: Vote mutation `onSuccess` ahora invalida tambiÃ©n `['idea', ideaId]` (detail query)
- **M5** `page.tsx`: Delete button en `IdeaCard` solo visible para el creador de la idea (`idea.createdById === currentUserId`). `useAuth()` agregado al page
- **M8** `POST /api/ideas`: ValidaciÃ³n de `priority` contra enum `['LOW','MEDIUM','HIGH','CRITICAL']`
- **B1** `page.tsx`: Import `Star` eliminado (no usado)
- **B2** `GET /api/ideas/stats`: Queries `topVoted` y `recentIdeas` eliminadas del `Promise.all` y del response (no se usaban en UI)
- **B3** `GET /api/ideas/[id]`: Comments `orderBy: desc` â†’ `asc` (orden cronolÃ³gico)

### Conteo FÃ­sico â€” Sonnet fixes + Opus persistence (sesiÃ³n 18)
- **Sonnet fixes (S1-S5)**: Tipo movimiento corregido a ADJUSTMENT, permisos `usePanolPermissions`, sanitizaciÃ³n NaN/negativos, dead code eliminado, tracking per-item de Ã©xito
- **Opus O1**: Persistencia completa de sesiones de conteo â€” nuevos modelos Prisma (`StockCountSession`, `StockCountItem`), 4 API endpoints, UI refactorizada con auto-save debounced, reanudaciÃ³n de sesiones e historial de conteos pasados

### Preventivo â€” PDF + Auto-reschedule + Split Dialog (sesiones 12-13)
- **Bulk actions** en HoyView y PlanesView: modo selecciÃ³n, select-all, Eliminar/Activar/Desactivar bulk
- **PDF export**: botÃ³n `Download` en toolbar de HoyView y PlanesView â€” genera PDF landscape A4 con jspdf + autoTable
- **Auto-reschedule**: `POST /api/maintenance/preventive/reschedule-overdue` â€” reprograma instancias vencidas a hoy; botÃ³n "Reprogramar vencidos" en KPI card de Vencidos (solo visible cuando hay vencidos)
- **Split `PreventiveMaintenanceDialog.tsx`**: 2868 â†’ 1842 lÃ­neas (âˆ’36%); 6 step components extraÃ­dos a `components/work-orders/preventive-steps/`: EquipmentStep, GeneralStep, ToolsStep, InstructivesStep, ScheduleStep, SummaryStep + `types.ts`; 25 imports limpiados; 0 errores TypeScript

---

## Log TÃ©cnico

### Archivos modificados hoy
- `components/layout/Sidebar.tsx` â€” favoritos al bottom, Buscar eliminado
- `components/layout/MainLayout.tsx` â€” mobile bottom simple para produccion + administracion
- `components/layout/MobileBottomBar.tsx` â€” excluir produccion + administracion

### Ideas â€” Redesign completo (sesiÃ³n 3)
- PÃ¡gina reescrita desde 0 con estilo V0/Vercel
- Header: Ã­cono + tÃ­tulo + botÃ³n shrink compacto
- KPI cards: componente `KpiCard` con Ã­cono en cÃ­rculo coloreado, 2Ã—2 mobile â†’ 4 desktop
- `CATEGORY_CONFIG`: nuevo sistema de colores con `iconBg`, `iconText`, `accent` por categorÃ­a
- `STATUS_CONFIG`: status pills con dot coloreado + variante clara/oscura (sin dependencia de clases semÃ¡nticas del proyecto)
- `IdeaCard`: barra de acento izquierda por categorÃ­a, chip de categorÃ­a, status pill, tÃ­tulo, descripciÃ³n, footer con avatar + votes + comments. 3-dot menu solo visible en hover
- Filtros: h-8 compactos + botÃ³n "Limpiar" cuando hay filtros activos
- `CreateIdeaDialog`: labels uppercase tracking, `resize-none`, Ã­cono en header, botÃ³n con `Sparkles`
- `IdeaDetailDialog`: usa `size="md"`, `DialogBody`, layout de meta info clean, notas de revisiÃ³n/implementaciÃ³n con colores amber/green, comments con empty state

### Puestos de Trabajo â€” Mobile improvements (sesiÃ³n 4)

- `WorkstationsToolbar.tsx`: filtros mobile-only â€” search full-width, estado `flex-1`, instructivos/mÃ¡quinas/sort ocultos en mobile con `hidden sm:block`
- `WorkstationsToolbar.tsx`: Sheet "Filtros" ahora siempre visible en mobile (antes condicionado a `availableSectores.length > 1`). SheetBody incluye los 3 filtros ocultos en mobile + sector si corresponde
- `WorkstationsToolbar.tsx`: botÃ³n "+" icon-only para mobile (`sm:hidden`), desktop mantiene texto "Nuevo Puesto" (`hidden sm:inline-flex`)
- `WorkstationsToolbar.tsx`: filter bar `h-10` â†’ `sm:h-10`, permite wrap en mobile
- `page.tsx`: "Ocultar resumen" â†’ `hidden sm:inline-flex` (secundario en mobile)
- `page.tsx`: bulk actions bar â†’ `flex-wrap gap-2` (evita overflow en mobile)

### WorkOrders â€” Filter bar mobile (sesiÃ³n 5)

- `WorkOrdersFiltersBar.tsx`: eliminado `flex-wrap` del contenedor principal â†’ una sola lÃ­nea en mobile
- `WorkOrdersFiltersBar.tsx`: search â†’ `min-w-0 sm:min-w-[200px]` (flex-1 sin ancho mÃ­nimo en mobile)
- `WorkOrdersFiltersBar.tsx`: Estado, Prioridad, Responsable, MÃ¡quina, Ordenar â†’ `hidden sm:block` (solo desktop)
- `WorkOrdersFiltersBar.tsx`: separador vertical â†’ `hidden sm:block`; "MÃ¡s filtros" visible siempre
- `WorkOrdersFiltersBar.tsx`: pasa `availableUsers` a `WorkOrdersAdvancedFiltersSheet`
- `WorkOrdersAdvancedFiltersSheet.tsx`: nueva prop `availableUsers`; agrega secciones `sm:hidden` para Estado, Prioridad, Responsable al top del sheet
- `WorkOrdersAdvancedFiltersSheet.tsx`: `handleReset` ahora tambiÃ©n resetea status/priority/assignee

### Archivos modificados (sesiÃ³n 5)
- `components/work-orders/WorkOrdersFiltersBar.tsx`
- `components/work-orders/WorkOrdersAdvancedFiltersSheet.tsx`

### Archivos modificados (sesiÃ³n 4)
- `components/work-stations/WorkstationsToolbar.tsx`
- `app/mantenimiento/puestos-trabajo/page.tsx`

### Archivos modificados (sesiÃ³n 3)
- `app/mantenimiento/ideas/page.tsx` â€” reescritura completa

### Archivos modificados (sesiÃ³n 2 cont.)
- `lib/permissions.ts` â€” `hasPermission` guard `?? []` + eliminados console.log debug
- `app/api/auth/login/route.ts` â€” `systemRole: user.role` en respuesta
- `app/api/auth/me/route.ts` â€” `systemRole: user.role` en respuesta
- `contexts/AuthContext.tsx` â€” campo `systemRole?: string` + seteo en login y refreshUser
- `components/usuarios/UserEditDialog.tsx` â€” usa `systemRole` para `hasPermission`

### Trampas encontradas
- `ROLE_PERMISSIONS` estÃ¡ keyed por `UserRole` enum del sistema, NO por nombre de rol de empresa. Nunca pasar `"Administrador"` â€” pasar `systemRole`
- Webpack chunk corruption: sucede al modificar archivos grandes; fix siempre es `rm -rf .next` + restart

### AgendaV2 â€” Synchro-style Board (sesiÃ³n 6)

**Nuevos archivos creados** (12 archivos, build OK â€” sin errores TS):
- `app/administracion/agendav2/page.tsx`
- `components/agendav2/AgendaV2Page.tsx` â€” contenedor principal, topbar, view switcher
- `components/agendav2/BoardView.tsx` â€” kanban con DnD (DndContext, DragOverlay)
- `components/agendav2/BoardColumn.tsx` â€” columna con header icon + inline add
- `components/agendav2/TaskCard.tsx` â€” card exacta Synchro: group name, date, title, progress, avatars, counts
- `components/agendav2/TaskCalendarStrip.tsx` â€” timeline semanal (7 dÃ­as, navegable, TODAY marker)
- `components/agendav2/TaskDetailPanel.tsx` â€” Sheet lateral con Tabs: Subtareas/Comentarios/Actividades
- `components/agendav2/SubtaskList.tsx` â€” lista con drag handles + inline add + progress bar
- `components/agendav2/InboxView.tsx` â€” split layout lista+detalle, crossfade al cambiar Ã­tem
- `components/agendav2/DashboardView.tsx` â€” KPI cards + BarChart (recharts) + Today tasks + Activity feed
- `components/agendav2/CreateTaskModal.tsx` â€” dialog crear tarea (title, desc, priority, status, dueDate, category)
- `components/agendav2/index.ts`

**Stack usado**: dnd-kit, recharts, date-fns/es, TanStack Query, shadcn/ui Sheet+Tabs+Dialog
**No se instalÃ³ nada nuevo** â€” todo existÃ­a en package.json
**Build**: `â—‹ /administracion/agendav2 â€” 17.6 kB | 378 kB` âœ“

**Data**: Usa `/api/agenda/tasks` y `/api/agenda/stats` existentes. Subtasks/Comments/Activities usan mock data (estructura real disponible en Prisma pero no expuesta en la API de agenda).

### AgendaV2 â€” RediseÃ±o visual completo Synchro (sesiÃ³n 7)

**Archivos modificados** (rediseÃ±o visual, sin cambios a lÃ³gica):
- `AgendaV2Sidebar.tsx` â€” w-[220px], bg-zinc-50, avatar h-10, botÃ³n dark rounded-xl, nav items con rounded-xl, Favoritos con Star icon, spacing generoso
- `TaskCard.tsx` â€” bg-white rounded-2xl border-zinc-100 shadow-sm on hover, priority dot en header, progress bar por status (teal para IN_PROGRESS), avatars stacked, counts con iconos
- `BoardColumn.tsx` â€” headers con colored pill badge por status (teal="En Progreso", amber="En RevisiÃ³n", etc.), drop zone bg-zinc-50, empty state con dashed border + click-to-add
- `TaskCalendarStrip.tsx` â€” TODAY marker: cÃ­rculo teal con nÃºmero blanco + lÃ­nea debajo, status pills de colores por estado, bg-white rounded-2xl
- `TaskDetailPanel.tsx` â€” Sheet restyle: header con Ã­cono cuadrado gris + title + chips status/prioridad, adjuntos como pills con tipo, tabs con border-teal-500 active, footer con Cancel/Save buttons, comments con bubble chat style
- `InboxView.tsx` â€” avatar con dot rojo para unread, Bookmark icon, status chip en detalle, attachments pills, bubble comments, activity feed
- `DashboardView.tsx` â€” Quick Actions row (4 cards), KPI cards con trend badge, Mapa de Actividad (recharts BarChart agrupado por hora), Milestone Tracker con 2 barras (Meta/Real), Team section, Upcoming Meetings cards
- `AgendaV2Page.tsx` â€” bg-zinc-50/50, topbar border-zinc-100 bg-white/80, altura h-[calc(100vh-4rem)]

**Build**: `â—‹ /administracion/agendav2 â€” 26.6 kB | 382 kB` âœ“ (sin errores TS en agendav2)

**Paleta Synchro aplicada**: zinc-50 sidebar, white cards, zinc-100 borders, teal-400/500 accent, rounded-2xl en cards/modals, rounded-xl en buttons/pills

### Bridge Compras â†” PaÃ±ol â€” Fases 4 y 5

**Fase 4 â€” UI para vincular SupplierItem â†” Tool:**
- `GET /api/tools/search` â€” endpoint liviano para comboboxes (`?q=texto&itemType=&limit=20`)
- APIs SupplierItem modificadas: GET incluye `tool`, POST/PUT aceptan `toolId`
- API Pedidos POST: pasa `toolId/componentId/machineId` en items
- 3 comboboxes reutilizables: `ToolSearchCombobox`, `MachineSearchCombobox`, `ComponentSearchCombobox`
- PÃ¡gina proveedor: columna "PaÃ±ol" en tabla de items + Dialog vincular + campo toolId en modal "Agregar Item"
- PedidoCompra form: secciÃ³n colapsable "Â¿Para quÃ© equipo?" con 3 comboboxes

**Fase 5 â€” Dashboard "Activos en Campo vs PaÃ±ol":**
- `GET /api/panol/field-vs-storage` â€” calcula in-storage (InventoryLot AVAILABLE) vs in-field (LotInstallation active) vs needed (ComponentTool)
- SecciÃ³n en `/panol/dashboard`: 4 mini KPIs + barras horizontales apiladas top 6 spare parts + leyenda

**Archivos creados:**
- `app/api/tools/search/route.ts`
- `components/panol/ToolSearchCombobox.tsx`
- `components/compras/MachineSearchCombobox.tsx`
- `components/compras/ComponentSearchCombobox.tsx`
- `app/api/panol/field-vs-storage/route.ts`

**Archivos modificados:**
- `app/api/compras/proveedores/[id]/items/route.ts` â€” GET include tool, POST acepta toolId
- `app/api/compras/proveedores/[id]/items/[itemId]/route.ts` â€” PUT acepta toolId
- `app/api/compras/pedidos/route.ts` â€” items con toolId/componentId/machineId
- `app/administracion/compras/proveedores/[id]/page.tsx` â€” columna PaÃ±ol + dialogs
- `components/compras/pedido-compra-form-modal.tsx` â€” secciÃ³n contexto equipo
- `app/panol/dashboard/page.tsx` â€” secciÃ³n Campo vs PaÃ±ol

**Build**: âœ… sin errores TypeScript

### PaÃ±ol â€” MigraciÃ³n TanStack Query + Mobile (sesiÃ³n 8)

**Migraciones a TanStack Query v5** (eliminado `useState+useEffect+fetch` â†’ `useQuery`):
- `forecast/page.tsx` â€” `queryKey: ['panol','forecast', days, includeHistory]`, staleTime 3min
- `repuestos/page.tsx` â€” `queryKey: ['panol','repuestos', companyId]`, staleTime 3min, CRUD usa `invalidateQueries`
- `dashboard/page.tsx` â€” `queryKey: ['panol','dashboard', companyId]`, staleTime 2min, Promise.all dentro de queryFn

**Mobile responsive (dual-view cards/table):**
- `forecast/page.tsx` â€” Cards mobile (`md:hidden`) con grid 3-col (Stock/Necesidad/Pedir) + badge prioridad; tabla desktop (`hidden md:block`)
- `repuestos/page.tsx` â€” Cards mobile (`md:hidden`) clickeables â†’ detalle, con edit inline + dropdown; tabla desktop (`hidden md:block`). Sort y CSV export ocultos en mobile (`hidden sm:flex`)

**console.error limpiados**: repuestos (lÃ­nea 150), dashboard (lÃ­nea 153). Solo queda `error.tsx` (error boundary, legÃ­timo)

**Archivos modificados:**
- `app/panol/forecast/page.tsx`
- `app/panol/repuestos/page.tsx`
- `app/panol/dashboard/page.tsx`

**Build**: âœ… `next build` exitoso sin errores TypeScript

### Soluciones â€” AuditorÃ­a completa + implementaciÃ³n (sesiÃ³n 9-10)

**AuditorÃ­a realizada** con 3 agentes paralelos (rutas API, componentes frontend, integraciones).

**Fixes de seguridad (3):**
- `PUT /api/failures/[id]/solution` â€” eliminado raw SQL auth (`$queryRaw` + `JOIN UserOnCompany`), reemplazado por `verifyToken()` + company boundary check
- `GET /api/failures/[id]/solutions` â€” `(prisma as any).failureOccurrence` â†’ `prisma.failureOccurrence` (removido unsafe cast)
- `POST /api/work-orders/[id]/apply-solution` â€” removidos 2 `(prisma as any)` casts + agregado company boundary check (sesiÃ³n anterior)
- Auth agregada a `GET /api/failure-occurrences/[id]/solutions` y `GET /api/failures/[id]/solutions` (sesiÃ³n anterior)

**Features nuevas (4):**
- `PATCH /api/solutions-applied/[id]` â€” endpoint para editar soluciones (diagnosis, solution, notes, outcome, effectiveness, attachments, etc.) con auth + company boundary
- `GET /api/solutions-applied/[id]` â€” endpoint para detalle de una soluciÃ³n con includes completos
- `SolutionDetailDialog` â€” `handleSaveEdit` ahora llama API real (PATCH para SolutionApplied, PUT para legacy). BotÃ³n muestra loading state
- `SolutionDetailDialog` â€” file upload ahora sube a `/api/upload` vÃ­a FormData (S3). Era noop con toast fake
- `SolutionDetailDialog` â€” History tab renderiza `applicationHistory` embebido en la soluciÃ³n (timeline con OT, usuario, fecha, efectividad)

**MigraciÃ³n Soluciones page:**
- De `/api/work-orders?type=CORRECTIVE&status=COMPLETED` (client-side filter, sin paginaciÃ³n) â†’ `/api/solutions-applied?mode=history` (server-side search, paginaciÃ³n, filtros)
- `getSolutionHistory` ampliado: include `machine.name`, `component.name`, `subComponent.name`, `workOrder.completedDate`
- Agregado campo `search` a `SolutionHistoryParams`, Zod schema, y API route â€” bÃºsqueda full-text en diagnosis, solution, confirmedCause, failureOccurrence.title
- KPIs ahora basados en outcome (Funcionaron/Parciales/No Funcionaron) con queries independientes para totales
- Search con `useDebounce(300ms)` para evitar requests excesivos
- Mapper `mapToSolution()` convierte SolutionApplied â†’ interface Solution (SolutionCard)

**Cleanup:**
- Hook `useFailureSolutionsByWorkOrder` eliminado (dead code â€” exportado pero never imported)
- Mock data eliminado de SolutionDetailDialog (sesiÃ³n anterior): Unsplash images, w3schools videos, mock docs

**Archivos creados:**
- `app/api/solutions-applied/[id]/route.ts` (GET + PATCH)
- `app/api/solutions-applied/[id]/obsolete/route.ts` (PATCH, sesiÃ³n anterior)

**Archivos modificados:**
- `app/api/failures/[id]/solution/route.ts` â€” reescrito completo (auth segura)
- `app/api/failures/[id]/solutions/route.ts` â€” removido `(prisma as any)` cast
- `app/api/solutions-applied/route.ts` â€” agregado `search` param
- `lib/corrective/solution-history.ts` â€” `getSolutionHistory` con machine/component/subComponent includes + search filter
- `lib/corrective/validations.ts` â€” `search` en solutionHistoryParamsSchema
- `components/solutions/SolutionDetailDialog.tsx` â€” edit API real, file upload real, history tab con datos
- `app/mantenimiento/soluciones/page.tsx` â€” migrado a /api/solutions-applied con paginaciÃ³n
- `hooks/mantenimiento/use-failure-solutions.ts` â€” eliminado hook dead code

### Preventivo â€” AuditorÃ­a de seguridad + integraciones (sesiÃ³n 11)

**AuditorÃ­a realizada** con 3 agentes paralelos (rutas API, frontend, schema/integraciones). Encontrados: 10/16 rutas sin auth, 15/16 sin company boundary check, bug en instructives POST.

**Fixes de seguridad (Phase 1 â€” Opus):**

1. **Auth en `/api/maintenance/preventive/` (GET/POST)** â€” agregado `verifyToken()` + company boundary check (companyId del body/query vs token)
2. **Auth en `/api/maintenance/preventive/[id]` (GET/PUT/DELETE)** â€” agregado `verifyToken()` + company boundary check contra `template.companyId`
3. **Auth en `/api/maintenance/preventive/[id]/instructives` (GET/POST/DELETE)** â€” agregado `verifyToken()`. **Bug fix en POST**: buscaba template en tabla `Document` (siempre 404); corregido a `prisma.preventiveTemplate.findUnique()` + company boundary check
4. **Auth en `/api/maintenance/preventive/alerts`** â€” agregado `verifyToken()` + company boundary check
5. **Auth en `/api/maintenance/dashboard` y `/api/maintenance/kpis`** â€” agregado `verifyToken()` + company boundary check. Ambos eran endpoints pÃºblicos con solo `companyId` como query param
6. **CRON_SECRET en `/api/cron/preventive-scheduler`** â€” agregado check `Authorization: Bearer $CRON_SECRET` en POST y GET (health check). PatrÃ³n consistente con los otros 12+ cron endpoints

**Integraciones (Phase 2 â€” Opus):**

7. **Discord notifications conectadas:**
   - `notifyPreventiveCompleted()` llamada desde `execute/route.ts` despuÃ©s de ejecutar un preventivo (fire-and-forget con `.catch()`)
   - `notifyPreventiveReminder()` llamada desde `cron/preventive-scheduler` â€” envÃ­a recordatorios cuando `daysUntil` coincide con `alertDaysBefore` del template
   - Ambas funciones ya existÃ­an en `lib/discord/notifications.ts` pero nunca eran invocadas

8. **Health score calculator corregido:**
   - Antes: solo contaba `MaintenanceChecklist.nextDueDate` para PMs vencidos (modelo legacy)
   - DespuÃ©s: nueva funciÃ³n `countOverduePMs()` suma legacy + `PreventiveInstance` con status PENDING/OVERDUE y fecha pasada
   - Usa `template: { machineId, isActive: true }` para filtrar por mÃ¡quina correctamente

9. **Hourly rate hardcodeado eliminado:**
   - `preventive/[id]/complete/route.ts`: `averageHourlyRate = 25` â†’ `resolveHourlyRate(userId, companyId)` que busca `TechnicianCostRate` â†’ env â†’ 25 fallback. TambiÃ©n migrado auth de `jwtVerify` directo â†’ `verifyToken()`
   - `lib/maintenance-helpers.ts`: `25` â†’ `parseFloat(process.env.MAINTENANCE_HOURLY_RATE_DEFAULT || '25')` (funciÃ³n pura, no puede ser async)

**Archivos modificados:**
- `app/api/maintenance/preventive/route.ts` â€” auth + company check en GET/POST
- `app/api/maintenance/preventive/[id]/route.ts` â€” auth + company check en GET/PUT/DELETE
- `app/api/maintenance/preventive/[id]/instructives/route.ts` â€” auth + fix bug POST (Document â†’ PreventiveTemplate)
- `app/api/maintenance/preventive/alerts/route.ts` â€” auth + company check
- `app/api/maintenance/dashboard/route.ts` â€” auth + company check
- `app/api/maintenance/kpis/route.ts` â€” auth + company check
- `app/api/cron/preventive-scheduler/route.ts` â€” CRON_SECRET + Discord reminders
- `app/api/maintenance/execute/route.ts` â€” Discord notifyPreventiveCompleted
- `app/api/maintenance/preventive/[id]/complete/route.ts` â€” resolveHourlyRate + verifyToken
- `lib/maintenance/health-score-calculator.ts` â€” countOverduePMs con PreventiveInstance
- `lib/maintenance-helpers.ts` â€” env-based hourly rate

### Preventivo â€” Bulk actions en HoyView y PlanesView (sesiÃ³n 12)

**Bulk actions en `PreventivoHoyView`:**
- BotÃ³n `CheckSquare2` en toolbar para entrar/salir de modo selecciÃ³n
- Estado interno: `selectionMode: boolean`, `selectedIds: Set<number>`
- `MaintenanceCard` extendido: `isSelected`, `onToggleSelect`, `selectionMode` â€” checkbox aparece en modo selecciÃ³n, card entera clickeable para toggle
- "Seleccionar todos (N)" + count seleccionados con limpiar
- Barra sticky bottom con "Eliminar (N)": llama `DELETE /api/maintenance/${id}` por cada seleccionado, invalida `maintenance-pending` al final
- Impostaciones: `Checkbox`, `useQueryClient`, `useToast`, `useCallback`, `CheckSquare2`

**Bulk actions en `PreventivoPlanesView`:**
- Mismo patrÃ³n de selecciÃ³n
- `PlanCard` extendido: mismas 3 props de selecciÃ³n
- Barra sticky bottom con 3 acciones:
  - **Activar**: `PUT /api/maintenance/preventive/${id}` con `{ isActive: true }`, invalida `preventive-planes`
  - **Desactivar**: igual con `{ isActive: false }`
  - **Eliminar**: `DELETE /api/maintenance/preventive/${id}`, invalida `preventive-planes`
- Imports: `useQueryClient`, `useToast`, `useCallback`, `CheckSquare2`, `Power`, `PowerOff`

**Archivos modificados:**
- `components/maintenance/preventive/PreventivoHoyView.tsx`
- `components/maintenance/preventive/PreventivoPlanesView.tsx`

### Preventivo â€” PDF export + Auto-reschedule + Split dialog (sesiÃ³n 13)

**PDF export (`lib/pdf/preventive-pdf.ts` â€” nuevo):**
- `exportPreventivePDF(items, companyName, viewTitle)` â€” landscape A4 con jspdf + jspdf-autotable
- 8 columnas: TÃ­tulo, Equipo, Prioridad, Frecuencia, DuraciÃ³n, PrÃ³xima Fecha, Responsable, DescripciÃ³n
- Maneja ambas vistas (HoyView y PlanesView) â€” misma funciÃ³n gracias al diseÃ±o flexible
- BotÃ³n `Download` en toolbar de HoyView y PlanesView, deshabilitado cuando no hay Ã­tems

**Auto-reschedule OVERDUE (`app/api/maintenance/preventive/reschedule-overdue/route.ts` â€” nuevo):**
- `POST /api/maintenance/preventive/reschedule-overdue` â€” body: `{ companyId }`
- Reprograma instancias OVERDUE o PENDING con fecha pasada â†’ `scheduledDate = today, status = PENDING`
- Filtra solo templates activos de la empresa del token (company boundary check)
- BotÃ³n "Reprogramar vencidos" en la KPI card de Vencidos (HoyView), visible solo cuando `kpis.overdue > 0`
- Handler `handleRescheduleOverdue` con toast + `invalidateQueries(['maintenance-pending'])`

**Split `PreventiveMaintenanceDialog.tsx` (2868 â†’ 1842 lÃ­neas, reducciÃ³n 36%):**
- Directorio nuevo: `components/work-orders/preventive-steps/`
- Tipos compartidos: `types.ts` â†’ `PreventiveFormData`, `ToolRequest`, `ValidationErrors`
- 6 step components extraÃ­dos del dialog:
  - `EquipmentStep.tsx` â€” mÃ¡quina, componentes, subcomponentes, SelectionSummaryChips
  - `GeneralStep.tsx` â€” tÃ­tulo, descripciÃ³n, prioridad, tÃ©cnico asignado, notas, isActive
  - `ToolsStep.tsx` â€” herramientas generales + repuestos especÃ­ficos + seleccionados
  - `InstructivesStep.tsx` â€” upload dropzone + lista de instructivos
  - `ScheduleStep.tsx` â€” fecha, frecuencia, alertas, ventana, tiempo estimado, preview 5 fechas
  - `SummaryStep.tsx` â€” resumen read-only de todo el formulario
- Imports limpiados: 25 imports eliminados del main dialog (Checkbox, DatePicker, Label, Textarea, Select, Switch, MultiSelect, SectionCard, EmptyState, ScrollArea, Separator, etc.)
- 0 errores TypeScript (validado con `npx tsc --noEmit --skipLibCheck`)

**Archivos creados:**
- `lib/pdf/preventive-pdf.ts`
- `app/api/maintenance/preventive/reschedule-overdue/route.ts`
- `components/work-orders/preventive-steps/types.ts`
- `components/work-orders/preventive-steps/EquipmentStep.tsx`
- `components/work-orders/preventive-steps/GeneralStep.tsx`
- `components/work-orders/preventive-steps/ToolsStep.tsx`
- `components/work-orders/preventive-steps/InstructivesStep.tsx`
- `components/work-orders/preventive-steps/ScheduleStep.tsx`
- `components/work-orders/preventive-steps/SummaryStep.tsx`

**Archivos modificados:**
- `components/maintenance/preventive/PreventivoHoyView.tsx` â€” PDF button + reschedule button
- `components/maintenance/preventive/PreventivoPlanesView.tsx` â€” PDF button
- `components/work-orders/PreventiveMaintenanceDialog.tsx` â€” imports step components, removes extracted JSX

### PaÃ±ol â€” AuditorÃ­a Repuestos + Movimientos (sesiones 14-15)

**Repuestos â€” Sonnet fixes:**
- `app/panol/repuestos/page.tsx`: `import { cn }` agregado (faltaba, causaba error); icono `History` agregado; dialog detalle expandido a `max-w-2xl max-h-[85vh] overflow-y-auto`; componente `SparePartMovements` inline que fetcha `/api/tools/movements?toolId=X&companyId=Y&limit=10` y muestra mini tabla con badge coloreado por tipo
- `hooks/use-panol-permissions.ts`: permiso delete cambiado de `tools.delete` â†’ `panol.delete_product`
- `app/api/tools/route.ts`: fallback inseguro de "cualquier empresa" eliminado del GET â€” ahora retorna 400 si no hay companyId

**Repuestos â€” Opus fixes:**
- `app/api/tools/route.ts`: POST reescrito con Zod `CreateToolSchema` (21 campos) + INSERT raw SQL completo (era solo 11 campos)
- `app/api/tools/loans/route.ts`: removido `borrowedById`/`borrowedBy` (no existen en schema); worker include agregado correctamente
- `app/api/tools/[id]/route.ts`: PUT expandido â€” destructura y actualiza code, maxStockLevel, reorderPoint, isCritical, leadTimeDays, unit
- `app/api/tools/movements/route.ts`: `userId` extraÃ­do de JWT (reemplaza `userId: 1` hardcodeado); `getCurrentUserId()` helper

**Movimientos â€” Sonnet fixes (sesiÃ³n 15):**
- `app/api/tools/movements/route.ts`:
  - `getUserId()` movido ANTES del tool lookup â†’ 401 temprano si no autenticado
  - VerificaciÃ³n `userOnCompany` despuÃ©s de encontrar tool â†’ 403 si sin acceso (fix de seguridad multi-tenant)
  - Tipos vÃ¡lidos corregidos: `MAINTENANCE` â†’ `ADJUSTMENT, LOAN` (match con enum Prisma `MovementType`)
  - Stock check extendido: `OUT || LOAN` valida stock insuficiente
  - Switch stock update: agrega case `LOAN` (reduce stock), case `ADJUSTMENT` (suma/resta)
  - `getMovementMessage()`: MAINTENANCE reemplazado por LOAN + ADJUSTMENT con mensajes en espaÃ±ol
- `app/panol/movimientos/page.tsx`:
  - `Movement` interface: `MAINTENANCE` â†’ `ADJUSTMENT | LOAN`
  - `MOVEMENT_TYPES`: agregados `ADJUSTMENT` (icon Minus, amber) y `LOAN` (icon Share2, destructive + isOut)
  - Signo cantidad (`+`/`-`): reemplazado `m.type === 'OUT'` â†’ `MOVEMENT_TYPES[m.type]?.isOut` en mobile, tabla y CSV
  - Filter dropdown: MAINTENANCE eliminado; ADJUSTMENT y LOAN agregados
  - Imports: `Minus`, `Share2` agregados a lucide-react
- **S2 (KPIs)**: ya correcto â€” exits contaba solo OUT antes de esta sesiÃ³n

**Archivos modificados (sesiÃ³n 15):**
- `app/api/tools/movements/route.ts`
- `app/panol/movimientos/page.tsx`

### Discord â€” NotificaciÃ³n cambio de estado de mÃ¡quina (sesiÃ³n 16)

**Nueva funciÃ³n `notifyMachineStatusChange`** en `lib/discord/notifications.ts`:
- Interface `MachineStatusChangeData` con machineId, machineName, oldStatus, newStatus, sectorId, sectorName?, changedByName?
- Helper `getMachineStatusLabel()` traduce enum â†’ espaÃ±ol (ACTIVEâ†’Activa, OUT_OF_SERVICEâ†’Fuera de servicio, MAINTENANCEâ†’En mantenimiento, DECOMMISSIONEDâ†’Dada de baja)
- Embed con color ERROR (rojo) para OUT_OF_SERVICE, WARNING (amarillo) para MAINTENANCE
- Campos: Estado anterior, Estado nuevo, MÃ¡quina, Modificado por (si disponible)
- EnvÃ­a al canal `FALLA_NUEVA` (el mÃ¡s relevante para disponibilidad de equipos) via `sendNotification()`

**PATCH endpoint modificado** en `app/api/maquinas/[id]/route.ts`:
- Select ampliado para obtener `status`, `name`, `sectorId` antes del update
- DespuÃ©s del update exitoso: si `newStatus === 'OUT_OF_SERVICE' || 'MAINTENANCE'`, llama `notifyMachineStatusChange()` fire-and-forget (`.catch()` silencioso)
- Import agregado: `notifyMachineStatusChange` from `@/lib/discord/notifications`

**Archivos modificados:**
- `orvit-v1/lib/discord/notifications.ts` â€” nueva funciÃ³n + interface + helper
- `orvit-v1/app/api/maquinas/[id]/route.ts` â€” import + notificaciÃ³n en PATCH

### PaÃ±ol Movimientos â€” Opus fixes (sesiÃ³n 17)

**O1 â€” User en GET movements:**
- Batch-lookup de usuarios despuÃ©s del query principal: extrae `userId` Ãºnicos â†’ `prisma.user.findMany` â†’ `Map` â†’ attach en response
- Evita necesidad de modificar schema Prisma (ToolMovement no tiene relaciÃ³n `user` definida)
- Frontend ya tenÃ­a `user?: { id, name }` en la interface y renderizaba `movement.user.name` â€” ahora recibe datos reales

**O2 â€” MovementDialog expandido a 5 tipos:**
- Reescritura completa de `components/panol/MovementDialog.tsx`
- `TYPE_CONFIG` record con: label, icon, badgeClass, stockEffect (`add|subtract|none|adjust`), reasons[] por tipo
- 5 tipos: IN, OUT, TRANSFER, RETURN, ADJUSTMENT (grid 2col mobile / 5col desktop)
- TRANSFER: campo "UbicaciÃ³n Destino" condicional
- ADJUSTMENT: label cambia a "Stock Nuevo" â€” el frontend calcula delta (`nuevo - actual`) y lo envÃ­a como quantity
- Backend: `quantity <= 0` validation relaxed para ADJUSTMENT (delta puede ser negativo)
- Resumen: muestra `Stock actual â†’ despuÃ©s` con colores verde/rojo segÃºn delta
- Motivos contextuales por tipo (Compra/ReposiciÃ³n para IN, Mantenimiento/Obra para OUT, etc.)

**O3 â€” Date range filter:**
- Backend: `dateFrom`/`dateTo` query params en GET `/api/tools/movements` â†’ `whereClause.createdAt { gte, lte }`
- Frontend: 2 inputs `type="date"` en la barra de filtros (`hidden sm:flex`)
- Query key incluye fechas â†’ TanStack Query refetcha automÃ¡ticamente al cambiar rango
- `clearFilters` y `hasFilters` actualizados para incluir fechas

**Archivos modificados (sesiÃ³n 17):**
- `app/api/tools/movements/route.ts` â€” batch user lookup, date filters, ADJUSTMENT validation
- `app/panol/movimientos/page.tsx` â€” dateFrom/dateTo state, fetchMovements con params, date inputs
- `components/panol/MovementDialog.tsx` â€” reescritura completa con 5 tipos

### PaÃ±ol Dashboard â€” Opus fixes (sesiÃ³n 18a)

- `app/api/panol/field-vs-storage/route.ts`: `$queryRaw` SQL â†’ Prisma native `lotInstallation.findMany()` con nested relation filtering
- `hooks/use-panol-permissions.ts`: `user.role === 'ADMIN'` (company role name match) â†’ solo `user.systemRole` para check admin
- `app/panol/dashboard/page.tsx`: `STOCK_IN` (enum fantasma) â†’ `ADJUSTMENT` en Recent Activity

### Conteo FÃ­sico â€” Sonnet Fixes + Opus Persistence (sesiÃ³n 18b)

**Sonnet Fixes (S1-S5) en `app/panol/conteo/page.tsx`:**
- S1: Tipo movimiento `IN/OUT` â†’ `ADJUSTMENT` con delta signed
- S2: Import `usePanolPermissions`, guards en buttons + `applyAdjustments`
- S3: `updateCount` sanitiza NaN y negativos
- S4: Eliminado `'adjusting'` de `CountStatus` (dead code)
- S5: Tracking per-item con `Set<number>`, solo marca exitosos como `adjusted`

**Opus O1: Persistencia de sesiones de conteo:**
- Schema: Enum `StockCountStatus` + modelos `StockCountSession` + `StockCountItem`
- Relaciones agregadas a `Company`, `User`, `Tool`
- SQL aplicado via `prisma db execute` (migration normal bloqueada por schema drift)
- API routes creadas:
  - `GET/POST /api/panol/conteo` â€” listar/crear sesiones
  - `GET/PATCH /api/panol/conteo/[id]` â€” detalle/guardar progreso
  - `POST /api/panol/conteo/[id]/finalize` â€” aplicar ajustes atÃ³micamente
- Finalize hace ajustes directos con Prisma `$transaction` (no vÃ­a movements API)
- UI refactorizada:
  - `startCount` â†’ POST crea sesiÃ³n en servidor
  - Auto-save debounced (2s) via PATCH
  - `applyAdjustments` â†’ POST finalize endpoint
  - Banner de reanudaciÃ³n para sesiones IN_PROGRESS
  - Tabla de historial de conteos pasados
  - Loading states para start/resume

**Archivos creados:**
- `app/api/panol/conteo/route.ts`
- `app/api/panol/conteo/[id]/route.ts`
- `app/api/panol/conteo/[id]/finalize/route.ts`

**Archivos modificados:**
- `prisma/schema.prisma` â€” enum + 2 modelos + relaciones en Company/User/Tool
- `hooks/use-panol-permissions.ts`
- `app/api/panol/field-vs-storage/route.ts`
- `app/panol/dashboard/page.tsx`
- `app/panol/conteo/page.tsx`

**TypeScript:** 0 errores
