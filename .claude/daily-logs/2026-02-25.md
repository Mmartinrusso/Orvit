# Daily Log — 2026-02-25

## Resumen Ejecutivo

### Sidebar — Reubicación de Favoritos y limpieza del bottom
- Favoritos movidos del top de la nav al **bottom section**, arriba de Feedback
- Estado expandido: lista compacta con ícono + nombre + botón quitar (hover)
- Estado colapsado: íconos individuales con tooltip, separador visual antes de Feedback
- Botón **Buscar** eliminado del sidebar (⌘K sigue funcionando)
- Notificaciones se mantiene en el bottom (importante para el usuario)
- Feedback se deja por ahora, se eliminará en el futuro

### Mobile Bottom Bar — Producción y Administración
- `/produccion/*` y `/administracion/*` ahora usan el mismo bottombar simple que `/mantenimiento/*`
- Un único botón centrado con ícono de menú para abrir el sidebar
- El bottombar complejo (`MobileBottomBar.tsx`) ya no aparece en producción ni administración
- **Archivos modificados:**
  - `components/layout/MainLayout.tsx` — extendido el bloque del botón simple a `/produccion` y `/administracion`
  - `components/layout/MobileBottomBar.tsx` — agregados `/produccion` y `/administracion` a la lista de exclusión

### Comprobante Form — Fixes críticos (sesión 2, cont. de ayer)
- `hasPermission()` crash: `ROLE_PERMISSIONS["Administrador"]` → `undefined` → `.includes()` lanzaba TypeError. Fix: `ROLE_PERMISSIONS[role] ?? []` con guard
- `systemRole` propagation: login API + `/api/auth/me` ahora retornan `systemRole: user.role` (rol del sistema, no de empresa). AuthContext almacena `systemRole`. `UserEditDialog` usa `currentUser.systemRole || currentUser.role` para `hasPermission`
- Lucas Russo y Mariano Russo (Pretensados Córdoba): `systemRole` actualizado de `USER` → `ADMIN_ENTERPRISE` en DB vía Prisma Studio
- Webpack chunk corruption (3 veces): borrar `.next` + reiniciar dev server. Causa: modificar archivos grandes como `permissions.ts` o `Sidebar.tsx` invalida chunk IDs

### Almacén — Mejoras Inventario completas (sesión 9)
- **Bug crítico fix**: `userId: 1` hardcodeado reemplazado con `useAuth()` real en SolicitudesTab, DespachosTab y DevolucionesTab (4 instancias en 3 archivos)
- **Mobile cards** en todos los tabs del Almacén: SolicitudesTab, DespachosTab, DevolucionesTab, InventarioTab, KardexTab y ReservasTab — vista dual `md:hidden` / `hidden md:block`
- **Date range filter** en KardexTab: inputs "Desde / Hasta" con botón clear, pasan `dateFrom/dateTo` a los filtros de la query
- **CSV export** en InventarioTab, KardexTab y SolicitudesTab: botón `Download` en toolbar, usa `downloadCSV` de `lib/cargas/utils`
- **Detail Sheet** en InventarioTab: click en fila abre Sheet lateral con stock actual/disponible/reservado, reorden, criticidad, ubicación y botón despacho rápido
- **QR Label printing** conectado en `/panol`: reemplazados 3 `toast.info('QR próximamente')` con `ToolQRLabel` usando `DialogTrigger asChild` dentro del DropdownMenuItem
- **Build**: ✅ sin errores TypeScript en archivos modificados

### Pañol — Migración completa TanStack Query v5 + Mobile responsive
- **Las 3 páginas restantes** del pañol migradas de `useState+useEffect+fetch` → TanStack Query v5: **forecast**, **repuestos** y **dashboard**
- Las 9 páginas del módulo pañol ahora usan TanStack Query con cache automático y staleTime configurado (2-3 min según la página)
- **Vista dual mobile/desktop** agregada en forecast y repuestos: cards compactas en mobile (`md:hidden`), tablas en desktop (`hidden md:block`)
- **Forecast mobile**: cards con grid 3-col (Stock/Necesidad/Pedir) + badge de prioridad por color
- **Repuestos mobile**: cards clickeables que abren detalle, con botón editar + menú dropdown inline, sort y CSV export ocultos en mobile
- `console.error` eliminados de repuestos y dashboard (solo queda el legítimo en `error.tsx`)
- **Build exitoso** — `next build` sin errores TypeScript

### Agenda — Mobile overhaul completo (sesión 6)
- `AgendaPage.tsx`: padding `px-6` → `px-3 sm:px-6`
- `AgendaPage.tsx`: header responsive — título `text-xl sm:text-2xl`, subtítulo `hidden sm:block`, botón Discord `hidden sm:flex`, "Nueva Tarea" → ícono solo en mobile con `<span className="hidden sm:inline">`
- `AgendaPage.tsx`: Sidebar Grupos → wrapper `hidden sm:block flex-shrink-0` (oculto en mobile)
- `AgendaPage.tsx`: Sidebar Personas → `hidden sm:flex` en Card (oculto en mobile, content área toma 100% del ancho)
- `AgendaPage.tsx`: Toolbar — search `min-w-0 sm:min-w-[200px]`, Origin/Status/Priority/Refresh → `hidden sm:block` wrappers
- `AgendaPage.tsx`: Mobile quickfilters row (`flex sm:hidden`) — Select para Grupos + Select para Persona, justo debajo del toolbar
- `AgendaKPICards.tsx`: "Top Asignados" card → `col-span-2 md:col-span-1` (ocupa fila completa en mobile, 1/5 en desktop)
- `AgendaKPICards.tsx`: grid `gap-4` → `gap-3 md:gap-4`

### Discord — Notificación automática de cambio de estado de máquina
- Cuando una máquina pasa a **Fuera de servicio** o **En mantenimiento**, se envía notificación automática al canal de Discord del sector
- La notificación incluye: estado anterior, estado nuevo, nombre de la máquina y quién hizo el cambio
- No afecta la operación normal: si Discord falla, el cambio de estado se completa igual

### Ideas — Audit fixes Opus (sesión 20)
- **O1** `DELETE /api/ideas/[id]`: Admin bypass implementado — admins (ADMIN/SUPERADMIN/ADMIN_ENTERPRISE) ahora pueden eliminar cualquier idea, no solo el creador. DB lookup de `systemRole`
- **O2** `PUT /api/ideas/[id]`: Validación de `category` y `priority` en update — antes aceptaba valores arbitrarios sin validar contra los enums permitidos
- **O3** `GET /api/ideas/[id]/comment`: Order cambiado de `desc` → `asc` para consistencia con el detalle de idea (B3 del Sonnet)
- **O4** `POST /api/ideas/[id]/vote`: Toggle + count envueltos en `$transaction` atómico — elimina race condition en el conteo de votos
- **O5** `POST /api/ideas/[id]/comment`: Límite de 2000 caracteres en contenido de comentarios
- **O6** `POST /api/ideas/[id]/vote`: Query de verificación de idea usa `select: { id: true }` en vez de fetch completo

### Ideas — Audit fixes Sonnet (sesión 19)
- **C1** `PUT /api/ideas/[id]/status`: Implementado guard de roles — solo ADMIN/SUPERADMIN/ADMIN_ENTERPRISE pueden cambiar estado. DB lookup de `systemRole` del actor antes de proceder
- **C2** `PUT /api/ideas/[id]`: Empty `if` block completado — retorna 403 para no-creadores
- **C3** `GET /api/ideas/[id]`: Raw `votes` array removido de la respuesta (destructuring `{ votes, ...rest }`); solo se exponen `voteCount` y `hasVoted`
- **M1** `GET /api/ideas/[id]`: Agrega `commentCount` al response del detalle
- **M3** `page.tsx`: Vote mutation `onSuccess` ahora invalida también `['idea', ideaId]` (detail query)
- **M5** `page.tsx`: Delete button en `IdeaCard` solo visible para el creador de la idea (`idea.createdById === currentUserId`). `useAuth()` agregado al page
- **M8** `POST /api/ideas`: Validación de `priority` contra enum `['LOW','MEDIUM','HIGH','CRITICAL']`
- **B1** `page.tsx`: Import `Star` eliminado (no usado)
- **B2** `GET /api/ideas/stats`: Queries `topVoted` y `recentIdeas` eliminadas del `Promise.all` y del response (no se usaban en UI)
- **B3** `GET /api/ideas/[id]`: Comments `orderBy: desc` → `asc` (orden cronológico)

### Conteo Físico — Sonnet fixes + Opus persistence (sesión 18)
- **Sonnet fixes (S1-S5)**: Tipo movimiento corregido a ADJUSTMENT, permisos `usePanolPermissions`, sanitización NaN/negativos, dead code eliminado, tracking per-item de éxito
- **Opus O1**: Persistencia completa de sesiones de conteo — nuevos modelos Prisma (`StockCountSession`, `StockCountItem`), 4 API endpoints, UI refactorizada con auto-save debounced, reanudación de sesiones e historial de conteos pasados

### Preventivo — PDF + Auto-reschedule + Split Dialog (sesiones 12-13)
- **Bulk actions** en HoyView y PlanesView: modo selección, select-all, Eliminar/Activar/Desactivar bulk
- **PDF export**: botón `Download` en toolbar de HoyView y PlanesView — genera PDF landscape A4 con jspdf + autoTable
- **Auto-reschedule**: `POST /api/maintenance/preventive/reschedule-overdue` — reprograma instancias vencidas a hoy; botón "Reprogramar vencidos" en KPI card de Vencidos (solo visible cuando hay vencidos)
- **Split `PreventiveMaintenanceDialog.tsx`**: 2868 → 1842 líneas (−36%); 6 step components extraídos a `components/work-orders/preventive-steps/`: EquipmentStep, GeneralStep, ToolsStep, InstructivesStep, ScheduleStep, SummaryStep + `types.ts`; 25 imports limpiados; 0 errores TypeScript

---

## Log Técnico

### Archivos modificados hoy
- `components/layout/Sidebar.tsx` — favoritos al bottom, Buscar eliminado
- `components/layout/MainLayout.tsx` — mobile bottom simple para produccion + administracion
- `components/layout/MobileBottomBar.tsx` — excluir produccion + administracion

### Ideas — Redesign completo (sesión 3)
- Página reescrita desde 0 con estilo V0/Vercel
- Header: ícono + título + botón shrink compacto
- KPI cards: componente `KpiCard` con ícono en círculo coloreado, 2×2 mobile → 4 desktop
- `CATEGORY_CONFIG`: nuevo sistema de colores con `iconBg`, `iconText`, `accent` por categoría
- `STATUS_CONFIG`: status pills con dot coloreado + variante clara/oscura (sin dependencia de clases semánticas del proyecto)
- `IdeaCard`: barra de acento izquierda por categoría, chip de categoría, status pill, título, descripción, footer con avatar + votes + comments. 3-dot menu solo visible en hover
- Filtros: h-8 compactos + botón "Limpiar" cuando hay filtros activos
- `CreateIdeaDialog`: labels uppercase tracking, `resize-none`, ícono en header, botón con `Sparkles`
- `IdeaDetailDialog`: usa `size="md"`, `DialogBody`, layout de meta info clean, notas de revisión/implementación con colores amber/green, comments con empty state

### Puestos de Trabajo — Mobile improvements (sesión 4)

- `WorkstationsToolbar.tsx`: filtros mobile-only — search full-width, estado `flex-1`, instructivos/máquinas/sort ocultos en mobile con `hidden sm:block`
- `WorkstationsToolbar.tsx`: Sheet "Filtros" ahora siempre visible en mobile (antes condicionado a `availableSectores.length > 1`). SheetBody incluye los 3 filtros ocultos en mobile + sector si corresponde
- `WorkstationsToolbar.tsx`: botón "+" icon-only para mobile (`sm:hidden`), desktop mantiene texto "Nuevo Puesto" (`hidden sm:inline-flex`)
- `WorkstationsToolbar.tsx`: filter bar `h-10` → `sm:h-10`, permite wrap en mobile
- `page.tsx`: "Ocultar resumen" → `hidden sm:inline-flex` (secundario en mobile)
- `page.tsx`: bulk actions bar → `flex-wrap gap-2` (evita overflow en mobile)

### WorkOrders — Filter bar mobile (sesión 5)

- `WorkOrdersFiltersBar.tsx`: eliminado `flex-wrap` del contenedor principal → una sola línea en mobile
- `WorkOrdersFiltersBar.tsx`: search → `min-w-0 sm:min-w-[200px]` (flex-1 sin ancho mínimo en mobile)
- `WorkOrdersFiltersBar.tsx`: Estado, Prioridad, Responsable, Máquina, Ordenar → `hidden sm:block` (solo desktop)
- `WorkOrdersFiltersBar.tsx`: separador vertical → `hidden sm:block`; "Más filtros" visible siempre
- `WorkOrdersFiltersBar.tsx`: pasa `availableUsers` a `WorkOrdersAdvancedFiltersSheet`
- `WorkOrdersAdvancedFiltersSheet.tsx`: nueva prop `availableUsers`; agrega secciones `sm:hidden` para Estado, Prioridad, Responsable al top del sheet
- `WorkOrdersAdvancedFiltersSheet.tsx`: `handleReset` ahora también resetea status/priority/assignee

### Archivos modificados (sesión 5)
- `components/work-orders/WorkOrdersFiltersBar.tsx`
- `components/work-orders/WorkOrdersAdvancedFiltersSheet.tsx`

### Archivos modificados (sesión 4)
- `components/work-stations/WorkstationsToolbar.tsx`
- `app/mantenimiento/puestos-trabajo/page.tsx`

### Archivos modificados (sesión 3)
- `app/mantenimiento/ideas/page.tsx` — reescritura completa

### Archivos modificados (sesión 2 cont.)
- `lib/permissions.ts` — `hasPermission` guard `?? []` + eliminados console.log debug
- `app/api/auth/login/route.ts` — `systemRole: user.role` en respuesta
- `app/api/auth/me/route.ts` — `systemRole: user.role` en respuesta
- `contexts/AuthContext.tsx` — campo `systemRole?: string` + seteo en login y refreshUser
- `components/usuarios/UserEditDialog.tsx` — usa `systemRole` para `hasPermission`

### Trampas encontradas
- `ROLE_PERMISSIONS` está keyed por `UserRole` enum del sistema, NO por nombre de rol de empresa. Nunca pasar `"Administrador"` — pasar `systemRole`
- Webpack chunk corruption: sucede al modificar archivos grandes; fix siempre es `rm -rf .next` + restart

### AgendaV2 — Synchro-style Board (sesión 6)

**Nuevos archivos creados** (12 archivos, build OK — sin errores TS):
- `app/administracion/agendav2/page.tsx`
- `components/agendav2/AgendaV2Page.tsx` — contenedor principal, topbar, view switcher
- `components/agendav2/BoardView.tsx` — kanban con DnD (DndContext, DragOverlay)
- `components/agendav2/BoardColumn.tsx` — columna con header icon + inline add
- `components/agendav2/TaskCard.tsx` — card exacta Synchro: group name, date, title, progress, avatars, counts
- `components/agendav2/TaskCalendarStrip.tsx` — timeline semanal (7 días, navegable, TODAY marker)
- `components/agendav2/TaskDetailPanel.tsx` — Sheet lateral con Tabs: Subtareas/Comentarios/Actividades
- `components/agendav2/SubtaskList.tsx` — lista con drag handles + inline add + progress bar
- `components/agendav2/InboxView.tsx` — split layout lista+detalle, crossfade al cambiar ítem
- `components/agendav2/DashboardView.tsx` — KPI cards + BarChart (recharts) + Today tasks + Activity feed
- `components/agendav2/CreateTaskModal.tsx` — dialog crear tarea (title, desc, priority, status, dueDate, category)
- `components/agendav2/index.ts`

**Stack usado**: dnd-kit, recharts, date-fns/es, TanStack Query, shadcn/ui Sheet+Tabs+Dialog
**No se instaló nada nuevo** — todo existía en package.json
**Build**: `○ /administracion/agendav2 — 17.6 kB | 378 kB` ✓

**Data**: Usa `/api/agenda/tasks` y `/api/agenda/stats` existentes. Subtasks/Comments/Activities usan mock data (estructura real disponible en Prisma pero no expuesta en la API de agenda).

### AgendaV2 — Rediseño visual completo Synchro (sesión 7)

**Archivos modificados** (rediseño visual, sin cambios a lógica):
- `AgendaV2Sidebar.tsx` — w-[220px], bg-zinc-50, avatar h-10, botón dark rounded-xl, nav items con rounded-xl, Favoritos con Star icon, spacing generoso
- `TaskCard.tsx` — bg-white rounded-2xl border-zinc-100 shadow-sm on hover, priority dot en header, progress bar por status (teal para IN_PROGRESS), avatars stacked, counts con iconos
- `BoardColumn.tsx` — headers con colored pill badge por status (teal="En Progreso", amber="En Revisión", etc.), drop zone bg-zinc-50, empty state con dashed border + click-to-add
- `TaskCalendarStrip.tsx` — TODAY marker: círculo teal con número blanco + línea debajo, status pills de colores por estado, bg-white rounded-2xl
- `TaskDetailPanel.tsx` — Sheet restyle: header con ícono cuadrado gris + title + chips status/prioridad, adjuntos como pills con tipo, tabs con border-teal-500 active, footer con Cancel/Save buttons, comments con bubble chat style
- `InboxView.tsx` — avatar con dot rojo para unread, Bookmark icon, status chip en detalle, attachments pills, bubble comments, activity feed
- `DashboardView.tsx` — Quick Actions row (4 cards), KPI cards con trend badge, Mapa de Actividad (recharts BarChart agrupado por hora), Milestone Tracker con 2 barras (Meta/Real), Team section, Upcoming Meetings cards
- `AgendaV2Page.tsx` — bg-zinc-50/50, topbar border-zinc-100 bg-white/80, altura h-[calc(100vh-4rem)]

**Build**: `○ /administracion/agendav2 — 26.6 kB | 382 kB` ✓ (sin errores TS en agendav2)

**Paleta Synchro aplicada**: zinc-50 sidebar, white cards, zinc-100 borders, teal-400/500 accent, rounded-2xl en cards/modals, rounded-xl en buttons/pills

### Bridge Compras ↔ Pañol — Fases 4 y 5

**Fase 4 — UI para vincular SupplierItem ↔ Tool:**
- `GET /api/tools/search` — endpoint liviano para comboboxes (`?q=texto&itemType=&limit=20`)
- APIs SupplierItem modificadas: GET incluye `tool`, POST/PUT aceptan `toolId`
- API Pedidos POST: pasa `toolId/componentId/machineId` en items
- 3 comboboxes reutilizables: `ToolSearchCombobox`, `MachineSearchCombobox`, `ComponentSearchCombobox`
- Página proveedor: columna "Pañol" en tabla de items + Dialog vincular + campo toolId en modal "Agregar Item"
- PedidoCompra form: sección colapsable "¿Para qué equipo?" con 3 comboboxes

**Fase 5 — Dashboard "Activos en Campo vs Pañol":**
- `GET /api/panol/field-vs-storage` — calcula in-storage (InventoryLot AVAILABLE) vs in-field (LotInstallation active) vs needed (ComponentTool)
- Sección en `/panol/dashboard`: 4 mini KPIs + barras horizontales apiladas top 6 spare parts + leyenda

**Archivos creados:**
- `app/api/tools/search/route.ts`
- `components/panol/ToolSearchCombobox.tsx`
- `components/compras/MachineSearchCombobox.tsx`
- `components/compras/ComponentSearchCombobox.tsx`
- `app/api/panol/field-vs-storage/route.ts`

**Archivos modificados:**
- `app/api/compras/proveedores/[id]/items/route.ts` — GET include tool, POST acepta toolId
- `app/api/compras/proveedores/[id]/items/[itemId]/route.ts` — PUT acepta toolId
- `app/api/compras/pedidos/route.ts` — items con toolId/componentId/machineId
- `app/administracion/compras/proveedores/[id]/page.tsx` — columna Pañol + dialogs
- `components/compras/pedido-compra-form-modal.tsx` — sección contexto equipo
- `app/panol/dashboard/page.tsx` — sección Campo vs Pañol

**Build**: ✅ sin errores TypeScript

### Pañol — Migración TanStack Query + Mobile (sesión 8)

**Migraciones a TanStack Query v5** (eliminado `useState+useEffect+fetch` → `useQuery`):
- `forecast/page.tsx` — `queryKey: ['panol','forecast', days, includeHistory]`, staleTime 3min
- `repuestos/page.tsx` — `queryKey: ['panol','repuestos', companyId]`, staleTime 3min, CRUD usa `invalidateQueries`
- `dashboard/page.tsx` — `queryKey: ['panol','dashboard', companyId]`, staleTime 2min, Promise.all dentro de queryFn

**Mobile responsive (dual-view cards/table):**
- `forecast/page.tsx` — Cards mobile (`md:hidden`) con grid 3-col (Stock/Necesidad/Pedir) + badge prioridad; tabla desktop (`hidden md:block`)
- `repuestos/page.tsx` — Cards mobile (`md:hidden`) clickeables → detalle, con edit inline + dropdown; tabla desktop (`hidden md:block`). Sort y CSV export ocultos en mobile (`hidden sm:flex`)

**console.error limpiados**: repuestos (línea 150), dashboard (línea 153). Solo queda `error.tsx` (error boundary, legítimo)

**Archivos modificados:**
- `app/panol/forecast/page.tsx`
- `app/panol/repuestos/page.tsx`
- `app/panol/dashboard/page.tsx`

**Build**: ✅ `next build` exitoso sin errores TypeScript

### Soluciones — Auditoría completa + implementación (sesión 9-10)

**Auditoría realizada** con 3 agentes paralelos (rutas API, componentes frontend, integraciones).

**Fixes de seguridad (3):**
- `PUT /api/failures/[id]/solution` — eliminado raw SQL auth (`$queryRaw` + `JOIN UserOnCompany`), reemplazado por `verifyToken()` + company boundary check
- `GET /api/failures/[id]/solutions` — `(prisma as any).failureOccurrence` → `prisma.failureOccurrence` (removido unsafe cast)
- `POST /api/work-orders/[id]/apply-solution` — removidos 2 `(prisma as any)` casts + agregado company boundary check (sesión anterior)
- Auth agregada a `GET /api/failure-occurrences/[id]/solutions` y `GET /api/failures/[id]/solutions` (sesión anterior)

**Features nuevas (4):**
- `PATCH /api/solutions-applied/[id]` — endpoint para editar soluciones (diagnosis, solution, notes, outcome, effectiveness, attachments, etc.) con auth + company boundary
- `GET /api/solutions-applied/[id]` — endpoint para detalle de una solución con includes completos
- `SolutionDetailDialog` — `handleSaveEdit` ahora llama API real (PATCH para SolutionApplied, PUT para legacy). Botón muestra loading state
- `SolutionDetailDialog` — file upload ahora sube a `/api/upload` vía FormData (S3). Era noop con toast fake
- `SolutionDetailDialog` — History tab renderiza `applicationHistory` embebido en la solución (timeline con OT, usuario, fecha, efectividad)

**Migración Soluciones page:**
- De `/api/work-orders?type=CORRECTIVE&status=COMPLETED` (client-side filter, sin paginación) → `/api/solutions-applied?mode=history` (server-side search, paginación, filtros)
- `getSolutionHistory` ampliado: include `machine.name`, `component.name`, `subComponent.name`, `workOrder.completedDate`
- Agregado campo `search` a `SolutionHistoryParams`, Zod schema, y API route — búsqueda full-text en diagnosis, solution, confirmedCause, failureOccurrence.title
- KPIs ahora basados en outcome (Funcionaron/Parciales/No Funcionaron) con queries independientes para totales
- Search con `useDebounce(300ms)` para evitar requests excesivos
- Mapper `mapToSolution()` convierte SolutionApplied → interface Solution (SolutionCard)

**Cleanup:**
- Hook `useFailureSolutionsByWorkOrder` eliminado (dead code — exportado pero never imported)
- Mock data eliminado de SolutionDetailDialog (sesión anterior): Unsplash images, w3schools videos, mock docs

**Archivos creados:**
- `app/api/solutions-applied/[id]/route.ts` (GET + PATCH)
- `app/api/solutions-applied/[id]/obsolete/route.ts` (PATCH, sesión anterior)

**Archivos modificados:**
- `app/api/failures/[id]/solution/route.ts` — reescrito completo (auth segura)
- `app/api/failures/[id]/solutions/route.ts` — removido `(prisma as any)` cast
- `app/api/solutions-applied/route.ts` — agregado `search` param
- `lib/corrective/solution-history.ts` — `getSolutionHistory` con machine/component/subComponent includes + search filter
- `lib/corrective/validations.ts` — `search` en solutionHistoryParamsSchema
- `components/solutions/SolutionDetailDialog.tsx` — edit API real, file upload real, history tab con datos
- `app/mantenimiento/soluciones/page.tsx` — migrado a /api/solutions-applied con paginación
- `hooks/mantenimiento/use-failure-solutions.ts` — eliminado hook dead code

### Preventivo — Auditoría de seguridad + integraciones (sesión 11)

**Auditoría realizada** con 3 agentes paralelos (rutas API, frontend, schema/integraciones). Encontrados: 10/16 rutas sin auth, 15/16 sin company boundary check, bug en instructives POST.

**Fixes de seguridad (Phase 1 — Opus):**

1. **Auth en `/api/maintenance/preventive/` (GET/POST)** — agregado `verifyToken()` + company boundary check (companyId del body/query vs token)
2. **Auth en `/api/maintenance/preventive/[id]` (GET/PUT/DELETE)** — agregado `verifyToken()` + company boundary check contra `template.companyId`
3. **Auth en `/api/maintenance/preventive/[id]/instructives` (GET/POST/DELETE)** — agregado `verifyToken()`. **Bug fix en POST**: buscaba template en tabla `Document` (siempre 404); corregido a `prisma.preventiveTemplate.findUnique()` + company boundary check
4. **Auth en `/api/maintenance/preventive/alerts`** — agregado `verifyToken()` + company boundary check
5. **Auth en `/api/maintenance/dashboard` y `/api/maintenance/kpis`** — agregado `verifyToken()` + company boundary check. Ambos eran endpoints públicos con solo `companyId` como query param
6. **CRON_SECRET en `/api/cron/preventive-scheduler`** — agregado check `Authorization: Bearer $CRON_SECRET` en POST y GET (health check). Patrón consistente con los otros 12+ cron endpoints

**Integraciones (Phase 2 — Opus):**

7. **Discord notifications conectadas:**
   - `notifyPreventiveCompleted()` llamada desde `execute/route.ts` después de ejecutar un preventivo (fire-and-forget con `.catch()`)
   - `notifyPreventiveReminder()` llamada desde `cron/preventive-scheduler` — envía recordatorios cuando `daysUntil` coincide con `alertDaysBefore` del template
   - Ambas funciones ya existían en `lib/discord/notifications.ts` pero nunca eran invocadas

8. **Health score calculator corregido:**
   - Antes: solo contaba `MaintenanceChecklist.nextDueDate` para PMs vencidos (modelo legacy)
   - Después: nueva función `countOverduePMs()` suma legacy + `PreventiveInstance` con status PENDING/OVERDUE y fecha pasada
   - Usa `template: { machineId, isActive: true }` para filtrar por máquina correctamente

9. **Hourly rate hardcodeado eliminado:**
   - `preventive/[id]/complete/route.ts`: `averageHourlyRate = 25` → `resolveHourlyRate(userId, companyId)` que busca `TechnicianCostRate` → env → 25 fallback. También migrado auth de `jwtVerify` directo → `verifyToken()`
   - `lib/maintenance-helpers.ts`: `25` → `parseFloat(process.env.MAINTENANCE_HOURLY_RATE_DEFAULT || '25')` (función pura, no puede ser async)

**Archivos modificados:**
- `app/api/maintenance/preventive/route.ts` — auth + company check en GET/POST
- `app/api/maintenance/preventive/[id]/route.ts` — auth + company check en GET/PUT/DELETE
- `app/api/maintenance/preventive/[id]/instructives/route.ts` — auth + fix bug POST (Document → PreventiveTemplate)
- `app/api/maintenance/preventive/alerts/route.ts` — auth + company check
- `app/api/maintenance/dashboard/route.ts` — auth + company check
- `app/api/maintenance/kpis/route.ts` — auth + company check
- `app/api/cron/preventive-scheduler/route.ts` — CRON_SECRET + Discord reminders
- `app/api/maintenance/execute/route.ts` — Discord notifyPreventiveCompleted
- `app/api/maintenance/preventive/[id]/complete/route.ts` — resolveHourlyRate + verifyToken
- `lib/maintenance/health-score-calculator.ts` — countOverduePMs con PreventiveInstance
- `lib/maintenance-helpers.ts` — env-based hourly rate

### Preventivo — Bulk actions en HoyView y PlanesView (sesión 12)

**Bulk actions en `PreventivoHoyView`:**
- Botón `CheckSquare2` en toolbar para entrar/salir de modo selección
- Estado interno: `selectionMode: boolean`, `selectedIds: Set<number>`
- `MaintenanceCard` extendido: `isSelected`, `onToggleSelect`, `selectionMode` — checkbox aparece en modo selección, card entera clickeable para toggle
- "Seleccionar todos (N)" + count seleccionados con limpiar
- Barra sticky bottom con "Eliminar (N)": llama `DELETE /api/maintenance/${id}` por cada seleccionado, invalida `maintenance-pending` al final
- Impostaciones: `Checkbox`, `useQueryClient`, `useToast`, `useCallback`, `CheckSquare2`

**Bulk actions en `PreventivoPlanesView`:**
- Mismo patrón de selección
- `PlanCard` extendido: mismas 3 props de selección
- Barra sticky bottom con 3 acciones:
  - **Activar**: `PUT /api/maintenance/preventive/${id}` con `{ isActive: true }`, invalida `preventive-planes`
  - **Desactivar**: igual con `{ isActive: false }`
  - **Eliminar**: `DELETE /api/maintenance/preventive/${id}`, invalida `preventive-planes`
- Imports: `useQueryClient`, `useToast`, `useCallback`, `CheckSquare2`, `Power`, `PowerOff`

**Archivos modificados:**
- `components/maintenance/preventive/PreventivoHoyView.tsx`
- `components/maintenance/preventive/PreventivoPlanesView.tsx`

### Preventivo — PDF export + Auto-reschedule + Split dialog (sesión 13)

**PDF export (`lib/pdf/preventive-pdf.ts` — nuevo):**
- `exportPreventivePDF(items, companyName, viewTitle)` — landscape A4 con jspdf + jspdf-autotable
- 8 columnas: Título, Equipo, Prioridad, Frecuencia, Duración, Próxima Fecha, Responsable, Descripción
- Maneja ambas vistas (HoyView y PlanesView) — misma función gracias al diseño flexible
- Botón `Download` en toolbar de HoyView y PlanesView, deshabilitado cuando no hay ítems

**Auto-reschedule OVERDUE (`app/api/maintenance/preventive/reschedule-overdue/route.ts` — nuevo):**
- `POST /api/maintenance/preventive/reschedule-overdue` — body: `{ companyId }`
- Reprograma instancias OVERDUE o PENDING con fecha pasada → `scheduledDate = today, status = PENDING`
- Filtra solo templates activos de la empresa del token (company boundary check)
- Botón "Reprogramar vencidos" en la KPI card de Vencidos (HoyView), visible solo cuando `kpis.overdue > 0`
- Handler `handleRescheduleOverdue` con toast + `invalidateQueries(['maintenance-pending'])`

**Split `PreventiveMaintenanceDialog.tsx` (2868 → 1842 líneas, reducción 36%):**
- Directorio nuevo: `components/work-orders/preventive-steps/`
- Tipos compartidos: `types.ts` → `PreventiveFormData`, `ToolRequest`, `ValidationErrors`
- 6 step components extraídos del dialog:
  - `EquipmentStep.tsx` — máquina, componentes, subcomponentes, SelectionSummaryChips
  - `GeneralStep.tsx` — título, descripción, prioridad, técnico asignado, notas, isActive
  - `ToolsStep.tsx` — herramientas generales + repuestos específicos + seleccionados
  - `InstructivesStep.tsx` — upload dropzone + lista de instructivos
  - `ScheduleStep.tsx` — fecha, frecuencia, alertas, ventana, tiempo estimado, preview 5 fechas
  - `SummaryStep.tsx` — resumen read-only de todo el formulario
- Imports limpiados: 25 imports eliminados del main dialog (Checkbox, DatePicker, Label, Textarea, Select, Switch, MultiSelect, SectionCard, EmptyState, ScrollArea, Separator, etc.)
- 0 errores TypeScript (validado con `npx tsc --noEmit --skipLibCheck`)

**Archivos creados:**
- `lib/pdf/preventive-pdf.ts`
- `app/api/maintenance/preventive/reschedule-overdue/route.ts`
- `components/work-orders/preventive-steps/types.ts`
- `components/work-orders/preventive-steps/EquipmentStep.tsx`
- `components/work-orders/preventive-steps/GeneralStep.tsx`
- `components/work-orders/preventive-steps/ToolsStep.tsx`
- `components/work-orders/preventive-steps/InstructivesStep.tsx`
- `components/work-orders/preventive-steps/ScheduleStep.tsx`
- `components/work-orders/preventive-steps/SummaryStep.tsx`

**Archivos modificados:**
- `components/maintenance/preventive/PreventivoHoyView.tsx` — PDF button + reschedule button
- `components/maintenance/preventive/PreventivoPlanesView.tsx` — PDF button
- `components/work-orders/PreventiveMaintenanceDialog.tsx` — imports step components, removes extracted JSX

### Pañol — Auditoría Repuestos + Movimientos (sesiones 14-15)

**Repuestos — Sonnet fixes:**
- `app/panol/repuestos/page.tsx`: `import { cn }` agregado (faltaba, causaba error); icono `History` agregado; dialog detalle expandido a `max-w-2xl max-h-[85vh] overflow-y-auto`; componente `SparePartMovements` inline que fetcha `/api/tools/movements?toolId=X&companyId=Y&limit=10` y muestra mini tabla con badge coloreado por tipo
- `hooks/use-panol-permissions.ts`: permiso delete cambiado de `tools.delete` → `panol.delete_product`
- `app/api/tools/route.ts`: fallback inseguro de "cualquier empresa" eliminado del GET — ahora retorna 400 si no hay companyId

**Repuestos — Opus fixes:**
- `app/api/tools/route.ts`: POST reescrito con Zod `CreateToolSchema` (21 campos) + INSERT raw SQL completo (era solo 11 campos)
- `app/api/tools/loans/route.ts`: removido `borrowedById`/`borrowedBy` (no existen en schema); worker include agregado correctamente
- `app/api/tools/[id]/route.ts`: PUT expandido — destructura y actualiza code, maxStockLevel, reorderPoint, isCritical, leadTimeDays, unit
- `app/api/tools/movements/route.ts`: `userId` extraído de JWT (reemplaza `userId: 1` hardcodeado); `getCurrentUserId()` helper

**Movimientos — Sonnet fixes (sesión 15):**
- `app/api/tools/movements/route.ts`:
  - `getUserId()` movido ANTES del tool lookup → 401 temprano si no autenticado
  - Verificación `userOnCompany` después de encontrar tool → 403 si sin acceso (fix de seguridad multi-tenant)
  - Tipos válidos corregidos: `MAINTENANCE` → `ADJUSTMENT, LOAN` (match con enum Prisma `MovementType`)
  - Stock check extendido: `OUT || LOAN` valida stock insuficiente
  - Switch stock update: agrega case `LOAN` (reduce stock), case `ADJUSTMENT` (suma/resta)
  - `getMovementMessage()`: MAINTENANCE reemplazado por LOAN + ADJUSTMENT con mensajes en español
- `app/panol/movimientos/page.tsx`:
  - `Movement` interface: `MAINTENANCE` → `ADJUSTMENT | LOAN`
  - `MOVEMENT_TYPES`: agregados `ADJUSTMENT` (icon Minus, amber) y `LOAN` (icon Share2, destructive + isOut)
  - Signo cantidad (`+`/`-`): reemplazado `m.type === 'OUT'` → `MOVEMENT_TYPES[m.type]?.isOut` en mobile, tabla y CSV
  - Filter dropdown: MAINTENANCE eliminado; ADJUSTMENT y LOAN agregados
  - Imports: `Minus`, `Share2` agregados a lucide-react
- **S2 (KPIs)**: ya correcto — exits contaba solo OUT antes de esta sesión

**Archivos modificados (sesión 15):**
- `app/api/tools/movements/route.ts`
- `app/panol/movimientos/page.tsx`

### Discord — Notificación cambio de estado de máquina (sesión 16)

**Nueva función `notifyMachineStatusChange`** en `lib/discord/notifications.ts`:
- Interface `MachineStatusChangeData` con machineId, machineName, oldStatus, newStatus, sectorId, sectorName?, changedByName?
- Helper `getMachineStatusLabel()` traduce enum → español (ACTIVE→Activa, OUT_OF_SERVICE→Fuera de servicio, MAINTENANCE→En mantenimiento, DECOMMISSIONED→Dada de baja)
- Embed con color ERROR (rojo) para OUT_OF_SERVICE, WARNING (amarillo) para MAINTENANCE
- Campos: Estado anterior, Estado nuevo, Máquina, Modificado por (si disponible)
- Envía al canal `FALLA_NUEVA` (el más relevante para disponibilidad de equipos) via `sendNotification()`

**PATCH endpoint modificado** en `app/api/maquinas/[id]/route.ts`:
- Select ampliado para obtener `status`, `name`, `sectorId` antes del update
- Después del update exitoso: si `newStatus === 'OUT_OF_SERVICE' || 'MAINTENANCE'`, llama `notifyMachineStatusChange()` fire-and-forget (`.catch()` silencioso)
- Import agregado: `notifyMachineStatusChange` from `@/lib/discord/notifications`

**Archivos modificados:**
- `orvit-v1/lib/discord/notifications.ts` — nueva función + interface + helper
- `orvit-v1/app/api/maquinas/[id]/route.ts` — import + notificación en PATCH

### Pañol Movimientos — Opus fixes (sesión 17)

**O1 — User en GET movements:**
- Batch-lookup de usuarios después del query principal: extrae `userId` únicos → `prisma.user.findMany` → `Map` → attach en response
- Evita necesidad de modificar schema Prisma (ToolMovement no tiene relación `user` definida)
- Frontend ya tenía `user?: { id, name }` en la interface y renderizaba `movement.user.name` — ahora recibe datos reales

**O2 — MovementDialog expandido a 5 tipos:**
- Reescritura completa de `components/panol/MovementDialog.tsx`
- `TYPE_CONFIG` record con: label, icon, badgeClass, stockEffect (`add|subtract|none|adjust`), reasons[] por tipo
- 5 tipos: IN, OUT, TRANSFER, RETURN, ADJUSTMENT (grid 2col mobile / 5col desktop)
- TRANSFER: campo "Ubicación Destino" condicional
- ADJUSTMENT: label cambia a "Stock Nuevo" — el frontend calcula delta (`nuevo - actual`) y lo envía como quantity
- Backend: `quantity <= 0` validation relaxed para ADJUSTMENT (delta puede ser negativo)
- Resumen: muestra `Stock actual → después` con colores verde/rojo según delta
- Motivos contextuales por tipo (Compra/Reposición para IN, Mantenimiento/Obra para OUT, etc.)

**O3 — Date range filter:**
- Backend: `dateFrom`/`dateTo` query params en GET `/api/tools/movements` → `whereClause.createdAt { gte, lte }`
- Frontend: 2 inputs `type="date"` en la barra de filtros (`hidden sm:flex`)
- Query key incluye fechas → TanStack Query refetcha automáticamente al cambiar rango
- `clearFilters` y `hasFilters` actualizados para incluir fechas

**Archivos modificados (sesión 17):**
- `app/api/tools/movements/route.ts` — batch user lookup, date filters, ADJUSTMENT validation
- `app/panol/movimientos/page.tsx` — dateFrom/dateTo state, fetchMovements con params, date inputs
- `components/panol/MovementDialog.tsx` — reescritura completa con 5 tipos

### Pañol Dashboard — Opus fixes (sesión 18a)

- `app/api/panol/field-vs-storage/route.ts`: `$queryRaw` SQL → Prisma native `lotInstallation.findMany()` con nested relation filtering
- `hooks/use-panol-permissions.ts`: `user.role === 'ADMIN'` (company role name match) → solo `user.systemRole` para check admin
- `app/panol/dashboard/page.tsx`: `STOCK_IN` (enum fantasma) → `ADJUSTMENT` en Recent Activity

### Conteo Físico — Sonnet Fixes + Opus Persistence (sesión 18b)

**Sonnet Fixes (S1-S5) en `app/panol/conteo/page.tsx`:**
- S1: Tipo movimiento `IN/OUT` → `ADJUSTMENT` con delta signed
- S2: Import `usePanolPermissions`, guards en buttons + `applyAdjustments`
- S3: `updateCount` sanitiza NaN y negativos
- S4: Eliminado `'adjusting'` de `CountStatus` (dead code)
- S5: Tracking per-item con `Set<number>`, solo marca exitosos como `adjusted`

**Opus O1: Persistencia de sesiones de conteo:**
- Schema: Enum `StockCountStatus` + modelos `StockCountSession` + `StockCountItem`
- Relaciones agregadas a `Company`, `User`, `Tool`
- SQL aplicado via `prisma db execute` (migration normal bloqueada por schema drift)
- API routes creadas:
  - `GET/POST /api/panol/conteo` — listar/crear sesiones
  - `GET/PATCH /api/panol/conteo/[id]` — detalle/guardar progreso
  - `POST /api/panol/conteo/[id]/finalize` — aplicar ajustes atómicamente
- Finalize hace ajustes directos con Prisma `$transaction` (no vía movements API)
- UI refactorizada:
  - `startCount` → POST crea sesión en servidor
  - Auto-save debounced (2s) via PATCH
  - `applyAdjustments` → POST finalize endpoint
  - Banner de reanudación para sesiones IN_PROGRESS
  - Tabla de historial de conteos pasados
  - Loading states para start/resume

**Archivos creados:**
- `app/api/panol/conteo/route.ts`
- `app/api/panol/conteo/[id]/route.ts`
- `app/api/panol/conteo/[id]/finalize/route.ts`

**Archivos modificados:**
- `prisma/schema.prisma` — enum + 2 modelos + relaciones en Company/User/Tool
- `hooks/use-panol-permissions.ts`
- `app/api/panol/field-vs-storage/route.ts`
- `app/panol/dashboard/page.tsx`
- `app/panol/conteo/page.tsx`

**TypeScript:** 0 errores
