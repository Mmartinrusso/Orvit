# Log 2026-02-22

## üìã RESUMEN EJECUTIVO

### Ventas ‚Äî Liquidaciones

El wizard "Nueva Liquidaci√≥n" (Step 2) fue redise√±ado completamente con un layout de 3 paneles (20/60/20). El panel central muestra el documento de liquidaci√≥n como una hoja f√≠sica, con strip de color por estado, KPIs en banda, secciones con header tipo banda gris y tarjetas de factura con tinta de color.

### ‚úÖ General ‚Äî Sidebar completamente configurable por empresa + modo edici√≥n directo desde el sidebar

El sidebar ya no est√° hardcodeado en ning√∫n m√≥dulo. Los administradores pueden hacer click en **"Editar sidebar"** (visible solo para ADMIN/ADMIN_ENTERPRISE/SUPERADMIN) directamente en el sidebar, sin ir a ninguna p√°gina de configuraci√≥n:
1. **Drag & drop** de las 10 secciones top-level (Personal, Ventas, Costos, Compras, Tesorer√≠a, N√≥minas, Almac√©n, Automatizaciones, Controles, Cargas) con grip handles.
2. **Renombrar** cualquier secci√≥n inline (ej: "Ventas" ‚Üí "Comercial") con click en el l√°piz.
3. **Eliminar** secciones ‚Äî aparecen en panel "Secciones ocultas" para restaurar cuando quieran.
4. **Crear grupos nuevos** con item picker (b√∫squeda de todos los m√≥dulos, selecci√≥n por checkboxes).
5. **Expandir m√≥dulos** para editar su estructura interna (grupos + items) con DnD, tambi√©n desde el sidebar.

Los usuarios ven la estructura y el orden configurado por su empresa, filtrado por sus propios permisos. La tab "Navegaci√≥n" de la p√°gina de configuraci√≥n fue eliminada.

### ‚úÖ General ‚Äî Configuraci√≥n de Claude Code revisada y optimizada

Auditor√≠a completa de toda la configuraci√≥n de Claude Code (reglas, skills, memoria, permisos). Se actualiz√≥ CLAUDE.md con la gu√≠a de skills y la arquitectura del bot de Discord. Se corrigieron 3 skills desactualizados. Se simplificaron los permisos de 3 settings.json (de ~60 reglas espec√≠ficas a permisos amplios). Se reorganiz√≥ MEMORY.md para que sea conciso y no redundante.

### ‚úÖ General ‚Äî Sistema pre-flight para evitar retrabajo

Se analizaron 20+ sesiones de trabajo y se identificaron las 3 causas principales de retrabajo: dise√±o visual sin referencia, scope creep a mitad de tarea, y nombres de campos incorrectos. Se crearon 2 herramientas nuevas:
1. **Regla pre-flight** ‚Äî Claude verifica 5 puntos antes de empezar cualquier feature (d√≥nde va, c√≥mo se ve, qu√© datos, qui√©n lo usa, alcance completo). M√°ximo 1-2 preguntas antes de arrancar.
2. **Gu√≠a "C√≥mo pedir"** ‚Äî Template r√°pido para el usuario con QU√â/D√ìNDE/REFERENCIA/DATOS + tips por tipo de tarea (feature, bug, redise√±o).

### ‚úÖ General ‚Äî Sistema de aprendizaje continuo

Se cre√≥ un sistema de memoria tem√°tica para que Claude se auto-alimente con cada sesi√≥n:
1. **Errores comunes** ‚Äî Cat√°logo de 11 bugs organizados por categor√≠a (Frontend, API, Prisma, Tooling) con s√≠ntoma/causa/fix
2. **Preferencias del usuario** ‚Äî Gustos de dise√±o (layout 20/80, cards expandibles, strips de color) y workflow (m√°ximo 1-2 preguntas, todo configurable por empresa)
3. **Decisiones arquitect√≥nicas** ‚Äî Decisiones por m√≥dulo (Ventas, Sidebar, Discord, DB, Auth) para no contradecir lo decidido
4. **Patrones de c√≥digo** ‚Äî 8 patrones reutilizables con ejemplos (migraci√≥n SQL directa, registry pattern, KPI bars, etc.)
5. **Regla de auto-aprendizaje** ‚Äî Triggers autom√°ticos para actualizar memoria despu√©s de bugs, redise√±os, decisiones o patrones nuevos

### ‚úÖ General ‚Äî Skills de frontend mejoradas

Se investigaron 28+ skills externas y se instalaron 3 nuevas para mejorar la calidad visual del frontend:
1. **`frontend-design`** (Anthropic oficial) ‚Äî Direcci√≥n est√©tica anti-"AI slop": tipograf√≠a, color, motion, composici√≥n espacial
2. **`shadcn-ui`** (Google Labs) ‚Äî Gu√≠a experta de integraci√≥n shadcn/ui con cat√°logo, customizaci√≥n y ejemplos
3. **`enhance-prompt`** (Google Labs) ‚Äî Pipeline para convertir ideas vagas en prompts de dise√±o precisos

Adem√°s, se actualiz√≥ `orvit-frontend` con reglas de pulido visual: spacing scale, jerarqu√≠a tipogr√°fica, sombras, hover states, transiciones, bordes, densidad y accesibilidad.

---

## Log T√©cnico

### Archivos modificados

- `app/administracion/ventas/liquidaciones/nueva/page.tsx`
- `app/api/ventas/liquidaciones/ventas-disponibles/route.ts` (sesi√≥n anterior)

### Cambios aplicados (sesi√≥n anterior + esta sesi√≥n)

**Sidebar (OV list):**
- Eliminado badge con n√∫mero de LIQ (LIQ-XXXX)
- Eliminado badge de texto de cobranza (Cobrada/Parcial X%) ‚Äî solo queda la barra visual

**API ventas-disponibles:**
- Agregado `quote { select: { fechaEnvio: true } }` al include de Prisma

**Documento ‚Äî redise√±o dram√°tico:**
1. Agregado `OV_ESTADO_COLOR` constant (mapping de estado ‚Üí hex color)
2. Strip de color fino (h-1.5) en el tope del documento seg√∫n estado de la OV
3. Header: n√∫mero `text-2xl font-mono` + cliente `text-base` + estado como pill colored (no outline Badge)
4. Fechas inline en una fila: "Cot. enviada" (Send icon) + "Aprobada/Creada" (CheckCircle verde)
5. KPI strip como banda horizontal conectada con `flex border rounded-lg divide-x`:
   - Total OV | Comisi√≥n (X%) en violeta | N¬∞ Facturas
6. Section headers como bandas grises (`bg-muted/40 border-b`) con icon + label uppercase
7. Secci√≥n Cobranza: `%cobrado` en el header con color din√°mico + barra full-width h-1.5 sin padding
8. Invoice cards: `backgroundColor: colors.bg` (tint de color) + total `text-base font-bold` + barra h-1 al pie

---

### Sidebar configurable por empresa ‚Äî implementaci√≥n completa

**Arquitectura de 3 capas:**
1. REGISTRY (`ventas-modules.ts`) ‚Äî todos los items posibles + permisos
2. COMPANY CONFIG (`CompanySettings.sidebarConfig` JSON) ‚Äî admin organiza en grupos
3. PERMISSION FILTER (`Sidebar.tsx`) ‚Äî cada usuario ve solo lo que tiene permiso

**Archivos creados/modificados:**

| Acci√≥n | Archivo |
|--------|---------|
| Modificado | `lib/sidebar/ventas-modules.ts` ‚Äî 11 m√≥dulos faltantes agregados |
| Creado | `lib/sidebar/ventas-default-config.ts` ‚Äî default que replica el sidebar anterior |
| Creado | `lib/sidebar/company-sidebar-config.ts` ‚Äî tipos + helpers |
| Modificado | `prisma/schema.prisma` ‚Äî `sidebarConfig Json? @db.JsonB` en `CompanySettings` |
| Creado | `app/api/companies/[id]/sidebar-config/route.ts` ‚Äî GET/PUT/DELETE |
| Creado | `hooks/use-company-sidebar-config.ts` ‚Äî 3 hooks TanStack Query |
| Modificado | `components/layout/Sidebar.tsx` ‚Äî ventasItems reemplazado con `buildVentasNodes()` |
| Modificado | `app/api/user/sidebar/ventas/route.ts` ‚Äî simplificado a solo `collapsed: string[]` |
| Creado | `components/ventas/configuracion/sidebar-editor.tsx` ‚Äî UI admin completa |
| Modificado | `app/administracion/configuracion/page.tsx` ‚Äî tab "Navegaci√≥n" agregado |

**Migraci√≥n aplicada en esta sesi√≥n ‚Äî directo a Supabase:**

`prisma migrate dev` y `prisma db push` fallaron (shadow DB rota + type change no relacionado). Soluci√≥n: Node.js + `pg` directo con `DIRECT_URL` (puerto 5432, no pgbouncer):

```bash
NODE_TLS_REJECT_UNAUTHORIZED=0 node -e "
const { Client } = require('pg');
const client = new Client({ connectionString: process.env.DIRECT_URL });
client.connect()
  .then(() => client.query('ALTER TABLE \"CompanySettings\" ADD COLUMN IF NOT EXISTS \"sidebarConfig\" JSONB'))
  .then(r => { console.log('Done:', r.command); return client.end(); })
"
# Output: Done: ALTER
```

Columna verificada: `sidebarConfig JSONB nullable ‚úì`

**Estado final: FEATURE COMPLETA Y EN PRODUCCI√ìN**

---

### Sidebar configurable ‚Äî extensi√≥n a todos los m√≥dulos (sesi√≥n actual)

**Registries creados:**
| Archivo | M√≥dulos |
|---------|---------|
| `lib/sidebar/mantenimiento-modules.ts` | 34 m√≥dulos |
| `lib/sidebar/mantenimiento-default-config.ts` | 10 grupos |
| `lib/sidebar/produccion-modules.ts` | 14 m√≥dulos |
| `lib/sidebar/produccion-default-config.ts` | 6 grupos |
| `lib/sidebar/compras-modules.ts` | 15 m√≥dulos |
| `lib/sidebar/compras-default-config.ts` | 4 grupos |
| `lib/sidebar/tesoreria-modules.ts` | 6 m√≥dulos |
| `lib/sidebar/tesoreria-default-config.ts` | 1 grupo flat |
| `lib/sidebar/nominas-modules.ts` | 8 m√≥dulos |
| `lib/sidebar/nominas-default-config.ts` | 1 grupo flat |
| `lib/sidebar/almacen-modules.ts` | 7 m√≥dulos |
| `lib/sidebar/almacen-default-config.ts` | 1 grupo flat |

**Archivos generalizados:**
- `lib/sidebar/company-sidebar-config.ts` ‚Äî importa los 7 registries/defaults; exports gen√©ricos: `getEffectiveConfig(key, saved)`, `getModuleByKey(key, id)`, `getRegistry(key)`, `getOrphanedModulesForKey(key, config)`, `validateModuleConfig(key, config)`, `ALL_MODULE_KEYS`
- `app/api/companies/[id]/sidebar-config/route.ts` ‚Äî GET retorna todos los m√≥dulos; PUT body `{ module, config }`; DELETE acepta `{ module? }`
- `hooks/use-company-sidebar-config.ts` ‚Äî `useUpdateCompanySidebarConfig` acepta `{ module, config }`; `useResetCompanySidebarConfig` acepta `moduleKey?`
- `components/layout/Sidebar.tsx` ‚Äî reemplazados todos los arrays hardcodeados (mantenimiento, produccion, ventas, compras, tesoreria, nominas, almacen) con `useMemo` + `buildModuleNodes(config.groups, permissionsMap, key)`. Los permission maps son gen√©ricos por m√≥dulo.
- `components/ventas/configuracion/sidebar-editor.tsx` ‚Äî tabs de m√≥dulo arriba (Ventas/Compras/Tesorer√≠a/N√≥minas/Almac√©n/Mantenimiento/Producci√≥n). Al cambiar de tab: si hay cambios sin guardar pide confirmaci√≥n, resetea estado. Todas las calls a save/reset pasan `activeModule`.

**Estado: FEATURE COMPLETA ‚Äî sidebar 100% configurable en todos los m√≥dulos**

---

### Orden configurable de m√≥dulos top-level (sesi√≥n actual)

El admin puede controlar el **orden** de las secciones (Ventas, Costos, Compras, Tesorer√≠a, N√≥minas, Almac√©n) en el sidebar de Administraci√≥n ‚Äî no solo el contenido interno de cada una.

**Archivos modificados:**

| Archivo | Cambio |
|---------|--------|
| `lib/sidebar/company-sidebar-config.ts` | `adminOrder?: string[]` en `CompanySidebarConfig`; exports `ADMIN_ORDERABLE_MODULES`, `DEFAULT_ADMIN_MODULE_ORDER`, `getAdminModuleOrder(saved)` |
| `app/api/companies/[id]/sidebar-config/route.ts` | GET agrega `adminOrder`; PUT maneja caso `{ adminOrder: string[] }` (case especial antes del module config) |
| `hooks/use-company-sidebar-config.ts` | `adminOrder: string[]` en `CompanySidebarConfigResponse`; nuevo hook `useUpdateAdminModuleOrder()` |
| `components/layout/Sidebar.tsx` | `administracionItems` usa `adminModuleSectionsMap` (Record key‚ÜíSidebarItem|null) + `getAdminModuleOrder()` para orden din√°mico |
| `components/ventas/configuracion/sidebar-editor.tsx` | Tab "Orden" al inicio; estado `moduleOrder: string[] | null`; `handleSaveOrder()` con `orderMutation`; lista reordenable con ‚Üë‚Üì |

**Comportamiento:**
- Sin config guardada ‚Üí orden default (igual al anterior, sin breaking change)
- Con config ‚Üí sidebar reordenado para todos los usuarios de la empresa
- Restablecer ‚Üí vuelve al orden default
- Solo Dashboard y Agenda quedan fijos en el top ‚Äî todo lo dem√°s es reordenable

**Extensi√≥n ‚Äî Personal, Automatizaciones, Controles, Cargas tambi√©n reordenables:**
- `ADMIN_ORDERABLE_MODULES` extendido a 10 items (personal, ventas, costos, compras, tesoreria, nominas, almacen, automatizaciones, controles, cargas)
- `adminModuleSectionsMap` en Sidebar.tsx incluye los 4 nuevos items
- `administracionItems` simplificado: solo Dashboard + Agenda fijos, `...orderedModuleSections` para todo lo dem√°s
- `getAdminModuleOrder()` ahora hace merge: si el adminOrder guardado no incluye nuevas keys, las agrega al final (backwards compat)

---

### Sidebar ‚Äî Rename / Delete / Custom Groups (sesi√≥n actual)

Feature completa de edici√≥n libre de grupos top-level del sidebar.

**Nuevos tipos en `lib/sidebar/company-sidebar-config.ts`:**
```typescript
export interface CustomAdminGroup {
  name: string;
  icon: string;
  items: string[]; // moduleIds de cualquier registry
}
export interface CompanySidebarConfig {
  // ... m√≥dulos
  adminOrder?: string[];
  sectionLabels?: Record<string, string>; // overrides de nombres para secciones est√°ndar
  customGroups?: Record<string, CustomAdminGroup>; // grupos creados por el admin
}
```
Nuevos helpers: `getModuleItemById(moduleId)`, `getAllLeafItems()` (todos los items con path de todos los m√≥dulos, filtrando `category: 'future'`).

**API `app/api/companies/[id]/sidebar-config/route.ts`:**
- GET: retorna `sectionLabels` y `customGroups` en la response
- PUT: nuevo caso `adminSidebarBatch` ‚Äî actualiza `adminOrder`, `sectionLabels`, `upsertCustomGroups` y `removeCustomGroups` en un solo PUT at√≥mico

**Hook `hooks/use-company-sidebar-config.ts`:**
- `CompanySidebarConfigResponse` ahora incluye `sectionLabels` y `customGroups`
- Nuevo `useUpdateAdminSidebar()` ‚Äî mutation que hace PUT con `{ adminSidebarBatch: batch }`

**`components/layout/Sidebar.tsx`:**
- `allPermissionsMap` ‚Äî useMemo que merge TODOS los permissionsMap individuales (ventas, compras, tesoreria, nominas, almacen, mantenimiento, producci√≥n). **IMPORTANTE**: definido DESPU√âS de `produccionPermissionsMap` para evitar TDZ error.
- `customGroupSections` ‚Äî useMemo que construye `Record<string, SidebarItem | null>` para los custom groups del admin, filtrando por `allPermissionsMap`
- `getSL(key, defaultLabel)` ‚Äî helper para leer overrides de `sectionLabels`
- `adminModuleSectionsMap` spread los custom groups primero, luego los est√°ndar con nombre desde `getSL()`

**`components/ventas/configuracion/sidebar-editor.tsx` ‚Äî Tab Orden redise√±ado:**
- Estado de trabajo local: `workingOrder`, `workingLabels`, `pendingCustomGroups`, `deletedCustomGroups`
- **Inline rename**: click en l√°piz ‚Üí `<Input>` con `<Check>` / `<X>` para confirmar/cancelar
- **Eliminar secci√≥n**: la quita de `workingOrder`; las est√°ndar aparecen en panel "Secciones ocultas" (amber) con bot√≥n "Agregar de vuelta"; los custom groups van a `deletedCustomGroups`
- **Crear grupo nuevo** (Dialog): nombre + select de √≠cono + searchbar de items + checkboxes agrupados por m√≥dulo (`getAllLeafItems()`)
- **Guardar** (un solo PUT): construye batch con `adminOrder`, `sectionLabels` (delta), `upsertCustomGroups` (pendientes), `removeCustomGroups` (eliminados)
- **Restablecer**: `DEFAULT_ADMIN_MODULE_ORDER` + labels vac√≠os + no tocar custom groups

**Bug fix cr√≠tico ‚Äî allPermissionsMap en posici√≥n incorrecta:**
En la sesi√≥n anterior, `allPermissionsMap` se hab√≠a colocado en l√≠nea 436, antes de que `mantenimientoPermissionsMap` (l√≠nea 615) y `produccionPermissionsMap` (l√≠nea 701) fueran definidos ‚Äî causando TDZ error en runtime. Movido a l√≠nea 725, despu√©s de ambos.

---

### Sidebar ‚Äî Modo edici√≥n directo desde el sidebar (sesi√≥n actual)

El admin ya no necesita ir a la p√°gina de configuraci√≥n para editar el sidebar. Se implement√≥ un modo edici√≥n completo que se activa desde el propio sidebar.

**Archivos creados/modificados:**

| Acci√≥n | Archivo |
|--------|---------|
| Creado | `components/layout/sidebar-edit-mode.tsx` ‚Äî componente completo (~620 l√≠neas) |
| Modificado | `components/layout/Sidebar.tsx` ‚Äî bot√≥n "Editar sidebar" + renderizado condicional |
| Modificado | `app/administracion/configuracion/page.tsx` ‚Äî eliminado tab "Navegaci√≥n" + import SidebarEditor |
| Eliminado | `components/ventas/configuracion/sidebar-editor.tsx` ‚Äî reemplazado por edit mode |

**`components/layout/sidebar-edit-mode.tsx`:**
- DnD top-level: `DndContext + SortableContext + useSortable` con `PointerSensor (distance: 8)`
- `SortableSectionRow`: drag handle (GripVertical), rename inline (Pencil ‚Üí Input + Check/X), delete (Trash2)
- Expand sections tipo "m√≥dulo" ‚Üí expone grupos internos como draggables (DndContext propio)
- `SortableGroupRow`: grupos con su propio `DndContext` para los items
- `SortableItemRow`: items con dropdown "Mover a grupo" (Select) para cross-group moves
- Panel "Secciones ocultas": secciones eliminadas con bot√≥n Restaurar
- Dialog "Nuevo grupo": nombre + icon selector + buscador + checkboxes por m√≥dulo
- Save: `useUpdateAdminSidebar()` (batch top-level) + `useUpdateCompanySidebarConfig()` (por m√≥dulo modificado)
- Cancel: simplemente llama `onExitEditMode()` ‚Äî state local no se persiste

**`Sidebar.tsx`:**
- `canModifySidebar = ['ADMIN', 'ADMIN_ENTERPRISE', 'SUPERADMIN'].includes(user?.role?.toUpperCase() ?? '')`
- Bot√≥n "Editar sidebar" visible solo en √°rea Administraci√≥n + canModifySidebar + !isSidebarEditMode
- Renderizado condicional: `{isSidebarEditMode ? <SidebarEditMode ... /> : <normal items />}`

### Next Session

- Testear en el browser: drag & drop de secciones, rename, delete, restore, crear grupo custom
- Si `prisma migrate dev` sigue fallando, investigar migraciones rotas de `work_orders` o usar `baseline`

---

## Sesi√≥n 3 ‚Äî Feature A ajustes + Feature B Sistema de Cotizaciones

### Feature A ‚Äî Ajustes finales del wizard Step 2

**Cambios al layout 20/80 (pedido por el usuario):**
- Eliminado panel derecho (KPIs + include/exclude + nav) ‚Üí layout cambi√≥ de 20/60/20 a **20/80**
- Items table: agregado sub-rows para `costBreakdown` de cada item (concepto + monto con bullet indent)
- Fix: `Fragment` importado desde react para keys en el map de items con sub-rows

**API ventas-disponibles (ya hab√≠a sido actualizada):**
- Campos de factura: `fechaEmision`, `fechaVencimiento`, `netoGravado`, `iva21`, `iva105`, `condicionesPago`

### Feature B ‚Äî Sistema de Cotizaciones Configurable

**Prisma schema (`prisma/schema.prisma`):**
- Nuevo modelo `QuoteTemplate` con: visual (logo, colores, tipograf√≠a), columnas (JSON), firma, aprobaci√≥n online, presets de pago
- Relaci√≥n `Company ‚Üí quoteTemplates QuoteTemplate[]`
- Campo `Quote.templateId Int?` + relaci√≥n `template QuoteTemplate?`
- **Migraci√≥n pendiente** ‚Äî el usuario debe correr: `npx prisma migrate dev --name add_quote_template`

**API routes:**
| Archivo | Descripci√≥n |
|---------|-------------|
| `app/api/configuracion/cotizaciones/route.ts` | GET list + POST create |
| `app/api/configuracion/cotizaciones/[id]/route.ts` | GET + PATCH + DELETE |

**Builder UI:**
- `app/administracion/configuracion/cotizaciones/page.tsx` ‚Äî p√°gina completa con:
  - Selector de templates (tabs arriba)
  - Panel izquierdo (40%): 4 tabs ‚Äî Visual | Columnas | Firma | Condiciones
  - Panel derecho (60%): preview en tiempo real con datos de muestra
  - `ColumnSorter`: toggle visible + rename + reordenar con ‚ñ≤‚ñº
  - `PaymentPresetsEditor`: lista de condiciones con add/edit/delete inline
  - `TemplatePreview`: render del documento con colores, tipograf√≠a, tabla de items, firma, watermark

**Integraci√≥n:**
- `app/administracion/configuracion/page.tsx`: tab "Cotizaciones" en sub-tabs de Empresa ‚Üí bot√≥n que navega al editor

**Migraci√≥n aplicada v√≠a SQL directo (mismo patr√≥n que otras migraciones):**
```bash
/opt/homebrew/bin/node -e "
const { Client } = require('/path/to/node_modules/pg');
// CREATE TABLE quote_templates (29 columnas)
// ALTER TABLE quotes ADD COLUMN templateId INT REFERENCES quote_templates(id)
"
```

---

## Sesi√≥n 4 ‚Äî Detalle de facturas + historial de pagos + datos de ejemplo

### Redise√±o visual del detalle de factura (Step 2 wizard)

**Problema:** usuario dijo "El dise√±o visual no me convence".

**Nuevo dise√±o ‚Äî estado cerrado:**
- Barra vertical de color (estado) a la izquierda
- N√∫mero de factura en color del estado + pill estado + fecha
- Total + indicador de cobranza ("‚úì COBRADA" / "75% cobrado" / "Sin cobrar")
- Barra de progreso h-1 al pie de la card

**Nuevo dise√±o ‚Äî estado expandido:**
- Grid 3 columnas con dividers: Emitida | Vencimiento | Condici√≥n de pago
- Grid IVA: Neto gravado | IVA 21% | IVA 10.5% (solo si hay valores)
- Grid cobranza: Total | Cobrado | Saldo pendiente
- Barra h-2 con porcentaje
- **Historial de pagos completo** (ver abajo)

### Historial de pagos en facturas

**API actualizada** (`app/api/ventas/liquidaciones/ventas-disponibles/route.ts`):
- Agregado `paymentAllocations` al select de invoices con cadena completa:
  `InvoicePaymentAllocation ‚Üí ClientPayment ‚Üí ClientPaymentCheque`
- Campos: n√∫mero de cobro, fecha, medios (efectivo/transferencia/tarjeta), banco, referencia, cheques (tipo/n√∫mero/banco/titular/importe/vencimiento/estado)

**Interfaces agregadas** (en `nueva/page.tsx`):
- `ChequeRef` ‚Äî tipo, numero, banco, titular, importe, fechaVencimiento, estado
- `PaymentAllocationRef` ‚Äî montoAplicado, fechaAplicacion, payment (con todos los medios y cheques)

**UI del historial:**
- Por cada imputaci√≥n: header "Cobro #XXXX ‚Äî DD/MM/YYYY ‚Äî $importe"
- Medios mostrados: efectivo (importe), transferencia (banco + ref), tarjeta (importe)
- Cheques: card por cada cheque con tipo/n√∫mero/banco/titular/importe/vencimiento + badge de estado
- Fallback: si cobrada pero sin imputaciones ‚Üí "Cobrado $X ¬∑ sin detalle de imputaciones registrado"

**Fix:** el fallback de "sin pagos" no aparec√≠a en facturas COBRADAS sin imputaciones porque la condici√≥n era `cobradoInv === 0`. Corregido para que siempre se muestre.

### Datos de ejemplo ‚Äî cobros para vendedor Messi

8 cobros creados con variedad de medios de pago:

| N√∫mero | Factura | Medio | Detalle |
|--------|---------|-------|---------|
| COB-2025-00001 | inv 18 | Transferencia | Banco Galicia ¬∑ ref TRF-2025-001847 ¬∑ $70.724,50 |
| COB-2025-00002 | inv 19 | Efectivo | $43.832,25 (cobro parcial) |
| COB-2025-00003 | inv 21 | Cheque tercero | N¬∞ 12345678 ¬∑ Banco Santander ¬∑ Distribuidora El Sol SRL ¬∑ $35.362,25 |
| COB-2025-00004 | inv 22 | Transferencia | BBVA ¬∑ ref TRF-2025-003291 ¬∑ $50.000 |
| COB-2025-00005 | inv 22 | Efectivo | $37.664,50 (saldo de la misma factura) |
| COB-2025-00006 | inv 23 | 2 cheques | Banco Naci√≥n N¬∞ 98765432 (DEPOSITADO) + Banco Galicia N¬∞ 11223344 (COBRADO) |
| COB-2025-00007 | inv 24 | Efectivo + Tarjeta | $30.000 efectivo + $40.724,50 VISA ref VISA-7890123456 |
| COB-2025-00008 | inv 27 | Transferencia + retenciones | Banco Macro ¬∑ CBU-20260105-0098 ¬∑ retenciones IVA/Ganancias/IB |

Para ver el resultado: `/administracion/ventas/liquidaciones/nueva` ‚Üí Step 2 ‚Üí expandir cualquier factura de Messi.

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Auditor√≠a y cleanup de configuraci√≥n Claude Code (Sesi√≥n 5)

### Session Overview
- **Date**: 2026-02-22 (quinta sesi√≥n)
- **Focus Area**: Auditor√≠a completa y mejora de toda la configuraci√≥n de Claude Code

### What Was Done

#### Completed
- [x] Auditor√≠a exhaustiva: 16 skills, 2 rules, 3 settings.json, CLAUDE.md, MEMORY.md, debugging.md
- [x] **CLAUDE.md** actualizado:
  - Agregada secci√≥n "Skills y Workflow" con tabla completa de skill ‚Üí tarea
  - Agregada secci√≥n "Discord Bot ‚Äî Servicio Standalone" con arquitectura nueva
  - Actualizado project structure (hooks/mantenimiento, hooks/produccion)
  - Agregadas notas: auth role mismatch + discord bot usage
- [x] **commit/SKILL.md** ‚Äî "Claude Sonnet 4.6" ‚Üí "Claude" (no hardcodear modelo)
- [x] **pr/SKILL.md** ‚Äî √≠dem
- [x] **orvit-discord/SKILL.md** ‚Äî reescritura completa: arquitectura standalone, HTTP API, bot-service-client, env vars separadas (bot service vs orvit)
- [x] **workflow-rules.md** ‚Äî path del template expl√≠cito, tabla de skills con "Cu√°ndo usar"
- [x] **MEMORY.md** ‚Äî reorganizado: m√°s conciso, sin redundancia con CLAUDE.md/workflow-rules, trampas conocidas consolidadas
- [x] **settings.json** ‚Äî 3 archivos simplificados:
  - User-level: de ~60 reglas espec√≠ficas ‚Üí permisos amplios por comando base
  - Parent-level: solo daily-logs Write/Edit + additionalDirectories
  - Project-level: vaciado (redundante con parent)

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `orvit-v1/CLAUDE.md` | modified | Skills table + Discord standalone + auth notes |
| `.claude/skills/commit/SKILL.md` | modified | Co-Authored-By sin modelo hardcodeado |
| `.claude/skills/pr/SKILL.md` | modified | √çdem |
| `.claude/skills/orvit-discord/SKILL.md` | rewritten | Arquitectura standalone completa |
| `.claude/rules/workflow-rules.md` | modified | Template path + skills table |
| `~/.claude/projects/.../memory/MEMORY.md` | rewritten | Conciso, sin redundancia |
| `~/.claude/settings.json` | rewritten | Permisos amplios, sin cruft |
| `Orvit/.claude/settings.json` | simplified | Solo daily-logs + directories |
| `Orvit/Orvit/.claude/settings.json` | emptied | Redundante |

### Skills Used
- Ninguno (sesi√≥n de configuraci√≥n, no de c√≥digo)

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Sistema pre-flight anti-retrabajo (Sesi√≥n 6)

### Session Overview
- **Date**: 2026-02-22 (sexta sesi√≥n)
- **Focus Area**: Investigaci√≥n de patrones de retrabajo + creaci√≥n de sistema preventivo

### What Was Done

#### Completed
- [x] An√°lisis de 20+ sesiones previas para identificar causas de retrabajo
- [x] Identificados 3 patrones principales:
  1. Dise√±o visual sin referencia ‚Üí iteraciones (wizard Step 2: 3 rondas)
  2. Scope creep mid-task ‚Üí "ah y tambi√©n mostr√° X" (facturas: simple ‚Üí completo)
  3. Campos incorrectos ‚Üí `fecha` vs `fechaEmision` (5 archivos arreglados)
- [x] Creada regla pre-flight (`.claude/rules/pre-flight-rules.md`) con 5 puntos de verificaci√≥n
- [x] Creada gu√≠a para el usuario (`.claude/rules/como-pedir.md`) con template y tips
- [x] Actualizada MEMORY.md con referencia a regla pre-flight (#3)

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `.claude/rules/pre-flight-rules.md` | created | Regla 3: 5 puntos de verificaci√≥n antes de implementar |
| `.claude/rules/como-pedir.md` | created | Gu√≠a r√°pida para el usuario sobre c√≥mo pedir tareas |
| `~/.claude/projects/.../memory/MEMORY.md` | modified | Agregada regla #3 pre-flight |

### Decisions Made
- **M√°ximo 1-2 preguntas**: an√°lisis mostr√≥ que preguntar 5+ cosas antes de empezar genera fricci√≥n y el usuario ignora. Mejor inferir lo que se pueda.
- **Mockup ASCII para dise√±o**: cuando no hay referencia visual, proponer mockup en texto antes de implementar ‚Äî m√°s r√°pido que implementar y rehacer.
- **Verificar schema.prisma siempre**: los nombres de campos son la causa #3 de retrabajo. Leer el modelo antes de escribir c√≥digo.

### Skills Used
- Ninguno (sesi√≥n de an√°lisis y configuraci√≥n)

### Next Session
- Testear el sistema pre-flight con una tarea real vaga ‚Üí Claude deber√≠a hacer 1-2 preguntas espec√≠ficas
- Pendientes anteriores: testear rename/delete/custom groups en browser, investigar migraciones rotas

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Sistema de aprendizaje continuo (Sesi√≥n 7)

### Session Overview
- **Date**: 2026-02-22 (s√©ptima sesi√≥n)
- **Focus Area**: Crear sistema de memoria tem√°tica auto-alimentada

### What Was Done

#### Completed
- [x] Creado `errores-comunes.md` ‚Äî 11 errores catalogados por categor√≠a (Frontend, API, Prisma, Tooling)
- [x] Creado `preferencias-usuario.md` ‚Äî gustos de dise√±o, info, organizaci√≥n y workflow
- [x] Creado `decisiones.md` ‚Äî decisiones arquitect√≥nicas por m√≥dulo (Ventas, Sidebar, Discord, DB, Auth)
- [x] Creado `patrones-codigo.md` ‚Äî 8 patrones reutilizables con c√≥digo de ejemplo
- [x] Creado `.claude/rules/auto-learning-rules.md` ‚Äî triggers para actualizar memoria autom√°ticamente
- [x] Reescrito `MEMORY.md` como √≠ndice con links a archivos tem√°ticos + tabla de cu√°ndo consultar cada uno
- [x] Eliminado `debugging.md` (migrado a errores-comunes.md)

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `memory/errores-comunes.md` | created | Cat√°logo de 11 errores por categor√≠a |
| `memory/preferencias-usuario.md` | created | Preferencias de dise√±o y workflow |
| `memory/decisiones.md` | created | Decisiones arquitect√≥nicas por m√≥dulo |
| `memory/patrones-codigo.md` | created | 8 patrones reutilizables con c√≥digo |
| `memory/MEMORY.md` | rewritten | Convertido en √≠ndice con links a tem√°ticos |
| `memory/debugging.md` | deleted | Reemplazado por errores-comunes.md |
| `.claude/rules/auto-learning-rules.md` | created | Regla 4: triggers de auto-aprendizaje |

### Decisions Made
- **MEMORY.md como √≠ndice**: Se carga siempre en el system prompt (200 l√≠neas max). Los topic files se consultan bajo demanda. Balance entre contexto siempre disponible y detalle cuando se necesita.
- **Append, no rewrite**: Los archivos de memoria crecen acumulativamente. Solo se borran entries incorrectos.
- **Seed con datos reales**: Todos los archivos arrancaron con contenido extra√≠do de 3 daily logs (20, 21, 22 feb) ‚Äî no est√°n vac√≠os.

### Skills Used
- Ninguno (sesi√≥n de configuraci√≥n)

### Next Session
- Testear auto-aprendizaje: fixear un bug y verificar que se agregue a errores-comunes.md
- Pendientes: testear rename/delete/custom groups en browser

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Bug fix + Mejoras Sprint 1/2 Liquidaciones & Vendedores (Sesi√≥n 8)

### Session Overview
- **Date**: 2026-02-22 (octava sesi√≥n)
- **Focus Area**: Bug fix OV selection + mejoras UX en wizard y listado de vendedores

### Sprint 1 ‚Äî Bug fixes

**Bug: Checkbox OV en Step 2 bloqueado**
- Causa: `onClick={(e) => e.stopPropagation()}` directo en `<Checkbox>` shadcn/ui (Radix) no intercepta el evento de forma confiable
- Fix: `<div onClick={(e) => e.stopPropagation()}>` como wrapper externo ‚Üí el stopPropagation opera sobre el DOM nativo
- Archivo: `nueva/page.tsx` l√≠nea 724

### Sprint 2 ‚Äî Mejoras UX (4 mejoras)

**A1: Filtro de cobranza ‚Äî panel izq. Step 2**
- Estado: `filterCobranza: 'all' | 'cobrada' | 'parcial' | 'sin_cobrar'`
- Toggle 4 botones en header del panel izq.
- `sortedVentas` filtra por `porcentajeCobrado` (100% / 0<x<100% / 0%)

**A2: Resumen sticky ‚Äî panel izq. Step 2**
- Footer `bg-muted/30` encima del bot√≥n "Incluir todas"
- Muestra en tiempo real: OVs incluidas | Total ($) | Comisi√≥n (%)

**C2: Alertas de cuota ‚Äî listado de vendedores**
- Card "Rendimiento": porcentaje real + badge "N bajo cuota" si alguno < 70%
- Filas de tabla: `bg-red-50/50` + √≠cono AlertTriangle en rojo cuando < 70%
- Barra de progreso coloreada (verde/√°mbar/rojo) por vendedor

**C3: Tab "Liquidaciones" ‚Äî perfil del vendedor**
- Tabs "Resumen" | "Liquidaciones" encima del contenido
- Carga lazy: `GET /api/ventas/liquidaciones?sellerId={id}` solo al abrir el tab
- Tabla con N√∫mero, Per√≠odo, Estado, OVs, Total, Comisi√≥n, A pagar + link al detalle

### Files Modified
| Archivo | Cambio |
|---------|--------|
| `app/administracion/ventas/liquidaciones/nueva/page.tsx` | Bug checkbox + A1 + A2 |
| `app/administracion/ventas/vendedores/page.tsx` | C2 alertas de cuota |
| `app/administracion/ventas/vendedores/[id]/page.tsx` | C3 tab Liquidaciones |

### Pattern Learned
- **Radix UI stopPropagation**: siempre usar `<div onClick={...}>` externo ‚Äî nunca pasar `onClick` al componente Radix directamente

### Next Session ‚Äî Sprint 3 pendiente
- √çndice DB: `Sale(sellerId, fechaEmision, companyId)`
- Motivo de exclusi√≥n inline en Step 2
- Reglas de comisi√≥n escalonadas en liquidaciones

---

## üõ†Ô∏è LOG T√âCNICO ‚Äî Skills de frontend + sistema de aprendizaje (Sesi√≥n 9)

### Session Overview
- **Date**: 2026-02-22 (novena sesi√≥n)
- **Focus Area**: Investigaci√≥n e instalaci√≥n de skills externas para mejorar calidad visual del frontend

### What Was Done

#### Completed
- [x] Investigaci√≥n exhaustiva de skills externas: npmx.dev, GitHub, awesome-claude-skills, awesome-cursorrules, Google Labs, Anthropic official
- [x] Identificadas 28+ skills/recursos relevantes para frontend
- [x] Instaladas 3 skills nuevas:
  - `frontend-design` (Anthropic oficial) ‚Äî direcci√≥n est√©tica, anti-"AI slop", tipograf√≠a, color, motion, composici√≥n
  - `shadcn-ui` (Google Labs Stitch) ‚Äî gu√≠a experta shadcn/ui con 326 l√≠neas + resources + examples
  - `enhance-prompt` (Google Labs Stitch) ‚Äî mejora de prompts de dise√±o con vocabulario UI/UX
- [x] Actualizado `orvit-frontend/SKILL.md` ‚Äî agregadas secciones de pulido visual:
  - Spacing scale (escala 4px), tipograf√≠a hierarchy, sombras/elevaci√≥n, hover states
  - Transiciones (150ms/200ms/300ms), bordes/radius, densidad, feedback visual, accesibilidad
  - 5 anti-patterns nuevos agregados
- [x] Actualizado `CLAUDE.md` ‚Äî 3 skills nuevas en tabla de skills

#### Sistema de aprendizaje continuo (misma sesi√≥n)
- [x] Creados 4 archivos de memoria tem√°ticos (errores-comunes, preferencias-usuario, decisiones, patrones-codigo)
- [x] Creada regla auto-learning-rules.md
- [x] MEMORY.md convertido en √≠ndice con links

### Files Modified
| File | Action | Reason |
|------|--------|--------|
| `.claude/skills/frontend-design/SKILL.md` | created | Anthropic official ‚Äî direcci√≥n est√©tica |
| `.claude/skills/shadcn-ui/SKILL.md` | created | Google Labs ‚Äî gu√≠a shadcn/ui completa |
| `.claude/skills/shadcn-ui/resources/*` | created | Component catalog, customization, setup, migration guides |
| `.claude/skills/shadcn-ui/examples/*` | created | Auth layout, data table, form pattern examples |
| `.claude/skills/enhance-prompt/SKILL.md` | created | Google Labs ‚Äî prompt enhancement pipeline |
| `.claude/skills/enhance-prompt/references/KEYWORDS.md` | created | UI vocabulary and adjective palettes |
| `.claude/skills/orvit-frontend/SKILL.md` | modified | Agregadas reglas de pulido visual (spacing, tipograf√≠a, sombras, hover, transiciones, bordes, densidad, feedback, accesibilidad) |
| `orvit-v1/CLAUDE.md` | modified | 3 skills nuevas en tabla |
| `memory/errores-comunes.md` | created | 11 errores catalogados |
| `memory/preferencias-usuario.md` | created | Gustos de dise√±o y workflow |
| `memory/decisiones.md` | created | Decisiones arquitect√≥nicas por m√≥dulo |
| `memory/patrones-codigo.md` | created | 8 patrones reutilizables |
| `.claude/rules/auto-learning-rules.md` | created | Triggers de auto-aprendizaje |
| `memory/MEMORY.md` | rewritten | √çndice con links a tem√°ticos |

### Skills Used
- Ninguno (sesi√≥n de investigaci√≥n y configuraci√≥n)

### Next Session
- Probar las skills nuevas con una tarea de frontend real
- Sprint 3 pendiente: √≠ndice DB, motivo exclusi√≥n, comisiones escalonadas

---

## ‚úÖ Sesi√≥n 10 ‚Äî Template Builder Avanzado (Cotizaciones)

### Resumen Ejecutivo

Se mejor√≥ completamente el builder de templates de cotizaciones, que antes mostraba solo un "boceto fijo". Ahora el usuario puede:

1. **Elegir entre 5 estilos predise√±ados** (Minimal, Profesional, Moderno, Cl√°sico, T√©cnico) desde una galer√≠a de mini-previews encima del editor
2. **Personalizar el layout del header**: 4 variantes visuales (Classic, Centrado, Banner de color, Compacto) con pickers visuales
3. **Configurar separadores**: 4 estilos (s√≥lido, punteado, doble, ninguno) + 3 grosores (fino/medio/grueso)
4. **Personalizar la tabla**: filas alternadas (zebra), relleno del header, radio de bordes
5. **Logo con 3 tama√±os y 4 posiciones** (izquierda, centrado, derecha, ninguno)
6. La **preview en tiempo real** muestra exactamente c√≥mo queda el documento

### Log T√©cnico

**DB**: Migraci√≥n directa SQL agregando 8 columnas a `quote_templates`:
- `headerLayout`, `logoSize`, `separatorStyle`, `separatorWeight`, `tableZebraRows`, `tableHeaderFill`, `tableBorderRadius`, `preset`

**Prisma schema**: Actualizado con los 8 nuevos campos + `npx prisma generate` ejecutado

**API** (`app/api/configuracion/cotizaciones/route.ts` y `[id]/route.ts`): Zod schemas actualizados con los 8 nuevos campos

**Frontend** (`app/administracion/configuracion/cotizaciones/page.tsx`): Reescritura completa (~1367 l√≠neas)
- Tipos TypeScript: `HeaderLayout`, `LogoSize`, `SeparatorStyle`, `SeparatorWeight`, `TableBorderRadius`
- Constante `PRESETS` con 5 configuraciones predise√±adas
- Helper `getSepBorder()` para calcular CSS border-top seg√∫n estilo+grosor
- `TemplatePreview` con 4 variantes de header via `renderHeader()` switch
- `PresetMiniPreview`: mini-preview CSS-only de 72x96px para la galer√≠a
- 5 tabs: Visual | Dise√±o | Columnas | Firma | Condiciones
- Tab "Dise√±o": pickers visuales para separadores + opciones de tabla

### Files Modified
| File | Action |
|------|--------|
| `orvit-v1/prisma/schema.prisma` | +8 campos en QuoteTemplate |
| `orvit-v1/app/api/configuracion/cotizaciones/route.ts` | Zod + create con nuevos campos |
| `orvit-v1/app/api/configuracion/cotizaciones/[id]/route.ts` | Zod updateSchema |
| `orvit-v1/app/administracion/configuracion/cotizaciones/page.tsx` | Reescritura completa |

### Skills Used
- `orvit-frontend`
