# Daily Log — 2026-02-24

## Resumen Ejecutivo

### Sidebar — Sistema de Favoritos
- Usuarios pueden "starear" cualquier ítem del sidebar y verlo desde cualquier módulo
- Persiste en `User.sidebarPreferences.favorites` (campo JsonB en Postgres)
- API: `GET/PUT /api/user/sidebar/favorites`
- Hook: `use-sidebar-favorites.ts` con TanStack Query + optimistic updates
- Fix crítico: ruta usaba `getToken` (inexistente) → corregido a `cookies() + verifyToken`

### Comprobante Form — Más mejoras (sesión 2)
- Tecla `.` del teclado numérico actúa como `,` en TODOS los campos monetarios: Cantidad, Precio Unitario, IVA 21%, Percep IVA, Percep IIBB y todos los demás campos de totales
- Autocomplete por Cód. Prov.: ahora se dispara al presionar Enter (no en cada tecla) → busca el ítem, lo rellena y salta a Cantidad
- Flujo teclado tabla ítems: Cód.Prov → Enter → Cantidad → Enter → Precio Unitario (saltea Unidad, ya viene del ítem)
- Fix total incorrecto: `calculateTotal` llamaba `normalizeMoneyInput` sobre valores ya normalizados (`"181953.20"`) → eliminaba el punto decimal → montos ×100. Fix: `parseFloat` directo sin normalizar
- DELETE factura: ahora elimina en cascada remitos, devoluciones y NCAs vinculadas (antes solo desvinculaba)
- DELETE OP: revierte fondos — elimina CashMovements, BankMovements y SupplierAccountMovements asociados
- Tablas `credit_debit_notes` y `credit_debit_note_items` creadas en DB (faltaban, causaban 500 en DELETE comprobante)

### Comprobante Form — Mejoras
- Modal más ancho: `size="2xl"` (90vw)
- Eliminado campo Fecha de Imputación
- Fecha de Vencimiento: auto-completa año actual (estaba hardcodeado 2025)
- IVA 21%: fix en cálculo (`parseFloat(formatNumber(...))` rompía con números grandes → ahora `Math.round(neto * 0.21 * 100) / 100`)
- Todos los campos monetarios editables (iva21, noGravado, impInter, percepcionIVA, percepcionIIBB, otrosConceptos, iva105, iva27, exento, iibb): patrón `rawInputs` — se puede tipear libremente sin límite de 1 dígito
- Cantidad y Precio Unitario en tabla de ítems: formato argentino (188.826,48), `type="text"` con `normalizeMoneyInput` en onChange
- Subtotal read-only: también formateado en estilo argentino

### Git
- Commit y push de 1023 archivos acumulados a `main`
- Fix de auth en favoritos commiteado pendiente de push

### Máquinas — Mobile UI (sesión 3)
- `QRCodeGenerator`: botón icon-only en mobile, texto completo en desktop
- `MachineDetailHeader`: KPI toggle movido a 3-dot menu (item mobile-only `sm:hidden`); removido botón separado
- `MachineMaintenanceTab`: scroll removido, KPIs en 4 cols compactas en mobile, toolbar 2 filas centrada en mobile
- `MachineDetailDialog`: `border-b` removido del header (venía hardcodeado en `DialogBody` base → fix con `border-none` en className); scrollbar oculto con `hide-scrollbar` en TabsList principal
- Sub-tabs (Preventivo/Correctivo): `w-fit h-7` centrado, mismo en desktop; `hide-scrollbar` agregado
- `MachineFailuresTab`: KPIs ocultables (toggle "KPIs" mobile-only junto a Reportar, default oculto); toolbar 3 filas en mobile (`sm:contents` para preservar desktop); selects envueltos en `sm:w-[120px] sm:flex-none` para que search tome espacio restante; KPI cards 3 cols mobile más compactas
- `FailureQuickReportDialog`: fix scroll — `<form>` necesitaba `flex flex-col flex-1 min-h-0` para que `DialogBody` con `flex-1 overflow-y-auto` funcionara

---

## Log Técnico

### Archivos creados/modificados
- `app/api/user/sidebar/favorites/route.ts` — CREADO + fix auth
- `hooks/use-sidebar-favorites.ts` — CREADO
- `components/layout/Sidebar.tsx` — favoritos section, star buttons, HARDCODED_ITEMS, moduleId en todos los ítems
- `components/compras/comprobante-form-modal.tsx` — múltiples fixes
- `components/ui/dialog.tsx` — tamaño 2xl agregado
- `components/maquinas/QRCodeGenerator.tsx` — responsive trigger buttons
- `components/maquinas/MachineDetailHeader.tsx` — KPI toggle en 3-dot menu
- `components/maquinas/MachineDetailDialog.tsx` — border-none en header, hide-scrollbar en TabsList
- `components/maintenance/MachineMaintenanceTab.tsx` — mobile layout KPIs + toolbar + sub-tabs compactos
- `components/maquinas/MachineFailuresTab.tsx` — KPI toggle, toolbar responsive, selects con ancho fijo desktop
- `components/corrective/failures/FailureQuickReportDialog.tsx` — fix scroll form

### Trampas encontradas hoy
- `getToken` NO existe en `lib/auth.ts` — usar `cookies() + verifyToken` (igual que otras rutas)
- `parseFloat(formatNumber(n, 2))` rompe con números grandes en formato es-AR (el punto de miles corta el parse)
- Python script necesario para edits cuando la indentación del archivo es un solo espacio (Edit tool falla con mismatch)
- `calculateTotal` NO debe llamar `normalizeMoneyInput` — los valores de `formData` ya son floats JS (`"181953.20"`); normalizarlos de nuevo elimina el punto decimal y multiplica ×100
- `normalizeMoneyInput` es destructivo sobre floats JS: `"1273672.37"` → elimina `.` → `"127367237"` (no usar sobre valores ya normalizados)
- Para inputs controlados de React, `requestAnimationFrame` es más confiable que `setTimeout(0)` para restaurar cursor después de actualizar state
- `DialogHeader` base tiene `border-b` hardcodeado → sobrescribir con `border-none` en el className del uso
- La clase de este proyecto para ocultar scrollbar es `hide-scrollbar` (definida en `globals.css`), NO `scrollbar-hide`
- `sm:contents` en wrappers: los hijos se vuelven flex items del abuelo; los Select necesitan wrapper `sm:w-[Xpx] sm:flex-none` para tener ancho fijo en desktop
- `<form>` dentro de Dialog necesita `flex flex-col flex-1 min-h-0` para que `DialogBody` (con `flex-1 overflow-y-auto`) pueda scrollear
