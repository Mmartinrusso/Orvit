# Daily Log — 2026-02-24

## Resumen Ejecutivo

### Sidebar — Sistema de Favoritos
- Usuarios pueden "starear" cualquier ítem del sidebar y verlo desde cualquier módulo
- Persiste en `User.sidebarPreferences.favorites` (campo JsonB en Postgres)
- API: `GET/PUT /api/user/sidebar/favorites`
- Hook: `use-sidebar-favorites.ts` con TanStack Query + optimistic updates
- Fix crítico: ruta usaba `getToken` (inexistente) → corregido a `cookies() + verifyToken`

### Comprobante Form — Más mejoras (sesión 2)
- Tecla `.` del teclado numérico actúa como `,` en TODOS los campos monetarios: Cantidad, Precio Unitario, IVA 21%, Percep IVA, Percep IIBB y todos los demás campos de totales
- Autocomplete por Cód. Prov.: ahora se dispara al presionar Enter (no en cada tecla) → busca el ítem, lo rellena y salta a Cantidad
- Flujo teclado tabla ítems: Cód.Prov → Enter → Cantidad → Enter → Precio Unitario (saltea Unidad, ya viene del ítem)
- Fix total incorrecto: `calculateTotal` llamaba `normalizeMoneyInput` sobre valores ya normalizados (`"181953.20"`) → eliminaba el punto decimal → montos ×100. Fix: `parseFloat` directo sin normalizar
- DELETE factura: ahora elimina en cascada remitos, devoluciones y NCAs vinculadas (antes solo desvinculaba)
- DELETE OP: revierte fondos — elimina CashMovements, BankMovements y SupplierAccountMovements asociados
- Tablas `credit_debit_notes` y `credit_debit_note_items` creadas en DB (faltaban, causaban 500 en DELETE comprobante)

### Comprobante Form — Mejoras
- Modal más ancho: `size="2xl"` (90vw)
- Eliminado campo Fecha de Imputación
- Fecha de Vencimiento: auto-completa año actual (estaba hardcodeado 2025)
- IVA 21%: fix en cálculo (`parseFloat(formatNumber(...))` rompía con números grandes → ahora `Math.round(neto * 0.21 * 100) / 100`)
- Todos los campos monetarios editables (iva21, noGravado, impInter, percepcionIVA, percepcionIIBB, otrosConceptos, iva105, iva27, exento, iibb): patrón `rawInputs` — se puede tipear libremente sin límite de 1 dígito
- Cantidad y Precio Unitario en tabla de ítems: formato argentino (188.826,48), `type="text"` con `normalizeMoneyInput` en onChange
- Subtotal read-only: también formateado en estilo argentino

### Git
- Commit y push de 1023 archivos acumulados a `main`
- Fix de auth en favoritos commiteado pendiente de push

### Android Back Button — Sistema global (sesión 4)
- Hardware back button de Samsung/Android ahora cierra modales en vez de navegar para atrás
- Estrategia: `history.pushState({ __modal: true })` al abrir modal, `popstate` listener llama handler en vez de navegar
- `lib/back-stack.ts` — stack global de handlers (push/pop al abrir/cerrar modales)
- `hooks/use-modal-back.ts` — hook React que registra/desregistra handler según `isOpen`
- `components/ui/dialog.tsx` — `Dialog` convertido de re-export a wrapper con `useModalBack`
- `components/ui/sheet.tsx` — igual para Sheet
- Cobertura: **todos** los Dialog y Sheet del sistema sin cambiar ningún consumidor
- Tradeoff aceptado: cierre programático deja 1 entrada huérfana en el historial (un back extra "no hace nada")
- Build: ✓ sin errores nuevos

### UnitsToolbar — Reestructura completa (sesión 4)
- Botones flotantes en 2 filas → `flex-nowrap shrink-0` resuelve
- Título "Unidades Móviles" no visible → `flex-1` en contenedor izquierdo
- Refresh/Download: `hidden sm:flex` (solo desktop)
- Botones secundarios (Seleccionar, Cargar Km, Mostrar resumen) movidos a action bar en toolbar
- Calendar view añadido al toggle de vistas
- Duplicate view mode toggle en content area eliminado
- "Nueva Unidad": siempre visible (icon en mobile, icon+text en sm+)
- Nuevas props: `hasUnidades`, `selectionMode`, `onToggleSelectionMode`, `showDashboard`, `onToggleDashboard`, `onLoadKilometrajeMasivo`

### CRUD Audit (sesión 4)
- 3 agentes paralelos auditaron todo el sistema buscando fetch manuales sin invalidación
- 1 bug real encontrado: `ComponentDetailsModal` PATCH no refrescaba UI → fixed con `onClose()` + `onDeleted?.()`
- 4 candidatos eran falsos positivos (callbacks + invalidation via otros caminos)

### Máquinas — Mobile UI (sesión 3)
- `QRCodeGenerator`: botón icon-only en mobile, texto completo en desktop
- `MachineDetailHeader`: KPI toggle movido a 3-dot menu (item mobile-only `sm:hidden`); removido botón separado
- `MachineMaintenanceTab`: scroll removido, KPIs en 4 cols compactas en mobile, toolbar 2 filas centrada en mobile
- `MachineDetailDialog`: `border-b` removido del header (venía hardcodeado en `DialogBody` base → fix con `border-none` en className); scrollbar oculto con `hide-scrollbar` en TabsList principal
- Sub-tabs (Preventivo/Correctivo): `w-fit h-7` centrado, mismo en desktop; `hide-scrollbar` agregado
- `MachineFailuresTab`: KPIs ocultables (toggle "KPIs" mobile-only junto a Reportar, default oculto); toolbar 3 filas en mobile (`sm:contents` para preservar desktop); selects envueltos en `sm:w-[120px] sm:flex-none` para que search tome espacio restante; KPI cards 3 cols mobile más compactas
- `FailureQuickReportDialog`: fix scroll — `<form>` necesitaba `flex flex-col flex-1 min-h-0` para que `DialogBody` con `flex-1 overflow-y-auto` funcionara

---

## Log Técnico

### Archivos creados/modificados
- `app/api/user/sidebar/favorites/route.ts` — CREADO + fix auth
- `hooks/use-sidebar-favorites.ts` — CREADO
- `components/layout/Sidebar.tsx` — favoritos section, star buttons, HARDCODED_ITEMS, moduleId en todos los ítems
- `components/compras/comprobante-form-modal.tsx` — múltiples fixes
- `components/ui/dialog.tsx` — tamaño 2xl agregado
- `components/maquinas/QRCodeGenerator.tsx` — responsive trigger buttons
- `components/maquinas/MachineDetailHeader.tsx` — KPI toggle en 3-dot menu
- `components/maquinas/MachineDetailDialog.tsx` — border-none en header, hide-scrollbar en TabsList
- `components/maintenance/MachineMaintenanceTab.tsx` — mobile layout KPIs + toolbar + sub-tabs compactos
- `components/maquinas/MachineFailuresTab.tsx` — KPI toggle, toolbar responsive, selects con ancho fijo desktop
- `components/corrective/failures/FailureQuickReportDialog.tsx` — fix scroll form

### Archivos creados/modificados (sesiones 5+6)
- `components/layout/Sidebar.tsx` — user profile movido de footer → header; empresa al fondo; Configuración+Notificaciones removidos del bottom; alturas ajustadas para alinear con PageHeader
- `components/layout/Navbar.tsx` — agregado Settings icon button (context-aware link a configuración)
- `components/layout/PageHeader.tsx` — `py-2.5` → `py-4` (más alto, alineado con sidebar user section)

### Archivos creados/modificados (sesión 4)
- `lib/back-stack.ts` — CREADO
- `hooks/use-modal-back.ts` — CREADO
- `components/ui/dialog.tsx` — Dialog wrapper con useModalBack
- `components/ui/sheet.tsx` — Sheet wrapper con useModalBack
- `components/unidades-moviles/UnitsToolbar.tsx` — reestructura completa
- `app/mantenimiento/unidades-moviles/page.tsx` — nuevas props toolbar, duplicate view mode eliminado
- `components/maquinas/ComponentDetailsModal.tsx` — fix PATCH refresh

### Sidebar + PageHeader — Rediseño layout (sesiones 5+6)
- **Sidebar sesión 5**: perfil del usuario movido de ABAJO → ARRIBA
  - Avatar + nombre + email son lo primero que ve el usuario al abrir el sidebar
  - Dropdown con Cuenta/Notificaciones/Cerrar sesión funcional desde la parte superior
- **Sidebar sesión 6** (refinamiento):
  - Configuración y Notificaciones **eliminados** del bottom del sidebar (expanded + collapsed) → solo en PageHeader/Navbar
  - Feedback se mantiene temporalmente en el bottom
  - Empresa movida al **fondo absoluto** del sidebar con `border-t`, texto en `text-sidebar-foreground/50`, logo h-5 w-5
  - User section: `py-2.5` padding + `h-10` button (más pequeño) → alineado con PageHeader
  - `border-b border-sidebar-ring/20` en la sección del usuario para separación visual
- **PageHeader**: `py-2.5` → `py-4` (más alto, ~60px total + border-b)
  - Alineación: sidebar user section (10+40+10+1px border = 61px) = PageHeader (16+28+16+1px border = 61px) ✓
- **Navbar**: Settings icon (⚙️) context-aware entre NotificationPanel y ThemeSelector
- Lint: 0 errores nuevos

### Herramientas y Repuestos en Ejecución de Mantenimiento — Verificación (sesión 8)
- Plan completo auditado: todos los fixes 1-5 ya estaban implementados
- **Fix 1** (Schema): `usedQuantity Int?` + `returnedDamaged Boolean @default(false)` en `SparePartReservation` — ya en schema.prisma
- **Fix 2** (ExecuteMaintenanceDialog): sección "Recursos Utilizados" con herramientas/repuestos, ad-hoc search — ya implementado
- **Fix 3** (execute/route.ts): `processResources()` con 3 casos (A/B/C) + historial en `resourcesUsed`/`spareParts` — ya implementado
- **Fix 4** (calculator.ts): `usedQuantity ?? quantity` para costos + `extrasCost` por herramientas dañadas — ya implementado
- **Fix 5** (MaintenanceDetailDialog): sección "Recursos utilizados" en timeline con herramientas/repuestos separados — ya implementado
- Todos los archivos: `Package`, `Wrench` ya importados donde necesario

### Módulo Fallas — Auditoría completa + 7 mejoras implementadas (sesión 7)
- **Discord Notifications completadas**: 4 rutas con TODOs ahora envían notificaciones
  - `create-work-order/route.ts`: `notifyOTCreated` + `notifyOTAssigned` cuando se crea OT desde falla
  - `quick-report/route.ts`: `notifyNewFailure` + `notifyP1ToSectorTechnicians` al crear reporte rápido
  - `solutions/route.ts`: `notifyFailureResolved` cuando primera solución marca falla como resuelta
  - Patrón: fire-and-forget (`sendDiscordNotifications().catch(() => {})`) para no bloquear respuesta
- **Schema error fix**: `solutions/route.ts` GET ya no silencia errores de schema (200→503 con `_schema_error: true`)
- **Menciones en comentarios**: `comments/route.ts` POST crea `Notification` in-app para cada `@mention`
- **QA Rules en AddSolutionDialog**: banner P1/P2/seguridad, rootCause obligatoria, evidenceLevel indicador
  - Props nuevas: `failurePriority`, `isSafetyRelated`
  - `useMemo` calcula `qaRules = { requireRootCause, evidenceLevel, isHighPriority, isSafety }`
- **Bulk create OTs**: nueva operación `createWorkOrders` en `bulk/route.ts`
  - Filtra fallas sin OT, crea WOs en loop con prioridad mapeada, vincula FO→WO
- **Auto-escalación cron**: agregado al `sla-check/route.ts` existente (no nuevo endpoint)
  - P3 abierta > 48h → P2, P2 abierta > 24h → P1
  - Actualiza tanto FailureOccurrence como WorkOrder asociada
  - Envía `notifyPriorityEscalated` por Discord
- **Watchers UI**: ya existía implementada (watch/unwatch button, follower count, tooltip con nombres)

### Trampas encontradas hoy
- `getToken` NO existe en `lib/auth.ts` — usar `cookies() + verifyToken` (igual que otras rutas)
- `parseFloat(formatNumber(n, 2))` rompe con números grandes en formato es-AR (el punto de miles corta el parse)
- Python script necesario para edits cuando la indentación del archivo es un solo espacio (Edit tool falla con mismatch)
- `calculateTotal` NO debe llamar `normalizeMoneyInput` — los valores de `formData` ya son floats JS (`"181953.20"`); normalizarlos de nuevo elimina el punto decimal y multiplica ×100
- `normalizeMoneyInput` es destructivo sobre floats JS: `"1273672.37"` → elimina `.` → `"127367237"` (no usar sobre valores ya normalizados)
- Para inputs controlados de React, `requestAnimationFrame` es más confiable que `setTimeout(0)` para restaurar cursor después de actualizar state
- `DialogHeader` base tiene `border-b` hardcodeado → sobrescribir con `border-none` en el className del uso
- La clase de este proyecto para ocultar scrollbar es `hide-scrollbar` (definida en `globals.css`), NO `scrollbar-hide`
- `sm:contents` en wrappers: los hijos se vuelven flex items del abuelo; los Select necesitan wrapper `sm:w-[Xpx] sm:flex-none` para tener ancho fijo en desktop
- `<form>` dentro de Dialog necesita `flex flex-col flex-1 min-h-0` para que `DialogBody` (con `flex-1 overflow-y-auto`) pueda scrollear


---

## Sesión (continuación) — Auditoría y fixes OT (Phase 1 completa)

### Resumen Ejecutivo
Completada la Fase 1 del plan de mejoras del módulo Work Orders: 3 bugs corregidos + 4 notificaciones Discord/in-app + @mentions en comentarios.

### Cambios implementados

**Bugs corregidos:**
1. `checklists/route.ts` línea 100 y 162 — Template suggestion usaba `workOrder.id` en vez de `workOrder.machineId`. También agregado `machineId` al select de la query.
2. `waiting/route.ts` línea 103 — Comparación de status con lowercase (`'completed'`, `'cancelled'`) → uppercase (`'COMPLETED'`, `'CANCELLED'`).
3. `resume/route.ts` líneas 81 y 97 — Mismo bug de lowercase: `'waiting'` → `'WAITING'`, `'in_progress'` → `'IN_PROGRESS'`.
4. `ai-suggestions/route.ts` línea 273 — Comparación de prioridad con `<` sobre strings. Fix: mapa numérico `{ LOW:1, MEDIUM:2, HIGH:3, URGENT:4 }` para comparación correcta de `shouldEscalate`.

**Notificaciones Discord agregadas:**
5. `assign-and-plan/route.ts` — Reemplazado TODO comment con llamada real a `notifyOTAssigned()` (fire-and-forget). Incluye: id, title, priority, machineName, sectorId, assignedTo, assignedBy (del JWT payload.name), scheduledDate, slaDeadline.
6. `bulk/route.ts` — Después del switch para operación `assign`: fetch de work orders con datos necesarios, luego `Promise.all(notifyOTAssigned(...))` fire-and-forget para cada OT asignada.

**Notificaciones in-app creadas:**
7. `qa/route.ts` PATCH — Extended existingQA include para obtener `assignedToId` y `title`. Después de actualizar QA, si status es `APPROVED` o `REJECTED`, crea `prisma.notification` para el técnico asignado (fire-and-forget). Tipo: `system_alert`, priority: HIGH para REJECTED, MEDIUM para APPROVED.
8. `confirm-return/route.ts` — Después de confirmar retorno, crea notificaciones para `assignedToId` y `createdById` (si son distintos al confirmar userId). Set<number> para evitar duplicados.

**@Mentions en comentarios:**
9. `comments/route.ts` POST — Después de crear el comentario, extrae `@mentions` del content con regex. Busca usuarios por nombre (case-insensitive) en la misma empresa, excluye al autor. Crea `prisma.notification` tipo `task_commented` para cada mencionado (fire-and-forget).

### Archivos modificados
- `app/api/work-orders/[id]/checklists/route.ts`
- `app/api/work-orders/[id]/waiting/route.ts`
- `app/api/work-orders/[id]/resume/route.ts`
- `app/api/work-orders/[id]/ai-suggestions/route.ts`
- `app/api/work-orders/[id]/assign-and-plan/route.ts`
- `app/api/work-orders/[id]/qa/route.ts`
- `app/api/work-orders/[id]/confirm-return/route.ts`
- `app/api/work-orders/[id]/comments/route.ts`
- `app/api/work-orders/bulk/route.ts`

### Patrones usados
- Notificaciones Discord: siempre fire-and-forget con `.catch(() => {})`
- Notificaciones in-app: `prisma.notification.create(...)` con tipos del enum `NotificationType`
- Bulk Discord: `Promise.all(...).catch(() => {})` para enviar múltiples sin bloquear
- @Mentions: regex `/@([\w\s]+?)(?=\s|$|[^a-záéíóúüñ\s])/gi` + lookup por nombre case-insensitive


---

## Sesión (cont.) — Fase 2: UI Work Orders

### Resumen Ejecutivo
Implementada Fase 2 de mejoras UI: bulk actions bar para operaciones en lote + PDF download funcional.

### Cambios implementados

**Bulk Actions Bar (nuevo componente + integración):**
1. **`WorkOrdersBulkBar.tsx`** (nuevo) — Barra flotante fija al bottom center con animación slide-in. Acciones: Asignar (popover con lista de usuarios), Prioridad (popover LOW/MEDIUM/HIGH/URGENT), Programar (popover con datetime-local), Cancelar (confirm). Cada acción llama `/api/work-orders/bulk` con fire-and-forget toast pattern.
2. **`WorkOrdersGrid.tsx`** — Nuevas props: `selectionMode`, `selectedIds`, `onToggleSelect`. Checkbox aparece en cada card cuando selectionMode está activo. Card con `ring-2 ring-primary bg-primary/5` cuando seleccionada. Click en card toggles selección en selectionMode.
3. **`WorkOrdersTable.tsx`** — Nuevas props: `selectionMode`, `selectedIds`, `onToggleSelect`, `onSelectAll`. Checkbox column condicional. Header checkbox para select-all. Row highlighting cuando seleccionada.
4. **`page.tsx` (ordenes)** — Estados `selectionMode`, `selectedIds`. Botón "Selección" al lado de la barra de filtros. Handlers: `handleToggleSelect`, `handleSelectAll`, `handleClearSelection`, `handleBulkComplete`. Renderiza `WorkOrdersBulkBar` cuando hay selección activa.

**PDF Download (fix en componente existente):**
5. **`PrintWorkOrders.tsx`** — Reemplazado TODO con implementación real usando `html2canvas` + `jsPDF` (ya en package.json). Dynamic imports para code splitting. Genera PDF multi-página con margins de 10mm. Nombre del archivo: `OTs_{usuario}_{fecha}.pdf`.

### Archivos modificados
- `components/work-orders/WorkOrdersBulkBar.tsx` (NUEVO)
- `components/work-orders/WorkOrdersGrid.tsx`
- `components/work-orders/WorkOrdersTable.tsx`
- `components/work-orders/PrintWorkOrders.tsx`
- `app/mantenimiento/ordenes/page.tsx`

---

## Sesión (cont.) — Auditoría + Fixes Módulo Soluciones

### Resumen Ejecutivo
Auditoría completa del módulo Soluciones (SolutionApplied) con 3 agentes paralelos. 5 fixes implementados: mock data eliminado, casts inseguros corregidos, auth agregada a 3 routes, endpoint de obsolescencia creado, límite de query agregado.

### Hallazgos del audit
- **SolutionDetailDialog**: Media/Docs/History usaban mock data hardcodeado (imágenes de Unsplash, videos de w3schools) como fallback permanente
- **apply-solution/route.ts**: `(prisma as any).failureOccurrence` y `(prisma as any).failureSolution` — unsafe casts, sin company ownership check
- **failure-occurrences/[id]/solutions**: GET y POST sin ningún auth check (acceso público)
- **failures/[id]/solutions**: GET sin auth check (acceso público)
- **soluciones/page.tsx**: Usa `/api/work-orders` sin límite (unbounded query) en vez de `/api/solutions-applied` dedicado
- Schema tiene `isObsolete/obsoleteReason/obsoleteAt/obsoleteById` en SolutionApplied pero sin endpoint API

### Fixes implementados
1. **SolutionDetailDialog.tsx** — Eliminados 25 líneas de mock data (mockImages, mockVideos, mockDocs, mockInstructives, mockExecutions). useMemo ahora retorna arrays vacíos si no hay attachments reales. History tab muestra empty state. Footer del edit dialog ya no dice "Guardado automáticamente".
2. **apply-solution/route.ts** — `(prisma as any).failureOccurrence.create` → `prisma.failureOccurrence.create`. `(prisma as any).failureSolution.findUnique` → `prisma.failureSolution.findUnique`. Agregado company ownership check vía `prisma.companyUser.findFirst`.
3. **failure-occurrences/[id]/solutions/route.ts** — Agregado `getAuthPayload()` helper con `verifyToken`. Auth check en GET y POST (401 si no autenticado).
4. **failures/[id]/solutions/route.ts** — Agregado import de `cookies + verifyToken`. Auth check al inicio del GET handler.
5. **app/api/solutions-applied/[id]/obsolete/route.ts** — NUEVO endpoint PATCH. Auth con verifyToken, company boundary check, actualiza `isObsolete/obsoleteReason/obsoleteAt/obsoleteById`. Mensaje diferenciado para marcar/desmarcar.
6. **app/mantenimiento/soluciones/page.tsx** — Agregado `limit: '200'` a query params de work-orders para evitar query sin límite.

### Arquitectura del módulo (para referencia futura)
- **3 modelos de solución**: `SolutionApplied` (nuevo, rico), `FailureSolution` (legacy, simpler), soluciones en `WorkOrder.notes` (legacy más antiguo)
- **Analytics**: `lib/corrective/solution-history.ts` — temporal decay (e^(-age/halfLife)), Jaccard similarity, MTTR, getTopSolutions
- **Integraciones funcionando**: Discord (notifyFailureResolved), inventory deduction, AI suggestions scoring
- **Pendiente**: migrar soluciones/page.tsx a usar `/api/solutions-applied` con paginación real (requiere mapear campos diagnosis/solution/performedBy → los campos que espera SolutionCard)

### Archivos modificados
- `components/solutions/SolutionDetailDialog.tsx`
- `app/api/work-orders/[id]/apply-solution/route.ts`
- `app/api/failure-occurrences/[id]/solutions/route.ts`
- `app/api/failures/[id]/solutions/route.ts`
- `app/api/solutions-applied/[id]/obsolete/route.ts` (NUEVO)
- `app/mantenimiento/soluciones/page.tsx`

### Descubrimientos durante exploración
- WorkLogPanel.tsx ya existe (295 líneas) en `components/corrective/work-orders/` — NO se necesitaba crear
- FailureTimelineTab.tsx ya existe — NO se necesitaba crear
- Grid ya es responsivo (1→2→3→4 cols) — NO se necesitaba fix mobile
- PrintWorkOrders ya tenía print funcional — solo faltaba PDF download
- Solo faltaba: bulk actions bar (UI) + PDF download
