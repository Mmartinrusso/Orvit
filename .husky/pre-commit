#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# Pre-commit: Escaneo de secretos con Gitleaks
# =============================================================================
# Verifica que no se commiteen credenciales, API keys, o secretos.
# Para instalar gitleaks: https://github.com/gitleaks/gitleaks#installing
# =============================================================================

# Verificar si gitleaks est√° instalado
if command -v gitleaks >/dev/null 2>&1; then
  echo "üîç Escaneando secretos con Gitleaks..."
  gitleaks protect --staged --verbose --config .gitleaks.toml
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå COMMIT BLOQUEADO: Se detectaron secretos en los cambios."
    echo "   Revisa los archivos marcados arriba y elimina los secretos."
    echo "   Si es un falso positivo, agrega el path al allowlist en .gitleaks.toml"
    echo ""
    exit 1
  fi
  echo "‚úÖ No se detectaron secretos."
else
  echo "‚ö†Ô∏è  Gitleaks no est√° instalado. Saltando escaneo de secretos."
  echo "   Instalar: https://github.com/gitleaks/gitleaks#installing"
  echo "   Windows: winget install Gitleaks.Gitleaks"
  echo "   Mac: brew install gitleaks"
fi

# Verificar que no haya NEXT_PUBLIC_AWS_* en el c√≥digo
echo "üîç Verificando que no haya NEXT_PUBLIC_AWS_*..."
FOUND=$(git diff --cached --name-only | xargs grep -l "NEXT_PUBLIC_AWS_" 2>/dev/null || true)
if [ -n "$FOUND" ]; then
  echo ""
  echo "‚ùå COMMIT BLOQUEADO: Se encontr√≥ NEXT_PUBLIC_AWS_* en:"
  echo "$FOUND"
  echo "   Las credenciales AWS NUNCA deben exponerse al cliente."
  echo ""
  exit 1
fi
echo "‚úÖ No hay credenciales AWS expuestas al cliente."
