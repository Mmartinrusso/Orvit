generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Company {
  id                        Int                         @id @default(autoincrement())
  name                      String
  cuit                      String?                     @unique
  logo                      String?
  address                   String?
  phone                     String?
  email                     String?
  website                   String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  logoDark                  String?
  logoLight                 String?
  areas                     Area[]
  categories                Category[]
  clients                   Client[]
  clientTypes               ClientType[]
  deliveryZones             DeliveryZone[]
  transportCompanies        TransportCompany[]
  businessSectors           BusinessSector[]
  settings                  CompanySettings?
  CompanySettingsCosting    CompanySettingsCosting?
  costEmployees             CostEmployee[]
  costProducts              CostProduct[]
  CostVarianceMonthly       CostVarianceMonthly[]
  documents                 Document[]
  FactPnLMonthly            FactPnLMonthly[]
  FactPurchasesMonthly      FactPurchasesMonthly[]
  FactSalesMonthly          FactSalesMonthly[]
  fixedTasks                FixedTask[]
  indirectItems             IndirectItem[]
  inputItems                InputItem[]
  lines                     Line[]
  loads                     Load[]
  machines                  Machine[]
  monthlyIndirects          MonthlyIndirect[]
  monthlyProductions        MonthlyProduction[]
  notifications             Notification[]
  notificationPreferences   NotificationPreferences[]
  priceComparisons          PriceComparison[]
  products                  Product[]
  productCostHistories      ProductCostHistory[]
  productCostLogs           ProductCostLog[]
  salesPriceLogs            SalesPriceLog[]
  productStockMovements     ProductStockMovement[]
  ProductStandardCost       ProductStandardCost[]
  ProductionMethod          ProductionMethod[]
  purchaseAccounts          PurchaseAccount[]
  purchaseReceipts          PurchaseReceipt[]
  recipes                   Recipe[]
  roles                     Role[]
  sectors                   Sector[]
  tasks                     Task[]
  taxBases                  TaxBase[]
  controls                  Control[]
  tools                     Tool[]
  toolRequests              ToolRequest[]
  trucks                    Truck[]
  unidadesMoviles           UnidadMovil[]
  kilometrajeLogs           KilometrajeLog[]            @relation("CompanyKilometrajeLogs")
  users                     UserOnCompany[]
  workStations              WorkStation[]
  workers                   Worker[]
  Zone                      Zone[]
  plantZones                PlantZone[]
  employee_categories       EmployeeCategory[]
  employee_monthly_salaries employee_monthly_salaries[]
  employee_salary_history   EmployeeSalaryHistory[]
  employees                 Employee[]
  machineOrder              MachineOrder[]
  maintenanceChecklists     MaintenanceChecklist[]
  maintenance_configs       maintenance_configs[]
  products_lowercase        products[]
  recipe_change_history     recipe_change_history[]
  recipe_cost_tests         recipe_cost_tests[]
  recipe_items              recipe_items[]
  recipes_new               recipes[]
  suppliers                 suppliers[]
  supplies                  supplies[]
  supply_monthly_prices     supply_monthly_prices[]
  supply_price_history      supply_price_history[]
  workOrders                WorkOrder[]
  paymentOrders             PaymentOrder[]
  ownedByUsers              User[]                      @relation("OwnedCompanies")
  userDashboardConfigs      UserDashboardConfig[]
  userColorPreferences      UserColorPreferences[]
  symptomLibrary            SymptomLibrary[]
  downtimeLogs              DowntimeLog[]
  templates                 Template[]
  solutionsApplied          SolutionApplied[]
  correctiveSettings        CorrectiveSettings?

  // P5: Nuevas relaciones
  occurrenceEvents             FailureOccurrenceEvent[]
  activityEvents               ActivityEvent[]
  rootCauseAnalyses            RootCauseAnalysis[]
  correctiveChecklistTemplates CorrectiveChecklistTemplate[]
  workOrderChecklists          WorkOrderChecklist[]

  // Asistente IA
  assistantEmbeddings    AssistantEmbedding[]
  assistantConversations AssistantConversation[]
  assistantActionLogs    AssistantActionLog[]

  // Módulo Compras Extendido
  warehouses               Warehouse[]
  purchaseOrders           PurchaseOrder[]
  goodsReceipts            GoodsReceipt[]
  creditDebitNotes         CreditDebitNote[]
  creditNoteRequests       CreditNoteRequest[]
  costCenters              CostCenter[]
  projects                 Project[]
  paymentRequests          PaymentRequest[]
  purchaseReturns          PurchaseReturn[]
  supplierAccountMovements SupplierAccountMovement[]
  matchExceptionSLAConfigs MatchExceptionSLAConfig[]
  notificationOutbox       NotificationOutbox[]
  sodRules                 SoDRule[]
  sodViolations            SoDViolation[]
  stockTransfers           StockTransfer[]
  stockAdjustments         StockAdjustment[]

  // Sistema de Solicitudes y Cotizaciones
  purchaseRequests       PurchaseRequest[]
  purchaseQuotations     PurchaseQuotation[]
  purchaseComments       PurchaseComment[]
  quotationSettings      CompanyQuotationSettings?
  supplierChangeRequests SupplierChangeRequest[]

  // ViewMode
  viewConfig CompanyViewConfig?

  // Sistema de Ventas
  salesConfig            SalesConfig?
  purchaseConfig         PurchaseConfig?
  purchaseAdvancedConfig PurchaseAdvancedConfig? @relation("PurchaseAdvancedConfig")
  treasuryConfig         TreasuryConfig?
  generalConfig          GeneralConfig?
  integrationConfig      IntegrationConfig?
  aiConfig               AIConfig?
  quotes                 Quote[]
  sales                  Sale[]
  saleDeliveries         SaleDelivery[]
  saleRemitos            SaleRemito[]
  salesInvoices          SalesInvoice[]
  salesCreditDebitNotes  SalesCreditDebitNote[]
  clientPayments         ClientPayment[]
  clientLedgerEntries    ClientLedgerEntry[]
  collectionAttempts     CollectionAttempt[]
  loadOrders             LoadOrder[]
  clientBlockHistory     ClientBlockHistory[]    @relation("ClientBlockHistory")
  clientNotes            ClientNote[]            @relation("ClientNotes")
  salesPriceLists        SalesPriceList[]
  discountLists          DiscountList[]

  // Sistema de Módulos por Empresa
  companyModules CompanyModule[]

  // Portal del Cliente
  clientContacts       ClientContact[]
  clientPortalUsers    ClientPortalUser[]
  clientPortalInvites  ClientPortalInvite[]
  clientPortalSessions ClientPortalSession[]
  clientPortalOrders   ClientPortalOrder[]

  // Sistema de Acopios
  saleAcopios   SaleAcopio[]
  acopioRetiros AcopioRetiro[]

  // Tesorería
  cashAccounts      CashAccount[]
  cashMovements     CashMovement[]
  bankAccounts      BankAccount[]
  bankMovements     BankMovement[]
  cheques           Cheque[]
  treasuryTransfers TreasuryTransfer[]
  bankStatements    BankStatement[]
  treasuryMovements TreasuryMovement[]
  idempotencyKeys   IdempotencyKey[]

  // Sistema de Billing (SaaS)
  subscriptionId String?
  primaryAdminId Int?
  templateId     String?
  isActive       Boolean          @default(true)
  subscription   Subscription?    @relation("CompanySubscription", fields: [subscriptionId], references: [id])
  primaryAdmin   User?            @relation("CompanyPrimaryAdmin", fields: [primaryAdminId], references: [id])
  template       CompanyTemplate? @relation(fields: [templateId], references: [id])

  // Módulo de Nóminas
  payrollConfig    PayrollConfig?
  companyHolidays  CompanyHoliday[]
  salaryComponents SalaryComponent[]
  payrollPeriods   PayrollPeriod[]
  payrolls         Payroll[]
  salaryAdvances   SalaryAdvance[]
  // v4: Nuevas relaciones de nóminas
  agreementRates   AgreementRate[]
  payrollRuns      PayrollRun[]
  // v4.1: Estructura Gremio/Categoría/Sector
  payrollUnions    PayrollUnion[]
  workSectors      WorkSector[]
  workPositions    WorkPosition[]

  // Reservas de repuestos
  sparePartReservations SparePartReservation[]

  // Sistema de Costos de Mantenimiento
  maintenanceCostBreakdowns MaintenanceCostBreakdown[]
  technicianCostRates       TechnicianCostRate[]
  thirdPartyCosts           ThirdPartyCost[]
  maintenanceBudgets        MaintenanceBudget[]

  // Motor de Automatizaciones
  automationRules      AutomationRule[]
  automationExecutions AutomationExecution[]

  // Libro de Ideas
  ideas Idea[]

  // Centro de Costos V2
  costSystemConfig          CostSystemConfig?
  monthlyCostConsolidations MonthlyCostConsolidation[]

  // Discord Bot - Configuración por empresa
  discordBotToken String? // Token del bot de Discord (encriptado)
  discordGuildId  String? // ID del servidor de Discord

  // CMMS: PTW/LOTO
  lotoProcedures LOTOProcedure[]
  permitsToWork  PermitToWork[]
  lotoExecutions LOTOExecution[]

  // FMEA
  componentFailureModes ComponentFailureMode[]

  // Skills & Certifications
  skills                Skill[]
  userCertifications    UserCertification[]
  taskSkillRequirements TaskSkillRequirement[]

  // CMMS: Machine Counters (Usage-based maintenance)
  machineCounters MachineCounter[]

  // CMMS: Management of Change (MOC)
  managementOfChanges ManagementOfChange[]

  // Audit Log
  auditLogs AuditLog[]

  // Módulo de Producción
  workShifts                 WorkShift[]
  workCenters                WorkCenter[]
  productionReasonCodes      ProductionReasonCode[]
  productionOrders           ProductionOrder[]
  dailyProductionReports     DailyProductionReport[]
  productionDowntimes        ProductionDowntime[]
  productionQualityControls  ProductionQualityControl[]
  productionDefects          ProductionDefect[]
  productionBatchLots        ProductionBatchLot[]
  productionEvents           ProductionEvent[]
  productionRoutineTemplates ProductionRoutineTemplate[]
  productionRoutines         ProductionRoutine[]
  dailyProductionSessions    DailyProductionSession[]
  dailyProductionEntries     DailyProductionEntry[]
  productionResourceTypes    ProductionResourceType[]
  productionResources        ProductionResource[]
  prestressedMolds           PrestressedMold[]
  curingRecords              CuringRecord[]

  // Pedidos de Compra por Voz
  voicePurchaseLogs VoicePurchaseLog[]

  // Reporte de Fallas por Voz
  voiceFailureLogs VoiceFailureLog[]

  // Pedidos de Compra Recurrentes
  recurringPurchaseOrders RecurringPurchaseOrder[]

  // Agenda: Tareas y Recordatorios
  agendaTasks     AgendaTask[]
  agendaReminders AgendaReminder[]
  voiceTaskLogs   VoiceTaskLog[]

  // Módulo Almacén
  stockReservations     StockReservation[]
  materialRequests      MaterialRequest[]
  despachos             Despacho[]
  devoluciones          DevolucionMaterial[]
  productionStockConfig ProductionStockConfig?

  // Importador de Máquinas con IA
  machineImportJobs MachineImportJob[]

  // Categorías de Insumos y Contratos de Servicios
  supplyCategories SupplyCategory[]
  serviceContracts ServiceContract[]

  // GRNI - Accruals de recepciones sin facturar
  grniAccruals GRNIAccrual[]

  // AI Chat Sessions
  chatSessions ChatSession[]

  // Postventa
  rmas       SaleRMA[]
  warranties ProductWarranty[]

  // Metas y Objetivos
  salesGoals            SalesGoal[]
  performanceDashboards SalesPerformanceDashboard[]

  // Snapshots de saldo de cuenta corriente
  clientBalanceSnapshots ClientBalanceSnapshot[]

  // Feedback de usuarios
  feedbacks Feedback[]

  // Ventas: Zonas, Vendedores, Condiciones de Pago
  salesZones   SalesZone[]
  salesReps    SalesRep[]
  paymentTerms PaymentTerm[]

  // Feature Flags
  featureFlags FeatureFlag[]

  @@index([subscriptionId])
  @@index([primaryAdminId])
  @@index([templateId])
  @@map("Company")
}

model CompanySettings {
  id                       String   @id @default(uuid())
  companyId                Int      @unique
  batchLabel               String   @default("batea")
  intermediateLabel        String   @default("placa")
  currency                 String   @default("ARS")
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  machineOrder             String?
  // Tolerancias para reclamos NCA
  toleranciaFaltante       Decimal  @default(0.02) @db.Decimal(5, 4) // 2% tolerancia qty
  toleranciaPrecio         Decimal  @default(0.05) @db.Decimal(5, 4) // 5% tolerancia precio
  // Configuración de Almacén
  requireDespachoSignature Boolean  @default(false) // Requerir firma digital al confirmar recepción de despacho
  company                  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("CompanySettings")
}

model User {
  id                      Int                       @id @default(autoincrement())
  name                    String
  email                   String                    @unique
  password                String?
  avatar                  String?
  logo                    String?
  role                    UserRole                  @default(USER)
  isActive                Boolean                   @default(true)
  lastLogin               DateTime?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  phone                   String? // Teléfono del usuario para billing/contacto
  discordUserId           String?                   @unique // ID de Discord del usuario para DMs
  sidebarPreferences      Json?                     @db.JsonB // User sidebar customization { ventas: { visible: [], pinned: [], order: [] } }
  createdCategories       Category[]                @relation("CategoryCreator")
  clientsSold             Client[]                  @relation("ClientSeller")
  clientsBlocked          Client[]                  @relation("ClientBlockedBy")
  clientBlocksCreated     ClientBlockHistory[]      @relation("BlockedByUser")
  clientBlocksResolved    ClientBlockHistory[]      @relation("UnblockedByUser")
  clientNotes             ClientNote[]              @relation("ClientNotes")
  contacts                Contact[]                 @relation("UserContacts")
  contactInteractions     ContactInteraction[]      @relation("UserContactInteractions")
  documents               Document[]
  assignedFixedTasks      FixedTask[]               @relation("FixedTaskAssignee")
  createdFixedTasks       FixedTask[]               @relation("FixedTaskCreator")
  fixedTaskExecutions     FixedTaskExecution[]      @relation("FixedTaskExecutions")
  historyEvents           HistoryEvent[]
  notifications           Notification[]
  notificationPreferences NotificationPreferences[]
  createdProducts         Product[]                 @relation("ProductCreator")
  productStockMovements   ProductStockMovement[]    @relation("ProductStockMovementCreator")
  createdPurchaseReceipts PurchaseReceipt[]
  createdPaymentOrders    PaymentOrder[]
  reminders               Reminder[]                @relation("UserReminders")
  assignedTasks           Task[]                    @relation("TaskAssignee")
  createdTasks            Task[]                    @relation("TaskCreator")
  taskAttachments         TaskAttachment[]          @relation("TaskAttachmentUploader")
  taskComments            TaskComment[]             @relation("TaskCommentAuthor")
  taxBasesCreated         TaxBase[]                 @relation("TaxBaseCreatedBy")
  taxRecordsPaid          TaxRecord[]               @relation("TaxRecordPaidBy")
  taxRecordsReceived      TaxRecord[]               @relation("TaxRecordReceivedBy")
  controlsCreated         Control[]                 @relation("ControlCreatedBy")
  toolLoans               ToolLoan[]                @relation("UserToolLoans")
  toolRequests            ToolRequest[]
  companies               UserOnCompany[]
  grantedPermissions      UserPermission[]          @relation("GrantedUserPermissions")
  userPermissions         UserPermission[]          @relation("UserSpecificPermissions")
  workOrderAttachments    WorkOrderAttachment[]
  workOrderComments       WorkOrderComment[]
  workStations            WorkStationInstructive[]
  checklist_executions    checklist_executions[]
  failureOccurrences      FailureOccurrence[]       @relation("FailureOccurrenceReporter")
  solutionsApplied        FailureSolution[]         @relation("SolutionAppliedBy")
  solutionApplications    SolutionApplication[]     @relation("UserSolutionApplications")
  maintenance_history     maintenance_history[]
  assignedWorkOrders      WorkOrder[]               @relation("WorkOrderAssignedTo")
  createdWorkOrders       WorkOrder[]               @relation("WorkOrderCreatedBy")
  ownedCompanies          Company[]                 @relation("OwnedCompanies")
  dashboardConfigs        UserDashboardConfig[]
  colorPreferences        UserColorPreferences[]

  // Nuevas relaciones - Sistema Correctivo
  workLogsPerformed         WorkLog[]                  @relation("WorkLogPerformedBy")
  templatesCreated          Template[]                 @relation("TemplateCreatedBy")
  qaVerifications           QualityAssurance[]         @relation("QAVerifiedBy")
  qaReturnConfirmed         QualityAssurance[]         @relation("QAReturnConfirmedBy")
  failureWatchers           FailureWatcher[]           @relation("FailureWatcher")
  workOrderWatchers         WorkOrderWatcher[]         @relation("WorkOrderWatcher")
  solutionsAppliedPerformed SolutionApplied[]          @relation("SolutionAppliedPerformedBy")
  downtimeReturned          DowntimeLog[]              @relation("DowntimeReturnedBy")
  occurrencesLinked         FailureOccurrence[]        @relation("OccurrenceLinkedBy")
  occurrencesReopened       FailureOccurrence[]        @relation("OccurrenceReopenedBy")
  failureOccurrenceComments FailureOccurrenceComment[] @relation("FailureOccurrenceCommentAuthor")

  // P5: Nuevas relaciones
  occurrenceEventsCreated FailureOccurrenceEvent[] @relation("OccurrenceEventCreator")
  activityEventsPerformed ActivityEvent[]          @relation("ActivityEventPerformer")
  rcaCreated              RootCauseAnalysis[]      @relation("RCACreator")
  checklistsCompleted     WorkOrderChecklist[]     @relation("ChecklistCompletedBy")

  // Asistente IA
  assistantConversations AssistantConversation[]
  assistantActionLogs    AssistantActionLog[]

  // Módulo Compras Extendido
  purchaseOrdersCreated    PurchaseOrder[]           @relation("PurchaseOrderCreatedBy")
  purchaseOrdersApproved   PurchaseOrder[]           @relation("PurchaseOrderApprovedBy")
  purchaseOrdersRejected   PurchaseOrder[]           @relation("PurchaseOrderRejectedBy")
  goodsReceiptsCreated     GoodsReceipt[]            @relation("GoodsReceiptCreatedBy")
  creditDebitNotesCreated  CreditDebitNote[]         @relation("CreditDebitNoteCreatedBy")
  approvalsAssigned        PurchaseApproval[]        @relation("ApprovalAssignedTo")
  approvalsResolved        PurchaseApproval[]        @relation("ApprovalResolvedBy")
  approvalsCreated         PurchaseApproval[]        @relation("ApprovalCreatedBy")
  matchResultsResolved     MatchResult[]             @relation("MatchResultResolvedBy")
  matchExceptionsResolved  MatchException[]          @relation("MatchExceptionResolvedBy")
  matchExceptionsOwned     MatchException[]          @relation("MatchExceptionOwner")
  matchExceptionsEscalated MatchException[]          @relation("MatchExceptionEscalatedTo")
  matchExceptionHistory    MatchExceptionHistory[]
  sodViolations            SoDViolation[]            @relation("SoDViolationUser")
  paymentRequestsCreated   PaymentRequest[]          @relation("PaymentRequestCreatedBy")
  paymentRequestsApproved  PaymentRequest[]          @relation("PaymentRequestApprovedBy")
  paymentRequestsRejected  PaymentRequest[]          @relation("PaymentRequestRejectedBy")
  paymentRequestLogs       PaymentRequestLog[]       @relation("PaymentRequestLogUser")
  purchaseReturnsCreated   PurchaseReturn[]          @relation("PurchaseReturnCreatedBy")
  stockMovementsCreated    StockMovement[]
  purchaseAuditLogs        PurchaseAuditLog[]        @relation("PurchaseAuditLogUser")
  stockTransfersCreated    StockTransfer[]           @relation("StockTransferCreatedBy")
  stockAdjustmentsCreated  StockAdjustment[]         @relation("StockAdjustmentCreatedBy")
  stockAdjustmentsApproved StockAdjustment[]         @relation("StockAdjustmentApprovedBy")
  movementsConciliados     SupplierAccountMovement[] @relation("MovementConciliadoBy")
  movementsCreated         SupplierAccountMovement[] @relation("MovementCreatedBy")

  // Sistema de Solicitudes y Cotizaciones
  purchaseRequestsSolicitante PurchaseRequest[]        @relation("RequestSolicitante")
  quotationsCreated           PurchaseQuotation[]      @relation("QuotationCreatedBy")
  quotationsSelected          PurchaseQuotation[]      @relation("QuotationSelectedBy")
  purchaseComments            PurchaseComment[]        @relation("PurchaseCommentUser")
  quotationStatusChanges      QuotationStatusHistory[] @relation("QuotationStatusChangedBy")

  // Control de ingreso de stock en facturas
  receiptsIngresoConfirmado PurchaseReceipt[] @relation("ReceiptIngresoConfirmado")
  receiptsPagoForzado       PurchaseReceipt[] @relation("ReceiptPagoForzado")
  receiptsValidado          PurchaseReceipt[] @relation("ReceiptValidado")
  receiptsPayApproved       PurchaseReceipt[] @relation("ReceiptPayApproved")

  // Compras rápidas y solicitudes de NCA
  goodsReceiptsRegularized  GoodsReceipt[]      @relation("GoodsReceiptRegularizedBy")
  creditNoteRequestsCreated CreditNoteRequest[] @relation("CreditNoteRequestCreatedBy")

  // Solicitudes de cambio de proveedor (doble aprobación)
  supplierChangeRequestsCreated   SupplierChangeRequest[] @relation("SupplierChangeRequested")
  supplierChangeRequestsApproved  SupplierChangeRequest[] @relation("SupplierChangeApproved")
  supplierChangeRequestsRejected  SupplierChangeRequest[] @relation("SupplierChangeRejected")
  supplierChangeRequests2Approved SupplierChangeRequest[] @relation("SupplierChangeSecondApproved")

  // Seguridad Avanzada
  refreshTokens  RefreshToken[]
  sessions       Session[]
  loginAttempts  LoginAttempt[]
  twoFactor      UserTwoFactor?
  trustedDevices TrustedDevice[]
  securityEvents SecurityEvent[]

  // Unidades Móviles
  kilometrajeLogs KilometrajeLog[] @relation("KilometrajeLogRegistradoPor")

  // Sistema de Ventas
  quotesAsSeller          Quote[]                @relation("QuoteSeller")
  quotesCreated           Quote[]                @relation("QuoteCreatedBy")
  quotesApproved          Quote[]                @relation("QuoteApprovedBy")
  quoteVersions           QuoteVersion[]
  salesAsSeller           Sale[]                 @relation("SaleSeller")
  salesCreated            Sale[]                 @relation("SaleCreatedBy")
  salesApproved           Sale[]                 @relation("SaleApprovedBy")
  deliveriesCreated       SaleDelivery[]         @relation("DeliveryCreatedBy")
  remitosCreated          SaleRemito[]           @relation("RemitoCreatedBy")
  invoicesCreated         SalesInvoice[]         @relation("InvoiceCreatedBy")
  creditNotesCreated      SalesCreditDebitNote[] @relation("CreditNoteCreatedBy")
  clientPaymentsCreated   ClientPayment[]        @relation("PaymentCreatedBy")
  salesAuditLogs          SalesAuditLog[]        @relation("SalesAuditLogUser")
  sellerKPIs              SellerKPI[]
  salesApprovalsSolicited SalesApproval[]        @relation("ApprovalSolicitante")
  salesApprovalsAssigned  SalesApproval[]        @relation("ApprovalAsignado")
  salesApprovalsResolved  SalesApproval[]        @relation("ApprovalResolutor")
  collectionAttempts      CollectionAttempt[]    @relation("CollectionAttemptUser")
  loadOrdersCreated       LoadOrder[]            @relation("LoadOrderCreatedBy")
  loadOrdersConfirmed     LoadOrder[]            @relation("LoadOrderConfirmedBy")

  // Sistema de Módulos por Empresa
  modulesEnabled CompanyModule[] @relation("ModuleEnabledBy")

  // Sistema de Acopios
  acopiosCreated SaleAcopio[]   @relation("AcopioCreatedBy")
  retirosCreated AcopioRetiro[] @relation("RetiroCreatedBy")

  // Tesorería
  cashAccountsCreated           CashAccount[]       @relation("CashAccountCreatedBy")
  cashMovementsCreated          CashMovement[]      @relation("CashMovementCreatedBy")
  bankAccountsCreated           BankAccount[]       @relation("BankAccountCreatedBy")
  bankMovementsCreated          BankMovement[]      @relation("BankMovementCreatedBy")
  bankMovementsConciliados      BankMovement[]      @relation("BankMovementConciliadoBy")
  chequesCreated                Cheque[]            @relation("ChequeCreatedBy")
  treasuryTransfersCreated      TreasuryTransfer[]  @relation("TreasuryTransferCreatedBy")
  bankStatementsCreated         BankStatement[]     @relation("BankStatementCreatedBy")
  bankStatementsCerrados        BankStatement[]     @relation("BankStatementCerradoPor")
  bankStatementItemsConciliados BankStatementItem[] @relation("BankStatementItemConciliadoBy")
  treasuryMovementsCreated      TreasuryMovement[]  @relation("TreasuryMovementCreatedBy")
  treasuryMovementsConciliados  TreasuryMovement[]  @relation("TreasuryMovementConciliadoBy")

  // Reservas de repuestos
  reservationsPickedBy   SparePartReservation[] @relation("ReservationPickedBy")
  reservationsReturnedBy SparePartReservation[] @relation("ReservationReturnedBy")

  // Sistema de Costos de Mantenimiento
  technicianCostRates    TechnicianCostRate[]
  thirdPartyCostsCreated ThirdPartyCost[]     @relation("ThirdPartyCostCreator")
  budgetsCreated         MaintenanceBudget[]  @relation("BudgetCreator")

  // Sistema de Billing (SaaS)
  subscription            Subscription?     @relation("UserSubscription")
  companiesAsPrimaryAdmin Company[]         @relation("CompanyPrimaryAdmin")
  billingPaymentsReceived BillingPayment[]  @relation("PaymentReceivedBy")
  billingAuditLogs        BillingAuditLog[] @relation("BillingAuditLogUser")
  couponsCreated          BillingCoupon[]   @relation("CouponCreatedBy")

  // Motor de Automatizaciones
  automationRulesCreated AutomationRule[] @relation("AutomationRuleCreator")

  // Libro de Ideas
  ideasCreated     Idea[]        @relation("IdeaCreator")
  ideasReviewed    Idea[]        @relation("IdeaReviewer")
  ideasImplemented Idea[]        @relation("IdeaImplementer")
  ideaVotes        IdeaVote[]
  ideaComments     IdeaComment[] @relation("IdeaCommentAuthor")

  // Centro de Costos V2
  costConsolidationsCalculated MonthlyCostConsolidation[] @relation("CostConsolidationCalculator")

  // Trazabilidad de Lotes
  lotsInstalled LotInstallation[] @relation("LotInstalledBy")
  lotsRemoved   LotInstallation[] @relation("LotRemovedBy")

  // Audit Log
  auditLogs AuditLog[] @relation("AuditPerformedBy")

  // CMMS: Responsabilidades de Activos
  machinesOwned     Machine[] @relation("MachineOwner")
  machinesPlanning  Machine[] @relation("MachinePlanner")
  machinesTechnical Machine[] @relation("MachineTechnician")

  // CMMS: PTW/LOTO
  lotoProceduresCreated  LOTOProcedure[] @relation("LOTOProcedureCreator")
  lotoProceduresApproved LOTOProcedure[] @relation("LOTOProcedureApprover")

  ptwRequested     PermitToWork[] @relation("PTWRequested")
  ptwApproved      PermitToWork[] @relation("PTWApproved")
  ptwRejected      PermitToWork[] @relation("PTWRejected")
  ptwActivated     PermitToWork[] @relation("PTWActivated")
  ptwSuspended     PermitToWork[] @relation("PTWSuspended")
  ptwResumed       PermitToWork[] @relation("PTWResumed")
  ptwClosed        PermitToWork[] @relation("PTWClosed")
  ptwFinalVerified PermitToWork[] @relation("PTWFinalVerified")
  ptwPPEVerified   PermitToWork[] @relation("PTWPPEVerified")

  lotoLockedBy             LOTOExecution[] @relation("LOTOLockedBy")
  lotoZeroEnergyVerifiedBy LOTOExecution[] @relation("LOTOZeroEnergyVerifiedBy")
  lotoUnlockedBy           LOTOExecution[] @relation("LOTOUnlockedBy")

  // Skills & Certifications
  skills         UserSkill[]
  skillsVerified UserSkill[]         @relation("SkillVerifiedBy")
  certifications UserCertification[]

  // Machine Counters
  counterLastReadings MachineCounter[]        @relation("CounterLastReadingBy")
  counterReadings     MachineCounterReading[] @relation("CounterReadingRecordedBy")

  // Management of Change (MOC)
  mocRequested         ManagementOfChange[] @relation("MOCRequestedBy")
  mocReviewed          ManagementOfChange[] @relation("MOCReviewedBy")
  mocApproved          ManagementOfChange[] @relation("MOCApprovedBy")
  mocImplemented       ManagementOfChange[] @relation("MOCImplementedBy")
  mocDocumentsUploaded MOCDocument[]        @relation("MOCDocumentUploadedBy")
  mocHistoryChanges    MOCHistory[]         @relation("MOCHistoryChangedBy")
  mocTasksAssigned     MOCTask[]            @relation("MOCTaskAssignedTo")
  mocTasksCompleted    MOCTask[]            @relation("MOCTaskCompletedBy")

  // Módulo de Producción
  dailyReportsAsOperator      DailyProductionReport[]    @relation("DailyReportOperator")
  dailyReportsAsSupervisor    DailyProductionReport[]    @relation("DailyReportSupervisor")
  dailyReportsConfirmed       DailyProductionReport[]    @relation("DailyReportConfirmer")
  dailyReportsReviewed        DailyProductionReport[]    @relation("DailyReportReviewer")
  productionDowntimesReported ProductionDowntime[]       @relation("DowntimeReportedBy")
  productionQCInspected       ProductionQualityControl[] @relation("QualityControlInspector")
  productionDefectsReported   ProductionDefect[]         @relation("DefectReportedBy")
  productionLotsBlocked       ProductionBatchLot[]       @relation("LotBlocker")
  productionLotsReleased      ProductionBatchLot[]       @relation("LotReleaser")
  productionEventsPerformed   ProductionEvent[]          @relation("ProductionEventPerformer")
  productionRoutinesExecuted  ProductionRoutine[]        @relation("RoutineExecutedBy")
  productionOrdersResponsible ProductionOrder[]          @relation("ProductionOrderResponsible")
  productionOrdersCreated     ProductionOrder[]          @relation("ProductionOrderCreator")
  dailySessionsSubmitted      DailyProductionSession[]   @relation("SessionSubmitter")
  dailySessionsApproved       DailyProductionSession[]   @relation("SessionApprover")
  dailyEntriesRegistered      DailyProductionEntry[]     @relation("DailyEntryRegisteredBy")

  // Discord - Acceso a sectores
  discordSectorAccess  UserDiscordAccess[] @relation("UserDiscordAccess")
  discordAccessGranted UserDiscordAccess[] @relation("GrantedDiscordAccess")

  // Pedidos de Compra por Voz
  voicePurchaseLogs VoicePurchaseLog[] @relation("VoicePurchaseLogUser")

  // Reporte de Fallas por Voz
  voiceFailureLogs VoiceFailureLog[] @relation("VoiceFailureLogUser")

  // Pedidos de Compra Recurrentes
  recurringPurchaseOrders RecurringPurchaseOrder[] @relation("RecurringOrderCreador")

  // Agenda: Tareas y Recordatorios
  agendaTasksCreated  AgendaTask[]     @relation("AgendaTasksCreatedBy")
  agendaTasksAssigned AgendaTask[]     @relation("AgendaTasksAssignedToUser")
  agendaReminders     AgendaReminder[] @relation("AgendaRemindersUser")
  voiceTaskLogs       VoiceTaskLog[]   @relation("VoiceTaskLogsUser")

  // Módulo Almacén
  stockReservationsCreated     StockReservation[]   @relation("StockReservationCreatedBy")
  materialRequestsSolicitante  MaterialRequest[]    @relation("MaterialRequestSolicitante")
  materialRequestsDestinatario MaterialRequest[]    @relation("MaterialRequestDestinatario")
  materialRequestsAprobadas    MaterialRequest[]    @relation("MaterialRequestAprobadoPor")
  despachosDespachador         Despacho[]           @relation("DespachoDespachador")
  despachosDestinatario        Despacho[]           @relation("DespachoDestinatario")
  despachosReceptor            Despacho[]           @relation("DespachoReceptor")
  devolucionesDevolviente      DevolucionMaterial[] @relation("DevolucionDevolviente")
  devolucionesRecibidas        DevolucionMaterial[] @relation("DevolucionRecibidoPor")
  warehouseScopes              UserWarehouseScope[]

  // Importador de Máquinas con IA
  machineImportsCreated MachineImportJob[] @relation("ImportJobCreatedBy")

  // Contratos de Servicios
  createdServiceContracts ServiceContract[] @relation("ServiceContractCreator")

  // AI Chat Sessions
  chatSessions ChatSession[]

  // Postventa - RMAs
  rmasSolicitadas  SaleRMA[]        @relation("RMASolicitante")
  rmasAprobadas    SaleRMA[]        @relation("RMAAprobador")
  rmasProcesadas   SaleRMA[]        @relation("RMAProcesador")
  rmaHistoryEvents SaleRMAHistory[] @relation("RMAHistoryUser")

  // Metas y Objetivos
  goalsAsignadas        SalesGoal[]                 @relation("GoalVendedor")
  goalsCreadas          SalesGoal[]                 @relation("GoalCreator")
  performanceDashboards SalesPerformanceDashboard[] @relation("PerformanceVendedor")

  // Feedback del usuario
  feedbacks Feedback[]

  // Feature Flags
  featureFlags FeatureFlag[]

  @@index([role, isActive])
  @@index([isActive])
  @@map("User")
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String
  displayName String
  description String?
  companyId   Int
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  sectorId    Int?
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sector      Sector?          @relation(fields: [sectorId], references: [id])
  permissions RolePermission[]
  users       UserOnCompany[]

  @@unique([companyId, name])
  @@map("Role")
}

model UserOnCompany {
  id        Int      @id @default(autoincrement())
  userId    Int
  companyId Int
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())
  roleId    Int?
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role      Role?    @relation(fields: [roleId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([companyId, isActive])
  @@index([companyId, roleId])
  @@index([joinedAt])
  @@map("UserOnCompany")
}

// Acceso de usuarios a sectores en Discord
// Control granular por tipo de canal
model UserDiscordAccess {
  id        Int      @id @default(autoincrement())
  userId    Int
  sectorId  Int
  grantedAt DateTime @default(now())
  grantedBy Int? // Usuario que otorgó el acceso

  // Permisos por tipo de canal (true = puede ver, false = no puede ver)
  canViewFallas      Boolean @default(true) // Canal de Fallas
  canViewPreventivos Boolean @default(true) // Canal de Preventivos
  canViewOT          Boolean @default(true) // Canal de Órdenes de Trabajo
  canViewGeneral     Boolean @default(true) // Canal General

  user    User   @relation("UserDiscordAccess", fields: [userId], references: [id], onDelete: Cascade)
  sector  Sector @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  granter User?  @relation("GrantedDiscordAccess", fields: [grantedBy], references: [id])

  @@unique([userId, sectorId])
  @@index([sectorId])
  @@map("UserDiscordAccess")
}

model Area {
  id                  Int                  @id @default(autoincrement())
  name                String
  icon                String?
  logo                String?
  description         String?
  companyId           Int
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  machines            Machine[]
  sectors             Sector[]
  managementOfChanges ManagementOfChange[]

  @@index([companyId])
  @@map("Area")
}

model Sector {
  id                           Int                    @id @default(autoincrement())
  name                         String
  description                  String?
  areaId                       Int
  companyId                    Int
  createdAt                    DateTime               @default(now())
  updatedAt                    DateTime               @updatedAt
  imageUrl                     String?
  // Discord - Webhooks para notificaciones por sector
  discordFallasWebhook         String? // Webhook URL para canal de Fallas
  discordPreventivosWebhook    String? // Webhook URL para canal de Preventivos
  discordOrdenesTrabajoWebhook String? // Webhook URL para canal de Órdenes de Trabajo
  discordResumenDiaWebhook     String? // Webhook URL para canal de Resumen del día
  // Discord - IDs de canales (para uso con bot)
  discordCategoryId            String? // ID de la categoría del sector
  discordGeneralChannelId      String? // ID del canal General (para resumen e inicio del día)
  discordFallasChannelId       String? // ID del canal de Fallas
  discordPreventivosChannelId  String? // ID del canal de Preventivos
  discordOTChannelId           String? // ID del canal de Órdenes de Trabajo
  machines                     Machine[]
  roles                        Role[]
  area                         Area                   @relation(fields: [areaId], references: [id], onDelete: Cascade)
  company                      Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sectorTools                  SectorTool[]
  tools                        Tool[]
  unidadesMoviles              UnidadMovil[]
  workStations                 WorkStation[]
  maintenanceChecklists        MaintenanceChecklist[]
  maintenance_configs          maintenance_configs[]
  workOrders                   WorkOrder[]
  workSectors                  WorkSector[]           @relation("SectorToWorkSector")
  maintenanceBudgets           MaintenanceBudget[]
  permitsToWork                PermitToWork[]

  plantZones          PlantZone[]
  managementOfChanges ManagementOfChange[]

  // Módulo de Producción
  enabledForProduction Boolean           @default(false) // Habilitar sector para Producción
  productionOrders     ProductionOrder[]

  // Discord - Acceso de usuarios
  userDiscordAccess UserDiscordAccess[]

  // Plantillas de rutinas de producción asociadas a este sector
  routineTemplates ProductionRoutineTemplate[] @relation("SectorRoutineTemplates")

  // Puestos de trabajo definidos para este sector
  workPositions WorkPosition[] @relation("SectorWorkPositions")

  // Producción diaria
  productionProducts      Product[]                @relation("ProductProductionSector")
  dailyProductionSessions DailyProductionSession[]
  dailyProductionEntries  DailyProductionEntry[]   @relation("EntryBySector")

  @@map("Sector")
}

// ============================================
// ZONA DE PLANTA - Agrupación jerárquica de máquinas
// Ej: "Planta Dosificadora" → "Zona Mezcla" → Máquinas
// ============================================
model PlantZone {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  logo        String?
  photo       String?
  color       String? // Color para identificar visualmente
  order       Int     @default(0) // Orden de visualización

  // Jerarquía auto-referencial (zonas dentro de zonas, profundidad ilimitada)
  parentId Int?
  parent   PlantZone?  @relation("PlantZoneHierarchy", fields: [parentId], references: [id])
  children PlantZone[] @relation("PlantZoneHierarchy")

  // Relaciones
  sectorId  Int
  companyId Int
  sector    Sector    @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  machines  Machine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sectorId])
  @@index([companyId])
  @@index([parentId])
  @@map("PlantZone")
}

model UnidadMovil {
  id                   Int               @id @default(autoincrement())
  nombre               String
  tipo                 String
  marca                String
  modelo               String
  año                 Int
  patente              String
  numeroChasis         String?
  numeroMotor          String?
  kilometraje          Int               @default(0)
  estado               UnidadMovilEstado @default(ACTIVO)
  sectorId             Int?
  companyId            Int
  descripcion          String?
  fechaAdquisicion     DateTime?
  valorAdquisicion     Float?
  proveedor            String?
  garantiaHasta        DateTime?
  ultimoMantenimiento  DateTime?
  proximoMantenimiento DateTime?
  combustible          String?
  capacidadCombustible Int?
  consumoPromedio      Float?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  company              Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sector               Sector?           @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  workOrders           WorkOrder[]
  kilometrajeLogs      KilometrajeLog[]

  @@unique([companyId, patente])
  @@index([companyId]) // Listado por empresa
  @@index([companyId, estado]) // Filtro por estado
  @@index([companyId, sectorId]) // Filtro por sector
  @@index([companyId, tipo]) // Filtro por tipo
  @@index([proximoMantenimiento]) // Alertas de mantenimiento próximo
  @@map("UnidadMovil")
}

// Tipo de registro de kilometraje
enum KilometrajeLogTipo {
  MANUAL // Actualización manual
  MANTENIMIENTO // Registrado durante mantenimiento
  COMBUSTIBLE // Registrado al cargar combustible
  VIAJE // Registrado inicio/fin de viaje
  INSPECCION // Inspección diaria/semanal
}

// Historial de lecturas de kilometraje
model KilometrajeLog {
  id              Int                @id @default(autoincrement())
  unidadMovilId   Int
  kilometraje     Int // Lectura del odómetro
  fecha           DateTime           @default(now())
  tipo            KilometrajeLogTipo @default(MANUAL)
  registradoPorId Int? // Usuario que registró
  notas           String?
  companyId       Int
  createdAt       DateTime           @default(now())

  unidadMovil   UnidadMovil @relation(fields: [unidadMovilId], references: [id], onDelete: Cascade)
  registradoPor User?       @relation("KilometrajeLogRegistradoPor", fields: [registradoPorId], references: [id], onDelete: SetNull)
  company       Company     @relation("CompanyKilometrajeLogs", fields: [companyId], references: [id], onDelete: Cascade)

  @@index([unidadMovilId, fecha])
  @@index([companyId, fecha])
  @@map("KilometrajeLog")
}

model Machine {
  id              Int           @id @default(autoincrement())
  name            String
  nickname        String?
  aliases         Json? // Array de nombres alternativos ["caldera", "la caldera", "caldera de vapor"]
  type            MachineType   @default(OTHER)
  brand           String?
  model           String?
  serialNumber    String?
  description     String?
  status          MachineStatus @default(ACTIVE)
  acquisitionDate DateTime?
  slug            String?
  photo           String?
  logo            String?
  areaId          Int?
  sectorId        Int?
  plantZoneId     Int? // Zona de planta a la que pertenece (opcional)
  companyId       Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  // Campos adicionales de identificación y ubicación
  assetCode       String? // Código de activo interno
  sapCode         String? // Código SAP
  productionLine  String? // Línea de producción
  position        String? // Posición dentro del sector/área

  // Fechas y especificaciones técnicas
  manufacturingYear Int? // Año de fabricación
  installationDate  DateTime? // Fecha de instalación
  technicalNotes    String?   @db.Text // Notas técnicas

  // Especificaciones eléctricas y físicas
  power      String? // Potencia (ej: "5 kW")
  voltage    String? // Voltaje (ej: "220 V")
  weight     String? // Peso (ej: "500 kg")
  dimensions String? // Dimensiones (ej: "2x3x1.5 m")

  components            Component[]
  documents             Document[]
  historyEvents         HistoryEvent[]
  area                  Area?                  @relation(fields: [areaId], references: [id])
  company               Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sector                Sector?                @relation(fields: [sectorId], references: [id])
  plantZone             PlantZone?             @relation(fields: [plantZoneId], references: [id])
  toolMachines          ToolMachine[]
  workStationMachines   WorkStationMachine[]
  failures              Failure[]
  failureOccurrences    FailureOccurrence[]
  machineOrder          MachineOrder[]
  maintenanceChecklists MaintenanceChecklist[]
  maintenance_history   maintenance_history[]
  workOrders            WorkOrder[]
  downtimeLogs          DowntimeLog[]
  ideas                 Idea[]
  lotInstallations      LotInstallation[]

  // === Importador de Máquinas con IA ===
  machineImportJob MachineImportJob?

  // === CMMS: PTW/LOTO ===
  lotoProcedures LOTOProcedure[]
  permitsToWork  PermitToWork[]

  // === CMMS: Criticidad y Health Score ===
  criticalityScore      Int? // Score total 1-10 (calculado)
  criticalityProduction Int? // Impacto en producción 1-10
  criticalitySafety     Int? // Impacto en seguridad 1-10
  criticalityQuality    Int? // Impacto en calidad 1-10
  criticalityCost       Int? // Impacto en costos 1-10
  healthScore           Int? // 0-100 (calculado automáticamente)
  healthScoreUpdatedAt  DateTime? // Última actualización del health score

  // === CMMS: Responsables del activo ===
  ownerId      Int? // Dueño del activo
  owner        User? @relation("MachineOwner", fields: [ownerId], references: [id])
  plannerId    Int? // Planner asignado
  planner      User? @relation("MachinePlanner", fields: [plannerId], references: [id])
  technicianId Int? // Técnico referente
  technician   User? @relation("MachineTechnician", fields: [technicianId], references: [id])

  // === CMMS: Skills requeridos para trabajar en esta máquina ===
  skillRequirements TaskSkillRequirement[]

  // === CMMS: Contadores de uso (mantenimiento basado en uso) ===
  counters MachineCounter[]

  // === CMMS: Management of Change (MOC) ===
  managementOfChanges ManagementOfChange[]

  // === Módulo de Producción ===
  productionDowntimes ProductionDowntime[] @relation("ProductionDowntimeMachine")
  workCenters         WorkCenter[]

  // === Contratos de Servicios y Seguros ===
  serviceContracts ServiceContract[] @relation("MachineServiceContracts")

  // === Performance Indexes ===
  @@index([companyId])
  @@index([sectorId])
  @@index([companyId, sectorId])
  @@index([companyId, status])
  @@index([areaId])
  @@index([plantZoneId])
  @@index([status])
  @@index([healthScore])
  @@index([criticalityScore])
  @@map("Machine")
}

// =============================================================================
// IMPORTADOR DE MÁQUINAS CON IA
// =============================================================================

model MachineImportJob {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  // Estado
  status       ImportJobStatus @default(UPLOADING)
  errorMessage String?

  // Progreso (para polling)
  stage           String? // "uploading" | "extracting_file_3" | "merging"
  progressPercent Int     @default(0)
  currentStep     String? // descripción legible

  // Retry
  retryCount    Int       @default(0)
  lastAttemptAt DateTime?
  lockedAt      DateTime? // para evitar doble procesamiento

  // Archivos
  originalFileName String?
  totalFiles       Int     @default(0)
  processedFiles   Int     @default(0)

  // Resultado IA (merge final de todos los archivos)
  extractedData Json? // { machine, components, warnings, overallConfidence }
  confidence    Float? // 0-1 (consistente)

  // Revisión del usuario
  reviewedData Json?

  // Traducción
  translateEnabled Boolean @default(false)
  sourceLanguage   String? // 'auto' | 'en' | 'pt' | 'de' | 'fr' | 'it' | 'zh' | 'ja' | 'ko'
  targetLanguage   String? // 'es' | 'en' | 'pt'

  // Máquina creada
  machineId Int?     @unique
  machine   Machine? @relation(fields: [machineId], references: [id])

  // Auditoría
  createdById Int
  createdBy   User      @relation("ImportJobCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  files        MachineImportFile[]
  fileAnalyses MachineImportFileAnalysis[]

  @@index([companyId])
  @@index([status])
  @@index([createdById])
  @@index([lockedAt])
  @@map("machine_import_jobs")
}

model MachineImportFile {
  id          Int              @id @default(autoincrement())
  importJobId Int
  importJob   MachineImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  // Archivo (NO guardamos URL, solo key)
  fileName     String
  relativePath String
  s3Key        String // SOLO key, URL se genera firmada
  fileSize     Int
  mimeType     String
  sha256       String

  // Clasificación (multi-tag via JSON)
  fileTypes Json @default("[]") // ["BLUEPRINT", "BOM"]

  // Procesamiento
  isProcessed        Boolean @default(false)
  pageCount          Int?
  extractedTextS3Key String? // texto extraído en S3, no en DB
  needsVision        Boolean @default(false) // true si es escaneado

  createdAt DateTime @default(now())

  analysis MachineImportFileAnalysis?

  @@index([importJobId])
  @@index([sha256])
  @@map("machine_import_files")
}

// Resultado IA POR ARCHIVO (permite reintentos parciales)
model MachineImportFileAnalysis {
  id          Int               @id @default(autoincrement())
  fileId      Int               @unique
  file        MachineImportFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  importJobId Int
  importJob   MachineImportJob  @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  // Resultado de extracción de este archivo
  extractedJson Json // { machineInfo, components, rawEvidence }
  confidence    Float // 0-1
  warnings      Json  @default("[]")

  // Metadata
  model            String? // "gpt-4o" | "gpt-4o-mini"
  tokensUsed       Int?
  processingTimeMs Int?

  createdAt DateTime @default(now())

  @@index([importJobId])
  @@map("machine_import_file_analyses")
}

enum ImportJobStatus {
  UPLOADING
  QUEUED
  PROCESSING
  EXTRACTING
  MERGING
  DRAFT_READY
  CONFIRMED
  COMPLETED
  ERROR
  CANCELLED
}

// =============================================================================

model Component {
  id                     Int                    @id @default(autoincrement())
  name                   String
  code                   String? // Código de parte/referencia
  itemNumber             String? // Número de posición en el plano de despiece (1, 2, 3...)
  quantity               Int?                   @default(1) // Cantidad en el ensamble (default 1)
  type                   String?
  description            String?
  parentId               Int?
  machineId              Int
  technicalInfo          String?
  logo                   String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  system                 String?
  machine                Machine                @relation(fields: [machineId], references: [id], onDelete: Cascade)
  parent                 Component?             @relation("ComponentHierarchy", fields: [parentId], references: [id])
  children               Component[]            @relation("ComponentHierarchy")
  tools                  ComponentTool[]
  documents              Document[]
  historyEvents          HistoryEvent[]
  maintenance_checklists MaintenanceChecklist[]
  maintenance_history    maintenance_history[]
  workOrders             WorkOrder[]
  workStations           WorkStationComponent[]
  ideas                  Idea[]                 @relation("IdeaComponent")
  lotInstallations       LotInstallation[]
  interventionKits       InterventionKit[]

  // === Modelo 3D ===
  model3dUrl String? // URL del modelo 3D (GLB/GLTF)

  // === CMMS: Criticidad del componente ===
  criticality      Int? // 1-10
  isSafetyCritical Boolean @default(false)

  // === CMMS: FMEA - Modos de falla ===
  failureModes ComponentFailureMode[]

  // === CMMS: Management of Change (MOC) ===
  managementOfChanges ManagementOfChange[]

  // === Performance Indexes ===
  @@index([machineId])
  @@index([parentId])
  @@index([machineId, parentId])
  @@index([createdAt])
  @@index([system])
  @@map("Component")
}

model Tool {
  id                  Int        @id @default(autoincrement())
  name                String
  description         String?
  code                String?    @unique
  itemType            ItemType   @default(TOOL)
  category            String?
  brand               String?
  model               String?
  serialNumber        String?
  stockQuantity       Int        @default(0)
  minStockLevel       Int        @default(0)
  maxStockLevel       Int        @default(100)
  reorderPoint        Int? // Punto de reorden automático
  location            String?
  status              ToolStatus @default(AVAILABLE)
  cost                Float?
  supplier            String?
  acquisitionDate     DateTime?
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  notes               String?
  logo                String?
  companyId           Int
  sectorId            Int?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // === Campos específicos para SPARE_PART ===
  isCritical     Boolean @default(false) // Repuesto crítico
  leadTimeDays   Int? // Días de entrega típico
  alternativeIds Json? // IDs de alternativos aprobados

  // === Campos específicos para HAND_TOOL ===
  requiresCalibration      Boolean   @default(false)
  calibrationFrequencyDays Int? // Frecuencia de calibración en días
  calibrationStatus        String? // OK, DUE, OVERDUE, BLOCKED
  lastCalibrationAt        DateTime?
  nextCalibrationAt        DateTime?

  // === Campos específicos para todos ===
  unit String? @default("unidad") // Unidad de medida

  // === Modelo 3D ===
  model3dUrl String? // URL del modelo 3D (GLB/GLTF)

  // === Relaciones ===
  components           ComponentTool[]
  documents            Document[]
  sectorTools          SectorTool[]
  company              Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sector               Sector?                  @relation(fields: [sectorId], references: [id])
  loans                ToolLoan[]
  toolMachines         ToolMachine[]
  movements            ToolMovement[]
  reservations         SparePartReservation[]
  suppliers            InventoryItemSupplier[]
  lots                 InventoryLot[]
  // Módulo Almacén
  materialRequestItems MaterialRequestItem[]
  despachoItems        DespachoItem[]
  devolucionItems      DevolucionMaterialItem[]

  @@map("Tool")
}

model ToolMovement {
  id          Int          @id @default(autoincrement())
  type        MovementType
  quantity    Int
  reason      String?
  description String?
  toolId      Int
  userId      Int?
  createdAt   DateTime     @default(now())
  tool        Tool         @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@map("ToolMovement")
}

model ToolLoan {
  id         Int        @id @default(autoincrement())
  toolId     Int
  userId     Int?
  workerId   Int?
  quantity   Int
  status     LoanStatus @default(BORROWED)
  borrowedAt DateTime   @default(now())
  returnedAt DateTime?
  dueDate    DateTime?
  notes      String?
  tool       Tool       @relation(fields: [toolId], references: [id], onDelete: Cascade)
  user       User?      @relation("UserToolLoans", fields: [userId], references: [id])
  worker     Worker?    @relation(fields: [workerId], references: [id])

  @@map("ToolLoan")
}

// Reserva de repuestos/herramientas para Órdenes de Trabajo
model SparePartReservation {
  id           Int               @id @default(autoincrement())
  toolId       Int
  workOrderId  Int
  quantity     Int
  status       ReservationStatus @default(PENDING)
  reservedAt   DateTime          @default(now())
  pickedAt     DateTime?
  pickedById   Int?
  returnedAt   DateTime?
  returnedById Int?
  notes        String?
  companyId    Int

  tool       Tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)
  workOrder  WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  company    Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  pickedBy   User?     @relation("ReservationPickedBy", fields: [pickedById], references: [id])
  returnedBy User?     @relation("ReservationReturnedBy", fields: [returnedById], references: [id])

  @@index([workOrderId])
  @@index([toolId])
  @@index([companyId, status])
  @@map("spare_part_reservations")
}

model ToolMachine {
  id         Int      @id @default(autoincrement())
  toolId     Int
  machineId  Int
  quantity   Int      @default(1)
  isRequired Boolean  @default(false)
  notes      String?
  createdAt  DateTime @default(now())
  machine    Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  tool       Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([toolId, machineId])
  @@map("ToolMachine")
}

model ComponentTool {
  id                 Int              @id @default(autoincrement())
  componentId        Int
  toolId             Int
  quantityNeeded     Int              @default(1)
  unit               String?          @default("unidad") // Unidad de medida
  minStockLevel      Int?
  isOptional         Boolean          @default(false)
  isConsumable       Boolean          @default(false) // Se consume vs se instala permanente
  alternativeItemIds Json? // IDs de items alternativos aprobados
  kitId              Int? // Si pertenece a un kit
  kit                InterventionKit? @relation(fields: [kitId], references: [id])
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  component          Component        @relation(fields: [componentId], references: [id], onDelete: Cascade)
  tool               Tool             @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([componentId, toolId])
  @@index([kitId])
  @@map("ComponentTool")
}

// Kit de intervención - Agrupa items de BOM para una tarea específica
model InterventionKit {
  id            Int        @id @default(autoincrement())
  name          String // "Kit cambio de rodamientos bomba X"
  code          String? // Código único del kit
  description   String?
  componentId   Int? // Para qué componente (opcional)
  component     Component? @relation(fields: [componentId], references: [id])
  checklistId   Int? // Vinculado a qué PM/checklist (opcional)
  estimatedTime Int? // Minutos estimados para usar el kit
  isActive      Boolean    @default(true)
  companyId     Int
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  items ComponentTool[]

  @@index([companyId, isActive])
  @@map("intervention_kits")
}

model SectorTool {
  id         Int      @id @default(autoincrement())
  sectorId   Int
  toolId     Int
  quantity   Int      @default(1)
  isRequired Boolean  @default(true)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  sector     Sector   @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  tool       Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([sectorId, toolId])
  @@map("SectorTool")
}

// ============================================================
// INVENTORY MANAGEMENT - Múltiples proveedores y trazabilidad
// ============================================================

// Proveedores por item (un item puede tener múltiples proveedores)
model InventoryItemSupplier {
  id             Int       @id @default(autoincrement())
  toolId         Int
  tool           Tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)
  supplierName   String
  supplierCode   String? // Código del proveedor para este item
  leadTimeDays   Int? // Tiempo de entrega en días
  unitPrice      Float?
  currency       String    @default("ARS")
  isPreferred    Boolean   @default(false)
  lastPurchaseAt DateTime?
  notes          String?
  companyId      Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([toolId])
  @@index([companyId, isPreferred])
  @@map("inventory_item_suppliers")
}

// Lotes de inventario (para trazabilidad de repuestos)
model InventoryLot {
  id              Int       @id @default(autoincrement())
  toolId          Int
  tool            Tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)
  lotNumber       String
  serialNumber    String? // Si aplica número de serie
  quantity        Int // Cantidad original del lote
  remainingQty    Int // Cantidad restante
  supplierId      Int? // Referencia al proveedor
  purchaseOrderId Int? // Referencia a orden de compra
  receivedAt      DateTime  @default(now())
  expiresAt       DateTime? // Fecha de vencimiento (si aplica)
  status          LotStatus @default(AVAILABLE)
  unitCost        Float? // Costo unitario del lote
  notes           String?
  companyId       Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  installations LotInstallation[]

  @@unique([toolId, lotNumber, companyId])
  @@index([companyId, status])
  @@index([expiresAt])
  @@map("inventory_lots")
}

// Instalaciones de lotes (qué lote está instalado dónde)
model LotInstallation {
  id            Int          @id @default(autoincrement())
  lotId         Int
  lot           InventoryLot @relation(fields: [lotId], references: [id], onDelete: Cascade)
  machineId     Int
  machine       Machine      @relation(fields: [machineId], references: [id], onDelete: Cascade)
  componentId   Int?
  component     Component?   @relation(fields: [componentId], references: [id])
  quantity      Int          @default(1)
  installedAt   DateTime     @default(now())
  installedById Int
  installedBy   User         @relation("LotInstalledBy", fields: [installedById], references: [id])
  workOrderId   Int? // OT en la que se instaló
  workOrder     WorkOrder?   @relation(fields: [workOrderId], references: [id])

  // Retiro (si se reemplaza)
  removedAt          DateTime?
  removedById        Int?
  removedBy          User?     @relation("LotRemovedBy", fields: [removedById], references: [id])
  removalReason      String? // REPLACEMENT, FAILURE, UPGRADE, RELOCATION
  removalWorkOrderId Int?

  notes     String?
  companyId Int
  createdAt DateTime @default(now())

  @@index([machineId, removedAt])
  @@index([lotId])
  @@index([companyId])
  @@map("lot_installations")
}

model Worker {
  id                  Int                  @id @default(autoincrement())
  name                String
  phone               String?
  specialty           String?
  isActive            Boolean              @default(true)
  companyId           Int
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  assignedFixedTasks  FixedTask[]          @relation("FixedTaskWorker")
  fixedTaskExecutions FixedTaskExecution[] @relation("WorkerFixedTaskExecutions")
  toolLoans           ToolLoan[]
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedWorkOrders  WorkOrder[]          @relation("AssignedWorker")

  @@map("Worker")
}

model WorkOrder {
  id                 Int              @id @default(autoincrement())
  title              String
  description        String?
  status             WorkOrderStatus  @default(PENDING)
  priority           Priority         @default(MEDIUM)
  type               MaintenanceType  @default(CORRECTIVE)
  machineId          Int?
  componentId        Int?
  workStationId      Int?
  assignedToId       Int?
  assignedWorkerId   Int?
  createdById        Int
  scheduledDate      DateTime?
  startedDate        DateTime?
  completedDate      DateTime?
  estimatedHours     Float?
  actualHours        Float?
  cost               Float?
  notes              String?
  companyId          Int
  sectorId           Int?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  rootCause          String?
  correctiveActions  String?
  preventiveActions  String?
  spareParts         Json?
  failureDescription String?
  solution           String?
  executionWindow    ExecutionWindow? @default(ANY_TIME)
  timeUnit           TimeUnit?        @default(HOURS)
  timeValue          Float?
  tags               String[]         @default([])
  isCompleted        Boolean          @default(false)
  completionRate     Float?
  unidadMovilId      Int?

  // NUEVOS CAMPOS - Sistema Correctivo Profesional
  origin WorkOrderOrigin? @default(MANUAL)

  // Estados de espera
  waitingReason      String? // SPARE_PART | VENDOR | PRODUCTION | OTHER
  waitingDescription String?
  waitingETA         DateTime?
  waitingSince       DateTime?

  // Cierre guiado
  closingMode        String? // MINIMUM | PROFESSIONAL
  diagnosisNotes     String?
  workPerformedNotes String? // Rich text
  resultNotes        String?

  // Seguridad
  isSafetyRelated Boolean @default(false)

  // Criticidad
  assetCriticality AssetCriticality?

  // Cierre requiere retorno a producción
  requiresReturnToProduction  Boolean @default(false)
  returnToProductionConfirmed Boolean @default(false)

  // Plantilla
  fromTemplate Int?

  // SLA - Service Level Agreement
  slaDueAt      DateTime? // Fecha/hora límite según SLA
  slaStatus     String? // OK | AT_RISK | BREACHED
  slaBreachedAt DateTime? // Cuándo venció el SLA
  escalatedAt   DateTime? // Cuándo se escaló
  escalatedToId Int? // A quién se escaló

  // Ejecutores (pueden ser múltiples)
  executorIds Int[] @default([]) // IDs de usuarios que ejecutaron

  // Asignación y planificación
  assignedAt DateTime? // Cuándo se asignó
  plannedAt  DateTime? // Cuándo se planificó

  // Relaciones existentes
  attachments            WorkOrderAttachment[]
  comments               WorkOrderComment[]
  failureOccurrences     FailureOccurrence[]
  solutionApplications   SolutionApplication[]  @relation("WorkOrderSolutionApplications")
  maintenance_checklists MaintenanceChecklist[]
  maintenance_history    maintenance_history[]

  // Nuevas relaciones - Sistema Correctivo
  workLogs         WorkLog[]
  qualityAssurance QualityAssurance?
  downtimeLogs     DowntimeLog[]
  solutionsApplied SolutionApplied[] @relation("SolutionAppliedWorkOrder")

  // P5: Nuevas relaciones
  occurrenceEvents    FailureOccurrenceEvent[] @relation("OccurrenceEventWorkOrder")
  rootCauseAnalysis   RootCauseAnalysis?
  workOrderChecklists WorkOrderChecklist[]

  // Watchers/Followers
  watchers WorkOrderWatcher[]

  // Relaciones FK
  assignedTo            User?                  @relation("WorkOrderAssignedTo", fields: [assignedToId], references: [id])
  assignedWorker        Worker?                @relation("AssignedWorker", fields: [assignedWorkerId], references: [id])
  company               Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  component             Component?             @relation(fields: [componentId], references: [id])
  createdBy             User                   @relation("WorkOrderCreatedBy", fields: [createdById], references: [id])
  machine               Machine?               @relation(fields: [machineId], references: [id])
  sector                Sector?                @relation(fields: [sectorId], references: [id])
  unidadMovil           UnidadMovil?           @relation(fields: [unidadMovilId], references: [id])
  workStation           WorkStation?           @relation(fields: [workStationId], references: [id])
  sparePartReservations SparePartReservation[]
  // Módulo Almacén
  stockReservations     StockReservation[]
  materialRequests      MaterialRequest[]
  despachos             Despacho[]

  // Sistema de Costos
  costBreakdown   MaintenanceCostBreakdown?
  thirdPartyCosts ThirdPartyCost[]

  // Libro de Ideas
  ideas Idea[]

  // Trazabilidad de Lotes instalados
  lotInstallations LotInstallation[]

  // === CMMS: PTW/LOTO Requirements ===
  requiresPTW  Boolean @default(false)
  ptwTypes     Json?   @default("[]") // ["HOT_WORK", "CONFINED_SPACE"]
  requiresLOTO Boolean @default(false)
  ptwBlocked   Boolean @default(false) // Can't close without PTW CLOSED
  lotoBlocked  Boolean @default(false) // Can't close without LOTO UNLOCKED

  // PTW/LOTO Relations
  permitsToWork  PermitToWork[]
  lotoExecutions LOTOExecution[]

  // Módulo de Producción
  productionDowntimes ProductionDowntime[] @relation("ProductionDowntimeWorkOrder")

  @@index([origin])
  @@index([waitingReason])
  @@index([isSafetyRelated])
  // ✅ OPTIMIZACIÓN: Índices para consultas frecuentes de mantenimiento
  @@index([companyId, status])
  @@index([companyId, type])
  @@index([companyId, createdAt])
  @@index([companyId, completedDate])
  @@index([machineId, type])
  @@index([sectorId, status])
  // ✅ NUEVOS: Índices para alertas, Mis OTs y SLA
  @@index([companyId, assignedToId, status]) // Mis OTs
  @@index([companyId, priority, status]) // Por prioridad
  @@index([companyId, slaDueAt]) // SLA queries
  @@index([companyId, scheduledDate, status]) // Vencidas/calendario
  @@map("work_orders")
}

// Catálogo de tipos de falla - fallas reutilizables que pueden ocurrir múltiples veces
model Failure {
  id                  Int                 @id @default(autoincrement())
  title               String              @db.VarChar(255)
  description         String?
  machine_id          Int
  companyId           Int? // Empresa a la que pertenece
  failure_type        String?             @default("MECANICA") @db.VarChar(50)
  priority            String?             @default("MEDIUM") @db.VarChar(20)
  estimated_hours     Decimal?            @default(0) @db.Decimal(5, 2)
  reported_date       DateTime?           @default(now()) @db.Timestamp(6)
  status              String?             @default("REPORTED") @db.VarChar(50)
  affected_components Json?
  attachments         Json?
  isActive            Boolean             @default(true)
  created_at          DateTime?           @default(now()) @db.Timestamp(6)
  updated_at          DateTime?           @default(now()) @db.Timestamp(6)
  Machine             Machine             @relation(fields: [machine_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  occurrences         FailureOccurrence[] // Cada vez que esta falla ocurre

  @@index([machine_id], map: "idx_failures_machine_id")
  @@index([reported_date], map: "idx_failures_reported_date")
  @@index([status], map: "idx_failures_status")
  @@index([companyId])
  @@map("failures")
}

// Cada ocurrencia de una falla - puede tener múltiples soluciones
model FailureOccurrence {
  id                   Int       @id @default(autoincrement())
  failureId            Int? // WorkOrder asociado (OPCIONAL para observaciones)
  failureTypeId        Int? // Link al catálogo de tipos de falla (opcional)
  machineId            Int? // Máquina afectada principal (opcional para datos legacy)
  additionalMachineIds Json? // IDs de máquinas adicionales afectadas [1, 2, 3]
  subcomponentId       Int? // Subcomponente específico (para performance indexes)
  companyId            Int // Empresa (denormalizado para performance)
  reportedBy           Int // Usuario que reportó
  reportedAt           DateTime  @default(now())
  resolvedAt           DateTime? // Fecha de resolución
  title                String? // Título de la falla (puede sobrescribir del tipo)
  description          String? // Descripción específica de esta ocurrencia
  failureCategory      String?   @default("MECANICA") @db.VarChar(50)
  priority             String?   @default("MEDIUM") @db.VarChar(20)
  affectedComponents   Json? // IDs de componentes afectados
  status               String?   @default("OPEN") @db.VarChar(20) // OPEN, IN_PROGRESS, RESOLVED
  notes                String?

  // NUEVOS CAMPOS - Sistema Correctivo Profesional
  isIntermittent Boolean @default(false)
  isObservation  Boolean @default(false)
  causedDowntime Boolean @default(false)

  // Vinculación de duplicados (conserva timeline)
  linkedToOccurrenceId Int? // Vinculado a ocurrencia principal
  linkedAt             DateTime?
  linkedById           Int? // Usuario que vinculó
  linkedReason         String?   @db.VarChar(255)
  isLinkedDuplicate    Boolean   @default(false)

  // Reapertura
  reopenedFrom Int?
  reopenReason String?
  reopenedAt   DateTime?
  reopenedById Int?

  // Resolución inmediata
  resolvedImmediately Boolean @default(false)

  // Síntomas
  symptoms Json? // Array de symptom IDs

  // Fotos/Archivos adjuntos
  photos Json? // Array de URLs de fotos [{url, fileName, originalName}]

  // Relaciones
  workOrder            WorkOrder?               @relation(fields: [failureId], references: [id], onDelete: Cascade)
  occurrenceEvents     FailureOccurrenceEvent[] // Eventos "pasó otra vez" normalizados
  failureType          Failure?                 @relation(fields: [failureTypeId], references: [id], onDelete: SetNull)
  machine              Machine?                 @relation(fields: [machineId], references: [id], onDelete: Cascade)
  reporter             User                     @relation("FailureOccurrenceReporter", fields: [reportedBy], references: [id])
  solutions            FailureSolution[] // Múltiples soluciones para esta ocurrencia
  solutionApplications SolutionApplication[]    @relation("OccurrenceSolutionApplications") // Aplicaciones de soluciones

  // Nuevas relaciones - Sistema Correctivo
  downtimeLogs      DowntimeLog[]
  watchers          FailureWatcher[]
  comments          FailureOccurrenceComment[]
  solutionsApplied  SolutionApplied[] // Historial de soluciones reales
  rootCauseAnalysis RootCauseAnalysis? // P5.2: RCA asociado
  linkedOccurrence  FailureOccurrence?         @relation("LinkedDuplicates", fields: [linkedToOccurrenceId], references: [id])
  linkedDuplicates  FailureOccurrence[]        @relation("LinkedDuplicates")
  linkedBy          User?                      @relation("OccurrenceLinkedBy", fields: [linkedById], references: [id])
  reopenedByUser    User?                      @relation("OccurrenceReopenedBy", fields: [reopenedById], references: [id])

  // Libro de Ideas
  ideas Idea[]

  // Reporte de Fallas por Voz
  voiceFailureLog VoiceFailureLog? @relation("VoiceFailureOccurrence")

  @@index([failureId])
  @@index([failureTypeId])
  @@index([machineId])
  @@index([status])
  @@index([reportedAt])
  @@index([linkedToOccurrenceId])
  @@index([isLinkedDuplicate])
  @@index([isIntermittent])
  @@index([causedDowntime])
  @@index([companyId, status, reportedAt]) // Performance - Lista/KPIs
  @@index([companyId, machineId, status]) // Performance - Por máquina
  @@index([companyId, machineId, subcomponentId, reportedAt]) // Performance - Drill-down
  @@index([companyId, isLinkedDuplicate, status]) // Performance - Filtro principal GET
  @@index([companyId, isLinkedDuplicate, priority, status]) // Performance - Alertas
  @@index([companyId, reopenedFrom]) // Performance - Reincidencias
  @@map("failure_occurrences")
}

// Solución aplicada a una ocurrencia de falla - puede haber múltiples por ocurrencia
model FailureSolution {
  id                Int      @id @default(autoincrement())
  occurrenceId      Int // Ocurrencia a la que pertenece
  title             String   @db.VarChar(255)
  description       String // Rich HTML de la solución
  appliedById       Int // Usuario que aplicó la solución
  appliedAt         DateTime @default(now())
  actualHours       Decimal? @db.Decimal(5, 2)
  timeUnit          String   @default("hours") @db.VarChar(20) // hours, minutes
  toolsUsed         Json? // Array de {id, name, quantity}
  sparePartsUsed    Json? // Array de {id, name, quantity}
  rootCause         String? // Causa raíz identificada
  preventiveActions String? // Acciones preventivas recomendadas
  attachments       Json? // Archivos de documentación
  effectiveness     Int? // Rating 1-5 de efectividad
  isPreferred       Boolean  @default(false) // Solución preferida/recomendada
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  occurrence   FailureOccurrence     @relation(fields: [occurrenceId], references: [id], onDelete: Cascade)
  appliedBy    User                  @relation("SolutionAppliedBy", fields: [appliedById], references: [id])
  applications SolutionApplication[] @relation("SolutionApplications") // Veces que se aplicó esta solución

  @@index([occurrenceId])
  @@index([appliedById])
  @@index([isPreferred])
  @@map("failure_solutions")
}

// Registro de cada vez que se aplica una solución a un WorkOrder
// Permite rastrear efectividad y reutilización de soluciones
model SolutionApplication {
  id                Int      @id @default(autoincrement())
  failureSolutionId Int // Solución que se aplicó
  workOrderId       Int // WorkOrder donde se aplicó
  occurrenceId      Int? // Ocurrencia relacionada (opcional)
  appliedById       Int // Usuario que aplicó la solución
  appliedAt         DateTime @default(now())
  actualHours       Decimal? @db.Decimal(5, 2) // Tiempo real de esta aplicación
  timeUnit          String   @default("hours") @db.VarChar(20) // hours, minutes
  notes             String? // Notas específicas de esta aplicación
  effectiveness     Int? // Rating 1-5 de efectividad en esta aplicación
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  failureSolution FailureSolution    @relation("SolutionApplications", fields: [failureSolutionId], references: [id], onDelete: Cascade)
  workOrder       WorkOrder          @relation("WorkOrderSolutionApplications", fields: [workOrderId], references: [id], onDelete: Cascade)
  occurrence      FailureOccurrence? @relation("OccurrenceSolutionApplications", fields: [occurrenceId], references: [id], onDelete: SetNull)
  appliedBy       User               @relation("UserSolutionApplications", fields: [appliedById], references: [id])

  @@index([failureSolutionId])
  @@index([workOrderId])
  @@index([occurrenceId])
  @@index([appliedById])
  @@index([appliedAt])
  @@map("solution_applications")
}

model WorkOrderComment {
  id          Int       @id @default(autoincrement())
  content     String
  type        String?   @default("comment")
  workOrderId Int
  authorId    Int?
  createdAt   DateTime  @default(now())
  author      User?     @relation(fields: [authorId], references: [id])
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("WorkOrderComment")
}

model WorkOrderAttachment {
  id           Int       @id @default(autoincrement())
  workOrderId  Int
  url          String
  fileName     String
  fileType     String
  fileSize     Int?
  uploadedAt   DateTime  @default(now())
  uploadedById Int?
  uploadedBy   User?     @relation(fields: [uploadedById], references: [id])
  workOrder    WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("WorkOrderAttachment")
}

model Task {
  id           Int              @id @default(autoincrement())
  title        String
  description  String?
  status       TaskStatus       @default(TODO)
  priority     Priority         @default(MEDIUM)
  dueDate      DateTime?
  assignedToId Int?
  createdById  Int
  companyId    Int
  completedAt  DateTime?
  tags         Json?
  progress     Int              @default(0)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  subtasks     Subtask[]
  assignedTo   User?            @relation("TaskAssignee", fields: [assignedToId], references: [id])
  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy    User             @relation("TaskCreator", fields: [createdById], references: [id])
  attachments  TaskAttachment[]
  comments     TaskComment[]

  @@map("Task")
}

model TaskAttachment {
  id           Int      @id @default(autoincrement())
  taskId       Int
  name         String
  url          String
  size         Int?
  type         String?
  uploadedAt   DateTime @default(now())
  uploadedById Int?
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy   User?    @relation("TaskAttachmentUploader", fields: [uploadedById], references: [id])

  @@map("TaskAttachment")
}

model Subtask {
  id        Int      @id @default(autoincrement())
  taskId    Int
  title     String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("Subtask")
}

model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int
  content   String
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@map("TaskComment")
}

model FixedTask {
  id               Int                    @id @default(autoincrement())
  title            String
  description      String?
  frequency        TaskFrequency
  priority         Priority               @default(MEDIUM)
  estimatedTime    Int?
  isActive         Boolean                @default(true)
  assignedToId     Int?
  assignedWorkerId Int?
  createdById      Int
  companyId        Int
  department       String?
  nextExecution    DateTime
  lastExecuted     DateTime?
  completedAt      DateTime?
  isCompleted      Boolean                @default(false)
  executionTime    String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  assignedTo       User?                  @relation("FixedTaskAssignee", fields: [assignedToId], references: [id])
  assignedWorker   Worker?                @relation("FixedTaskWorker", fields: [assignedWorkerId], references: [id])
  company          Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy        User                   @relation("FixedTaskCreator", fields: [createdById], references: [id])
  executions       FixedTaskExecution[]
  instructives     FixedTaskInstructive[]

  @@map("FixedTask")
}

model FixedTaskInstructive {
  id          Int       @id @default(autoincrement())
  title       String
  content     String
  attachments Json?
  fixedTaskId Int
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  fixedTask   FixedTask @relation(fields: [fixedTaskId], references: [id], onDelete: Cascade)

  @@map("FixedTaskInstructive")
}

model FixedTaskExecution {
  id             Int       @id @default(autoincrement())
  fixedTaskId    Int
  executedAt     DateTime  @default(now())
  notes          String?
  status         String    @default("PENDING")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  actualDuration Int?
  completedAt    DateTime?
  nextScheduled  DateTime?
  userId         Int?
  workerId       Int?
  fixedTask      FixedTask @relation(fields: [fixedTaskId], references: [id], onDelete: Cascade)
  user           User?     @relation("FixedTaskExecutions", fields: [userId], references: [id])
  worker         Worker?   @relation("WorkerFixedTaskExecutions", fields: [workerId], references: [id])

  @@map("FixedTaskExecution")
}

model Document {
  id           Int           @id @default(autoincrement())
  name         String?
  fileName     String?
  type         DocumentType?
  url          String
  fileSize     Int?
  uploadDate   DateTime      @default(now())
  machineId    Int?
  componentId  Int?
  toolId       Int?
  companyId    Int?
  uploadedById Int?
  createdAt    DateTime      @default(now())
  entityId     String?
  entityType   String?
  originalName String?
  updatedAt    DateTime      @default(now()) @updatedAt
  folder       String? // Sistema de carpetas para organizar documentos
  company      Company?      @relation(fields: [companyId], references: [id])
  component    Component?    @relation(fields: [componentId], references: [id])
  machine      Machine?      @relation(fields: [machineId], references: [id])
  tool         Tool?         @relation(fields: [toolId], references: [id])
  uploadedBy   User?         @relation(fields: [uploadedById], references: [id])

  // ✅ OPTIMIZACIÓN: Índices para consultas de templates y checklists
  @@index([entityType])
  @@index([entityType, companyId])
  @@index([companyId])
  @@index([folder])
  @@map("Document")
}

model HistoryEvent {
  id          Int              @id @default(autoincrement())
  date        DateTime         @default(now())
  type        HistoryEventType
  description String
  itemId      Int
  itemType    String
  machineId   Int?
  componentId Int?
  userId      Int?
  companyId   Int?
  metadata    Json?
  createdAt   DateTime         @default(now())
  component   Component?       @relation(fields: [componentId], references: [id])
  machine     Machine?         @relation(fields: [machineId], references: [id])
  user        User?            @relation(fields: [userId], references: [id])

  @@map("HistoryEvent")
}

model Notification {
  id        Int              @id @default(autoincrement())
  type      NotificationType
  title     String
  message   String
  userId    Int
  companyId Int?
  isRead    Boolean          @default(false)
  priority  Priority         @default(MEDIUM)
  metadata  Json?
  createdAt DateTime         @default(now())
  readAt    DateTime?
  company   Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, companyId, readAt])
  @@index([userId, companyId, createdAt])
  @@index([companyId, readAt])
  @@map("Notification")
}

model NotificationPreferences {
  id                Int      @id @default(autoincrement())
  userId            Int
  companyId         Int
  // Canales habilitados
  emailEnabled      Boolean  @default(true)
  pushEnabled       Boolean  @default(true)
  inAppEnabled      Boolean  @default(true)
  // Tipos de notificación habilitados
  invoiceDueSoon    Boolean  @default(true)
  invoiceOverdue    Boolean  @default(true)
  chequeDueSoon     Boolean  @default(true)
  chequeOverdue     Boolean  @default(true)
  quoteExpiring     Boolean  @default(true)
  paymentReceived   Boolean  @default(true)
  stockAlerts       Boolean  @default(true)
  taskAlerts        Boolean  @default(true)
  maintenanceAlerts Boolean  @default(true)
  // Configuración de anticipación (días)
  invoiceDaysBefore Int      @default(3)
  chequeDaysBefore  Int      @default(1)
  quoteDaysBefore   Int      @default(7)
  // Horario silencioso
  quietHoursStart   String? // e.g. "22:00"
  quietHoursEnd     String? // e.g. "08:00"
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("NotificationPreferences")
}

model ToolRequest {
  id          Int      @id @default(autoincrement())
  reason      String
  quantity    Int      @default(1)
  status      String   @default("PENDING")
  requestedBy Int
  approvedBy  Int?
  companyId   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requester   User     @relation(fields: [requestedBy], references: [id])

  @@map("ToolRequest")
}

model Contact {
  id           Int                  @id @default(autoincrement())
  name         String
  email        String?
  phone        String?
  company      String?
  position     String?
  notes        String?
  avatar       String?
  category     String?
  tags         Json?
  isActive     Boolean              @default(true)
  userId       Int
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  user         User                 @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  interactions ContactInteraction[]
  reminders    Reminder[]

  // Agenda: Tareas asignadas a este contacto
  agendaTasks AgendaTask[] @relation("AgendaTasksAssignedToContact")

  @@map("Contact")
}

model Reminder {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  dueDate     DateTime
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  priority    Priority  @default(MEDIUM)
  type        String    @default("GENERAL")
  userId      Int
  contactId   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  contact     Contact?  @relation(fields: [contactId], references: [id])
  user        User      @relation("UserReminders", fields: [userId], references: [id], onDelete: Cascade)

  @@map("Reminder")
}

model ContactInteraction {
  id          Int      @id @default(autoincrement())
  type        String
  subject     String
  description String?
  date        DateTime @default(now())
  duration    Int?
  outcome     String?
  nextAction  String?
  contactId   Int
  userId      Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user        User     @relation("UserContactInteractions", fields: [userId], references: [id], onDelete: Cascade)

  @@map("ContactInteraction")
}

model Permission {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  category        String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@map("Permission")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  isGranted    Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("RolePermission")
}

model UserPermission {
  id           Int        @id @default(autoincrement())
  userId       Int
  permissionId Int
  isGranted    Boolean
  grantedById  Int?
  reason       String?
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  grantedBy    User?      @relation("GrantedUserPermissions", fields: [grantedById], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation("UserSpecificPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("UserPermission")
}

// Audit Log para cambios en permisos y roles
model PermissionAuditLog {
  id              Int      @id @default(autoincrement())
  action          String // PERMISSION_GRANTED, PERMISSION_REVOKED, ROLE_CREATED, ROLE_DELETED, ROLE_CLONED, USER_PERMISSION_CHANGED
  targetType      String // ROLE, USER
  targetId        Int // roleId o userId dependiendo del targetType
  targetName      String? // Nombre del rol o usuario afectado
  permissionId    Int? // ID del permiso afectado (si aplica)
  permissionName  String? // Nombre del permiso afectado
  performedById   Int // ID del usuario que realizó la acción
  performedByName String // Nombre del usuario que realizó la acción
  details         Json? // Detalles adicionales (ej: permisos clonados, valores anteriores)
  companyId       Int
  createdAt       DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([targetType, targetId])
  @@index([performedById])
  @@map("PermissionAuditLog")
}

model Category {
  id                 Int                 @id @default(autoincrement())
  name               String
  description        String?
  isActive           Boolean             @default(true)
  companyId          Int
  createdById        Int
  parentId           Int? // Para subcategorias
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy          User                @relation("CategoryCreator", fields: [createdById], references: [id])
  parent             Category?           @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children           Category[]          @relation("CategoryHierarchy")
  products           Product[]
  discountListRubros DiscountListRubro[]

  @@unique([companyId, name])
  @@index([parentId])
  @@map("Category")
}

model Product {
  id           String   @id @default(cuid())
  name         String
  code         String
  description  String
  categoryId   Int
  unit         String
  costPrice    Float
  costCurrency String   @default("ARS")
  minStock     Int
  currentStock Int
  volume       Float
  weight       Float
  location     String
  blocksPerM2  Int?
  isActive     Boolean  @default(true)
  images       Json?
  files        Json?
  companyId    Int
  createdById  Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  volumeUnit   String?  @default("metros_lineales")
  image        String?

  // Sistema de Costos
  costType             ProductCostType @default(MANUAL)
  recipeId             String? // Para productos tipo PRODUCTION
  purchaseInputId      String? // Para productos tipo PURCHASE
  weightedAverageCost  Float? // Costo promedio ponderado (PURCHASE)
  lastCostUpdate       DateTime? // Última actualización de costo
  costCalculationStock Int?            @default(0) // Stock usado en último cálculo

  // Precios de Venta y Margen
  salePrice    Float? // Precio de venta sugerido
  saleCurrency String @default("ARS") // Moneda del precio de venta
  marginMin    Float? // Margen mínimo permitido (%)
  marginMax    Float? // Margen máximo permitido (%)

  // Códigos adicionales
  barcode String? // Código de barras
  sku     String? // SKU alternativo

  // Características
  tags Json? // Array de etiquetas ["premium", "oferta"]

  // Producción
  productionSectorId Int? // Sector donde se produce este producto

  // Trazabilidad
  trackBatches    Boolean @default(false) // Seguimiento por lote
  trackExpiration Boolean @default(false) // Control de vencimiento

  // Alertas
  alertStockEmail Boolean @default(true) // Alertar por email
  alertStockDays  Int? // Días de anticipación para alertas

  category      Category         @relation(fields: [categoryId], references: [id])
  company       Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy     User             @relation("ProductCreator", fields: [createdById], references: [id])
  recipe        Recipe?          @relation("ProductRecipe", fields: [recipeId], references: [id], onDelete: SetNull)
  purchaseInput InputItem?       @relation("ProductPurchaseInput", fields: [purchaseInputId], references: [id], onDelete: SetNull)
  costLogs      ProductCostLog[]
  salePriceLogs SalesPriceLog[]

  // Sistema de Ventas
  quoteItems      QuoteItem[]
  saleItems       SaleItem[]
  deliveryItems   SaleDeliveryItem[]
  loadOrderItems  LoadOrderItem[]
  remitoItems     SaleRemitoItem[]
  invoiceItems    SalesInvoiceItem[]
  creditNoteItems SalesCreditDebitNoteItem[]
  priceListItems  SalesPriceListItem[]

  // Sistema de Acopios
  acopioItems SaleAcopioItem[] @relation("AcopioItemProduct")

  // Sistema de Listas de Descuentos
  discountListProducts DiscountListProduct[]

  // Movimientos de Stock
  stockMovements ProductStockMovement[]

  // Portal del Cliente
  portalOrderItems ClientPortalOrderItem[]

  // Postventa
  rmaItems   SaleRMAItem[]     @relation("RMAProducts")
  warranties ProductWarranty[] @relation("ProductWarranties")

  // Producción diaria
  productionSector       Sector?                @relation("ProductProductionSector", fields: [productionSectorId], references: [id])
  dailyProductionEntries DailyProductionEntry[]

  @@unique([companyId, code])
  @@index([costType])
  @@index([recipeId])
  @@index([purchaseInputId])
  @@index([barcode])
  @@index([companyId, isActive])
  @@index([productionSectorId])
  @@map("Product")
}

// Historial de cambios de costo de productos
model ProductCostLog {
  id        String @id @default(cuid())
  productId String
  companyId Int

  // Valores del cambio
  previousCost  Float?
  newCost       Float
  previousStock Int?
  newStock      Int?

  // Origen del cambio
  changeSource       String // 'PURCHASE', 'RECIPE_UPDATE', 'MANUAL', 'BATCH_RUN'
  sourceDocumentId   String? // ID del documento origen
  sourceDocumentType String? // Tipo de documento

  // Cálculo detallado (para auditoría)
  purchaseQuantity  Float?
  purchaseUnitPrice Float?
  calculationMethod String? // 'WEIGHTED_AVERAGE', 'LAST_PURCHASE', 'RECIPE_SUM'

  // Metadata
  createdAt   DateTime @default(now())
  createdById Int?
  notes       String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([companyId, createdAt(sort: Desc)])
  @@index([changeSource])
  @@map("ProductCostLog")
}

// Historial de cambios de precios de venta
model SalesPriceLog {
  id        String @id @default(cuid())
  productId String
  companyId Int

  // Valores del cambio
  previousPrice Float?
  newPrice      Float

  // Contexto del cambio
  salesPriceListId Int? // null cuando es cambio directo en Product.salePrice
  changeSource     String // 'PRICE_LIST', 'PRODUCT_DIRECT', 'BULK_UPDATE', 'IMPORT'
  reason           String? // Motivo del cambio

  // Metadata
  createdAt   DateTime @default(now())
  createdById Int?
  notes       String?

  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salesPriceList SalesPriceList? @relation(fields: [salesPriceListId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([companyId, createdAt(sort: Desc)])
  @@index([salesPriceListId])
  @@index([changeSource])
  @@map("SalesPriceLog")
}

// Movimientos de stock de productos (ventas)
model ProductStockMovement {
  id        String @id @default(cuid())
  productId String
  companyId Int

  tipo           ProductStockMovementType
  cantidad       Float
  stockAnterior  Float
  stockPosterior Float

  // Origen del movimiento
  sourceType   String? // 'SALE', 'RETURN', 'ADJUSTMENT', 'PRODUCTION', 'MANUAL'
  sourceId     String? // ID del documento origen
  sourceNumber String? // Número visible (OV-2024-001)

  motivo String?
  notas  String?

  createdBy Int
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation("ProductStockMovementCreator", fields: [createdBy], references: [id])

  @@index([productId])
  @@index([companyId, createdAt(sort: Desc)])
  @@map("product_stock_movements")
}

enum ProductStockMovementType {
  ENTRADA
  SALIDA
  AJUSTE
}

model WorkStation {
  id           Int                      @id @default(autoincrement())
  name         String
  description  String?
  code         String                   @unique
  status       WorkStationStatus        @default(ACTIVE)
  sectorId     Int
  companyId    Int
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  company      Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sector       Sector                   @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  instructives WorkStationInstructive[]
  machines     WorkStationMachine[]
  components   WorkStationComponent[]
  workOrders   WorkOrder[]

  @@unique([name, sectorId]) // Nombre único por sector
  @@map("WorkStation")
}

model WorkStationInstructive {
  id            Int         @id @default(autoincrement())
  title         String
  description   String?
  fileUrl       String?
  fileName      String?
  fileType      String?
  fileSize      Int?
  isActive      Boolean     @default(true)
  workStationId Int
  createdById   Int
  scope         String?
  contentHtml   String?
  machineIds    Json?
  componentIds  Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     User        @relation(fields: [createdById], references: [id])
  workStation   WorkStation @relation(fields: [workStationId], references: [id], onDelete: Cascade)

  @@map("WorkStationInstructive")
}

model WorkStationMachine {
  id            Int         @id @default(autoincrement())
  workStationId Int
  machineId     Int
  isRequired    Boolean     @default(true)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  machine       Machine     @relation(fields: [machineId], references: [id], onDelete: Cascade)
  workStation   WorkStation @relation(fields: [workStationId], references: [id], onDelete: Cascade)

  @@unique([workStationId, machineId])
  @@map("WorkStationMachine")
}

model WorkStationComponent {
  id            Int         @id @default(autoincrement())
  workStationId Int
  componentId   Int
  isRequired    Boolean     @default(true)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  component     Component   @relation(fields: [componentId], references: [id], onDelete: Cascade)
  workStation   WorkStation @relation(fields: [workStationId], references: [id], onDelete: Cascade)

  @@unique([workStationId, componentId])
  @@map("WorkStationComponent")
}

model Line {
  id                            String                          @id @default(uuid())
  code                          String
  name                          String
  createdAt                     DateTime                        @default(now())
  updatedAt                     DateTime                        @updatedAt
  companyId                     Int
  products                      CostProduct[]
  globalAllocations             GlobalAllocation[]
  IndirectItemAllocation        IndirectItemAllocation[]
  IndirectItemAllocationMonthly IndirectItemAllocationMonthly[]
  company                       Company                         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  ZoneAllocation                ZoneAllocation[]
  ZoneAllocationMonthly         ZoneAllocationMonthly[]

  // Módulo de Producción
  workCenters WorkCenter[]

  @@unique([companyId, code])
  @@map("Line")
}

model CostProduct {
  id                  String                @id @default(uuid())
  lineId              String
  name                String
  measureKind         MeasureKind
  unitLabel           String
  costMethod          CostMethod
  active              Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  companyId           Int
  company             Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  line                Line                  @relation(fields: [lineId], references: [id], onDelete: Cascade)
  CostVarianceMonthly CostVarianceMonthly[]
  MethodProductYield  MethodProductYield[]
  monthlyProductions  MonthlyProduction[]
  perUnitBOM          PerUnitBOM[]
  costHistory         ProductCostHistory[]
  ProductStandardCost ProductStandardCost[]
  variant             ProductVariant?
  volumetricParam     VolumetricParam?
  yieldConfig         YieldConfig?

  // Módulo de Producción
  productionOrders ProductionOrder[]

  @@index([companyId, active])
  @@index([lineId])
  @@map("CostProduct")
}

model ProductVariant {
  id        String      @id @default(uuid())
  productId String      @unique
  name      String?
  product   CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("ProductVariant")
}

model InputItem {
  id                    String              @id @default(uuid())
  name                  String
  unitLabel             String
  currentPrice          Decimal             @db.Decimal(12, 4)
  supplier              String?
  updatedAt             DateTime            @updatedAt
  createdAt             DateTime            @default(now())
  companyId             Int
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  priceHistory          InputPriceHistory[]
  perUnitBOM            PerUnitBOM[]
  recipeItems           RecipeItem[]
  productsUsingPurchase Product[]           @relation("ProductPurchaseInput")

  // Link a item de inventario para consumo de stock
  supplierItemId   Int?
  supplierItem     SupplierItem? @relation("InputItemSupply", fields: [supplierItemId], references: [id])
  conversionFactor Decimal       @default(1) @db.Decimal(10, 4) // Factor para convertir unidades

  @@index([supplierItemId])
  @@map("InputItem")
}

model InputPriceHistory {
  id            String    @id @default(uuid())
  companyId     Int
  inputId       String
  effectiveFrom DateTime
  price         Decimal   @db.Decimal(12, 4)
  createdAt     DateTime  @default(now())
  input         InputItem @relation(fields: [inputId], references: [id], onDelete: Cascade)

  @@index([inputId, effectiveFrom])
  @@index([companyId, effectiveFrom])
  @@map("InputPriceHistory")
}

model CostEmployee {
  id           String                @id @default(uuid())
  name         String
  role         String
  grossSalary  Decimal               @db.Decimal(12, 2)
  payrollTaxes Decimal               @db.Decimal(12, 2)
  active       Boolean               @default(true)
  updatedAt    DateTime              @updatedAt
  createdAt    DateTime              @default(now())
  companyId    Int
  zoneId       String?
  company      Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Zone         Zone?                 @relation(fields: [zoneId], references: [id])
  compHistory  EmployeeCompHistory[]

  @@index([companyId, active])
  @@map("CostEmployee")
}

model EmployeeCompHistory {
  id            String       @id @default(uuid())
  companyId     Int
  employeeId    String
  effectiveFrom DateTime
  grossSalary   Decimal      @db.Decimal(12, 2)
  payrollTaxes  Decimal      @db.Decimal(12, 2)
  changePct     Decimal?     @db.Decimal(5, 2)
  createdAt     DateTime     @default(now())
  employee      CostEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, effectiveFrom])
  @@index([companyId, effectiveFrom])
  @@map("EmployeeCompHistory")
}

model MonthlyIndirect {
  id           String           @id @default(uuid())
  category     IndirectCategory
  label        String
  amount       Decimal          @db.Decimal(12, 2)
  month        String
  companyId    Int
  itemId       String?
  servicePrice Decimal?         @db.Decimal(12, 4)
  quantity     Decimal?         @db.Decimal(12, 4)
  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  item         IndirectItem?    @relation(fields: [itemId], references: [id])

  @@index([companyId, month])
  @@map("MonthlyIndirect")
}

model IndirectItem {
  id                            String                          @id @default(uuid())
  companyId                     Int
  code                          String
  label                         String
  createdAt                     DateTime                        @default(now())
  category                      IndirectCategory
  currentPrice                  Decimal?                        @db.Decimal(12, 4)
  updatedAt                     DateTime                        @updatedAt
  company                       Company                         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  IndirectItemAllocation        IndirectItemAllocation[]
  IndirectItemAllocationMonthly IndirectItemAllocationMonthly[]
  priceHistory                  IndirectPriceHistory[]
  monthlyIndirects              MonthlyIndirect[]

  @@unique([companyId, code])
  @@map("IndirectItem")
}

model IndirectPriceHistory {
  id            String       @id @default(uuid())
  companyId     Int
  indirectId    String
  effectiveFrom DateTime
  price         Decimal      @db.Decimal(12, 4)
  createdAt     DateTime     @default(now())
  indirect      IndirectItem @relation(fields: [indirectId], references: [id], onDelete: Cascade)

  @@index([indirectId, effectiveFrom])
  @@index([companyId, effectiveFrom])
  @@map("IndirectPriceHistory")
}

model GlobalAllocation {
  id        String   @id @default(uuid())
  category  String
  lineId    String
  percent   Decimal  @db.Decimal(5, 4)
  updatedAt DateTime @updatedAt
  line      Line     @relation(fields: [lineId], references: [id], onDelete: Cascade)

  @@unique([category, lineId])
  @@map("GlobalAllocation")
}

model Recipe {
  id                    String               @id @default(uuid())
  name                  String
  base                  RecipeBase           @default(PER_BATCH)
  scopeType             String
  scopeId               String
  version               Int
  isActive              Boolean              @default(false)
  description           String?
  createdBy             String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  companyId             Int
  intermediateQuantity  Decimal?             @db.Decimal(12, 6)
  intermediateUnitLabel String?
  outputQuantity        Decimal?             @db.Decimal(12, 6)
  outputUnitLabel       String?
  baseQty               Decimal?             @db.Decimal(12, 6)
  baseUnit              String?
  status                RecipeStatus         @default(DRAFT)
  validFrom             DateTime?
  validTo               DateTime?
  batchRuns             BatchRun[]
  MethodProductYield    MethodProductYield[]
  company               Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items                 RecipeItem[]
  productsUsingRecipe   Product[]            @relation("ProductRecipe")

  // Módulo de Producción
  productionOrders ProductionOrder[]

  @@unique([companyId, scopeType, scopeId, name])
  @@index([scopeType, scopeId, isActive])
  @@map("Recipe")
}

model RecipeItem {
  id        String    @id @default(uuid())
  recipeId  String
  inputId   String
  quantity  Decimal   @db.Decimal(12, 6)
  unitLabel String
  input     InputItem @relation(fields: [inputId], references: [id], onDelete: Cascade)
  recipe    Recipe    @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, inputId])
  @@map("RecipeItem")
}

model YieldConfig {
  id                     String      @id @default(uuid())
  productId              String      @unique
  intermediatesPerBatch  Decimal?    @db.Decimal(12, 4)
  outputsPerIntermediate Decimal?    @db.Decimal(12, 4)
  scrapA                 Decimal?    @db.Decimal(5, 4)
  scrapB                 Decimal?    @db.Decimal(5, 4)
  outputsPerBatch        Decimal?    @db.Decimal(12, 4)
  scrapGlobal            Decimal?    @db.Decimal(5, 4)
  m3PerBatch             Decimal?    @db.Decimal(12, 4)
  usesIntermediate       Boolean     @default(false)
  product                CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("YieldConfig")
}

model PerUnitBOM {
  id        String      @id @default(uuid())
  productId String
  inputId   String
  qtyPerOut Decimal     @db.Decimal(12, 4)
  unitLabel String
  input     InputItem   @relation(fields: [inputId], references: [id], onDelete: Cascade)
  product   CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, inputId])
  @@map("PerUnitBOM")
}

model VolumetricParam {
  id          String      @id @default(uuid())
  productId   String      @unique
  m3PerOutput Decimal     @db.Decimal(12, 4)
  product     CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("VolumetricParam")
}

model BatchRun {
  id            String   @id @default(uuid())
  date          DateTime
  recipeId      String
  batches       Decimal  @db.Decimal(12, 4)
  intermediates Decimal? @db.Decimal(12, 4)
  outputs       Decimal? @db.Decimal(12, 4)
  note          String?
  recipe        Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("BatchRun")
}

model MonthlyProduction {
  id               String      @id @default(uuid())
  productId        String
  month            String
  producedQuantity Decimal     @db.Decimal(12, 4)
  companyId        Int
  company          Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product          CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, month])
  @@index([companyId, month])
  @@map("MonthlyProduction")
}

model ProductCostHistory {
  id                 String      @id @default(uuid())
  productId          String
  month              String
  directPerOutput    Decimal     @db.Decimal(12, 4)
  indirectPerOutput  Decimal     @db.Decimal(12, 4)
  employeesPerOutput Decimal     @db.Decimal(12, 4)
  totalPerOutput     Decimal     @db.Decimal(12, 4)
  manualOverride     Boolean     @default(false)
  companyId          Int
  createdAt          DateTime    @default(now())
  method             CostMethod
  notes              String?
  company            Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product            CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, month, method])
  @@map("ProductCostHistory")
}

model CostParam {
  key   String @id
  value String

  @@map("CostParam")
}

model CompanySettingsCosting {
  id                        String     @id
  companyId                 Int        @unique
  currencyBase              String     @default("ARS")
  inputPriceSource          String     @default("PRICE_HISTORY")
  treatEmployeesAsOverhead  Boolean    @default(true)
  requireProductionForMonth Boolean    @default(true)
  allowZeroProduction       Boolean    @default(false)
  defaultCostMethod         CostMethod @default(REAL)
  autoCreateDO              Boolean    @default(true)
  autoReserveStock          Boolean    @default(true)
  cogsMethod                String     @default("COST_HISTORY")
  createdAt                 DateTime   @default(now())
  updatedAt                 DateTime
  Company                   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model CostVarianceMonthly {
  id               String      @id
  companyId        Int
  productId        String
  month            String
  method           CostMethod
  materialPriceVar Decimal     @db.Decimal(12, 4)
  materialUsageVar Decimal     @db.Decimal(12, 4)
  laborRateVar     Decimal?    @db.Decimal(12, 4)
  laborEffVar      Decimal?    @db.Decimal(12, 4)
  ohSpendingVar    Decimal     @db.Decimal(12, 4)
  ohVolumeVar      Decimal     @db.Decimal(12, 4)
  createdAt        DateTime    @default(now())
  Company          Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  CostProduct      CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, month, method])
}

model FactPnLMonthly {
  id              String   @id
  companyId       Int
  month           String
  salesNet        Decimal  @db.Decimal(15, 4)
  cogs            Decimal  @db.Decimal(15, 4)
  grossMargin     Decimal  @db.Decimal(15, 4)
  indirects       Decimal  @db.Decimal(15, 4)
  employees       Decimal  @db.Decimal(15, 4)
  operatingMargin Decimal  @db.Decimal(15, 4)
  purchasesTotal  Decimal  @db.Decimal(15, 4)
  createdAt       DateTime @default(now())
  Company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, month])
}

model FactPurchasesMonthly {
  id        String   @id
  companyId Int
  month     String
  amount    Decimal  @db.Decimal(15, 4)
  createdAt DateTime @default(now())
  Company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, month])
}

model FactSalesMonthly {
  id          String   @id
  companyId   Int
  month       String
  netAmount   Decimal  @db.Decimal(15, 4)
  grossAmount Decimal  @db.Decimal(15, 4)
  createdAt   DateTime @default(now())
  Company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, month])
}

model IndirectItemAllocation {
  id           String       @id
  companyId    Int
  itemId       String
  lineId       String
  percent      Decimal      @db.Decimal(5, 4)
  updatedAt    DateTime
  createdAt    DateTime     @default(now())
  IndirectItem IndirectItem @relation(fields: [itemId], references: [id])
  Line         Line         @relation(fields: [lineId], references: [id])

  @@unique([companyId, itemId, lineId])
  @@index([companyId, itemId])
  @@index([itemId])
}

model IndirectItemAllocationMonthly {
  id           String       @id
  companyId    Int
  itemId       String
  month        String
  lineId       String
  percent      Decimal      @db.Decimal(5, 4)
  updatedAt    DateTime
  createdAt    DateTime     @default(now())
  IndirectItem IndirectItem @relation(fields: [itemId], references: [id])
  Line         Line         @relation(fields: [lineId], references: [id])

  @@unique([companyId, itemId, month, lineId])
  @@index([companyId, month])
  @@index([itemId, month])
}

model MethodConversion {
  id               String           @id
  methodId         String
  fromKind         MethodUnitKind
  fromLabel        String
  toKind           MethodUnitKind
  toLabel          String
  factor           Decimal          @db.Decimal(12, 4)
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  ProductionMethod ProductionMethod @relation(fields: [methodId], references: [id], onDelete: Cascade)
}

model MethodProductYield {
  id               String           @id
  recipeId         String?
  productId        String
  methodId         String
  overrides        Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  ProductionMethod ProductionMethod @relation(fields: [methodId], references: [id], onDelete: Cascade)
  CostProduct      CostProduct      @relation(fields: [productId], references: [id], onDelete: Cascade)
  Recipe           Recipe?          @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([productId, methodId])
}

model ProductStandardCost {
  id          String      @id
  companyId   Int
  productId   String
  month       String
  totalUnit   Decimal     @db.Decimal(12, 4)
  dmUnit      Decimal     @db.Decimal(12, 4)
  laborUnit   Decimal?    @db.Decimal(12, 4)
  ohUnit      Decimal?    @db.Decimal(12, 4)
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  Company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  CostProduct CostProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, month])
}

model ProductionMethod {
  id                 String               @id
  companyId          Int
  code               String
  name               String
  baseUnit           String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  MethodConversion   MethodConversion[]
  MethodProductYield MethodProductYield[]
  Company            Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
}

model Zone {
  id                    String                  @id
  companyId             Int
  code                  String
  name                  String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  CostEmployee          CostEmployee[]
  Company               Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  ZoneAllocation        ZoneAllocation[]
  ZoneAllocationMonthly ZoneAllocationMonthly[]

  @@unique([companyId, code])
  @@index([companyId, name])
}

model ZoneAllocation {
  id        String   @id
  companyId Int
  zoneId    String
  lineId    String
  percent   Decimal  @db.Decimal(5, 4)
  updatedAt DateTime
  createdAt DateTime @default(now())
  Line      Line     @relation(fields: [lineId], references: [id])
  Zone      Zone     @relation(fields: [zoneId], references: [id])

  @@unique([companyId, zoneId, lineId])
  @@index([companyId, zoneId])
  @@index([zoneId])
}

model ZoneAllocationMonthly {
  id        String   @id
  companyId Int
  zoneId    String
  month     String
  lineId    String
  percent   Decimal  @db.Decimal(5, 4)
  updatedAt DateTime
  createdAt DateTime @default(now())
  Line      Line     @relation(fields: [lineId], references: [id])
  Zone      Zone     @relation(fields: [zoneId], references: [id])

  @@unique([companyId, zoneId, month, lineId])
  @@index([companyId, month])
  @@index([zoneId, month])
}

model MaintenanceChecklist {
  id                 Int                @id @default(autoincrement())
  workOrderId        Int?
  machineId          Int?
  componentId        Int?
  title              String
  description        String?
  frequency          ChecklistFrequency
  isTemplate         Boolean            @default(false)
  isActive           Boolean            @default(true)
  companyId          Int
  sectorId           Int?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  category           String?
  estimatedTotalTime Int?               @default(0)
  items              Json?
  phases             Json?
  instructives       Json?
  checklist_items    checklist_items[]
  company            Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Component          Component?         @relation(fields: [componentId], references: [id])
  machine            Machine?           @relation(fields: [machineId], references: [id])
  sector             Sector?            @relation(fields: [sectorId], references: [id])
  work_orders        WorkOrder?         @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  // Skills requeridos para ejecutar este checklist
  skillRequirements TaskSkillRequirement[]

  // Counter-based maintenance triggers
  counterTriggers CounterMaintenanceTrigger[]

  // ✅ OPTIMIZACIÓN: Índices para consultas de checklists
  @@index([companyId, isActive])
  @@index([companyId, sectorId, isActive])
  @@index([sectorId])
  @@map("maintenance_checklists")
}

model ChecklistExecution {
  id               Int      @id @default(autoincrement())
  checklistId      Int
  executedBy       String
  executionTime    Int
  companyId        Int
  sectorId         Int?
  status           String   @default("COMPLETED")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  completedItems   Int      @default(0)
  executedAt       DateTime @default(now())
  justifications   String?
  totalItems       Int      @default(0)
  executionDetails String?

  @@index([checklistId])
  @@index([companyId])
  @@index([executedAt])
  @@index([sectorId])
  @@map("ChecklistExecution")
}

model MachineOrder {
  id        Int      @id @default(autoincrement())
  companyId Int
  machineId Int
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  machine   Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([companyId, machineId])
  @@map("machine_order")
}

model EmployeeCategory {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(255)
  description String?
  is_active   Boolean @default(true)
  company_id  Int

  // Gremio/Convenio
  gremio          String? @db.VarChar(100)
  convention_code String? @db.VarChar(50)

  // Regla de pago FLEXIBLE
  payment_schedule_type String @default("BIWEEKLY_FIXED") @db.VarChar(50)
  // BIWEEKLY_FIXED | BIWEEKLY_1_15_16_EOM | MONTHLY_SAME_MONTH | MONTHLY_NEXT_MONTH
  payment_rule_json     Json?

  // Política de asistencia
  attendance_policy_json Json?

  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  Company         Company                  @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_employee_categories_company")
  employees       Employee[]
  defaultConcepts CategoryDefaultConcept[]
  agreementRates  AgreementRate[]
  periods         PayrollPeriod[]

  @@index([company_id], map: "idx_employee_categories_company")
  @@map("employee_categories")
}

model Employee {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(255)
  name          String    @db.VarChar(255)
  role          String    @db.VarChar(255)
  cuil          String?   @db.VarChar(20) // CUIL argentino (XX-XXXXXXXX-X)
  gross_salary  Decimal   @db.Decimal(10, 2)
  payroll_taxes Decimal?  @default(0) @db.Decimal(10, 2)
  active        Boolean   @default(true)
  category_id   Int? // Legacy (deprecated)
  company_id    Int
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  // Campos para Nóminas
  hire_date        DateTime? @db.Date
  termination_date DateTime? @db.Date
  cost_center_id   Int?

  // Nuevos campos v4.1 - Estructura Gremio/Categoría/Sector
  union_category_id Int? // Categoría dentro del gremio (OFICIAL, AYUDANTE, etc.)
  work_sector_id    Int? // Sector de trabajo (Albañilería, Oficina, etc.)

  employee_monthly_salaries employee_monthly_salaries[]
  employee_salary_history   EmployeeSalaryHistory[]
  employee_categories       EmployeeCategory?           @relation(fields: [category_id], references: [id], onUpdate: NoAction, map: "fk_employees_category")
  Company                   Company                     @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_employees_company")

  // Nuevas relaciones v4.1
  unionCategory UnionCategory? @relation("UnionCategoryEmployees", fields: [union_category_id], references: [id], onUpdate: NoAction)
  workSector    WorkSector?    @relation("WorkSectorEmployees", fields: [work_sector_id], references: [id], onUpdate: NoAction)

  // Relaciones de Nóminas
  salaryComponents EmployeeSalaryComponent[]
  payrollInputs    PayrollInput[]
  payrollItems     PayrollItem[]
  advances         SalaryAdvance[]

  // Nuevas relaciones v4
  fixedConcepts    EmployeeFixedConcept[]
  variableConcepts PayrollVariableConcept[]
  attendanceEvents AttendanceEvent[]
  payrollRunItems  PayrollRunItem[]

  @@index([category_id], map: "idx_employees_category")
  @@index([company_id], map: "idx_employees_company")
  @@index([cost_center_id])
  @@index([union_category_id])
  @@index([work_sector_id])
  @@map("employees")
}

model EmployeeSalaryHistory {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(255)
  company_id     Int
  employee_id    String    @db.VarChar(255)
  effective_from DateTime? @default(now()) @db.Timestamptz(6)
  gross_salary   Decimal   @db.Decimal(10, 2)
  payroll_taxes  Decimal?  @default(0) @db.Decimal(10, 2)
  change_pct     Decimal?  @db.Decimal(5, 2)
  reason         String?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  Company        Company   @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_employee_salary_history_company")
  employees      Employee  @relation(fields: [employee_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_employee_salary_history_employee")

  @@index([company_id], map: "idx_employee_salary_history_company")
  @@index([employee_id], map: "idx_employee_salary_history_employee")
  @@map("employee_salary_history")
}

model employee_monthly_salaries {
  id               Int       @id @default(autoincrement())
  employee_id      String    @db.VarChar(255)
  month_year       DateTime  @db.Date
  fecha_imputacion String    @db.VarChar(7)
  gross_salary     Decimal   @db.Decimal(10, 2)
  payroll_taxes    Decimal?  @default(0) @db.Decimal(10, 2)
  total_cost       Decimal   @db.Decimal(10, 2)
  notes            String?
  company_id       Int
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)
  Company          Company   @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  employees        Employee  @relation(fields: [employee_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([employee_id, month_year])
  @@index([month_year], map: "idx_employee_monthly_salaries_month_year")
  @@index([employee_id], map: "idx_employee_monthly_salaries_employee_id")
  @@index([fecha_imputacion], map: "idx_employee_monthly_salaries_fecha_imputacion")
  @@index([company_id], map: "idx_employee_monthly_salaries_company_id")
}

model employee_salary_history_new {
  id            Int       @id @default(autoincrement())
  employee_id   String    @db.VarChar(255)
  old_salary    Decimal   @db.Decimal(10, 2)
  new_salary    Decimal   @db.Decimal(10, 2)
  change_date   DateTime? @default(now()) @db.Timestamptz(6)
  change_reason String?
  company_id    Int
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([change_date], map: "idx_employee_salary_history_change_date")
  @@index([company_id], map: "idx_employee_salary_history_company_id")
  @@index([employee_id], map: "idx_employee_salary_history_employee_id")
}

model indirect_cost_categories {
  id                 Int                  @id @default(autoincrement())
  name               String               @db.VarChar(255)
  description        String?
  type               String               @db.VarChar(50)
  color              String?              @default("#3B82F6") @db.VarChar(7)
  icon               String?              @default("Building2") @db.VarChar(100)
  company_id         Int
  created_at         DateTime?            @default(now()) @db.Timestamp(6)
  updated_at         DateTime?            @default(now()) @db.Timestamp(6)
  indirect_cost_base indirect_cost_base[]
  indirect_costs     indirect_costs[]

  @@index([company_id], map: "idx_indirect_cost_categories_company")
}

model indirect_costs {
  id                       Int                      @id @default(autoincrement())
  name                     String                   @db.VarChar(255)
  category_id              Int
  amount                   Decimal                  @db.Decimal(15, 2)
  fecha_imputacion         String                   @db.VarChar(7)
  description              String?
  status                   String                   @default("pending") @db.VarChar(20)
  due_date                 DateTime?                @db.Date
  company_id               Int
  created_at               DateTime?                @default(now()) @db.Timestamp(6)
  updated_at               DateTime?                @default(now()) @db.Timestamp(6)
  indirect_cost_history    indirect_cost_history[]
  indirect_cost_categories indirect_cost_categories @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([company_id], map: "idx_indirect_costs_company")
  @@index([category_id], map: "idx_indirect_costs_category")
  @@index([fecha_imputacion], map: "idx_indirect_costs_fecha")
}

model indirect_cost_history {
  id             Int            @id @default(autoincrement())
  cost_id        Int
  old_amount     Decimal?       @db.Decimal(15, 2)
  new_amount     Decimal        @db.Decimal(15, 2)
  change_type    String         @db.VarChar(50)
  reason         String?
  company_id     Int
  created_at     DateTime?      @default(now()) @db.Timestamp(6)
  indirect_costs indirect_costs @relation(fields: [cost_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([cost_id], map: "idx_indirect_cost_history_cost")
  @@index([company_id], map: "idx_indirect_cost_history_company")
}

model indirect_cost_base {
  id                            Int                             @id @default(autoincrement())
  name                          String                          @db.VarChar
  category_id                   Int
  description                   String?
  company_id                    Int
  created_at                    DateTime?                       @default(now()) @db.Timestamp(6)
  updated_at                    DateTime?                       @default(now()) @db.Timestamp(6)
  indirect_cost_categories      indirect_cost_categories        @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  indirect_cost_change_history  indirect_cost_change_history[]
  indirect_cost_monthly_records indirect_cost_monthly_records[]

  @@index([company_id], map: "idx_cost_base_company")
}

model indirect_cost_change_history {
  id                            Int                            @id @default(autoincrement())
  cost_base_id                  Int
  monthly_record_id             Int?
  change_type                   String                         @db.VarChar
  old_amount                    Decimal?                       @db.Decimal
  new_amount                    Decimal?                       @db.Decimal
  old_status                    String?                        @db.VarChar
  new_status                    String?                        @db.VarChar
  fecha_imputacion              String?                        @db.VarChar
  reason                        String?
  company_id                    Int
  created_at                    DateTime?                      @default(now()) @db.Timestamp(6)
  indirect_cost_base            indirect_cost_base             @relation(fields: [cost_base_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  indirect_cost_monthly_records indirect_cost_monthly_records? @relation(fields: [monthly_record_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([cost_base_id], map: "idx_cost_change_history_base")
  @@index([company_id], map: "idx_cost_change_history_company")
}

model indirect_cost_monthly_records {
  id                           Int                            @id @default(autoincrement())
  cost_base_id                 Int
  fecha_imputacion             String                         @db.VarChar
  amount                       Decimal                        @db.Decimal
  status                       String                         @default("pending") @db.VarChar
  due_date                     DateTime?                      @db.Date
  notes                        String?
  company_id                   Int
  created_at                   DateTime?                      @default(now()) @db.Timestamp(6)
  updated_at                   DateTime?                      @default(now()) @db.Timestamp(6)
  indirect_cost_change_history indirect_cost_change_history[]
  indirect_cost_base           indirect_cost_base             @relation(fields: [cost_base_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([cost_base_id], map: "idx_monthly_records_base")
  @@index([company_id], map: "idx_monthly_records_company")
  @@index([fecha_imputacion], map: "idx_monthly_records_month")
}

model product_categories {
  id            Int                     @id @default(autoincrement())
  name          String                  @db.VarChar(255)
  description   String?
  company_id    Int
  created_at    DateTime?               @default(now()) @db.Timestamp(6)
  updated_at    DateTime?               @default(now()) @db.Timestamp(6)
  subcategories product_subcategories[]
  products      products[]
}

model product_subcategories {
  id          Int                @id @default(autoincrement())
  name        String             @db.VarChar(255)
  description String?
  category_id Int
  company_id  Int
  created_at  DateTime?          @default(now()) @db.Timestamp(6)
  updated_at  DateTime?          @default(now()) @db.Timestamp(6)
  category    product_categories @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products    products[]
  recipes     recipes[]
}

model products {
  id                    Int                    @id @default(autoincrement())
  name                  String                 @db.VarChar(255)
  description           String?
  sku                   String?                @unique @db.VarChar(100)
  category_id           Int
  company_id            Int
  unit_price            Decimal?               @default(0) @db.Decimal(15, 2)
  unit_cost             Decimal?               @default(0) @db.Decimal(15, 2)
  stock_quantity        Int?                   @default(0)
  min_stock_level       Int?                   @default(0)
  is_active             Boolean?               @default(true)
  created_at            DateTime?              @default(now()) @db.Timestamp(6)
  updated_at            DateTime?              @default(now()) @db.Timestamp(6)
  subcategory_id        Int?
  location              String?                @db.VarChar(255)
  weight                Decimal?               @default(0) @db.Decimal(15, 3)
  volume                Decimal?               @default(0) @db.Decimal(15, 3)
  volume_unit           String?                @default("metros_lineales") @db.VarChar(50)
  image                 String?                @db.VarChar(500)
  images                Json?
  product_categories    product_categories     @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  company               Company                @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_subcategories product_subcategories? @relation(fields: [subcategory_id], references: [id], onUpdate: NoAction)

  @@index([category_id], map: "idx_products_category_id")
  @@index([subcategory_id], map: "idx_products_subcategory_id")
  @@index([company_id], map: "idx_products_company_id")
  @@index([sku], map: "idx_products_sku")
}

model suppliers {
  id                       Int                       @id @default(autoincrement())
  name                     String                    @db.VarChar(255)
  contact_person           String?                   @db.VarChar(255)
  phone                    String?                   @db.VarChar(50)
  email                    String?                   @db.VarChar(255)
  address                  String?
  // Campos extendidos de ubicación
  city                     String?                   @db.VarChar(255)
  postal_code              String?                   @db.VarChar(50)
  province                 String?                   @db.VarChar(255)
  condiciones_pago         String?                   @db.VarChar(255)
  // Pronto Pago por defecto del proveedor
  prontoPagoDias           Int? // Días para descuento (ej: 10)
  prontoPagoPorcentaje     Decimal?                  @db.Decimal(5, 2) // % descuento (ej: 2.5)
  prontoPagoAplicaSobre    String?                   @db.VarChar(20) // "NETO" | "TOTAL" | "NETO_SIN_IVA"
  ingresos_brutos          String?                   @db.VarChar(100)
  condicion_iva            String?                   @db.VarChar(100)
  cbu                      String?
  alias_cbu                String?
  banco                    String?
  tipo_cuenta              String?
  numero_cuenta            String?
  // Contacto y notas adicionales
  contact_phone            String?                   @db.VarChar(50)
  contact_email            String?                   @db.VarChar(255)
  notes                    String?
  // Bloqueo de proveedor
  isBlocked                Boolean                   @default(false)
  blockedReason            String?
  blockedAt                DateTime?
  blockedByUserId          Int?
  company_id               Int
  created_at               DateTime?                 @default(now()) @db.Timestamp(6)
  updated_at               DateTime?                 @default(now()) @db.Timestamp(6)
  cuit                     String?                   @db.VarChar(20)
  razon_social             String?                   @db.VarChar(255)
  codigo                   String?                   @db.VarChar(50)
  purchaseReceipts         PurchaseReceipt[]
  purchaseReceiptItems     PurchaseReceiptItem[]
  supplierItems            SupplierItem[]
  paymentOrders            PaymentOrder[]
  Company                  Company                   @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  supplies                 supplies[]
  // Módulo Compras Extendido
  purchaseOrders           PurchaseOrder[]
  goodsReceipts            GoodsReceipt[]
  creditDebitNotes         CreditDebitNote[]
  paymentRequests          PaymentRequest[]
  purchaseReturns          PurchaseReturn[]
  supplierLeadTimes        SupplierLeadTime[]
  replenishmentSuggestions ReplenishmentSuggestion[]
  accountMovements         SupplierAccountMovement[]
  // Sistema de Solicitudes y Cotizaciones
  purchaseQuotations       PurchaseQuotation[]
  // Solicitudes de NCA
  creditNoteRequests       CreditNoteRequest[]
  // Contratos de Servicios
  serviceContracts         ServiceContract[]
  // GRNI - Accruals pendientes de factura
  grniAccruals             GRNIAccrual[]
  // Solicitudes de cambio (doble aprobación)
  changeRequests           SupplierChangeRequest[]

  @@index([company_id], map: "idx_suppliers_company_id")
  @@index([cuit])
  @@index([codigo])
  @@index([isBlocked])
}

// =====================================================
// SOLICITUDES DE CAMBIO DE PROVEEDOR (Doble Aprobación)
// Para cambios sensibles como datos bancarios
// =====================================================

model SupplierChangeRequest {
  id         Int       @id @default(autoincrement())
  supplierId Int
  supplier   suppliers @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  companyId  Int
  company    Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  tipo            String // CAMBIO_BANCARIO, CAMBIO_FISCAL, etc.
  datosAnteriores Json // Datos antes del cambio
  datosNuevos     Json // Datos propuestos

  estado String @default("PENDIENTE_APROBACION")
  // PENDIENTE_APROBACION, APROBADO, RECHAZADO

  // Primer solicitante/aprobador
  solicitadoPor Int
  solicitante   User     @relation("SupplierChangeRequested", fields: [solicitadoPor], references: [id])
  solicitadoAt  DateTime @default(now())

  // Primer aprobador (diferente del solicitante - SoD)
  aprobadoPor Int?
  aprobador   User?     @relation("SupplierChangeApproved", fields: [aprobadoPor], references: [id])
  aprobadoAt  DateTime?

  // Rechazo
  rechazadoPor  Int?
  rechazador    User?     @relation("SupplierChangeRejected", fields: [rechazadoPor], references: [id])
  rechazadoAt   DateTime?
  motivoRechazo String?

  // Segundo aprobador (para doble aprobación en cambios críticos)
  segundoAprobadorId  Int?
  segundoAprobador    User?     @relation("SupplierChangeSecondApproved", fields: [segundoAprobadorId], references: [id])
  segundaAprobacionAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId])
  @@index([companyId, estado])
  @@map("supplier_change_requests")
}

// =====================================================
// CATEGORÍAS DE INSUMOS/SUPPLIES
// =====================================================

model SupplyCategory {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100) // Rodamientos, Electricidad, Lubricantes, etc.
  description String?
  code        String?  @db.VarChar(20) // Código opcional (ROD, ELE, LUB)
  color       String?  @db.VarChar(7) // Color hex para UI (#FF5733)
  icon        String?  @db.VarChar(50) // Nombre del icono (cog, zap, droplet)
  parentId    Int? // Para subcategorías
  companyId   Int
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0) // Para ordenar en listas
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company  Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent   SupplyCategory?  @relation("SupplyCategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children SupplyCategory[] @relation("SupplyCategoryHierarchy")
  supplies supplies[]

  @@unique([companyId, name])
  @@unique([companyId, code])
  @@index([parentId])
  @@index([companyId, isActive])
  @@map("supply_categories")
}

model supplies {
  id                    Int                     @id @default(autoincrement())
  code                  String?                 @db.VarChar(50) // Código interno propio
  name                  String                  @db.VarChar(255)
  unit_measure          String                  @default("TN") @db.VarChar(50)
  supplier_id           Int?
  company_id            Int
  categoryId            Int? // FK a SupplyCategory
  is_active             Boolean?                @default(true)
  created_at            DateTime?               @default(now()) @db.Timestamp(6)
  updated_at            DateTime?               @default(now()) @db.Timestamp(6)
  supplierItems         SupplierItem[]
  recipe_items          recipe_items[]
  Company               Company                 @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  suppliers             suppliers?              @relation(fields: [supplier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  category              SupplyCategory?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  supply_monthly_prices supply_monthly_prices[]
  supply_price_history  supply_price_history[]

  @@unique([company_id, code]) // Código único por empresa
  @@index([company_id], map: "idx_supplies_company_id")
  @@index([categoryId])
}

// =====================================================
// SISTEMA DE CUENTAS CORRIENTES DE PROVEEDORES
// =====================================================

enum AccountMovementType {
  FACTURA
  NC
  ND
  PAGO
  ANTICIPO
  RETENCION
  AJUSTE
}

model SupplierAccountMovement {
  id         Int @id @default(autoincrement())
  supplierId Int
  companyId  Int

  // Tipo de movimiento
  tipo AccountMovementType

  // Referencias opcionales según el tipo
  facturaId           Int?
  notaCreditoDebitoId Int?
  pagoId              Int?

  // Fechas
  fecha            DateTime  @db.Date
  fechaVencimiento DateTime? @db.Date

  // Montos
  debe            Decimal @default(0) @db.Decimal(15, 2)
  haber           Decimal @default(0) @db.Decimal(15, 2)
  saldoMovimiento Decimal @default(0) @db.Decimal(15, 2)

  // Información del comprobante
  comprobante String? @db.VarChar(100)
  descripcion String?

  // Método de pago (si aplica)
  metodoPago String? @db.VarChar(50)

  // ViewMode - hereda del documento que generó el movimiento
  docType DocType @default(T1)

  // Estado
  conciliado   Boolean   @default(false)
  conciliadoAt DateTime?
  conciliadoBy Int?

  // Auditoría
  createdBy Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  supplier          suppliers        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  company           Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  factura           PurchaseReceipt? @relation(fields: [facturaId], references: [id], onDelete: SetNull)
  notaCreditoDebito CreditDebitNote? @relation(fields: [notaCreditoDebitoId], references: [id], onDelete: SetNull)
  pago              PaymentOrder?    @relation(fields: [pagoId], references: [id], onDelete: SetNull)
  conciliadoByUser  User?            @relation("MovementConciliadoBy", fields: [conciliadoBy], references: [id], onDelete: SetNull)
  createdByUser     User?            @relation("MovementCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([supplierId])
  @@index([companyId])
  @@index([fecha])
  @@index([tipo])
  @@index([comprobante])
  @@index([supplierId, conciliado])
  @@index([docType])
  @@index([companyId, docType])
  @@map("SupplierAccountMovement")
}

model supply_monthly_prices {
  id               Int       @id @default(autoincrement())
  supply_id        Int
  month_year       DateTime  @db.Date
  fecha_imputacion String    @db.VarChar(7)
  price_per_unit   Decimal   @db.Decimal(15, 2)
  notes            String?
  company_id       Int
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)
  freight_cost     Decimal?  @default(0) @db.Decimal(15, 2)
  Company          Company   @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  supplies         supplies  @relation(fields: [supply_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([supply_id, month_year])
  @@index([month_year], map: "idx_supply_monthly_prices_month_year")
  @@index([supply_id], map: "idx_supply_monthly_prices_supply_id")
  @@index([fecha_imputacion], map: "idx_supply_monthly_prices_fecha_imputacion")
}

model supply_price_history {
  id               Int       @id @default(autoincrement())
  supply_id        Int
  change_type      String    @db.VarChar(50)
  old_price        Decimal?  @db.Decimal(15, 2)
  new_price        Decimal?  @db.Decimal(15, 2)
  month_year       DateTime  @db.Date
  notes            String?
  company_id       Int
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  old_freight_cost Decimal?  @default(0) @db.Decimal(15, 2)
  new_freight_cost Decimal?  @default(0) @db.Decimal(15, 2)
  Company          Company   @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  supplies         supplies  @relation(fields: [supply_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model recipes {
  id                      Int                     @id @default(autoincrement())
  name                    String                  @db.VarChar(255)
  product_id              String?
  base_type               String                  @db.VarChar(20)
  version                 String                  @db.VarChar(50)
  description             String?
  output_quantity         Decimal?                @db.Decimal(10, 5)
  output_unit_label       String?                 @default("unidades") @db.VarChar(100)
  intermediate_quantity   Decimal?                @db.Decimal(10, 5)
  intermediate_unit_label String?                 @default("placas") @db.VarChar(100)
  is_active               Boolean?                @default(true)
  company_id              Int
  created_at              DateTime?               @default(now()) @db.Timestamp(6)
  updated_at              DateTime?               @default(now()) @db.Timestamp(6)
  units_per_item          Decimal?                @db.Decimal(10, 4)
  subcategory_id          Int?
  metros_utiles           Decimal?                @db.Decimal(10, 2)
  cantidad_pastones       Int?
  notes                   String?
  recipe_change_history   recipe_change_history[]
  recipe_items            recipe_items[]
  Company                 Company                 @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_subcategories   product_subcategories?  @relation(fields: [subcategory_id], references: [id], onUpdate: NoAction)

  @@unique([product_id, name, version, company_id])
  @@index([company_id], map: "idx_recipes_company")
  @@index([product_id], map: "idx_recipes_product")
}

model recipe_cost_tests {
  id            Int       @id @default(autoincrement())
  recipe_id     Int
  test_name     String    @db.VarChar(255)
  notes         String?
  test_data     Json
  total_cost    Decimal   @db.Decimal(10, 2)
  cost_per_unit Decimal   @db.Decimal(10, 2)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  created_by    Int?
  company_id    Int
  Company       Company   @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_recipe_cost_tests_company")

  @@index([recipe_id], map: "idx_cost_tests_recipe")
  @@index([company_id], map: "idx_cost_tests_company")
  @@index([created_at], map: "idx_cost_tests_date")
}

model recipe_change_history {
  id          Int       @id @default(autoincrement())
  recipe_id   Int
  change_type String    @db.VarChar(50)
  reason      String?
  company_id  Int
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  Company     Company   @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  recipes     recipes   @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([recipe_id], map: "idx_recipe_history_recipe")
}

model recipe_items {
  id                 Int       @id @default(autoincrement())
  recipe_id          Int
  supply_id          Int
  quantity           Decimal   @db.Decimal(10, 5)
  unit_measure       String    @db.VarChar(10)
  company_id         Int
  created_at         DateTime? @default(now()) @db.Timestamp(6)
  updated_at         DateTime? @default(now()) @db.Timestamp(6)
  pulsos             Int?      @default(100)
  kg_por_pulso       Decimal?  @default(0.0000) @db.Decimal(10, 4)
  is_bank_ingredient Boolean?  @default(false)
  Company            Company   @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  recipes            recipes   @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  supplies           supplies  @relation(fields: [supply_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([recipe_id], map: "idx_recipe_items_recipe")
  @@index([supply_id], map: "idx_recipe_items_supply")
}

model cost_distribution_config {
  id                  Int       @id @default(autoincrement())
  company_id          Int
  cost_type           String    @db.VarChar(100)
  cost_name           String    @db.VarChar(255)
  product_category_id Int
  percentage          Decimal   @db.Decimal(5, 2)
  is_active           Boolean?  @default(true)
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  updated_at          DateTime? @default(now()) @db.Timestamp(6)

  @@unique([company_id, cost_type, product_category_id])
  @@index([company_id], map: "idx_cost_dist_company")
  @@index([cost_type], map: "idx_cost_dist_type")
}

model employee_distribution_config {
  id                  Int       @id @default(autoincrement())
  company_id          Int
  employee_id         Int
  product_category_id Int
  percentage          Decimal   @db.Decimal(5, 2)
  is_active           Boolean?  @default(true)
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  updated_at          DateTime? @default(now()) @db.Timestamp(6)

  @@unique([company_id, employee_id, product_category_id])
  @@index([company_id], map: "idx_emp_dist_company")
  @@index([employee_id], map: "idx_emp_dist_employee")
}

model employee_cost_distribution {
  id                   Int       @id @default(autoincrement())
  company_id           Int
  cost_type            String    @db.VarChar(100)
  cost_name            String    @db.VarChar(255)
  employee_category_id Int
  percentage           Decimal   @db.Decimal(5, 2)
  is_active            Boolean?  @default(true)
  created_at           DateTime? @default(now()) @db.Timestamp(6)
  updated_at           DateTime? @default(now()) @db.Timestamp(6)
  product_category_id  Int?

  @@unique([company_id, cost_type, employee_category_id, product_category_id], map: "unique_employee_cost_distribution")
  @@index([company_id], map: "idx_emp_cost_dist_company")
  @@index([cost_type], map: "idx_emp_cost_dist_type")
  @@index([product_category_id], map: "idx_emp_cost_dist_product_category")
}

model monthly_sales {
  id               Int       @id @default(autoincrement())
  company_id       Int
  product_id       String    @db.VarChar(255)
  product_name     String    @db.VarChar(255)
  month_year       DateTime  @db.Date
  fecha_imputacion String    @db.VarChar(7)
  quantity_sold    Decimal   @db.Decimal(15, 4)
  unit_price       Decimal   @db.Decimal(15, 2)
  total_revenue    Decimal   @db.Decimal(15, 2)
  notes            String?
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)

  @@unique([company_id, product_id, month_year])
  @@index([month_year], map: "idx_monthly_sales_month")
  @@index([company_id], map: "idx_monthly_sales_company")
  @@index([fecha_imputacion], map: "idx_monthly_sales_fecha")
}

model monthly_production {
  id                Int       @id @default(autoincrement())
  company_id        Int
  product_id        String    @db.VarChar(255)
  product_name      String    @db.VarChar(255)
  month_year        DateTime  @db.Date
  fecha_imputacion  String    @db.VarChar(7)
  quantity_produced Decimal   @db.Decimal(15, 4)
  unit_cost         Decimal   @db.Decimal(15, 2)
  total_cost        Decimal   @db.Decimal(15, 2)
  notes             String?
  created_at        DateTime? @default(now()) @db.Timestamp(6)
  updated_at        DateTime? @default(now()) @db.Timestamp(6)

  @@unique([company_id, product_id, month_year])
  @@index([month_year], map: "idx_monthly_production_month")
  @@index([company_id], map: "idx_monthly_production_company")
  @@index([fecha_imputacion], map: "idx_monthly_production_fecha")
}

model PriceComparison {
  id          String                      @id @default(cuid())
  name        String
  companyId   Int
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  company     Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  competitors PriceComparisonCompetitor[]

  @@index([companyId])
  @@map("PriceComparison")
}

model PriceComparisonCompetitor {
  id            String                        @id @default(cuid())
  name          String
  comparisonId  String
  comparison    PriceComparison               @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
  productPrices PriceComparisonProductPrice[]

  @@index([comparisonId])
  @@map("PriceComparisonCompetitor")
}

model PriceComparisonProductPrice {
  id              String                    @id @default(cuid())
  productId       Int
  productName     String
  myPrice         Decimal                   @db.Decimal(15, 2)
  competitorPrice Decimal?                  @db.Decimal(15, 2)
  competitorId    String
  competitor      PriceComparisonCompetitor @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  @@index([competitorId])
  @@index([productId])
  @@map("PriceComparisonProductPrice")
}

model TaxBase {
  id            Int         @id @default(autoincrement())
  name          String      @db.VarChar(255)
  description   String?
  isRecurring   Boolean     @default(true)
  recurringDay  Int
  companyId     Int
  createdBy     Int
  notes         String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now()) @updatedAt
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User        @relation("TaxBaseCreatedBy", fields: [createdBy], references: [id])
  taxRecords    TaxRecord[]

  @@index([companyId])
  @@index([isActive])
  @@index([isRecurring, recurringDay], map: "TaxBase_recurring_idx")
  @@map("TaxBase")
}

model TaxRecord {
  id             Int              @id @default(autoincrement())
  taxBaseId      Int
  amount         Decimal          @db.Decimal(15, 2)
  status         TaxControlStatus @default(PENDIENTE)
  receivedDate   DateTime?
  paymentDate    DateTime?
  alertDate      DateTime
  month          String           @db.VarChar(7)
  receivedBy     Int?
  paidBy         Int?
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  paidByUser     User?            @relation("TaxRecordPaidBy", fields: [paidBy], references: [id])
  receivedByUser User?            @relation("TaxRecordReceivedBy", fields: [receivedBy], references: [id])
  taxBase        TaxBase          @relation(fields: [taxBaseId], references: [id], onDelete: Cascade)

  @@unique([taxBaseId, month])
  @@index([taxBaseId])
  @@index([status])
  @@index([alertDate])
  @@index([month])
  @@map("TaxRecord")
}

model Control {
  id            Int      @id @default(autoincrement())
  name          String   @db.VarChar(255)
  description   String?
  type          String   @db.VarChar(50) // 'tax', 'quality', 'production', 'financial', 'compliance', 'custom'
  companyId     Int
  createdBy     Int
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("ControlCreatedBy", fields: [createdBy], references: [id])

  @@unique([companyId, name, type])
  @@index([companyId])
  @@index([type])
  @@index([isActive])
  @@map("Control")
}

model Truck {
  id             Int       @id @default(autoincrement())
  internalId     Int? // ID interno único por empresa
  name           String
  type           TruckType
  length         Float
  maxWeight      Float?
  description    String?
  companyId      Int
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  client         String?
  isOwn          Boolean?  @default(true)
  chasisLength   Float?
  acopladoLength Float?
  chasisWeight   Float?
  acopladoWeight Float?
  loads          Load[]
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@unique([companyId, internalId])
  @@index([companyId])
  @@index([type])
  @@index([internalId])
  @@map("Truck")
}

// Estado de carga para workflow
enum LoadStatus {
  DRAFT
  PENDING
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

model Load {
  id              Int        @id @default(autoincrement())
  internalId      Int? // ID interno único por empresa
  truckId         Int
  date            DateTime   @default(now())
  description     String?
  companyId       Int
  status          LoadStatus @default(DRAFT)
  scheduledDate   DateTime? // Fecha programada de carga
  departureDate   DateTime? // Fecha/hora de salida real
  deliveryDate    DateTime? // Fecha/hora de entrega real
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deliveryClient  String?
  deliveryAddress String?
  isCorralon      Boolean?   @default(false)
  company         Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  truck           Truck      @relation(fields: [truckId], references: [id], onDelete: Cascade)
  items           LoadItem[]

  @@unique([companyId, internalId])
  @@index([companyId])
  @@index([truckId])
  @@index([date])
  @@index([internalId])
  @@index([status])
  @@map("Load")
}

model LoadItem {
  id          Int      @id @default(autoincrement())
  loadId      Int
  productId   String
  productName String
  quantity    Int
  length      Float?
  weight      Float?
  position    Int
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  load        Load     @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([loadId])
  @@index([productId])
  @@map("LoadItem")
}

model ClientType {
  id          String   @id @default(cuid())
  name        String
  description String?
  companyId   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clients     Client[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("ClientType")
}

// Zonas de reparto/entrega
model DeliveryZone {
  id          String   @id @default(cuid())
  name        String
  description String?
  companyId   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clients     Client[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("DeliveryZone")
}

// Zonas de Venta (Sales Territories)
model SalesZone {
  id          Int      @id @default(autoincrement())
  nombre      String   @db.VarChar(100)
  descripcion String?  @db.VarChar(500)
  companyId   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendedores SalesRep[]
  clientes   Client[]   @relation("ClientSalesZone")

  @@unique([companyId, nombre])
  @@index([companyId])
  @@map("sales_zones")
}

// Vendedores (Sales Reps)
model SalesRep {
  id           Int      @id @default(autoincrement())
  nombre       String   @db.VarChar(255)
  email        String   @db.VarChar(255)
  telefono     String?  @db.VarChar(50)
  zonaId       Int?
  comision     Decimal  @default(0) @db.Decimal(5, 2)
  cuotaMensual Decimal  @default(0) @db.Decimal(15, 2)
  ventasMes    Decimal  @default(0) @db.Decimal(15, 2)
  ventasAnio   Decimal  @default(0) @db.Decimal(15, 2)
  companyId    Int
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  zona    SalesZone? @relation(fields: [zonaId], references: [id], onUpdate: NoAction)

  @@index([companyId])
  @@index([zonaId])
  @@map("sales_reps")
}

// Condiciones de Pago (Payment Terms)
model PaymentTerm {
  id                   Int      @id @default(autoincrement())
  nombre               String   @db.VarChar(100)
  dias                 Int      @default(0)
  descuentoProntoPago  Decimal  @default(0) @db.Decimal(5, 2)
  diasDescuento        Int      @default(0)
  companyId            Int
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, nombre])
  @@index([companyId])
  @@map("payment_terms")
}

// Empresas de Transporte (configurables por empresa)
model TransportCompany {
  id          String   @id @default(cuid())
  name        String
  description String?
  phone       String?
  email       String?
  companyId   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clients     Client[] @relation("ClientTransport")

  @@unique([companyId, name])
  @@index([companyId])
  @@map("TransportCompany")
}

// Rubros/Sectores de clientes (configurables por empresa)
model BusinessSector {
  id          String   @id @default(cuid())
  name        String
  description String?
  companyId   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clients     Client[] @relation("ClientSector")

  @@unique([companyId, name])
  @@index([companyId])
  @@map("BusinessSector")
}

model Client {
  id                     String    @id @default(cuid())
  name                   String?
  email                  String
  phone                  String?
  address                String?
  cuit                   String?
  taxCondition           String    @default("consumidor_final")
  creditLimit            Float?
  currentBalance         Float     @default(0)
  paymentTerms           Int?      @default(0)
  isActive               Boolean   @default(true)
  observations           String?
  companyId              Int
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  legalName              String
  alternatePhone         String?
  city                   String?
  province               String?
  postalCode             String
  checkTerms             Int?
  saleCondition          String?
  contactPerson          String?
  grossIncome            String?
  activityStartDate      DateTime?
  merchandisePendingDays Int?
  sellerId               Int?

  // Clasificación del cliente
  clientTypeId   String?
  deliveryZoneId String?
  salesZoneId    Int?

  // Sistema de Bloqueo (para control de crédito)
  isBlocked       Boolean   @default(false)
  blockedReason   String?
  blockedAt       DateTime?
  blockedByUserId Int?

  // Condiciones de Venta (Tipo 1, 2 o 3)
  tipoCondicionVenta SaleConditionType @default(FORMAL)
  porcentajeFormal   Decimal?          @db.Decimal(5, 2) // Solo para MIXTO (ej: 60.00)

  // Límites de Acopio
  limiteAcopio     Decimal? @db.Decimal(15, 2) // Máximo en acopio
  acopioActual     Decimal  @default(0) @db.Decimal(15, 2) // Saldo actual en acopio
  diasAlertaAcopio Int? // Días antes de vencimiento para alertar

  // Campos adicionales (del sistema legacy)
  transportCompanyId    String? // FK a TransportCompany
  businessSectorId      String? // FK a BusinessSector
  settlementPeriod      SettlementPeriod? // Periodo de liquidación
  requiresPurchaseOrder Boolean           @default(false) // Exige orden de compra
  isDeliveryBlocked     Boolean           @default(false) // Bloqueado para entregas
  deliveryBlockedReason String? // Razón del bloqueo de entregas
  deliveryBlockedAt     DateTime? // Fecha de bloqueo de entregas
  quickNote             String? // Nota rápida visible en ventas
  quickNoteExpiry       DateTime? // Fecha de vencimiento de la nota
  hasCheckLimit         Boolean           @default(false) // Tiene tope de cheques
  checkLimitType        String? // Tipo de tope: 'CANTIDAD' o 'SALDO'
  checkLimit            Decimal?          @db.Decimal(15, 2) // Tope de cheques
  generalDiscount       Decimal?          @db.Decimal(5, 2) // Descuento general (%) - OBSOLETO, usar discountListId

  // Override temporal de límites (duración de cambios)
  creditLimitOverride                  Decimal?  @db.Decimal(15, 2) // Override temporal límite crédito
  creditLimitOverrideExpiry            DateTime? // Fecha expiración override
  merchandisePendingDaysOverride       Int? // Override temporal días mercadería pendiente
  merchandisePendingDaysOverrideExpiry DateTime? // Fecha expiración override
  tempCreditLimit                      Decimal?  @db.Decimal(15, 2) // Límite crédito temporal (valor base)
  tempCreditLimitOverride              Decimal?  @db.Decimal(15, 2) // Override temporal del límite temporal
  tempCreditLimitOverrideExpiry        DateTime? // Fecha expiración override

  // Otros campos adicionales
  invoiceDueDays        Int?    @default(15) // Vencimiento facturas por defecto (días)
  accountBlockDays      Int? // Días inactividad para bloquear cta cte
  extraBonusDescription String? // Bonificación extra (ej: "10% por pago en 30 días")

  // Lista de descuentos asignada
  discountListId String? // FK a DiscountList

  // Lista de precios por defecto
  defaultPriceListId Int? // FK a SalesPriceList

  // Campos adicionales extendidos
  whatsapp               String? // Número de WhatsApp
  municipalRetentionType String? // Tipo retención municipal (CONVENIO_MULTILATERAL, LOCAL, EXENTO, NO_APLICA)

  // Subclientes (relación padre-hijo)
  parentClientId String? // FK a Client padre

  // Días de visita y entrega (JSON arrays)
  visitDays    Json? @default("[]") // ["LUNES", "MARTES", ...]
  deliveryDays Json? @default("[]") // ["LUNES", "MARTES", ...]

  // Exenciones impositivas
  isVatPerceptionExempt          Boolean   @default(false) // Exento percepción IVA
  vatPerceptionExemptUntil       DateTime? // Fecha hasta exención
  vatPerceptionExemptCertificate String? // Nro certificado exención
  isVatRetentionExempt           Boolean   @default(false) // Exento retención IVA
  vatRetentionExemptUntil        DateTime? // Fecha hasta exención
  isGrossIncomeExempt            Boolean   @default(false) // Exento IIBB
  grossIncomeExemptUntil         DateTime? // Fecha hasta exención
  isMunicipalExempt              Boolean   @default(false) // Exento municipal
  municipalExemptUntil           DateTime? // Fecha hasta exención

  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  defaultPriceList SalesPriceList?   @relation("ClientDefaultPriceList", fields: [defaultPriceListId], references: [id], onUpdate: NoAction)
  seller           User?             @relation("ClientSeller", fields: [sellerId], references: [id], onUpdate: NoAction)
  clientType       ClientType?       @relation(fields: [clientTypeId], references: [id], onUpdate: NoAction)
  deliveryZone     DeliveryZone?     @relation(fields: [deliveryZoneId], references: [id], onUpdate: NoAction)
  salesZone        SalesZone?        @relation("ClientSalesZone", fields: [salesZoneId], references: [id], onUpdate: NoAction)
  blockedByUser    User?             @relation("ClientBlockedBy", fields: [blockedByUserId], references: [id], onUpdate: NoAction)
  transportCompany TransportCompany? @relation("ClientTransport", fields: [transportCompanyId], references: [id], onUpdate: NoAction)
  businessSector   BusinessSector?   @relation("ClientSector", fields: [businessSectorId], references: [id], onUpdate: NoAction)
  discountList     DiscountList?     @relation("ClientDiscountList", fields: [discountListId], references: [id], onUpdate: NoAction)
  parentClient     Client?           @relation("ClientSubclients", fields: [parentClientId], references: [id], onUpdate: NoAction)
  subClients       Client[]          @relation("ClientSubclients")
  discounts        ClientDiscount[]
  priceLists       ClientPriceList[]

  // Sistema de Ventas
  quotes           Quote[]
  sales            Sale[]
  deliveries       SaleDelivery[]
  remitos          SaleRemito[]
  invoices         SalesInvoice[]
  creditDebitNotes SalesCreditDebitNote[]
  payments         ClientPayment[]
  ledgerEntries    ClientLedgerEntry[]
  blockHistory     ClientBlockHistory[]   @relation("ClientBlockHistory")
  notes            ClientNote[]           @relation("ClientNotes")
  portalAccess     ClientPortalAccess[]

  // Portal del Cliente
  contacts     ClientContact[]
  portalUsers  ClientPortalUser[]
  portalOrders ClientPortalOrder[]

  // Sistema de Acopios
  acopios SaleAcopio[]

  // AI Chat Sessions
  chatSessions ChatSession[]

  // Postventa
  rmas       SaleRMA[]         @relation("ClientRMAs")
  warranties ProductWarranty[] @relation("ClientWarranties")

  // Snapshots de saldo
  balanceSnapshots ClientBalanceSnapshot[]

  @@index([companyId])
  @@index([isActive])
  @@index([companyId, isActive])
  @@index([name])
  @@index([sellerId])
  @@index([tipoCondicionVenta])
  @@index([clientTypeId])
  @@index([deliveryZoneId])
  @@index([salesZoneId])
  @@index([isBlocked])
  @@index([transportCompanyId])
  @@index([businessSectorId])
  @@index([settlementPeriod])
  @@index([isDeliveryBlocked])
  @@index([quickNoteExpiry])
  @@index([parentClientId])
  @@index([isVatPerceptionExempt])
  @@map("Client")
}

model ClientBlockHistory {
  id               String    @id @default(cuid())
  clientId         String
  companyId        Int
  tipoBloqueo      String // CREDITO, MORA, MANUAL, CHEQUE_RECHAZADO
  motivo           String
  montoExcedido    Decimal?  @db.Decimal(15, 2)
  facturaRef       String?
  diasMora         Int?
  bloqueadoAt      DateTime  @default(now())
  bloqueadoPor     Int
  desbloqueadoAt   DateTime?
  desbloqueadoPor  Int?
  motivoDesbloqueo String?

  client        Client  @relation("ClientBlockHistory", fields: [clientId], references: [id], onDelete: Cascade)
  company       Company @relation("ClientBlockHistory", fields: [companyId], references: [id], onDelete: Cascade)
  bloqueador    User    @relation("BlockedByUser", fields: [bloqueadoPor], references: [id], onUpdate: NoAction)
  desbloqueador User?   @relation("UnblockedByUser", fields: [desbloqueadoPor], references: [id], onUpdate: NoAction)

  @@index([clientId])
  @@index([companyId])
  @@index([bloqueadoAt])
  @@index([desbloqueadoAt])
  @@map("ClientBlockHistory")
}

model ClientNote {
  id           String    @id @default(cuid())
  clientId     String
  companyId    Int
  userId       Int
  tipo         String // LLAMADA, REUNION, EMAIL, RECLAMO, VISITA, NOTA, SEGUIMIENTO
  asunto       String
  contenido    String    @db.Text
  importante   Boolean   @default(false)
  fechaNota    DateTime  @default(now())
  recordatorio DateTime?
  completado   Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  client  Client  @relation("ClientNotes", fields: [clientId], references: [id], onDelete: Cascade)
  company Company @relation("ClientNotes", fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation("ClientNotes", fields: [userId], references: [id])

  @@index([clientId])
  @@index([companyId])
  @@index([userId])
  @@index([recordatorio])
  @@index([fechaNota])
  @@map("ClientNote")
}

model ClientDiscount {
  id          String    @id @default(cuid())
  clientId    String
  name        String
  percentage  Float?
  amount      Float?
  categoryId  Int?
  productId   String?
  minQuantity Int?
  isActive    Boolean   @default(true)
  validFrom   DateTime?
  validUntil  DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([isActive])
  @@map("ClientDiscount")
}

model ClientPriceList {
  id            String   @id @default(cuid())
  clientId      String
  priceListId   String
  priceListName String
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([isActive])
  @@map("ClientPriceList")
}

// =====================================================
// SISTEMA DE LISTAS DE DESCUENTOS
// =====================================================

// Lista/Plantilla de descuentos que se puede asignar a múltiples clientes
model DiscountList {
  id          String   @id @default(cuid())
  name        String // Nombre de la lista (ej: "Lista Mayorista", "Lista Corralón")
  description String?
  companyId   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company          Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rubroDiscounts   DiscountListRubro[] // Descuentos por rubro/categoría
  productDiscounts DiscountListProduct[] // Descuentos por producto específico
  clients          Client[]              @relation("ClientDiscountList") // Clientes que usan esta lista

  @@unique([companyId, name])
  @@index([companyId])
  @@index([isActive])
  @@map("DiscountList")
}

// Descuento por Rubro/Categoría dentro de una lista
model DiscountListRubro {
  id             String @id @default(cuid())
  discountListId String
  categoryId     Int // FK a Category (rubro)
  categoryName   String // Nombre del rubro (desnormalizado para visualización)

  // Rangos de serie (opcional)
  serieDesde Int? @default(0)
  serieHasta Int? @default(0)

  // Múltiples tipos de descuento
  descuento1    Decimal? @db.Decimal(5, 2) // Dto.1 (%)
  descuento2    Decimal? @db.Decimal(5, 2) // Dto.2 (%)
  descuentoPago Decimal? @db.Decimal(5, 2) // Dto.Pago (%)
  comision      Decimal? @db.Decimal(5, 2) // Comisión (%)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  discountList DiscountList @relation(fields: [discountListId], references: [id], onDelete: Cascade)
  category     Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([discountListId])
  @@index([categoryId])
  @@map("DiscountListRubro")
}

// Descuento por Producto específico dentro de una lista
model DiscountListProduct {
  id             String @id @default(cuid())
  discountListId String
  productId      String // FK a Product
  productCode    String // Código del producto (desnormalizado)
  productName    String // Nombre del producto (desnormalizado)

  descuento Decimal @db.Decimal(5, 2) // Descuento (%)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  discountList DiscountList @relation(fields: [discountListId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([discountListId])
  @@index([productId])
  @@map("DiscountListProduct")
}

model PurchaseAccount {
  id           Int               @id @default(autoincrement())
  nombre       String            @db.VarChar(255)
  descripcion  String?
  activa       Boolean           @default(true)
  companyId    Int
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  company      Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  comprobantes PurchaseReceipt[]

  @@index([companyId])
  @@index([activa])
  @@map("PurchaseAccount")
}

model PurchaseReceipt {
  id                         Int                        @id @default(autoincrement())
  numeroSerie                String                     @db.VarChar(10)
  numeroFactura              String                     @db.VarChar(20)
  tipo                       String                     @db.VarChar(50)
  proveedorId                Int
  fechaEmision               DateTime                   @db.Date
  fechaVencimiento           DateTime?                  @db.Date
  fechaImputacion            DateTime                   @db.Date
  tipoPago                   String                     @db.VarChar(20)
  metodoPago                 String?                    @db.VarChar(50)
  neto                       Decimal                    @db.Decimal(15, 2)
  iva21                      Decimal                    @default(0) @db.Decimal(15, 2)
  noGravado                  Decimal                    @default(0) @db.Decimal(15, 2)
  impInter                   Decimal                    @default(0) @db.Decimal(15, 2)
  percepcionIVA              Decimal                    @default(0) @db.Decimal(15, 2)
  percepcionIIBB             Decimal                    @default(0) @db.Decimal(15, 2)
  otrosConceptos             Decimal                    @default(0) @db.Decimal(15, 2)
  iva105                     Decimal                    @default(0) @db.Decimal(15, 2)
  iva27                      Decimal                    @default(0) @db.Decimal(15, 2)
  exento                     Decimal                    @default(0) @db.Decimal(15, 2)
  iibb                       Decimal                    @default(0) @db.Decimal(15, 2)
  total                      Decimal                    @db.Decimal(15, 2)
  tipoCuentaId               Int
  estado                     String                     @default("pendiente") @db.VarChar(20)
  observaciones              String?
  pagoUrgente                Boolean                    @default(false)
  // CAE/CAI para verificación AFIP
  cae                        String?                    @db.VarChar(20)
  fechaVtoCae                DateTime?                  @db.Date
  // Centro de costo / Proyecto
  costCenterId               Int?
  projectId                  Int?
  // ViewMode - optional para legacy (null = T1)
  docType                    DocType?                   @default(T1)
  companyId                  Int
  createdBy                  Int
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  priceHistory               PriceHistory[]
  company                    Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser              User                       @relation(fields: [createdBy], references: [id])
  proveedor                  suppliers                  @relation(fields: [proveedorId], references: [id])
  tipoCuenta                 PurchaseAccount            @relation(fields: [tipoCuentaId], references: [id])
  items                      PurchaseReceiptItem[]
  PaymentOrderReceipt        PaymentOrderReceipt[]
  // Módulo Compras Extendido
  goodsReceipts              GoodsReceipt[]
  matchResults               MatchResult[]
  paymentRequestReceipts     PaymentRequestReceipt[]
  creditDebitNotes           CreditDebitNote[]
  creditNoteRequests         CreditNoteRequest[]
  costCenter                 CostCenter?                @relation("ReceiptCostCenter", fields: [costCenterId], references: [id])
  project                    Project?                   @relation("ReceiptProject", fields: [projectId], references: [id])
  accountMovements           SupplierAccountMovement[]
  // NCAs imputadas a esta factura
  creditAllocations          SupplierCreditAllocation[] @relation("CreditAllocationsToReceipt")
  // Devoluciones creadas desde esta factura
  purchaseReturnsFromFactura PurchaseReturn[]           @relation("PurchaseReturnFactura")

  // Control de ingreso de stock / Remito
  ingresoConfirmado    Boolean   @default(false)
  ingresoConfirmadoPor Int?
  ingresoConfirmadoAt  DateTime?
  firmaIngreso         String? // URL de imagen de firma (S3)
  remitoUrl            String? // PDF/imagen del remito
  fotoIngresoUrl       String? // Foto del material recibido

  // Control de pago forzado (sin confirmación de ingreso)
  pagoForzado    Boolean   @default(false)
  pagoForzadoPor Int?
  pagoForzadoAt  DateTime?

  // 3-Way Match - Estado de match por LÍNEA
  matchStatus      FacturaMatchStatus @default(MATCH_PENDING)
  matchCheckedAt   DateTime?
  matchBlockReason String?

  // Validación de Factura (control humano: "está bien cargada")
  facturaValidada Boolean   @default(false)
  validadaPor     Int?
  validadaAt      DateTime?

  // Aprobación de Pago (autorización para pagar)
  payApprovalStatus PayApprovalStatus @default(PAY_PENDING)
  payApprovedBy     Int?
  payApprovedAt     DateTime?
  payRejectedReason String?

  // Pronto Pago
  prontoPagoDisponible  Boolean   @default(false)
  prontoPagoFechaLimite DateTime?
  prontoPagoPorcentaje  Decimal?  @db.Decimal(5, 2)
  prontoPagoMonto       Decimal?  @db.Decimal(15, 2)
  prontoPagoAplicado    Boolean   @default(false)
  prontoPagoAplicadoAt  DateTime?

  // Control de duplicados
  requiereRevisionDuplicado Boolean @default(false)
  motivoBloqueo             String?

  // Relaciones de control
  ingresoConfirmadoByUser User?         @relation("ReceiptIngresoConfirmado", fields: [ingresoConfirmadoPor], references: [id])
  pagoForzadoByUser       User?         @relation("ReceiptPagoForzado", fields: [pagoForzadoPor], references: [id])
  validadoByUser          User?         @relation("ReceiptValidado", fields: [validadaPor], references: [id])
  payApprovedByUser       User?         @relation("ReceiptPayApproved", fields: [payApprovedBy], references: [id])
  // GRNI vinculados a esta factura
  grniAccruals            GRNIAccrual[]

  @@index([companyId])
  @@index([proveedorId])
  @@index([tipoCuentaId])
  @@index([fechaEmision])
  @@index([fechaImputacion])
  @@index([estado])
  @@index([companyId, estado, pagoUrgente], map: "idx_purchase_receipt_urgent")
  @@index([companyId, proveedorId, estado], map: "idx_purchase_receipt_provider_status")
  @@index([cae])
  @@index([costCenterId])
  @@index([projectId])
  @@index([docType])
  @@index([companyId, docType])
  @@index([ingresoConfirmado])
  @@index([companyId, ingresoConfirmado])
  @@index([matchStatus])
  @@index([companyId, matchStatus])
  @@index([payApprovalStatus])
  @@index([companyId, payApprovalStatus])
  @@index([prontoPagoDisponible, prontoPagoFechaLimite])
  // Índice compuesto para listados optimizados por proveedor y fecha
  @@index([companyId, proveedorId, fechaEmision], map: "idx_purchase_receipt_provider_date")
  @@map("PurchaseReceipt")
}

model PurchaseReceiptItem {
  id             Int             @id @default(autoincrement())
  comprobanteId  Int
  itemId         Int?
  descripcion    String          @db.VarChar(255)
  cantidad       Decimal         @db.Decimal(15, 4)
  unidad         String          @db.VarChar(50)
  precioUnitario Decimal         @db.Decimal(15, 2)
  subtotal       Decimal         @db.Decimal(15, 2)
  proveedorId    Int
  companyId      Int
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  comprobante    PurchaseReceipt @relation(fields: [comprobanteId], references: [id], onDelete: Cascade)
  supplierItem   SupplierItem?   @relation(fields: [itemId], references: [id])
  proveedor      suppliers       @relation(fields: [proveedorId], references: [id])

  @@index([comprobanteId])
  @@index([proveedorId])
  @@index([itemId])
  @@index([companyId])
  @@map("PurchaseReceiptItem")
}

model SupplierItem {
  id                       Int                       @id @default(autoincrement())
  supplierId               Int
  supplyId                 Int
  nombre                   String                    @db.VarChar(255)
  descripcion              String?
  codigoProveedor          String?                   @db.VarChar(100)
  unidad                   String                    @db.VarChar(50)
  precioUnitario           Decimal?                  @db.Decimal(15, 2)
  activo                   Boolean                   @default(true)
  companyId                Int
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  priceHistory             PriceHistory[]
  receiptItems             PurchaseReceiptItem[]
  stock                    Stock?
  supplier                 suppliers                 @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supply                   supplies                  @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  // Módulo Compras Extendido
  stockLocations           StockLocation[]
  stockMovements           StockMovement[]
  stockTransferItems       StockTransferItem[]
  stockAdjustmentItems     StockAdjustmentItem[]
  purchaseOrderItems       PurchaseOrderItem[]
  goodsReceiptItems        GoodsReceiptItem[]
  creditDebitNoteItems     CreditDebitNoteItem[]
  aliases                  SupplierItemAlias[]
  purchaseReturnItems      PurchaseReturnItem[]
  replenishmentSuggestions ReplenishmentSuggestion[]
  supplierLeadTimes        SupplierLeadTime[]
  // Sistema de Solicitudes y Cotizaciones
  purchaseRequestItems     PurchaseRequestItem[]     @relation("RequestItemSupplierItem")
  purchaseQuotationItems   PurchaseQuotationItem[]   @relation("QuotationItemSupplierItem")
  // Solicitudes de NCA
  creditNoteRequestItems   CreditNoteRequestItem[]
  // Módulo Almacén
  stockReservations        StockReservation[]
  materialRequestItems     MaterialRequestItem[]
  despachoItems            DespachoItem[]
  devolucionItems          DevolucionMaterialItem[]
  // Módulo Producción - link a insumos de recetas
  inputItems               InputItem[]               @relation("InputItemSupply")

  @@unique([supplierId, supplyId])
  @@index([supplierId, codigoProveedor])
  @@index([supplierId])
  @@index([supplyId])
  @@index([companyId])
  @@index([activo])
  @@map("SupplierItem")
}

model PriceHistory {
  id             Int              @id @default(autoincrement())
  supplierItemId Int
  precioUnitario Decimal          @db.Decimal(15, 2)
  comprobanteId  Int?
  fecha          DateTime         @db.Date
  companyId      Int
  createdAt      DateTime         @default(now())
  comprobante    PurchaseReceipt? @relation(fields: [comprobanteId], references: [id])
  supplierItem   SupplierItem     @relation(fields: [supplierItemId], references: [id], onDelete: Cascade)

  @@index([supplierItemId])
  @@index([fecha])
  @@index([companyId])
  @@map("PriceHistory")
}

model Stock {
  id                  Int          @id @default(autoincrement())
  supplierItemId      Int          @unique
  cantidad            Decimal      @db.Decimal(15, 4)
  unidad              String       @db.VarChar(50)
  precioUnitario      Decimal      @db.Decimal(15, 2)
  ultimaActualizacion DateTime     @default(now())
  companyId           Int
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  supplierItem        SupplierItem @relation(fields: [supplierItemId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("Stock")
}

model PaymentOrder {
  id              Int      @id @default(autoincrement())
  companyId       Int
  proveedorId     Int
  fechaPago       DateTime @db.Date
  totalPago       Decimal  @db.Decimal(15, 2)
  efectivo        Decimal  @default(0) @db.Decimal(15, 2)
  dolares         Decimal  @default(0) @db.Decimal(15, 2)
  transferencia   Decimal  @default(0) @db.Decimal(15, 2)
  chequesTerceros Decimal  @default(0) @db.Decimal(15, 2)
  chequesPropios  Decimal  @default(0) @db.Decimal(15, 2)
  retIVA          Decimal  @default(0) @db.Decimal(15, 2)
  retGanancias    Decimal  @default(0) @db.Decimal(15, 2)
  retIngBrutos    Decimal  @default(0) @db.Decimal(15, 2)
  anticipo        Decimal  @default(0) @db.Decimal(15, 2)
  notas           String?

  // Estado y Doble Aprobación para pagos grandes
  estado                  String?   @default("EJECUTADO") // PENDIENTE_APROBACION, EJECUTADO, RECHAZADO
  requiereDobleAprobacion Boolean   @default(false)
  primeraAprobacionBy     Int?
  primeraAprobacionAt     DateTime?
  segundaAprobacionBy     Int?
  segundaAprobacionAt     DateTime?
  motivoRechazo           String?

  // ViewMode
  docType          DocType                   @default(T1)
  createdBy        Int
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  company          Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  proveedor        suppliers                 @relation(fields: [proveedorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdByUser    User                      @relation(fields: [createdBy], references: [id])
  recibos          PaymentOrderReceipt[]
  cheques          PaymentOrderCheque[]
  attachments      PaymentOrderAttachment[]
  // Módulo Compras Extendido
  paymentRequests  PaymentRequest[]
  accountMovements SupplierAccountMovement[]

  // Tesorería
  cashMovements    CashMovement[]
  bankMovements    BankMovement[]
  chequesEmitidos  Cheque[]       @relation("ChequePaymentOrder")
  chequesEndosados Cheque[]       @relation("ChequeEndosado")

  @@index([companyId])
  @@index([proveedorId])
  @@index([fechaPago])
  @@index([docType])
  @@index([companyId, docType])
  @@map("PaymentOrder")
}

model PaymentOrderReceipt {
  id             Int             @id @default(autoincrement())
  paymentOrderId Int
  receiptId      Int
  montoAplicado  Decimal         @db.Decimal(15, 2)
  createdAt      DateTime        @default(now())
  paymentOrder   PaymentOrder    @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)
  receipt        PurchaseReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@index([paymentOrderId])
  @@index([receiptId])
  @@map("PaymentOrderReceipt")
}

model PaymentOrderCheque {
  id               Int          @id @default(autoincrement())
  paymentOrderId   Int
  tipo             String       @db.VarChar(20) // CHEQUE / ECHEQ
  numero           String       @db.VarChar(50)
  banco            String?      @db.VarChar(100)
  titular          String?      @db.VarChar(255)
  fechaVencimiento DateTime?    @db.Date
  importe          Decimal      @db.Decimal(15, 2)
  companyId        Int
  createdAt        DateTime     @default(now())
  paymentOrder     PaymentOrder @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)

  @@index([paymentOrderId])
  @@index([companyId])
  @@map("PaymentOrderCheque")
}

// Comprobantes adjuntos a Órdenes de Pago (transferencias, echeqs, etc.)
model PaymentOrderAttachment {
  id             Int          @id @default(autoincrement())
  paymentOrderId Int
  fileName       String       @db.VarChar(255)
  fileUrl        String       @db.VarChar(500)
  fileType       String       @db.VarChar(100) // MIME type
  fileSize       Int? // Tamaño en bytes
  description    String?      @db.VarChar(255) // "Comprobante transferencia", "Echeq", etc.
  createdAt      DateTime     @default(now())
  paymentOrder   PaymentOrder @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)

  @@index([paymentOrderId])
  @@map("PaymentOrderAttachment")
}

// Imputación de NCAs a Facturas/NDAs (trazabilidad de saldos)
model SupplierCreditAllocation {
  id             Int      @id @default(autoincrement())
  // NCA que se está imputando
  creditNoteId   Int
  // Documento destino (Factura o NDA)
  receiptId      Int? // FK a PurchaseReceipt (factura)
  debitNoteId    Int? // FK a CreditDebitNote (NDA)
  // Tipo de imputación
  tipoImputacion String   @default("FACTURA") @db.VarChar(20) // FACTURA | NDA | SALDO_FAVOR
  // Importe aplicado
  amount         Decimal  @db.Decimal(15, 2)
  // Multi-moneda (escalabilidad futura)
  currency       String   @default("ARS") @db.VarChar(10)
  fxRate         Decimal? @db.Decimal(10, 6) // Tipo de cambio
  amountBase     Decimal? @db.Decimal(15, 2) // Importe en moneda base
  // Auditoría
  createdAt      DateTime @default(now())

  creditNote      CreditDebitNote  @relation("CreditNoteAllocations", fields: [creditNoteId], references: [id], onDelete: Cascade)
  receipt         PurchaseReceipt? @relation("CreditAllocationsToReceipt", fields: [receiptId], references: [id])
  targetDebitNote CreditDebitNote? @relation("CreditAllocationsToDebit", fields: [debitNoteId], references: [id])

  @@unique([creditNoteId, receiptId])
  @@unique([creditNoteId, debitNoteId])
  @@index([creditNoteId])
  @@index([receiptId])
  @@index([debitNoteId])
  @@map("supplier_credit_allocations")
}

model ChecklistInstructive {
  id          Int      @id @default(autoincrement())
  checklistId Int
  title       String
  content     String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@index([checklistId])
}

model checklist_executions {
  id               Int             @id @default(autoincrement())
  checklistItemId  Int
  workOrderId      Int?
  executedById     Int?
  isCompleted      Boolean         @default(false)
  actualValue      String?
  notes            String?
  hasIssue         Boolean         @default(false)
  issueDescription String?
  executedAt       DateTime        @default(now())
  checklist_items  checklist_items @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)
  User             User?           @relation(fields: [executedById], references: [id])
}

model checklist_items {
  id                     Int                    @id @default(autoincrement())
  checklistId            Int
  title                  String
  description            String?
  isRequired             Boolean                @default(true)
  expectedValue          String?
  unit                   String?
  minValue               Float?
  maxValue               Float?
  order                  Int                    @default(0)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  checklist_executions   checklist_executions[]
  maintenance_checklists MaintenanceChecklist   @relation(fields: [checklistId], references: [id], onDelete: Cascade)
}

model machine_order_temp {
  id             Int       @id @default(autoincrement())
  company_id     Int
  machine_id     Int
  order_position Int
  created_at     DateTime? @default(now()) @db.Timestamp(6)
  updated_at     DateTime? @default(now()) @db.Timestamp(6)

  @@unique([company_id, machine_id])
}

model maintenance_configs {
  id                     Int             @id @default(autoincrement())
  companyId              Int
  sectorId               Int?
  defaultTimeUnit        TimeUnit        @default(HOURS)
  defaultExecutionWindow ExecutionWindow @default(ANY_TIME)
  autoScheduling         Boolean         @default(true)
  reminderDays           Int             @default(3)
  allowOverdue           Boolean         @default(true)
  requirePhotos          Boolean         @default(false)
  requireSignoff         Boolean         @default(false)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime
  Company                Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Sector                 Sector?         @relation(fields: [sectorId], references: [id])

  @@unique([companyId, sectorId])
}

model maintenance_history {
  id                  Int        @id @default(autoincrement())
  workOrderId         Int
  machineId           Int?
  componentId         Int?
  executedAt          DateTime
  executedById        Int?
  duration            Float?
  cost                Float?
  notes               String?
  rootCause           String?
  correctiveActions   String?
  preventiveActions   String?
  spareParts          Json?
  nextMaintenanceDate DateTime?
  mttr                Float?
  mtbf                Float?
  completionRate      Float?
  qualityScore        Float?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime
  Component           Component? @relation(fields: [componentId], references: [id])
  User                User?      @relation(fields: [executedById], references: [id])
  Machine             Machine?   @relation(fields: [machineId], references: [id])
  work_orders         WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

enum ChecklistFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

enum UserRole {
  USER
  ADMIN
  ADMIN_ENTERPRISE
  SUPERADMIN
  SUPERVISOR
}

enum MachineStatus {
  ACTIVE
  OUT_OF_SERVICE
  DECOMMISSIONED
  MAINTENANCE
}

enum MachineType {
  PRODUCTION
  MAINTENANCE
  UTILITY
  PACKAGING
  TRANSPORTATION
  OTHER
}

enum WorkOrderStatus {
  INCOMING // Recién creada, sin asignar/planificar
  PENDING // Asignada pero no iniciada (legacy, mantener por compatibilidad)
  SCHEDULED // Planificada con fecha y responsable
  IN_PROGRESS // En ejecución
  WAITING // En espera (repuesto, proveedor, producción, etc.)
  COMPLETED // Cerrada/resuelta
  CANCELLED // Cancelada
  ON_HOLD // En pausa (legacy, usar WAITING preferentemente)
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  PREDICTIVE
  EMERGENCY
  FAILURE
}

enum ToolStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  DAMAGED
  RETIRED
}

enum ItemType {
  TOOL // Legacy - usar HAND_TOOL para nuevos
  SUPPLY // Legacy - usar SPARE_PART/CONSUMABLE para nuevos
  SPARE_PART // Repuesto: se instala/consume, stock, lote/serie
  HAND_TOOL // Herramienta: préstamo/devolución, calibración
  CONSUMABLE // Consumible: sin serie, bajo costo, alta rotación
  MATERIAL // Insumo: lubricantes, selladores, cables
}

enum MovementType {
  IN
  OUT
  TRANSFER
  ADJUSTMENT
  LOAN
  RETURN
}

enum LoanStatus {
  BORROWED
  RETURNED
  OVERDUE
}

enum ReservationStatus {
  PENDING // Reserva creada, pendiente de picking
  PICKED // Repuestos retirados del pañol
  CANCELLED // Reserva cancelada
  RETURNED // Repuestos devueltos (no usados)
}

enum LotStatus {
  AVAILABLE // Disponible para uso
  RESERVED // Reservado para OT
  CONSUMED // Consumido/instalado
  EXPIRED // Vencido
  DEFECTIVE // Defectuoso/rechazado
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  ASSIGN
  APPROVE
  REJECT
  CLOSE
  REOPEN
  RESERVE_STOCK
  CONSUME_STOCK
  LOCK_LOTO
  UNLOCK_LOTO
  APPROVE_PTW
  CLOSE_PTW
  LOGIN
  LOGOUT
}

// ============================================================
// CMMS: PTW/LOTO ENUMS
// ============================================================

enum PTWType {
  HOT_WORK // Trabajos en caliente (soldadura, corte)
  CONFINED_SPACE // Espacios confinados
  HEIGHT_WORK // Trabajo en altura
  ELECTRICAL // Trabajo eléctrico
  EXCAVATION // Excavación
  CHEMICAL // Trabajo con químicos
  RADIATION // Trabajo con radiación
  PRESSURE_SYSTEMS // Sistemas presurizados
  OTHER // Otros trabajos peligrosos
}

enum PTWStatus {
  DRAFT // Borrador, siendo completado
  PENDING_APPROVAL // Esperando aprobación del supervisor
  APPROVED // Aprobado, listo para usar
  ACTIVE // En uso activo
  SUSPENDED // Suspendido temporalmente
  CLOSED // Cerrado correctamente
  CANCELLED // Cancelado antes de usar
  EXPIRED // Expirado (pasó validTo sin cerrar)
}

enum LOTOStatus {
  LOCKED // Bloqueado activamente
  UNLOCKED // Desbloqueado
  PARTIAL // Parcialmente bloqueado (múltiples puntos)
}

enum NotificationType {
  work_order_assigned
  work_order_overdue
  work_order_due_soon
  stock_low
  stock_out
  maintenance_due
  task_assigned
  task_overdue
  system_alert
  task_updated
  task_deleted
  task_completed
  task_due_soon
  task_auto_reset
  task_commented
  reminder_overdue
  reminder_due_today
  reminder_due_soon
  tool_request_new
  tool_request_approved
  tool_request_rejected
  // Tipos para alertas Discord/Mantenimiento
  SLA_WARNING
  SLA_BREACH
  UNASSIGNED_FAILURE
  RECURRENCE_ALERT
  DOWNTIME_START
  DOWNTIME_END
  PRIORITY_ESCALATED
  // Tipos para rutinas de producción
  routine_photo_timer
  // Tipos para vencimientos de ventas
  invoice_due_soon
  invoice_overdue
  cheque_due_soon
  cheque_overdue
  quote_expiring
  payment_received
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

enum DocumentType {
  MANUAL
  BLUEPRINT
  PHOTO
  DOCUMENT
  PDF
  IMAGE
  VIDEO
}

enum HistoryEventType {
  MAINTENANCE
  REPAIR
  INSPECTION
  MODIFICATION
  INCIDENT
  CREATION
  UPDATE
  DELETION
}

enum WorkStationStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum MeasureKind {
  UNIT
  LENGTH
  AREA
  VOLUME
}

enum CostMethod {
  BATCH
  VOLUMETRIC
  PER_UNIT_BOM
  REAL
  STANDARD
}

// Tipo de costo para productos de venta
enum ProductCostType {
  PRODUCTION // Costo calculado desde receta de fabricación
  PURCHASE // Costo actualizado automáticamente desde compras
  MANUAL // Costo ingresado manualmente
}

enum IndirectCategory {
  IMP_SERV
  SOCIAL
  VEHICLES
  MKT
  OTHER
  UTILITIES
}

enum RecipeBase {
  PER_BATCH
  PER_M3
}

enum MethodUnitKind {
  BATCH
  INTERMEDIATE
  FINAL
}

enum RecipeStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UnidadMovilEstado {
  ACTIVO
  MANTENIMIENTO
  FUERA_SERVICIO
  DESHABILITADO
}

enum TaxControlStatus {
  RECIBIDO
  PAGADO
  PENDIENTE
  VENCIDO
}

enum TruckType {
  CHASIS
  EQUIPO
  SEMI
}

enum ExecutionWindow {
  BEFORE_START
  MID_SHIFT
  END_SHIFT
  ANY_TIME
  SCHEDULED
}

enum TimeUnit {
  HOURS
  DAYS
  CYCLES
  KILOMETERS
  SHIFTS
  UNITS_PRODUCED
}

// ===============================================
// DASHBOARD PERSONALIZABLE POR USUARIO
// ===============================================

model UserDashboardConfig {
  id        Int      @id @default(autoincrement())
  userId    Int
  companyId Int
  name      String   @default("Mi Dashboard")
  isDefault Boolean  @default(false)
  layout    Json // Array de widgets con posición y tamaño
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId, name])
  @@index([userId])
  @@index([companyId])
  @@map("user_dashboard_configs")
}

// Preferencias de Colores del Usuario para Centro de Costos
model UserColorPreferences {
  id        Int @id @default(autoincrement())
  userId    Int
  companyId Int

  // Nombre del tema (para identificación)
  themeName String @default("Personalizado")

  // Colores de gráficos (series)
  chart1 String @default("#3b82f6")
  chart2 String @default("#10b981")
  chart3 String @default("#f59e0b")
  chart4 String @default("#8b5cf6")
  chart5 String @default("#06b6d4")
  chart6 String @default("#ef4444")

  // Colores de barras de progreso
  progressPrimary   String @default("#3b82f6")
  progressSecondary String @default("#10b981")
  progressWarning   String @default("#f59e0b")
  progressDanger    String @default("#ef4444")

  // Colores de KPIs
  kpiPositive String @default("#10b981")
  kpiNegative String @default("#ef4444")
  kpiNeutral  String @default("#64748b")

  // Colores de fondos de cards
  cardHighlight String @default("#ede9fe")
  cardMuted     String @default("#f1f5f9")

  // Colores de donut/pie
  donut1 String @default("#3b82f6")
  donut2 String @default("#10b981")
  donut3 String @default("#f59e0b")
  donut4 String @default("#8b5cf6")
  donut5 String @default("#94a3b8")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_color_preferences")
}

// ===============================================
// SISTEMA DE MANTENIMIENTO CORRECTIVO PROFESIONAL
// ===============================================

// Enums para el sistema correctivo
enum SolutionOutcome {
  FUNCIONÓ // Funcionó correctamente
  PARCIAL // Funcionó parcialmente, necesita seguimiento
  NO_FUNCIONÓ // No resolvió el problema
}

enum FixType {
  PARCHE // Solución temporal
  DEFINITIVA // Solución definitiva
}

enum FailureOccurrenceStatus {
  REPORTED
  IN_PROGRESS
  RESOLVED
  CANCELLED
  RESOLVED_IMMEDIATE
}

enum WorkOrderOrigin {
  FAILURE
  REQUEST
  MANUAL
  PREVENTIVE
  PREDICTIVE
}

enum AssetCriticality {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum QAStatus {
  NOT_REQUIRED
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  RETURNED_TO_PRODUCTION
}

enum EvidenceLevel {
  OPTIONAL // P4
  BASIC // P3 - Al menos 1 evidencia
  STANDARD // P2 - Evidencia + checklist
  COMPLETE // P1 - Todo requerido
}

enum DowntimeCategory {
  UNPLANNED // Parada no planificada (falla)
  PLANNED // Parada planificada (mantenimiento)
  EXTERNAL // Factor externo (corte de luz, etc.)
}

enum TemplateType {
  QUICK_CLOSE // Plantilla de cierre rápido
  WORK_ORDER // Plantilla de OT (procedimiento)
  SOLUTION // Plantilla de solución
}

// Biblioteca de Síntomas
model SymptomLibrary {
  id             Int      @id @default(autoincrement())
  title          String   @db.VarChar(100)
  keywords       Json // MySQL compatible: ["ruido", "vibración", "caliente"]
  shortNote      String?  @db.VarChar(255)
  componentId    Int?
  subcomponentId Int?
  machineId      Int?
  companyId      Int
  isActive       Boolean  @default(true)
  usageCount     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, componentId])
  @@index([companyId, subcomponentId])
  @@map("symptom_library")
}

// Registro de Tiempo Muerto
model DowntimeLog {
  id                   Int              @id @default(autoincrement())
  failureOccurrenceId  Int
  workOrderId          Int?
  machineId            Int
  startedAt            DateTime         @default(now())
  endedAt              DateTime? // null = aún en downtime
  returnToProductionBy Int?
  returnToProductionAt DateTime?
  totalMinutes         Int?
  category             DowntimeCategory @default(UNPLANNED)
  reason               String?
  productionImpact     String?
  companyId            Int
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  failureOccurrence FailureOccurrence @relation(fields: [failureOccurrenceId], references: [id], onDelete: Cascade)
  workOrder         WorkOrder?        @relation(fields: [workOrderId], references: [id], onDelete: SetNull)
  machine           Machine           @relation(fields: [machineId], references: [id], onDelete: Cascade)
  returnedBy        User?             @relation("DowntimeReturnedBy", fields: [returnToProductionBy], references: [id])
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([failureOccurrenceId])
  @@index([machineId, startedAt])
  @@index([companyId, machineId, startedAt]) // Performance
  @@index([workOrderId, endedAt]) // Performance
  @@index([companyId, endedAt, startedAt]) // Performance - MTTR calculation
  @@map("downtime_logs")
}

// Registro de Trabajo
model WorkLog {
  id              Int       @id @default(autoincrement())
  workOrderId     Int
  performedById   Int
  performedByType String    @default("USER")
  startedAt       DateTime
  endedAt         DateTime?
  actualMinutes   Int?
  description     String?
  activityType    String    @default("EXECUTION") // EXECUTION | DIAGNOSIS | WAITING | TRAVEL | DOCUMENTATION
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  performedBy User      @relation("WorkLogPerformedBy", fields: [performedById], references: [id])

  @@index([workOrderId])
  @@index([performedById, startedAt])
  @@map("work_logs")
}

// Plantillas
model Template {
  id          Int          @id @default(autoincrement())
  type        TemplateType
  title       String       @db.VarChar(255)
  description String?
  content     Json // Estructura de la plantilla
  componentId Int?
  machineId   Int?
  areaId      Int?
  companyId   Int
  isActive    Boolean      @default(true)
  usageCount  Int          @default(0)
  createdById Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy        User              @relation("TemplateCreatedBy", fields: [createdById], references: [id])
  solutionsApplied SolutionApplied[]

  @@index([companyId, type])
  @@index([componentId])
  @@map("templates")
}

// Control de Calidad
model QualityAssurance {
  id                          Int           @id @default(autoincrement())
  workOrderId                 Int           @unique
  isRequired                  Boolean       @default(false)
  requiredReason              String? // SAFETY | HIGH_PRIORITY | HIGH_CRITICALITY | HIGH_DOWNTIME | RECURRENCE
  verifiedById                Int?
  verifiedAt                  DateTime?
  status                      QAStatus      @default(PENDING)
  checklist                   Json?
  notes                       String?
  returnToProductionConfirmed Boolean       @default(false)
  returnConfirmedById         Int?
  returnConfirmedAt           DateTime?
  evidenceRequired            EvidenceLevel @default(OPTIONAL)
  evidenceProvided            Json?
  createdAt                   DateTime      @default(now())
  updatedAt                   DateTime      @updatedAt

  workOrder         WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  verifiedBy        User?     @relation("QAVerifiedBy", fields: [verifiedById], references: [id])
  returnConfirmedBy User?     @relation("QAReturnConfirmedBy", fields: [returnConfirmedById], references: [id])

  @@index([workOrderId])
  @@index([status])
  @@map("quality_assurance")
}

// Seguidores de Fallas
model FailureWatcher {
  id                  Int      @id @default(autoincrement())
  failureOccurrenceId Int
  userId              Int
  reason              String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  failureOccurrence FailureOccurrence @relation(fields: [failureOccurrenceId], references: [id], onDelete: Cascade)
  user              User              @relation("FailureWatcher", fields: [userId], references: [id])

  @@unique([failureOccurrenceId, userId])
  @@index([userId])
  @@map("failure_watchers")
}

// Seguidores de Órdenes de Trabajo
model WorkOrderWatcher {
  id          Int      @id @default(autoincrement())
  workOrderId Int
  userId      Int
  reason      String? // AUTO_CREATOR | AUTO_ASSIGNED | AUTO_EXECUTOR | MANUAL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User      @relation("WorkOrderWatcher", fields: [userId], references: [id])

  @@unique([workOrderId, userId])
  @@index([userId])
  @@map("work_order_watchers")
}

// Comentarios de Fallas (Chat)
model FailureOccurrenceComment {
  id                  Int      @id @default(autoincrement())
  failureOccurrenceId Int
  authorId            Int
  content             String   @db.Text
  type                String   @default("comment") // comment | system | mention
  mentionedUserIds    Json? // Array de IDs de usuarios mencionados
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  failureOccurrence FailureOccurrence @relation(fields: [failureOccurrenceId], references: [id], onDelete: Cascade)
  author            User              @relation("FailureOccurrenceCommentAuthor", fields: [authorId], references: [id])

  @@index([failureOccurrenceId, createdAt])
  @@index([authorId])
  @@map("failure_occurrence_comments")
}

// Historial Real de Soluciones Aplicadas
model SolutionApplied {
  id                  Int  @id @default(autoincrement())
  failureOccurrenceId Int
  workOrderId         Int? // Puede ser null si fue resolución inmediata

  // Diagnóstico y solución (OBLIGATORIO)
  diagnosis String          @db.Text // "Qué encontré"
  solution  String          @db.Text // "Qué hice" (rich text)
  outcome   SolutionOutcome // funcionó/parcial/no_funcionó

  // Quién y cuándo (OBLIGATORIO)
  performedById  Int
  performedByIds Json? // Array de IDs si fueron múltiples técnicos
  performedAt    DateTime @default(now())
  actualMinutes  Int?

  // Clasificación final (OPCIONAL pero recomendado)
  finalComponentId    Int? // Componente donde realmente estaba la falla
  finalSubcomponentId Int? // Subcomponente específico
  confirmedCause      String? @db.VarChar(255)

  // Tipo de solución
  fixType FixType @default(DEFINITIVA)

  // Plantilla usada (si aplica)
  templateUsedId   Int?
  sourceSolutionId Int? // Referencia a solución previa (si se prellenó)

  // Materiales y herramientas
  toolsUsed      Json? // [{id, name, quantity}]
  sparePartsUsed Json? // [{id, name, quantity}]

  // Efectividad y evidencia
  effectiveness Int? // 1-5
  attachments   Json? // URLs de fotos/archivos
  notes         String? @db.Text

  // Obsolescencia (para marcar soluciones que ya no aplican)
  isObsolete     Boolean   @default(false) // Si la solución ya no es válida
  obsoleteReason String?   @db.VarChar(500) // Por qué ya no aplica
  obsoleteAt     DateTime? // Cuándo se marcó como obsoleta
  obsoleteById   Int? // Quién la marcó

  // Multi-tenant
  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  failureOccurrence FailureOccurrence @relation(fields: [failureOccurrenceId], references: [id], onDelete: Cascade)
  workOrder         WorkOrder?        @relation("SolutionAppliedWorkOrder", fields: [workOrderId], references: [id])
  performedBy       User              @relation("SolutionAppliedPerformedBy", fields: [performedById], references: [id])
  template          Template?         @relation(fields: [templateUsedId], references: [id])
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([failureOccurrenceId])
  @@index([workOrderId])
  @@index([performedById, performedAt])
  @@index([companyId, performedAt])
  @@index([finalSubcomponentId, effectiveness]) // Para top soluciones
  @@index([companyId, finalSubcomponentId, performedAt]) // Performance
  @@index([companyId, outcome]) // ✅ Filtro por outcome (FUNCIONÓ)
  @@index([companyId, outcome, effectiveness]) // ✅ getTopSolutions optimizado
  @@index([companyId, isObsolete, outcome]) // ✅ Filtrar no-obsoletas que funcionaron
  @@map("solutions_applied")
}

// Configuraciones de Correctivo por Empresa
model CorrectiveSettings {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Ventanas configurables
  duplicateWindowHours   Int @default(48) // Ventana búsqueda duplicados
  recurrenceWindowDays   Int @default(7) // Reincidencia rápida
  downtimeQaThresholdMin Int @default(60) // Downtime mínimo para QA

  // SLA por prioridad (en horas) - Alineado con P1-P4
  slaP1Hours Int @default(4) // Urgente
  slaP2Hours Int @default(8) // Alta
  slaP3Hours Int @default(24) // Media
  slaP4Hours Int @default(72) // Baja

  // Reglas de evidencia
  requireEvidenceP3 Boolean @default(true) // P3 requiere 1 evidencia
  requireEvidenceP2 Boolean @default(true) // P2 requiere evidencia + checklist
  requireEvidenceP1 Boolean @default(true) // P1 requiere todo

  // Retorno a producción
  requireReturnConfirmationOnDowntime Boolean @default(true)
  requireReturnConfirmationOnQA       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("corrective_settings")
}

// ============================================================
// P0.4: Eventos de Ocurrencia - "Pasó otra vez" NORMALIZADO
// ============================================================
model FailureOccurrenceEvent {
  id                  Int      @id @default(autoincrement())
  companyId           Int
  failureOccurrenceId Int
  occurredAt          DateTime @default(now())
  notes               String?  @db.Text
  createdById         Int
  createdAt           DateTime @default(now())

  // Flags del evento
  causedDowntime  Boolean @default(false)
  isSafetyRelated Boolean @default(false)
  isIntermittent  Boolean @default(false)

  // Si se creó OT desde este evento
  workOrderId Int?

  // Síntomas y fotos de esta ocurrencia específica
  symptoms    Json? // Array de IDs
  attachments Json? // Array de URLs

  // Relaciones
  failureOccurrence FailureOccurrence @relation(fields: [failureOccurrenceId], references: [id], onDelete: Cascade)
  createdBy         User              @relation("OccurrenceEventCreator", fields: [createdById], references: [id])
  workOrder         WorkOrder?        @relation("OccurrenceEventWorkOrder", fields: [workOrderId], references: [id])
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, failureOccurrenceId, occurredAt])
  @@index([failureOccurrenceId, createdAt])
  @@index([workOrderId])
  @@map("failure_occurrence_events")
}

// ============================================================
// P5.1: Eventos de Actividad - Para Timeline Unificado
// ============================================================
model ActivityEvent {
  id          Int      @id @default(autoincrement())
  companyId   Int
  occurredAt  DateTime @default(now())
  eventType   String   @db.VarChar(50) // CREATED, STATUS_CHANGED, ASSIGNED, etc.
  description String?  @db.Text

  // Entidades relacionadas (polimórfico)
  entityType String @db.VarChar(30) // FAILURE_OCCURRENCE | WORK_ORDER
  entityId   Int

  // Datos del cambio
  previousValue String? @db.VarChar(255)
  newValue      String? @db.VarChar(255)
  metadata      Json? // Datos adicionales del evento

  // Quién realizó la acción
  performedById Int?

  // Relaciones
  performedBy User?   @relation("ActivityEventPerformer", fields: [performedById], references: [id])
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, entityType, entityId, occurredAt])
  @@index([entityType, entityId])
  @@index([performedById])
  @@map("activity_events")
}

// ============================================================
// P5.2: Root Cause Analysis (5-Whys)
// ============================================================
model RootCauseAnalysis {
  id                  Int  @id @default(autoincrement())
  companyId           Int
  workOrderId         Int? @unique
  failureOccurrenceId Int? @unique

  // 5-Whys estructura
  whys       Json // [{level: 1, question: "¿Por qué?", answer: "..."}]
  rootCause  String? @db.Text // Causa raíz identificada
  conclusion String? @db.Text // Conclusión del análisis

  // Acciones correctivas derivadas
  correctiveActions Json? // [{action, responsible, dueDate, status}]

  // Metadata
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  status      String   @default("DRAFT") @db.VarChar(20) // DRAFT, COMPLETED, REVIEWED

  // Relaciones
  workOrder         WorkOrder?         @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  failureOccurrence FailureOccurrence? @relation(fields: [failureOccurrenceId], references: [id], onDelete: Cascade)
  createdBy         User               @relation("RCACreator", fields: [createdById], references: [id])
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, workOrderId])
  @@index([failureOccurrenceId])
  @@map("root_cause_analyses")
}

// ============================================================
// P5.3: Plantillas de Checklist para Correctivo
// ============================================================
model CorrectiveChecklistTemplate {
  id          Int     @id @default(autoincrement())
  companyId   Int
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Scope - cuándo aplicar esta plantilla
  machineId     Int?
  componentId   Int?
  failureTypeId Int?
  minPriority   String? @db.VarChar(10) // P1, P2, P3, P4
  tags          Json? // Array de tags para matching

  // Contenido del checklist
  items Json // [{id, description, type: 'check'|'value'|'text', required, order}]

  // Requisitos de evidencia
  evidenceRequired String @default("OPTIONAL") @db.VarChar(20) // OPTIONAL, BASIC, STANDARD, COMPLETE

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  workOrderChecklists WorkOrderChecklist[]

  @@index([companyId, isActive])
  @@index([machineId])
  @@index([componentId])
  @@map("corrective_checklist_templates")
}

// Instancia de checklist aplicada a una OT
model WorkOrderChecklist {
  id          Int @id @default(autoincrement())
  workOrderId Int
  templateId  Int
  companyId   Int

  // Respuestas del checklist
  responses Json // [{itemId, value, completedAt, completedById}]

  // Estado
  status        String    @default("PENDING") @db.VarChar(20) // PENDING, IN_PROGRESS, COMPLETED
  completedAt   DateTime?
  completedById Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  workOrder   WorkOrder                   @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  template    CorrectiveChecklistTemplate @relation(fields: [templateId], references: [id])
  company     Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  completedBy User?                       @relation("ChecklistCompletedBy", fields: [completedById], references: [id])

  @@index([workOrderId])
  @@index([templateId])
  @@index([workOrderId, companyId]) // ✅ Composite para queries de timeline
  @@map("work_order_checklists")
}

// ============================================
// ASISTENTE IA
// ============================================

// Embeddings para búsqueda semántica
// Nota: El campo 'embedding' se maneja con raw SQL (pgvector)
model AssistantEmbedding {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Referencia a la entidad original
  entityType String @db.VarChar(50) // 'work_order', 'failure', 'solution', etc.
  entityId   Int

  // Texto indexado
  content String @db.Text

  // Metadata para filtros (JSON con machineId, sectorId, etc.)
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId])
  @@index([companyId])
  @@index([entityType])
  @@map("assistant_embeddings")
}

// Historial de conversaciones
model AssistantConversation {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Título de la conversación (opcional, auto-generado)
  title String? @db.VarChar(255)

  // Contexto de la conversación (página actual, entidad, etc.)
  context Json?

  // Estado
  isActive Boolean @default(true)

  // Mensajes de la conversación
  messages AssistantMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([userId])
  @@map("assistant_conversations")
}

// Mensajes individuales
model AssistantMessage {
  id             Int                   @id @default(autoincrement())
  conversationId Int
  conversation   AssistantConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Contenido
  role    String @db.VarChar(20) // 'user' | 'assistant'
  content String @db.Text

  // Si fue una acción
  actionType   String? @db.VarChar(50)
  actionData   Json?
  actionStatus String? @db.VarChar(20) // 'pending', 'confirmed', 'executed', 'cancelled'

  // Fuentes/referencias usadas en la respuesta
  sources Json?

  // Métricas
  tokensUsed     Int?
  responseTimeMs Int?

  // Si fue por voz
  isVoiceInput Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@map("assistant_messages")
}

// Log de acciones ejecutadas por el asistente
model AssistantActionLog {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Qué acción se ejecutó
  actionType String @db.VarChar(50)
  actionData Json

  // Resultado
  success      Boolean
  resultData   Json?
  errorMessage String? @db.Text

  // Entidad afectada
  entityType String? @db.VarChar(50)
  entityId   Int?

  // Conversación donde se ejecutó (opcional)
  conversationId Int?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
  @@map("assistant_action_logs")
}

// ============================================================================
// MÓDULO COMPRAS - MODELOS EXTENDIDOS
// ============================================================================

// Depósitos / Pañoles / Almacenes
model Warehouse {
  id          Int      @id @default(autoincrement())
  codigo      String   @db.VarChar(50)
  nombre      String   @db.VarChar(255)
  descripcion String?
  direccion   String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  isTransit   Boolean  @default(false) // Para warehouse virtual IN_TRANSIT
  companyId   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company                Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stockLocations         StockLocation[]
  stockMovements         StockMovement[]
  goodsReceipts          GoodsReceipt[]
  transfersOrigen        StockTransfer[]         @relation("TransferOrigen")
  transfersDestino       StockTransfer[]         @relation("TransferDestino")
  stockAdjustments       StockAdjustment[]
  purchaseReturns        PurchaseReturn[]
  // Módulo Almacén
  stockReservations      StockReservation[]
  materialRequests       MaterialRequest[]
  despachos              Despacho[]
  devoluciones           DevolucionMaterial[]
  userWarehouseScopes    UserWarehouseScope[]
  productionStockConfigs ProductionStockConfig[] @relation("ProductionDefaultWarehouse")

  @@unique([companyId, codigo])
  @@index([companyId])
  @@index([isActive])
  @@map("warehouses")
}

// Stock por ubicación (depósito + item)
model StockLocation {
  id                Int      @id @default(autoincrement())
  warehouseId       Int
  supplierItemId    Int
  cantidad          Decimal  @db.Decimal(15, 4)
  cantidadReservada Decimal  @default(0) @db.Decimal(15, 4)
  stockMinimo       Decimal? @db.Decimal(15, 4)
  stockMaximo       Decimal? @db.Decimal(15, 4)
  puntoReposicion   Decimal? @db.Decimal(15, 4) // Si diferente de stockMinimo
  costoUnitario     Decimal? @db.Decimal(15, 4) // Último costo de entrada
  criticidad        String?  @db.VarChar(10) // A, B, C, CRITICO
  ubicacion         String?  @db.VarChar(100) // Ubicación física dentro del depósito
  // Códigos del último movimiento (para mostrar en inventario)
  codigoPropio      String?  @db.VarChar(100) // Código interno usado en última entrada
  codigoProveedor   String?  @db.VarChar(100) // Código del proveedor usado en última entrada
  descripcionItem   String?  @db.VarChar(255) // Descripción del item en última entrada
  companyId         Int
  updatedAt         DateTime @updatedAt

  // Módulo Almacén - campos adicionales
  ubicacionFisica String? @db.VarChar(100) // Rack-A-01, Bin-B-03
  metodoSalida    String? @db.VarChar(20) // FIFO, FEFO, LIFO, MANUAL

  warehouse     Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  supplierItem  SupplierItem   @relation(fields: [supplierItemId], references: [id], onDelete: Cascade)
  // Módulo Almacén
  despachoItems DespachoItem[]

  @@unique([warehouseId, supplierItemId])
  @@index([companyId])
  @@index([warehouseId])
  @@index([supplierItemId])
  @@map("stock_locations")
}

// Movimientos de Stock (Kardex)
model StockMovement {
  id                      Int               @id @default(autoincrement())
  tipo                    StockMovementType
  cantidad                Decimal           @db.Decimal(15, 4)
  cantidadAnterior        Decimal           @db.Decimal(15, 4)
  cantidadPosterior       Decimal           @db.Decimal(15, 4)
  costoUnitario           Decimal?          @db.Decimal(15, 2)
  costoTotal              Decimal?          @db.Decimal(15, 2)
  supplierItemId          Int
  warehouseId             Int
  // Códigos del item al momento del movimiento (para trazabilidad)
  codigoPropio            String?           @db.VarChar(100) // Código interno usado en OC/Recepción
  codigoProveedor         String?           @db.VarChar(100) // Código del proveedor usado en OC/Recepción
  descripcionItem         String?           @db.VarChar(255) // Descripción del item al momento del movimiento
  // Referencias opcionales según el tipo de movimiento
  goodsReceiptId          Int?
  purchaseReturnId        Int?
  transferId              Int?
  adjustmentId            Int?
  // Módulo Almacén - nuevas referencias
  despachoId              Int?
  devolucionId            Int?
  productionOrderId       Int?
  dailyProductionReportId Int?
  reservationId           Int?
  sourceNumber            String?           @db.VarChar(50) // "REC-2026-00001", "AJU-2026-00003", etc.
  motivo                  String?
  notas                   String?
  // ViewMode - hereda del documento padre
  docType                 DocType           @default(T1)
  companyId               Int
  createdBy               Int
  createdAt               DateTime          @default(now())

  supplierItem    SupplierItem           @relation(fields: [supplierItemId], references: [id])
  warehouse       Warehouse              @relation(fields: [warehouseId], references: [id])
  goodsReceipt    GoodsReceipt?          @relation(fields: [goodsReceiptId], references: [id])
  purchaseReturn  PurchaseReturn?        @relation(fields: [purchaseReturnId], references: [id])
  transfer        StockTransfer?         @relation(fields: [transferId], references: [id])
  adjustment      StockAdjustment?       @relation(fields: [adjustmentId], references: [id])
  createdByUser   User                   @relation(fields: [createdBy], references: [id])
  // Módulo Almacén - nuevas relaciones
  despacho        Despacho?              @relation(fields: [despachoId], references: [id])
  devolucion      DevolucionMaterial?    @relation(fields: [devolucionId], references: [id])
  productionOrder ProductionOrder?       @relation("StockMovementProductionOrder", fields: [productionOrderId], references: [id])
  dailyReport     DailyProductionReport? @relation(fields: [dailyProductionReportId], references: [id])
  reservation     StockReservation?      @relation(fields: [reservationId], references: [id])

  // Idempotencia: un PR no puede generar más de un movimiento por item
  @@unique([purchaseReturnId, supplierItemId], name: "unique_return_movement")
  @@index([supplierItemId])
  @@index([warehouseId])
  @@index([companyId])
  @@index([createdAt])
  @@index([tipo])
  @@index([docType])
  @@index([companyId, docType])
  @@index([purchaseReturnId])
  // Módulo Almacén - nuevos índices
  @@index([despachoId])
  @@index([devolucionId])
  @@index([productionOrderId])
  @@index([dailyProductionReportId])
  @@index([reservationId])
  // Índice compuesto para kardex optimizado
  @@index([supplierItemId, warehouseId, createdAt], map: "idx_stock_movement_kardex")
  @@map("stock_movements")
}

enum StockMovementType {
  ENTRADA_RECEPCION // Entrada por recepción de mercadería
  SALIDA_DEVOLUCION // Salida por devolución a proveedor
  TRANSFERENCIA_ENTRADA // Entrada por transferencia entre depósitos
  TRANSFERENCIA_SALIDA // Salida por transferencia entre depósitos
  AJUSTE_POSITIVO // Ajuste de inventario positivo
  AJUSTE_NEGATIVO // Ajuste de inventario negativo
  CONSUMO_PRODUCCION // Salida por consumo de producción
  RESERVA // Reserva de stock
  LIBERACION_RESERVA // Liberación de reserva
  DESPACHO // Salida por despacho de almacén
  DEVOLUCION // Entrada por devolución de material
}

// Transferencias entre depósitos
model StockTransfer {
  id                 Int            @id @default(autoincrement())
  numero             String         @db.VarChar(50)
  warehouseOrigenId  Int
  warehouseDestinoId Int
  estado             TransferStatus @default(BORRADOR)
  fechaSolicitud     DateTime       @db.Date
  fechaEnvio         DateTime?      @db.Date
  fechaRecepcion     DateTime?      @db.Date
  notas              String?
  companyId          Int
  createdBy          Int
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  items            StockTransferItem[]
  stockMovements   StockMovement[]
  warehouseOrigen  Warehouse           @relation("TransferOrigen", fields: [warehouseOrigenId], references: [id])
  warehouseDestino Warehouse           @relation("TransferDestino", fields: [warehouseDestinoId], references: [id])
  company          Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser    User                @relation("StockTransferCreatedBy", fields: [createdBy], references: [id])

  @@index([companyId])
  @@index([estado])
  @@map("stock_transfers")
}

model StockTransferItem {
  id                 Int      @id @default(autoincrement())
  transferId         Int
  supplierItemId     Int
  cantidadSolicitada Decimal  @db.Decimal(15, 4)
  cantidadEnviada    Decimal? @db.Decimal(15, 4)
  cantidadRecibida   Decimal? @db.Decimal(15, 4)
  notas              String?

  transfer     StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  supplierItem SupplierItem  @relation(fields: [supplierItemId], references: [id])

  @@index([transferId])
  @@map("stock_transfer_items")
}

enum TransferStatus {
  BORRADOR
  SOLICITADO
  EN_TRANSITO
  RECIBIDO_PARCIAL
  COMPLETADO
  CANCELADO
}

// Ajustes de inventario
model StockAdjustment {
  id            Int              @id @default(autoincrement())
  numero        String           @db.VarChar(50)
  tipo          AdjustmentType
  estado        AdjustmentStatus @default(BORRADOR)
  motivo        String
  motivoDetalle String? // Descripción libre adicional
  reasonCode    String?          @db.VarChar(50) // Código predefinido según tipo
  adjuntos      String[] // URLs a S3 (fotos/PDFs evidencia)
  notas         String?
  warehouseId   Int
  companyId     Int
  aprobadoPor   Int?
  aprobadoAt    DateTime?
  createdBy     Int
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  items          StockAdjustmentItem[]
  stockMovements StockMovement[]
  warehouse      Warehouse             @relation(fields: [warehouseId], references: [id])
  company        Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser  User                  @relation("StockAdjustmentCreatedBy", fields: [createdBy], references: [id])
  aprobadoByUser User?                 @relation("StockAdjustmentApprovedBy", fields: [aprobadoPor], references: [id])

  @@index([companyId])
  @@index([warehouseId])
  @@index([estado])
  @@map("stock_adjustments")
}

model StockAdjustmentItem {
  id               Int     @id @default(autoincrement())
  adjustmentId     Int
  supplierItemId   Int
  cantidadAnterior Decimal @db.Decimal(15, 4)
  cantidadNueva    Decimal @db.Decimal(15, 4)
  diferencia       Decimal @db.Decimal(15, 4)
  motivo           String?

  adjustment   StockAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  supplierItem SupplierItem    @relation(fields: [supplierItemId], references: [id])

  @@index([adjustmentId])
  @@map("stock_adjustment_items")
}

enum AdjustmentType {
  INVENTARIO_FISICO
  ROTURA
  VENCIMIENTO
  MERMA
  CORRECCION
  DEVOLUCION_INTERNA
  OTRO
}

enum AdjustmentStatus {
  BORRADOR
  PENDIENTE_APROBACION
  CONFIRMADO
  RECHAZADO
}

// Órdenes de Compra (Purchase Order)
model PurchaseOrder {
  id                   Int                 @id @default(autoincrement())
  numero               String              @db.VarChar(50)
  proveedorId          Int
  estado               PurchaseOrderStatus @default(BORRADOR)
  fechaEmision         DateTime            @db.Date
  fechaEntregaEsperada DateTime?           @db.Date
  fechaEntregaReal     DateTime?           @db.Date
  condicionesPago      String?             @db.VarChar(255)
  moneda               String              @default("ARS") @db.VarChar(10)
  subtotal             Decimal             @db.Decimal(15, 2)
  tasaIva              Decimal             @default(21) @db.Decimal(5, 2) // Porcentaje IVA configurable (21, 10.5, 0)
  impuestos            Decimal             @default(0) @db.Decimal(15, 2)
  total                Decimal             @db.Decimal(15, 2)
  notas                String?
  notasInternas        String?
  // Campos para aprobación
  requiereAprobacion   Boolean             @default(false)
  aprobadoPor          Int?
  aprobadoAt           DateTime?
  rechazadoPor         Int?
  rechazadoAt          DateTime?
  motivoRechazo        String?
  // Centro de costo
  costCenterId         Int?
  projectId            Int?
  // Campos de emergencia
  esEmergencia         Boolean             @default(false)
  motivoEmergencia     String?
  // ViewMode
  docType              DocType             @default(T1)
  // Tipo de cuenta/gasto pre-seleccionado (opcional, para cuando se cargue la factura)
  tipoCuentaId         Int?
  // Vinculación con Solicitud y Cotización
  purchaseRequestId    Int? // Solicitud que originó esta OC
  purchaseQuotationId  Int? // Cotización seleccionada
  // Tracking
  companyId            Int
  createdBy            Int
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  proveedor         suppliers           @relation(fields: [proveedorId], references: [id])
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser     User                @relation("PurchaseOrderCreatedBy", fields: [createdBy], references: [id])
  aprobadoByUser    User?               @relation("PurchaseOrderApprovedBy", fields: [aprobadoPor], references: [id])
  rechazadoByUser   User?               @relation("PurchaseOrderRejectedBy", fields: [rechazadoPor], references: [id])
  costCenter        CostCenter?         @relation(fields: [costCenterId], references: [id])
  project           Project?            @relation(fields: [projectId], references: [id])
  purchaseRequest   PurchaseRequest?    @relation("RequestPurchaseOrder", fields: [purchaseRequestId], references: [id])
  purchaseQuotation PurchaseQuotation?  @relation("QuotationPurchaseOrder", fields: [purchaseQuotationId], references: [id])
  items             PurchaseOrderItem[]
  goodsReceipts     GoodsReceipt[]
  approvals         PurchaseApproval[]
  matchResults      MatchResult[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([proveedorId])
  @@index([estado])
  @@index([fechaEmision])
  @@index([esEmergencia])
  @@index([docType])
  @@index([companyId, docType])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id                   Int       @id @default(autoincrement())
  purchaseOrderId      Int
  supplierItemId       Int
  codigoPropio         String?   @db.VarChar(50) // Código interno nuestro
  codigoProveedor      String?   @db.VarChar(50) // Código del proveedor
  descripcion          String    @db.VarChar(255)
  cantidad             Decimal   @db.Decimal(15, 4)
  cantidadRecibida     Decimal   @default(0) @db.Decimal(15, 4)
  cantidadPendiente    Decimal   @db.Decimal(15, 4)
  unidad               String    @db.VarChar(50)
  precioUnitario       Decimal   @db.Decimal(15, 2)
  descuento            Decimal   @default(0) @db.Decimal(5, 2) // Porcentaje
  subtotal             Decimal   @db.Decimal(15, 2)
  fechaEntregaEsperada DateTime? @db.Date
  notas                String?

  purchaseOrder PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  supplierItem  SupplierItem       @relation(fields: [supplierItemId], references: [id])
  receiptItems  GoodsReceiptItem[]

  @@index([purchaseOrderId])
  @@index([supplierItemId])
  @@map("purchase_order_items")
}

enum PurchaseOrderStatus {
  BORRADOR
  PENDIENTE_APROBACION
  APROBADA
  RECHAZADA
  ENVIADA_PROVEEDOR
  CONFIRMADA
  PARCIALMENTE_RECIBIDA
  COMPLETADA
  CANCELADA
}

// Recepciones / Remitos (Goods Receipt)
model GoodsReceipt {
  id                         Int                   @id @default(autoincrement())
  numero                     String                @db.VarChar(50)
  proveedorId                Int
  purchaseOrderId            Int? // Puede ser recepción sin OC
  warehouseId                Int
  estado                     GoodsReceiptStatus    @default(BORRADOR)
  fechaRecepcion             DateTime              @db.Date
  numeroRemito               String?               @db.VarChar(100) // Número del remito del proveedor
  // Control de documentación
  tieneFactura               Boolean               @default(false)
  facturaId                  Int? // Vinculación con factura cuando exista
  // Campos de emergencia/regularización
  esEmergencia               Boolean               @default(false)
  requiereRegularizacion     Boolean               @default(false)
  fechaLimiteRegularizacion  DateTime?
  regularizada               Boolean               @default(false)
  regularizadaAt             DateTime?
  // Compra Rápida (sin OC)
  isQuickPurchase            Boolean               @default(false)
  quickPurchaseReason        QuickPurchaseReason?
  quickPurchaseJustification String?
  regularizationStatus       RegularizationStatus?
  regularizedBy              Int?
  regularizationNotes        String?
  // Calidad
  estadoCalidad              QualityStatus         @default(PENDIENTE)
  notasCalidad               String?
  // Tracking
  notas                      String?
  // Evidencia de recepción
  adjuntos                   String[] // URLs a S3 (fotos remito firmado, mercadería)
  firma                      String? // Firma digital en base64 o URL a imagen
  observacionesRecepcion     String? // Observaciones sobre estado de la mercadería
  // ViewMode
  docType                    DocType               @default(T1)
  companyId                  Int
  createdBy                  Int
  createdAt                  DateTime              @default(now())
  updatedAt                  DateTime              @updatedAt

  proveedor          suppliers           @relation(fields: [proveedorId], references: [id])
  purchaseOrder      PurchaseOrder?      @relation(fields: [purchaseOrderId], references: [id])
  warehouse          Warehouse           @relation(fields: [warehouseId], references: [id])
  factura            PurchaseReceipt?    @relation(fields: [facturaId], references: [id])
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser      User                @relation("GoodsReceiptCreatedBy", fields: [createdBy], references: [id])
  items              GoodsReceiptItem[]
  stockMovements     StockMovement[]
  matchResults       MatchResult[]
  purchaseReturns    PurchaseReturn[]
  creditNoteRequests CreditNoteRequest[]
  regularizedByUser  User?               @relation("GoodsReceiptRegularizedBy", fields: [regularizedBy], references: [id])
  grniAccruals       GRNIAccrual[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([proveedorId])
  @@index([purchaseOrderId])
  @@index([estado])
  @@index([fechaRecepcion])
  @@index([requiereRegularizacion, regularizada])
  @@index([docType])
  @@index([companyId, docType])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id                  Int       @id @default(autoincrement())
  goodsReceiptId      Int
  purchaseOrderItemId Int? // Si viene de una OC
  supplierItemId      Int
  codigoPropio        String?   @db.VarChar(100) // Código interno usado en la OC
  codigoProveedor     String?   @db.VarChar(100) // Código del proveedor usado en la OC
  descripcion         String    @db.VarChar(255)
  cantidadEsperada    Decimal?  @db.Decimal(15, 4) // De la OC
  cantidadRecibida    Decimal   @db.Decimal(15, 4)
  cantidadAceptada    Decimal   @db.Decimal(15, 4)
  cantidadRechazada   Decimal   @default(0) @db.Decimal(15, 4)
  unidad              String    @db.VarChar(50)
  motivoRechazo       String?
  lote                String?   @db.VarChar(100)
  fechaVencimiento    DateTime? @db.Date
  notas               String?

  goodsReceipt      GoodsReceipt         @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  purchaseOrderItem PurchaseOrderItem?   @relation(fields: [purchaseOrderItemId], references: [id])
  supplierItem      SupplierItem         @relation(fields: [supplierItemId], references: [id])
  returnItems       PurchaseReturnItem[] // Items de devolución vinculados

  @@index([goodsReceiptId])
  @@index([purchaseOrderItemId])
  @@index([supplierItemId])
  @@map("goods_receipt_items")
}

enum GoodsReceiptStatus {
  BORRADOR
  CONFIRMADA
  ANULADA
}

enum QualityStatus {
  PENDIENTE
  APROBADO
  RECHAZADO
  APROBADO_PARCIAL
}

// ============================================================
// GRNI - Goods Received Not Invoiced
// Accrual contable automático para recepciones sin factura
// ============================================================
model GRNIAccrual {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Origen
  goodsReceiptId     Int
  goodsReceipt       GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  goodsReceiptItemId Int?

  // Proveedor
  supplierId Int
  supplier   suppliers @relation(fields: [supplierId], references: [id])

  // Descripción del item
  descripcion String?

  // Montos
  montoEstimado  Decimal  @db.Decimal(15, 2) // Precio OC * cantidad recibida
  montoFacturado Decimal? @db.Decimal(15, 2) // Cuando llega factura
  varianza       Decimal? @db.Decimal(15, 2) // montoFacturado - montoEstimado

  // Estado
  estado GRNIStatus @default(PENDIENTE)

  // Factura (cuando llega)
  facturaId Int?
  factura   PurchaseReceipt? @relation(fields: [facturaId], references: [id])

  // Período contable
  periodoCreacion    String // "2026-01" formato YYYY-MM
  periodoFacturacion String? // Cuando se factura

  // Moneda
  moneda String @default("ARS")

  // T1/T2
  docType String @default("T1")

  // Audit
  createdAt       DateTime  @default(now())
  createdBy       Int?
  reversadoAt     DateTime?
  reversadoBy     Int?
  motivoReversion String?

  @@index([companyId, estado])
  @@index([supplierId])
  @@index([periodoCreacion])
  @@index([goodsReceiptId])
  @@map("grni_accruals")
}

enum GRNIStatus {
  PENDIENTE // Esperando factura
  FACTURADO // Factura vinculada
  REVERSADO // Reversión manual
  ANULADO // Recepción anulada
}

// Compras Rápidas
enum QuickPurchaseReason {
  EMERGENCIA_PRODUCCION // Parada de línea, urgencia operativa
  REPOSICION_URGENTE // Stock crítico, no puede esperar OC
  PROVEEDOR_UNICO // Solo este proveedor lo tiene
  COMPRA_MENOR // Monto menor al umbral de OC
  OPORTUNIDAD_PRECIO // Oferta por tiempo limitado
  OTRO // Requiere justificación en texto
}

enum RegularizationStatus {
  REG_PENDING // Pendiente de regularizar
  REG_OK // Regularizada (se vinculó a OC o se documentó)
  REG_NOT_REQUIRED // No requiere (compra menor dentro de umbral)
}

// Estados de Match y Pago
enum FacturaMatchStatus {
  MATCH_PENDING // No hay recepciones vinculadas todavía
  MATCH_OK // TODAS las líneas dentro de tolerancia
  MATCH_WARNING // Diferencias menores (registrar CUÁLES líneas)
  MATCH_BLOCKED // Diferencias fuera de tolerancia (registrar CUÁLES)
}

enum PayApprovalStatus {
  PAY_PENDING // Sin revisar
  PAY_APPROVED // Aprobada para pago
  PAY_REJECTED // Rechazada
  PAY_BLOCKED_BY_MATCH // Bloqueada automáticamente por match
}

enum LineMatchStatus {
  LINE_OK // Coincide dentro de tolerancia
  LINE_WARNING // Diferencia menor
  LINE_BLOCKED // Diferencia mayor
  LINE_MISSING_RECEIPT // Facturado pero no recibido
  LINE_MISSING_INVOICE // Recibido pero no facturado
  LINE_EXTRA // Item extra no esperado
}

// Solicitudes de NCA
enum CreditNoteRequestStatus {
  SNCA_NUEVA // Recién creada
  SNCA_ENVIADA // Enviada al proveedor
  SNCA_EN_REVISION // Proveedor la está revisando
  SNCA_APROBADA // Proveedor aprobó
  SNCA_PARCIAL // Proveedor aprobó parcialmente
  SNCA_RECHAZADA // Proveedor rechazó
  SNCA_NCA_RECIBIDA // Se recibió la NCA del proveedor
  SNCA_APLICADA // NCA aplicada a factura/cuenta
  SNCA_CERRADA // Finalizada
  SNCA_CANCELADA // Cancelada internamente
}

enum CreditNoteRequestType {
  SNCA_FALTANTE // Llegó menos de lo facturado
  SNCA_DEVOLUCION // Se devolvió mercadería (afecta stock)
  SNCA_PRECIO // Precio facturado distinto al acordado
  SNCA_DESCUENTO // Descuento no aplicado
  SNCA_CALIDAD // Problema de calidad (puede afectar stock)
  SNCA_OTRO
}

enum CreditNoteType {
  // T1 - Notas de Crédito A (documentos AFIP)
  NCA_FALTANTE // Por mercadería que nunca llegó
  NCA_DEVOLUCION // Por mercadería devuelta
  NCA_PRECIO // Diferencia de precio
  NCA_DESCUENTO // Descuento no aplicado
  NCA_CALIDAD // Por problema de calidad
  NCA_OTRO

  // T2 - Notas de Crédito simple (documentos internos/extendidos)
  NC_FALTANTE // Por mercadería que nunca llegó
  NC_DEVOLUCION // Por mercadería devuelta
  NC_PRECIO // Diferencia de precio
  NC_DESCUENTO // Descuento no aplicado
  NC_CALIDAD // Por problema de calidad
  NC_OTRO
}

// Notas de Crédito / Débito
model CreditDebitNote {
  id               Int                   @id @default(autoincrement())
  tipo             CreditDebitNoteType
  numero           String                @db.VarChar(50)
  numeroSerie      String                @db.VarChar(20)
  proveedorId      Int
  facturaId        Int? // Factura de referencia
  goodsReceiptId   Int? // Recepción de referencia (para devoluciones)
  fechaEmision     DateTime              @db.Date
  motivo           String
  // Montos
  neto             Decimal               @db.Decimal(15, 2)
  iva21            Decimal               @default(0) @db.Decimal(15, 2)
  iva105           Decimal               @default(0) @db.Decimal(15, 2)
  iva27            Decimal               @default(0) @db.Decimal(15, 2)
  total            Decimal               @db.Decimal(15, 2)
  // Estado
  estado           CreditDebitNoteStatus @default(BORRADOR)
  aplicada         Boolean               @default(false)
  aplicadaAt       DateTime?
  // CAE/CAI
  cae              String?               @db.VarChar(20)
  fechaVtoCae      DateTime?             @db.Date
  // Tracking
  notas            String?
  // Tipo de NCA para clasificación
  tipoNca          CreditNoteType        @default(NCA_OTRO)
  // Vinculación a solicitud de NCA
  requestId        Int?
  // Vinculación a devolución física (si aplica)
  purchaseReturnId Int?
  // ViewMode
  docType          DocType               @default(T1)
  companyId        Int
  createdBy        Int
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  proveedor         suppliers                  @relation(fields: [proveedorId], references: [id])
  factura           PurchaseReceipt?           @relation(fields: [facturaId], references: [id])
  company           Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser     User                       @relation("CreditDebitNoteCreatedBy", fields: [createdBy], references: [id])
  items             CreditDebitNoteItem[]
  accountMovements  SupplierAccountMovement[]
  request           CreditNoteRequest?         @relation(fields: [requestId], references: [id])
  purchaseReturn    PurchaseReturn?            @relation("CreditNotePurchaseReturn", fields: [purchaseReturnId], references: [id])
  // Imputaciones (si es NCA)
  creditAllocations SupplierCreditAllocation[] @relation("CreditNoteAllocations")
  // NDAs que recibieron imputaciones de NCAs
  debitAllocations  SupplierCreditAllocation[] @relation("CreditAllocationsToDebit")

  @@index([companyId])
  @@index([proveedorId])
  @@index([facturaId])
  @@index([tipo])
  @@index([estado])
  @@index([docType])
  @@index([companyId, docType])
  @@map("credit_debit_notes")
}

model CreditDebitNoteItem {
  id             Int     @id @default(autoincrement())
  noteId         Int
  supplierItemId Int?
  descripcion    String  @db.VarChar(255)
  cantidad       Decimal @db.Decimal(15, 4)
  unidad         String  @db.VarChar(50)
  precioUnitario Decimal @db.Decimal(15, 2)
  subtotal       Decimal @db.Decimal(15, 2)

  note         CreditDebitNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  supplierItem SupplierItem?   @relation(fields: [supplierItemId], references: [id])

  @@index([noteId])
  @@map("credit_debit_note_items")
}

enum CreditDebitNoteType {
  NOTA_CREDITO
  NOTA_DEBITO
}

enum CreditDebitNoteStatus {
  BORRADOR
  EMITIDA
  APLICADA
  ANULADA
}

// Solicitud de Nota de Crédito del proveedor
model CreditNoteRequest {
  id          Int                     @id @default(autoincrement())
  numero      String                  @db.VarChar(50) // SNCA-2026-00001
  proveedorId Int
  estado      CreditNoteRequestStatus @default(SNCA_NUEVA)
  tipo        CreditNoteRequestType // FALTANTE, DEVOLUCION, PRECIO, DESCUENTO, OTRO

  // Vinculación
  facturaId      Int? // Factura de referencia
  goodsReceiptId Int? // Recepción de referencia

  // Montos
  montoSolicitado Decimal  @db.Decimal(15, 2)
  montoAprobado   Decimal? @db.Decimal(15, 2)

  // Descripción
  motivo      String
  descripcion String?

  // Evidencia
  evidencias String[] // URLs a fotos/documentos

  // Fechas
  fechaSolicitud DateTime  @default(now())
  fechaEnvio     DateTime? // Cuando se envió al proveedor
  fechaRespuesta DateTime? // Cuando el proveedor respondió
  fechaCierre    DateTime?

  // Respuesta del proveedor
  respuestaProveedor String?

  // ViewMode
  docType   DocType  @default(T1)
  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  proveedor       suppliers               @relation(fields: [proveedorId], references: [id])
  factura         PurchaseReceipt?        @relation(fields: [facturaId], references: [id])
  goodsReceipt    GoodsReceipt?           @relation(fields: [goodsReceiptId], references: [id])
  company         Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser   User                    @relation("CreditNoteRequestCreatedBy", fields: [createdBy], references: [id])
  items           CreditNoteRequestItem[]
  creditNotes     CreditDebitNote[]
  purchaseReturns PurchaseReturn[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([estado])
  @@index([proveedorId])
  @@index([facturaId])
  @@index([docType])
  @@index([companyId, docType])
  @@map("credit_note_requests")
}

model CreditNoteRequestItem {
  id                 Int      @id @default(autoincrement())
  requestId          Int
  supplierItemId     Int?
  descripcion        String
  cantidadFacturada  Decimal  @db.Decimal(15, 4)
  cantidadSolicitada Decimal  @db.Decimal(15, 4)
  cantidadAprobada   Decimal? @db.Decimal(15, 4)
  unidad             String   @db.VarChar(20)
  precioUnitario     Decimal  @db.Decimal(15, 4)
  subtotal           Decimal  @db.Decimal(15, 2)
  motivo             String?

  request      CreditNoteRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  supplierItem SupplierItem?     @relation(fields: [supplierItemId], references: [id])

  @@index([requestId])
  @@map("credit_note_request_items")
}

// Sistema de 3-Way Match (OC ↔ Recepción ↔ Factura)
model MatchResult {
  id                    Int         @id @default(autoincrement())
  purchaseOrderId       Int?
  goodsReceiptId        Int?
  facturaId             Int
  estado                MatchStatus @default(PENDIENTE)
  // Resultados del match
  matchOcRecepcion      Boolean?
  matchRecepcionFactura Boolean?
  matchOcFactura        Boolean?
  matchCompleto         Boolean     @default(false)
  // Detalles de discrepancias
  discrepancias         Json? // Array de discrepancias encontradas
  // Resolución
  resuelto              Boolean     @default(false)
  resueltoPor           Int?
  resueltoAt            DateTime?
  accionTomada          String?
  notas                 String?
  // Tracking
  companyId             Int
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  purchaseOrder  PurchaseOrder?    @relation(fields: [purchaseOrderId], references: [id])
  goodsReceipt   GoodsReceipt?     @relation(fields: [goodsReceiptId], references: [id])
  factura        PurchaseReceipt   @relation(fields: [facturaId], references: [id])
  resueltoByUser User?             @relation("MatchResultResolvedBy", fields: [resueltoPor], references: [id])
  exceptions     MatchException[]
  lineResults    MatchLineResult[]

  @@index([companyId])
  @@index([estado])
  @@index([facturaId])
  @@map("match_results")
}

// Resultado de match por LÍNEA
model MatchLineResult {
  id            Int @id @default(autoincrement())
  matchResultId Int

  // Identificación del item
  facturaItemId  Int? // Item de la factura
  receiptItemId  Int? // Item del remito (puede ser null si falta)
  ocItemId       Int? // Item de la OC
  supplierItemId Int? // Para mapeo robusto
  descripcion    String // Para items sin supplierItemId

  // Cantidades comparadas
  qtyFacturada Decimal  @db.Decimal(15, 4)
  qtyRecibida  Decimal  @db.Decimal(15, 4)
  qtyOC        Decimal? @db.Decimal(15, 4)

  // Precios comparados
  precioFactura  Decimal? @db.Decimal(15, 4)
  precioRecibido Decimal? @db.Decimal(15, 4)
  precioOC       Decimal? @db.Decimal(15, 4)

  // Resultado de esta línea
  status            LineMatchStatus // OK, WARNING, BLOCKED, MISSING
  diffCantidad      Decimal?        @db.Decimal(15, 4) // Diferencia absoluta
  diffPorcentaje    Decimal?        @db.Decimal(5, 2) // % de diferencia de cantidad
  diffPrecio        Decimal?        @db.Decimal(15, 4) // Diferencia absoluta de precio
  pctVarianzaPrecio Decimal?        @db.Decimal(5, 2) // % de varianza de precio
  razon             String? // "Faltante", "Exceso", "Precio diferente", etc.

  createdAt DateTime @default(now())

  matchResult MatchResult @relation(fields: [matchResultId], references: [id], onDelete: Cascade)

  @@index([matchResultId])
  @@index([status])
  @@map("match_line_results")
}

model MatchException {
  id               Int                @id @default(autoincrement())
  matchResultId    Int
  tipo             MatchExceptionType
  campo            String             @db.VarChar(100)
  valorEsperado    String?
  valorRecibido    String?
  diferencia       Decimal?           @db.Decimal(15, 4)
  porcentajeDiff   Decimal?           @db.Decimal(5, 2)
  dentroTolerancia Boolean            @default(false)
  // Owner y SLA
  ownerId          Int?
  ownerRole        String?            @db.VarChar(50)
  slaDeadline      DateTime?
  slaBreached      Boolean            @default(false)
  prioridad        String?            @db.VarChar(20) // BAJA, NORMAL, ALTA, URGENTE
  montoAfectado    Decimal?           @db.Decimal(15, 2)
  // Escalamiento
  escalatedAt      DateTime?
  escalatedTo      Int?
  // Resolución
  resuelto         Boolean            @default(false)
  resueltoPor      Int?
  resueltoAt       DateTime?
  accion           String?
  reasonCode       String?            @db.VarChar(50)
  reasonText       String?
  notas            String?
  createdAt        DateTime           @default(now())

  matchResult     MatchResult             @relation(fields: [matchResultId], references: [id], onDelete: Cascade)
  resueltoByUser  User?                   @relation("MatchExceptionResolvedBy", fields: [resueltoPor], references: [id])
  owner           User?                   @relation("MatchExceptionOwner", fields: [ownerId], references: [id])
  escalatedToUser User?                   @relation("MatchExceptionEscalatedTo", fields: [escalatedTo], references: [id])
  history         MatchExceptionHistory[]

  @@index([matchResultId])
  @@index([tipo])
  @@index([resuelto])
  @@index([ownerId])
  @@index([slaDeadline])
  @@index([slaBreached])
  @@map("match_exceptions")
}

enum MatchStatus {
  PENDIENTE
  MATCH_OK
  DISCREPANCIA
  RESUELTO
  BLOQUEADO
}

enum MatchExceptionType {
  CANTIDAD_DIFERENTE
  PRECIO_DIFERENTE
  ITEM_FALTANTE
  ITEM_EXTRA
  IMPUESTO_DIFERENTE
  TOTAL_DIFERENTE
  SIN_OC
  SIN_RECEPCION
  DUPLICADO
}

// Configuración de tolerancias para matching
model PurchaseConfig {
  id                                Int      @id @default(autoincrement())
  companyId                         Int      @unique
  // Tolerancias de cantidad (%)
  toleranciaCantidad                Decimal  @default(5) @db.Decimal(5, 2)
  // Tolerancias de precio (%)
  toleranciaPrecio                  Decimal  @default(2) @db.Decimal(5, 2)
  // Tolerancia de total (%)
  toleranciaTotal                   Decimal  @default(1) @db.Decimal(5, 2)
  // Políticas de Match
  permitirExceso                    Boolean  @default(false) // ¿Permitir recibir más de lo pedido?
  permitirPagoSinMatch              Boolean  @default(false)
  bloquearPagoConWarning            Boolean  @default(false) // ¿Bloquear pago si hay warning?
  permitirRecepcionSinOc            Boolean  @default(true)
  requiereAprobacionMontoMinimo     Decimal? @db.Decimal(15, 2)
  // Política de Compras Rápidas
  quickPurchaseEnabled              Boolean  @default(true)
  quickPurchaseMaxAmount            Decimal? @db.Decimal(15, 2) // Monto máximo sin aprobación
  quickPurchaseRequiresApproval     Boolean  @default(false) // Requiere aprobación extra
  quickPurchaseAllowedRoles         String[] // Roles que pueden crear compras rápidas
  quickPurchaseAlertThreshold       Int      @default(3) // Alertar si un usuario hace X en 7 días
  quickPurchaseRequireJustification Boolean  @default(true) // Motivo obligatorio
  // Umbrales de aprobación
  umbralAprobacionPedido            Decimal  @default(50000) @db.Decimal(15, 2) // Monto mínimo para requerir aprobación de pedido
  umbralDobleAprobacion             Decimal  @default(500000) @db.Decimal(15, 2) // Monto mínimo para doble aprobación de pago
  // Políticas de Pago
  permitirPagoSinRecepcion          Boolean  @default(false) // ¿Permitir pagar sin recepción confirmada?
  // Días para alertas
  diasAlertaRecepcionSinFactura     Int      @default(7)
  diasAlertaFacturaVencer           Int      @default(7)
  diasLimiteRegularizacion          Int      @default(15)
  // IA
  iaAutoMatch                       Boolean  @default(false)
  iaConfianzaMinima                 Decimal  @default(80) @db.Decimal(5, 2) // % mínimo de confianza
  createdAt                         DateTime @default(now())
  updatedAt                         DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("purchase_configs")
}

// =====================================================
// CONFIGURACIÓN SLA PARA MATCH EXCEPTIONS
// =====================================================
model MatchExceptionSLAConfig {
  id                 Int      @id @default(autoincrement())
  companyId          Int
  exceptionType      String   @db.VarChar(50) // PRECIO_DIFERENTE, CANTIDAD_DIFERENTE, etc
  slaHours           Int      @default(24)
  ownerRole          String?  @db.VarChar(50) // Rol responsable por defecto
  escalateAfterHours Int? // Horas antes de escalar
  escalateToRole     String?  @db.VarChar(50) // Rol para escalamiento
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, exceptionType])
  @@map("match_exception_sla_configs")
}

// =====================================================
// HISTORIAL DE MATCH EXCEPTIONS
// =====================================================
model MatchExceptionHistory {
  id          Int      @id @default(autoincrement())
  exceptionId Int
  action      String   @db.VarChar(50) // ASSIGN, ESCALATE, RESOLVE, COMMENT
  fromOwnerId Int?
  toOwnerId   Int?
  fromStatus  String?  @db.VarChar(50)
  toStatus    String?  @db.VarChar(50)
  reasonCode  String?  @db.VarChar(50)
  reasonText  String?
  userId      Int // Quien realizó la acción
  createdAt   DateTime @default(now())

  exception MatchException @relation(fields: [exceptionId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id])

  @@index([exceptionId])
  @@map("match_exception_history")
}

// =====================================================
// NOTIFICATION OUTBOX (Patrón Outbox para notificaciones)
// =====================================================
model NotificationOutbox {
  id            Int       @id @default(autoincrement())
  companyId     Int
  tipo          String    @db.VarChar(50) // URGENTE_PEDIDO, SLA_BREACH, MATCH_EXCEPTION, etc
  destinatarios Json // Array de { userId, email, channel }
  titulo        String    @db.VarChar(255)
  mensaje       String
  datos         Json? // Datos adicionales para template
  prioridad     String    @default("NORMAL") @db.VarChar(20)
  // Estado de envío
  estado        String    @default("PENDING") @db.VarChar(20) // PENDING, SENT, FAILED, CANCELLED
  intentos      Int       @default(0)
  ultimoError   String?
  // Tracking
  scheduledAt   DateTime? // Para envíos programados
  sentAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([estado])
  @@index([scheduledAt])
  @@map("notification_outbox")
}

// =====================================================
// SEGREGATION OF DUTIES (SoD) - Matriz de Reglas
// =====================================================
model SoDRule {
  id          Int      @id @default(autoincrement())
  companyId   Int
  codigo      String   @db.VarChar(20) // SOD_001, SOD_002, etc
  nombre      String   @db.VarChar(100)
  descripcion String?
  accion1     String   @db.VarChar(50) // Acción que el usuario hizo
  accion2     String   @db.VarChar(50) // Acción que no puede hacer
  scope       String   @default("SAME_DOCUMENT") @db.VarChar(30) // SAME_DOCUMENT, SAME_SUPPLIER, GLOBAL
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company    Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  violations SoDViolation[]

  @@unique([companyId, codigo])
  @@map("sod_rules")
}

// =====================================================
// REGISTRO DE VIOLACIONES SoD
// =====================================================
model SoDViolation {
  id           Int      @id @default(autoincrement())
  ruleId       Int
  companyId    Int
  userId       Int // Usuario que intentó violar
  documentType String   @db.VarChar(50) // OC, PEDIDO, OP, etc
  documentId   Int
  accion       String   @db.VarChar(50)
  bloqueado    Boolean  @default(true) // Si se bloqueó la acción
  aprobadoPor  Int? // Si alguien con permisos override aprobó
  motivo       String? // Justificación si se aprobó override
  createdAt    DateTime @default(now())

  rule    SoDRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation("SoDViolationUser", fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@map("sod_violations")
}

// Sistema de Aprobaciones
model PurchaseApproval {
  id             Int               @id @default(autoincrement())
  tipo           ApprovalType
  referenciaId   Int // ID del documento a aprobar
  referenciaTipo String            @db.VarChar(50) // purchase_order, goods_receipt, etc
  estado         ApprovalStatus    @default(PENDIENTE)
  monto          Decimal?          @db.Decimal(15, 2)
  motivo         String? // Motivo de la solicitud de aprobación
  // Asignación
  asignadoA      Int?
  fechaLimite    DateTime?
  // Resolución
  resueltoPor    Int?
  resueltoAt     DateTime?
  decision       ApprovalDecision?
  comentarios    String?
  // Tracking
  companyId      Int
  createdBy      Int
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  asignadoAUser  User?          @relation("ApprovalAssignedTo", fields: [asignadoA], references: [id])
  resueltoByUser User?          @relation("ApprovalResolvedBy", fields: [resueltoPor], references: [id])
  createdByUser  User           @relation("ApprovalCreatedBy", fields: [createdBy], references: [id])
  purchaseOrder  PurchaseOrder? @relation(fields: [referenciaId], references: [id])

  @@index([companyId])
  @@index([tipo])
  @@index([estado])
  @@index([asignadoA])
  @@index([referenciaId, referenciaTipo])
  @@map("purchase_approvals")
}

enum ApprovalType {
  MONTO
  CATEGORIA
  PROVEEDOR
  EMERGENCIA
  DESVIACION_MATCH
}

enum ApprovalStatus {
  PENDIENTE
  EN_REVISION
  APROBADA
  RECHAZADA
  ESCALADA
  VENCIDA
}

enum ApprovalDecision {
  APROBADA
  RECHAZADA
  APROBADA_CON_CONDICIONES
}

// Centros de Costo
model CostCenter {
  id          Int      @id @default(autoincrement())
  codigo      String   @db.VarChar(50)
  nombre      String   @db.VarChar(255)
  descripcion String?
  isActive    Boolean  @default(true)
  parentId    Int? // Para jerarquía
  companyId   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent         CostCenter?       @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children       CostCenter[]      @relation("CostCenterHierarchy")
  company        Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  receipts       PurchaseReceipt[] @relation("ReceiptCostCenter")

  @@unique([companyId, codigo])
  @@index([companyId])
  @@index([isActive])
  @@map("cost_centers")
}

// Proyectos / Obras
model Project {
  id          Int           @id @default(autoincrement())
  codigo      String        @db.VarChar(50)
  nombre      String        @db.VarChar(255)
  descripcion String?
  estado      ProjectStatus @default(ACTIVO)
  fechaInicio DateTime?     @db.Date
  fechaFin    DateTime?     @db.Date
  presupuesto Decimal?      @db.Decimal(15, 2)
  clienteId   Int? // Si aplica
  companyId   Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchaseOrders  PurchaseOrder[]
  receipts        PurchaseReceipt[] @relation("ReceiptProject")
  MaterialRequest MaterialRequest[]

  @@unique([companyId, codigo])
  @@index([companyId])
  @@index([estado])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVO
  EN_PAUSA
  COMPLETADO
  CANCELADO
}

// Alias de items para matching con IA
model SupplierItemAlias {
  id              Int      @id @default(autoincrement())
  supplierItemId  Int
  alias           String   @db.VarChar(255)
  codigoProveedor String?  @db.VarChar(100) // Código del proveedor para este alias
  esNombreFactura Boolean  @default(true) // Si es el nombre que aparece en facturas
  confianza       Decimal  @default(100) @db.Decimal(5, 2) // % de confianza del alias
  vecesUsado      Int      @default(0) // Veces que se usó este alias
  companyId       Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supplierItem SupplierItem @relation(fields: [supplierItemId], references: [id], onDelete: Cascade)

  @@index([supplierItemId])
  @@index([alias])
  @@index([codigoProveedor])
  @@index([companyId])
  @@map("supplier_item_aliases")
}

// Solicitudes de Pago (estructurada, reemplaza JSON en Document)
model PaymentRequest {
  id              Int                  @id @default(autoincrement())
  numero          String               @db.VarChar(50)
  proveedorId     Int
  estado          PaymentRequestStatus @default(SOLICITADA)
  prioridad       Priority             @default(MEDIUM)
  // Fechas
  fechaSolicitud  DateTime             @db.Date
  fechaObjetivo   DateTime?            @db.Date // "Para cuándo" necesita el pago
  fechaAprobacion DateTime?
  fechaPago       DateTime?
  // Montos
  montoTotal      Decimal              @db.Decimal(15, 2)
  // Justificación
  motivo          String?
  comentarios     String?
  esUrgente       Boolean              @default(false)
  // Aprobación
  aprobadoPor     Int?
  rechazadoPor    Int?
  motivoRechazo   String?
  // Conversión a orden de pago
  paymentOrderId  Int?
  // Tracking
  companyId       Int
  createdBy       Int
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  proveedor       suppliers               @relation(fields: [proveedorId], references: [id])
  company         Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser   User                    @relation("PaymentRequestCreatedBy", fields: [createdBy], references: [id])
  aprobadoByUser  User?                   @relation("PaymentRequestApprovedBy", fields: [aprobadoPor], references: [id])
  rechazadoByUser User?                   @relation("PaymentRequestRejectedBy", fields: [rechazadoPor], references: [id])
  paymentOrder    PaymentOrder?           @relation(fields: [paymentOrderId], references: [id])
  facturas        PaymentRequestReceipt[]
  logs            PaymentRequestLog[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([proveedorId])
  @@index([estado])
  @@index([prioridad])
  @@index([esUrgente])
  @@map("payment_requests")
}

model PaymentRequestReceipt {
  id               Int      @id @default(autoincrement())
  paymentRequestId Int
  receiptId        Int
  montoSolicitado  Decimal  @db.Decimal(15, 2)
  createdAt        DateTime @default(now())

  paymentRequest PaymentRequest  @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  receipt        PurchaseReceipt @relation(fields: [receiptId], references: [id])

  @@index([paymentRequestId])
  @@index([receiptId])
  @@map("payment_request_receipts")
}

enum PaymentRequestStatus {
  BORRADOR // Guardado sin enviar
  SOLICITADA // Enviada, pendiente de revisión
  EN_REVISION // En proceso de aprobación
  APROBADA // Aprobada, lista para pagar
  RECHAZADA // Rechazada con motivo
  CONVERTIDA // Convertida a orden de pago
  PAGADA // Pagada
  CANCELADA // Cancelada por usuario
}

// Log de auditoría para solicitudes de pago
model PaymentRequestLog {
  id                Int      @id @default(autoincrement())
  paymentRequestId  Int
  accion            String   @db.VarChar(50) // CREADA, EDITADA, ELIMINADA, ESTADO_CAMBIADO, PRIORIDAD_ELEVADA
  estadoAnterior    String?  @db.VarChar(30)
  estadoNuevo       String?  @db.VarChar(30)
  prioridadAnterior String?  @db.VarChar(20)
  prioridadNueva    String?  @db.VarChar(20)
  userId            Int
  detalles          Json? // Campos que cambiaron
  createdAt         DateTime @default(now())

  paymentRequest PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  user           User           @relation("PaymentRequestLogUser", fields: [userId], references: [id])

  @@index([paymentRequestId])
  @@index([userId])
  @@index([createdAt])
  @@map("payment_request_logs")
}

// Devoluciones a Proveedor (RMA)
model PurchaseReturn {
  id                   Int                  @id @default(autoincrement())
  numero               String               @db.VarChar(50)
  proveedorId          Int
  goodsReceiptId       Int? // Recepción original
  estado               PurchaseReturnStatus @default(BORRADOR)
  tipo                 ReturnType
  fechaSolicitud       DateTime             @db.Date
  fechaEnvio           DateTime?            @db.Date
  fechaResolucion      DateTime?            @db.Date
  motivo               String
  descripcion          String?
  // Evidencias por evento (auditoría)
  evidencias           Json? // Array de URLs de fotos/documentos (legacy)
  evidenciaProblema    String? // Foto/doc del problema detectado
  evidenciaEnvio       String? // Foto del remito de salida / transportista
  evidenciaRecepcion   String? // Confirmación del proveedor
  // Resolución
  resolucion           String?
  creditNoteId         Int? // Nota de crédito asociada
  // Factura origen (cuando la devolución se crea desde cuenta corriente)
  facturaId            Int?
  // Vinculación a solicitud de NCA
  creditNoteRequestId  Int?
  // Transporte
  carrier              String? // Transportista
  trackingNumber       String? // Número de seguimiento
  // Depósito origen (para validaciones)
  warehouseId          Int?
  // Control de idempotencia
  stockMovementCreated Boolean              @default(false)
  // Tracking
  notas                String?
  companyId            Int
  // Tipo de documento: T1 = AFIP standard, T2 = Extendido/interno
  docType              String?              @default("T1") @db.VarChar(10)
  createdBy            Int
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  proveedor         suppliers            @relation(fields: [proveedorId], references: [id])
  goodsReceipt      GoodsReceipt?        @relation(fields: [goodsReceiptId], references: [id])
  factura           PurchaseReceipt?     @relation("PurchaseReturnFactura", fields: [facturaId], references: [id])
  warehouse         Warehouse?           @relation(fields: [warehouseId], references: [id])
  company           Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser     User                 @relation("PurchaseReturnCreatedBy", fields: [createdBy], references: [id])
  items             PurchaseReturnItem[]
  stockMovements    StockMovement[]
  creditNoteRequest CreditNoteRequest?   @relation(fields: [creditNoteRequestId], references: [id])
  creditNotes       CreditDebitNote[]    @relation("CreditNotePurchaseReturn")

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([proveedorId])
  @@index([estado])
  @@index([creditNoteRequestId])
  @@index([warehouseId])
  @@index([facturaId])
  @@map("purchase_returns")
}

model PurchaseReturnItem {
  id                 Int              @id @default(autoincrement())
  returnId           Int
  supplierItemId     Int
  descripcion        String           @db.VarChar(255)
  cantidad           Decimal          @db.Decimal(15, 4)
  unidad             String           @db.VarChar(50)
  motivo             String?
  estado             ReturnItemStatus @default(PENDIENTE)
  // Trazabilidad: de dónde viene el item
  goodsReceiptItemId Int?
  // Precio de referencia (fuente de verdad para validaciones NCA)
  precioReferencia   Decimal?         @db.Decimal(15, 2)
  fuentePrecio       String? // 'GR_ITEM' | 'FACTURA' | 'MANUAL'

  return           PurchaseReturn    @relation(fields: [returnId], references: [id], onDelete: Cascade)
  supplierItem     SupplierItem      @relation(fields: [supplierItemId], references: [id])
  goodsReceiptItem GoodsReceiptItem? @relation(fields: [goodsReceiptItemId], references: [id])

  @@unique([returnId, goodsReceiptItemId])
  @@index([returnId])
  @@index([goodsReceiptItemId])
  @@map("purchase_return_items")
}

enum PurchaseReturnStatus {
  BORRADOR
  SOLICITADA
  APROBADA_PROVEEDOR
  ENVIADA
  RECIBIDA_PROVEEDOR
  EN_EVALUACION
  RESUELTA
  RECHAZADA
  CANCELADA
}

enum ReturnType {
  DEFECTO
  EXCESO
  ERROR_PEDIDO
  GARANTIA
  OTRO
}

enum ReturnItemStatus {
  PENDIENTE
  ACEPTADO
  RECHAZADO
}

// Sugerencias de Reposición
model ReplenishmentSuggestion {
  id                Int                  @id @default(autoincrement())
  supplierItemId    Int
  proveedorSugerido Int?
  warehouseId       Int
  cantidadSugerida  Decimal              @db.Decimal(15, 4)
  cantidadActual    Decimal              @db.Decimal(15, 4)
  stockMinimo       Decimal              @db.Decimal(15, 4)
  consumoPromedio   Decimal?             @db.Decimal(15, 4) // Consumo promedio diario/semanal
  leadTimeEstimado  Int? // Días estimados de entrega
  urgencia          ReplenishmentUrgency @default(NORMAL)
  motivo            String?
  estado            ReplenishmentStatus  @default(PENDIENTE)
  // Acción tomada
  purchaseOrderId   Int? // Si se generó OC
  ignorada          Boolean              @default(false)
  ignoradaPor       Int?
  ignoradaMotivo    String?
  // Tracking
  companyId         Int
  createdAt         DateTime             @default(now())
  expiresAt         DateTime? // Cuando expira la sugerencia

  supplierItem SupplierItem @relation(fields: [supplierItemId], references: [id])
  proveedor    suppliers?   @relation(fields: [proveedorSugerido], references: [id])

  @@index([companyId])
  @@index([estado])
  @@index([urgencia])
  @@index([supplierItemId])
  @@map("replenishment_suggestions")
}

enum ReplenishmentUrgency {
  BAJA
  NORMAL
  ALTA
  CRITICA
}

enum ReplenishmentStatus {
  PENDIENTE
  EN_PROCESO
  COMPLETADA
  IGNORADA
  EXPIRADA
}

// Lead Time por Proveedor (calculado automáticamente)
model SupplierLeadTime {
  id                  Int      @id @default(autoincrement())
  supplierId          Int
  supplierItemId      Int? // Opcional: lead time específico por item
  leadTimePromedio    Int // Días promedio
  leadTimeMinimo      Int?
  leadTimeMaximo      Int?
  desviacionEstandar  Decimal? @db.Decimal(5, 2)
  cantidadMuestras    Int      @default(0)
  ultimaActualizacion DateTime @default(now())
  companyId           Int

  supplier     suppliers     @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supplierItem SupplierItem? @relation(fields: [supplierItemId], references: [id])

  @@unique([supplierId, supplierItemId])
  @@index([companyId])
  @@index([supplierId])
  @@map("supplier_lead_times")
}

// Auditoría de Compras (extensión del sistema existente)
model PurchaseAuditLog {
  id                Int      @id @default(autoincrement())
  entidad           String   @db.VarChar(100) // purchase_order, goods_receipt, etc
  entidadId         Int
  accion            String   @db.VarChar(50) // CREATE, UPDATE, DELETE, APPROVE, REJECT, etc
  camposModificados Json? // {campo: {old: x, new: y}}
  datosAnteriores   Json?
  datosNuevos       Json?
  ip                String?  @db.VarChar(50)
  userAgent         String?
  // ViewMode - hereda del documento que generó el evento
  docType           DocType  @default(T1)
  companyId         Int
  userId            Int
  createdAt         DateTime @default(now())

  user User @relation("PurchaseAuditLogUser", fields: [userId], references: [id])

  @@index([companyId])
  @@index([entidad, entidadId])
  @@index([userId])
  @@index([createdAt])
  @@index([docType])
  @@index([companyId, docType])
  @@map("purchase_audit_logs")
}

// Detección de Duplicados
model DuplicateDetection {
  id              Int             @id @default(autoincrement())
  tipo            String          @db.VarChar(50) // factura, item_factura, recepcion_factura
  entidadId       Int // ID del documento sospechoso
  duplicadoDeId   Int? // ID del documento original
  campos          Json // Campos que coinciden
  confianza       Decimal         @db.Decimal(5, 2) // % de probabilidad de ser duplicado
  estado          DuplicateStatus @default(PENDIENTE)
  resueltoPor     Int?
  resueltoAt      DateTime?
  esRealDuplicado Boolean?
  notas           String?
  companyId       Int
  createdAt       DateTime        @default(now())

  @@index([companyId])
  @@index([tipo])
  @@index([estado])
  @@index([entidadId])
  @@map("duplicate_detections")
}

enum DuplicateStatus {
  PENDIENTE
  CONFIRMADO
  DESCARTADO
}

// ============================================================================
// SISTEMA DE SOLICITUDES DE COMPRA Y COTIZACIONES
// ============================================================================

// Solicitud de Compra (Request interno)
model PurchaseRequest {
  id                  Int                   @id @default(autoincrement())
  numero              String                @db.VarChar(50) // REQ-2026-00001
  titulo              String                @db.VarChar(200)
  descripcion         String?
  estado              PurchaseRequestStatus @default(BORRADOR)
  prioridad           RequestPriority       @default(NORMAL)
  // Solicitante
  solicitanteId       Int
  departamento        String?               @db.VarChar(100)
  // Fechas
  fechaNecesidad      DateTime?             @db.Date
  fechaLimite         DateTime?             @db.Date
  // Presupuesto estimado
  presupuestoEstimado Decimal?              @db.Decimal(15, 2)
  moneda              String                @default("ARS") @db.VarChar(10)
  // Adjuntos y notas
  adjuntos            String[] // URLs a archivos
  notas               String?
  // Multi-tenant
  companyId           Int
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  // Relaciones
  items          PurchaseRequestItem[]
  quotations     PurchaseQuotation[]
  solicitante    User                  @relation("RequestSolicitante", fields: [solicitanteId], references: [id])
  purchaseOrders PurchaseOrder[]       @relation("RequestPurchaseOrder") // OC generadas desde esta solicitud
  company        Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Pedido creado desde audio
  voicePurchaseLog VoicePurchaseLog? @relation("VoicePurchaseRequest")

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([estado])
  @@index([solicitanteId])
  @@index([prioridad])
  @@index([createdAt])
  @@index([fechaNecesidad])
  @@index([companyId, estado, createdAt]) // Composite para queries comunes
  @@index([companyId, prioridad, estado]) // Para filtro urgentes
  @@map("purchase_requests")
}

model PurchaseRequestItem {
  id               Int     @id @default(autoincrement())
  requestId        Int
  descripcion      String  @db.VarChar(500)
  cantidad         Decimal @db.Decimal(15, 4)
  unidad           String  @db.VarChar(50)
  supplierItemId   Int? // Opcional: si ya sabe qué item
  especificaciones String? // Detalles técnicos

  request        PurchaseRequest         @relation(fields: [requestId], references: [id], onDelete: Cascade)
  supplierItem   SupplierItem?           @relation("RequestItemSupplierItem", fields: [supplierItemId], references: [id])
  quotationItems PurchaseQuotationItem[]

  @@index([requestId])
  @@map("purchase_request_items")
}

enum PurchaseRequestStatus {
  BORRADOR
  ENVIADA
  EN_COTIZACION // Encargado buscando presupuestos
  COTIZADA // Tiene cotizaciones cargadas
  EN_APROBACION // Esperando aprobación de gerente
  APROBADA // Gerente aprobó una cotización
  EN_PROCESO // OC creada/enviada
  COMPLETADA // Recibido
  RECHAZADA
  CANCELADA
}

enum RequestPriority {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

// Cotización de Proveedor (Quotation)
model PurchaseQuotation {
  id                   Int             @id @default(autoincrement())
  numero               String          @db.VarChar(50) // COT-2026-00001
  requestId            Int // Solicitud de origen
  supplierId           Int // Proveedor que cotiza
  estado               QuotationStatus @default(RECIBIDA)
  // Fechas
  fechaCotizacion      DateTime        @db.Date
  validezHasta         DateTime?       @db.Date
  plazoEntrega         Int? // Días
  fechaEntregaEstimada DateTime?       @db.Date
  // Condiciones
  condicionesPago      String?         @db.VarChar(200)
  formaPago            String?         @db.VarChar(100)
  garantia             String?         @db.VarChar(200)
  // Totales
  subtotal             Decimal         @db.Decimal(15, 2)
  descuento            Decimal         @default(0) @db.Decimal(15, 2)
  impuestos            Decimal         @db.Decimal(15, 2)
  total                Decimal         @db.Decimal(15, 2)
  moneda               String          @default("ARS") @db.VarChar(10)
  // Multi-moneda y tipo de cambio
  exchangeRate         Decimal?        @db.Decimal(15, 4) // TC al momento de cargar (si USD)
  // IVA configurable
  pricesIncludeVat     Boolean         @default(false)
  vatRate              Decimal         @default(21) @db.Decimal(5, 2) // 21, 10.5, 0
  // Costos adicionales
  shippingCost         Decimal         @default(0) @db.Decimal(15, 2)
  otherCosts           Decimal         @default(0) @db.Decimal(15, 2)
  otherCostsDesc       String?         @db.VarChar(200)
  // Beneficios/Observaciones (para comparar)
  beneficios           String? // "Entrega inmediata", "Mejor precio", etc.
  observaciones        String?
  // Adjuntos
  adjuntos             String[] // PDF de cotización del proveedor
  // Selección/Aprobación (REGLA: solo 1 cotización seleccionada por request)
  esSeleccionada       Boolean         @default(false)
  seleccionadaPor      Int?
  seleccionadaAt       DateTime?
  motivoSeleccion      String? // Por qué se eligió esta
  // Timestamps de estados (para métricas)
  receivedAt           DateTime? // Cuando pasó a RECIBIDA
  convertedAt          DateTime? // Cuando se convirtió a OC
  expiredAt            DateTime? // Cuando se marcó como vencida
  // Flags de selección
  notSelectedReason    String?         @db.VarChar(100) // "another_selected", "price_too_high", etc.
  // Flag de vencimiento (separado de estado)
  isExpired            Boolean         @default(false) // true si pasó validez
  // Multi-tenant
  companyId            Int
  createdBy            Int
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relaciones
  items              PurchaseQuotationItem[]
  statusHistory      QuotationStatusHistory[]
  request            PurchaseRequest          @relation(fields: [requestId], references: [id])
  supplier           suppliers                @relation(fields: [supplierId], references: [id])
  company            Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser      User                     @relation("QuotationCreatedBy", fields: [createdBy], references: [id])
  seleccionadaByUser User?                    @relation("QuotationSelectedBy", fields: [seleccionadaPor], references: [id])
  purchaseOrders     PurchaseOrder[]          @relation("QuotationPurchaseOrder")

  @@unique([companyId, numero])
  @@index([requestId])
  @@index([supplierId])
  @@index([companyId])
  @@index([estado])
  @@index([companyId, estado, createdAt])
  @@index([companyId, validezHasta])
  @@index([requestId, estado])
  @@map("purchase_quotations")
}

model PurchaseQuotationItem {
  id              Int     @id @default(autoincrement())
  quotationId     Int
  requestItemId   Int? // Link al item solicitado
  supplierItemId  Int? // Item del catálogo del proveedor
  codigoProveedor String? @db.VarChar(100) // Código del producto según el proveedor
  descripcion     String  @db.VarChar(500)
  cantidad        Decimal @db.Decimal(15, 4)
  unidad          String  @db.VarChar(50)
  precioUnitario  Decimal @db.Decimal(15, 4)
  descuento       Decimal @default(0) @db.Decimal(5, 2) // %
  subtotal        Decimal @db.Decimal(15, 2)
  notas           String?
  // Matching para comparador
  productId       String? // ID de producto interno (si existe)
  normalizedKey   String? @db.VarChar(200) // Clave normalizada para matching
  supplierSku     String? @db.VarChar(100) // SKU del proveedor
  // Para items parciales/sustitutos
  isSubstitute    Boolean @default(false) // Es un sustituto
  substituteFor   Int? // requestItemId que sustituye

  quotation    PurchaseQuotation    @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  requestItem  PurchaseRequestItem? @relation(fields: [requestItemId], references: [id])
  supplierItem SupplierItem?        @relation("QuotationItemSupplierItem", fields: [supplierItemId], references: [id])

  @@index([quotationId])
  @@index([productId])
  @@index([normalizedKey])
  @@map("purchase_quotation_items")
}

enum QuotationStatus {
  BORRADOR
  RECIBIDA
  EN_REVISION
  SELECCIONADA // Elegida por el gerente
  CONVERTIDA_OC // Se creó OC desde esta
  RECHAZADA
  VENCIDA
}

// Historial de cambios de estado de cotización (auditoría)
model QuotationStatusHistory {
  id              Int              @id @default(autoincrement())
  quotationId     Int
  fromStatus      QuotationStatus?
  toStatus        QuotationStatus
  changedBy       Int
  changedAt       DateTime         @default(now())
  reason          String? // Motivo del cambio
  systemGenerated Boolean          @default(false) // true si fue automático (ej: vencimiento)
  metadata        Json? // Datos adicionales

  quotation PurchaseQuotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  user      User              @relation("QuotationStatusChangedBy", fields: [changedBy], references: [id])

  @@index([quotationId, changedAt])
  @@map("quotation_status_history")
}

// Configuración de cotizaciones por empresa
model CompanyQuotationSettings {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Comportamiento de selección
  autoRejectOnSelect Boolean @default(false) // Auto-rechazar otras al seleccionar

  // Score configurable (pesos que suman 100)
  scorePriceWeight    Int @default(50) // Peso del precio (0-100)
  scoreDeliveryWeight Int @default(25) // Peso de entrega (0-100)
  scorePaymentWeight  Int @default(25) // Peso de condiciones pago (0-100)

  // Penalizaciones
  penaltyMissingItems Int @default(10) // Penalización por item faltante
  penaltyExpired      Int @default(20) // Penalización por vencida
  penaltyIncomplete   Int @default(5) // Penalización por datos incompletos

  // Alertas
  alertDaysBefore Int @default(7) // Días antes de vencer para alertar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("company_quotation_settings")
}

// Comentarios/Chat polimórfico para compras
model PurchaseComment {
  id          Int                 @id @default(autoincrement())
  entidad     String              @db.VarChar(50) // "request", "quotation", "order"
  entidadId   Int
  tipo        PurchaseCommentType @default(COMENTARIO)
  contenido   String
  adjuntos    String[]
  // Menciones
  mencionados Int[] // IDs de usuarios mencionados
  // Multi-tenant
  companyId   Int
  userId      Int
  createdAt   DateTime            @default(now())

  user    User    @relation("PurchaseCommentUser", fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entidad, entidadId])
  @@index([companyId])
  @@index([createdAt])
  @@map("purchase_comments")
}

enum PurchaseCommentType {
  COMENTARIO
  ACTUALIZACION
  PREGUNTA
  RESPUESTA
  SISTEMA // Automático: "Estado cambió a X"
}

// Tipo de documento para ViewMode (T1: estándar/documentado, T2: extendido)
enum DocType {
  T1 // Formal (facturado, con CAE)
  T2 // Interno (sin fiscal)
  T3 // Presupuesto (cotización sin compromiso)
}

// ============================================================================
// VIEW MODE - Configuración de visibilidad
// ============================================================================

model CompanyViewConfig {
  id             String   @id @default(uuid())
  companyId      Int      @unique
  enabled        Boolean  @default(false)
  hotkey         String?  @db.VarChar(50)
  pinHash        String?  @db.VarChar(100)
  sessionTimeout Int      @default(30)
  // Tipos de comprobante T2 configurados para esta empresa (array de strings)
  // Ej: ["Presupuesto", "Remito Sin Factura", "Comprobante Interno"]
  tiposT2        String[] @default([])
  // Control de acceso a BD T2 separada (solo superadmin puede modificar)
  t2DbEnabled    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("company_view_config")
}

model ViewModeLog {
  id        String   @id @default(uuid())
  userId    Int
  companyId Int
  action    String   @db.VarChar(20)
  ipAddress String?  @db.VarChar(50)
  userAgent String?
  timestamp DateTime @default(now())

  @@index([companyId, timestamp])
  @@map("_vm_log")
}

// ============================================================================
// SEGURIDAD AVANZADA
// ============================================================================

// Refresh Tokens - Para rotación y revocación
model RefreshToken {
  id         String    @id @default(uuid())
  token      String    @unique
  userId     Int
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId  String
  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  revokedAt  DateTime?
  replacedBy String? // Token que lo reemplazó (detección de reuso)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// Token Blacklist - Invalidación inmediata
model TokenBlacklist {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  tokenType String // "access" | "refresh"
  userId    Int
  reason    String? // "logout" | "password_change" | "admin_revoke" | "security"
  expiresAt DateTime // Cuando el token original expiraría
  createdAt DateTime @default(now())

  @@index([tokenHash])
  @@index([expiresAt])
  @@index([userId])
  @@map("token_blacklist")
}

// Sesiones Activas - Control multi-dispositivo
model Session {
  id                String         @id @default(uuid())
  userId            Int
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceFingerprint String?
  deviceName        String? // "Chrome en Windows", "Safari en iPhone"
  deviceType        String? // "desktop" | "mobile" | "tablet"
  browser           String?
  os                String?
  ipAddress         String?
  userAgent         String?
  isActive          Boolean        @default(true)
  lastActivityAt    DateTime       @default(now())
  createdAt         DateTime       @default(now())
  expiresAt         DateTime
  revokedAt         DateTime?
  revokeReason      String?
  refreshTokens     RefreshToken[]

  @@index([userId, isActive])
  @@index([expiresAt])
  @@index([deviceFingerprint])
  @@map("sessions")
}

// Rate Limiting - Control de intentos
model RateLimitEntry {
  id           String    @id @default(uuid())
  identifier   String // IP o "ip:userId"
  action       String // "login" | "api" | "2fa" | "password_reset"
  count        Int       @default(1)
  firstAttempt DateTime  @default(now())
  lastAttempt  DateTime  @default(now())
  blockedUntil DateTime?

  @@unique([identifier, action])
  @@index([blockedUntil])
  @@map("rate_limit_entries")
}

// Login Attempts - Auditoría de seguridad
model LoginAttempt {
  id         String   @id @default(uuid())
  email      String
  ipAddress  String
  userAgent  String?
  success    Boolean
  failReason String? // "invalid_password" | "user_not_found" | "blocked" | "2fa_failed" | "inactive"
  userId     Int?
  user       User?    @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@index([userId])
  @@map("login_attempts")
}

// 2FA TOTP - Autenticación de dos factores
model UserTwoFactor {
  id              String    @id @default(uuid())
  userId          Int       @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  secret          String // Encriptado con clave del servidor
  isEnabled       Boolean   @default(false)
  verifiedAt      DateTime?
  backupCodes     String[] // Hashes de códigos de respaldo
  usedBackupCodes String[] // Códigos ya usados
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("user_two_factor")
}

// Dispositivos Confiables - Skip 2FA por 30 días
model TrustedDevice {
  id                String   @id @default(uuid())
  userId            Int
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceFingerprint String
  deviceName        String?
  trustToken        String   @unique
  expiresAt         DateTime // 30 días típicamente
  createdAt         DateTime @default(now())
  lastUsedAt        DateTime @default(now())

  @@index([userId])
  @@index([trustToken])
  @@index([deviceFingerprint])
  @@map("trusted_devices")
}

// Security Events - Auditoría completa
model SecurityEvent {
  id        String   @id @default(uuid())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  eventType String // "login" | "logout" | "password_change" | "2fa_enabled" | "2fa_disabled" | "session_revoked" | "suspicious_activity"
  severity  String // "info" | "warning" | "critical"
  ipAddress String?
  userAgent String?
  metadata  Json? // Datos adicionales del evento
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@map("security_events")
}

// ============================================================================
// SISTEMA DE VENTAS EMPRESARIAL
// ============================================================================

// Enums de Ventas
enum QuoteStatus {
  BORRADOR
  PENDIENTE_APROBACION
  APROBADA
  ENVIADA
  EN_NEGOCIACION
  ACEPTADA
  CONVERTIDA
  PERDIDA
  VENCIDA
  CANCELADA
}

// Tipo de documento de cotización
enum QuoteType {
  COTIZACION // Cotización tradicional con negociación
  NOTA_PEDIDO // Nota de pedido directa (el cliente ya decidió)
}

enum SaleStatus {
  BORRADOR
  PENDIENTE_APROBACION
  APROBADA
  CONFIRMADA
  EN_PREPARACION
  PARCIALMENTE_ENTREGADA
  ENTREGADA
  FACTURADA
  COMPLETADA
  CANCELADA
}

enum DeliveryStatus {
  PENDIENTE
  EN_PREPARACION
  LISTA_PARA_DESPACHO
  EN_TRANSITO
  RETIRADA
  ENTREGADA
  ENTREGA_FALLIDA
  CANCELADA
}

enum RemitoStatus {
  BORRADOR
  EMITIDO
  ANULADO
}

enum LoadOrderStatus {
  PENDIENTE
  CARGANDO
  CARGADA
  DESPACHADA
  CANCELADA
}

enum SalesInvoiceType {
  A
  B
  C
  M
  E // Exportación
}

enum SalesInvoiceStatus {
  BORRADOR
  EMITIDA
  ENVIADA
  PARCIALMENTE_COBRADA
  COBRADA
  VENCIDA
  ANULADA
}

enum AFIPStatus {
  PENDIENTE
  PROCESANDO
  APROBADO
  RECHAZADO
  ERROR
}

enum SalesCreditDebitType {
  NOTA_CREDITO
  NOTA_DEBITO
}

// CreditDebitNoteStatus ya definido arriba - eliminado duplicado

enum ClientPaymentStatus {
  PENDIENTE
  CONFIRMADO
  RECHAZADO
  ANULADO
}

enum ChequeStatus {
  CARTERA
  DEPOSITADO
  COBRADO
  RECHAZADO
  ENDOSADO
  ANULADO
}

enum ClientMovementType {
  FACTURA
  NOTA_CREDITO
  NOTA_DEBITO
  PAGO
  ANTICIPO
  AJUSTE
  ANULACION
  RECHAZO
}

enum SalesApprovalType {
  DESCUENTO
  CREDITO
  PRECIO_ESPECIAL
  MONTO_ALTO
  PLAZO_PAGO
}

enum SalesApprovalStatus {
  PENDIENTE
  APROBADA
  RECHAZADA
  ESCALADA
}

// ===== SISTEMA DE MÓDULOS POR EMPRESA =====

enum ModuleCategory {
  VENTAS
  COMPRAS
  MANTENIMIENTO
  COSTOS
  ADMINISTRACION
  GENERAL
}

// ===== SISTEMA DE ACOPIOS =====

enum SaleConditionType {
  FORMAL // T1: 100% facturado
  INFORMAL // T2: 100% remito sin factura
  MIXTO // T3: % configurable
}

enum SettlementPeriod {
  SEMANAL
  QUINCENAL
  MENSUAL
}

enum AcopioStatus {
  ACTIVO
  PARCIAL
  RETIRADO
  VENCIDO
  CANCELADO
}

// Configuración del Módulo de Ventas
model SalesConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Numeración automática
  quotePrefix        String @default("COT") @db.VarChar(10)
  quoteNextNumber    Int    @default(1)
  salePrefix         String @default("VTA") @db.VarChar(10)
  saleNextNumber     Int    @default(1)
  deliveryPrefix     String @default("ENT") @db.VarChar(10)
  deliveryNextNumber Int    @default(1)
  remitoPrefix       String @default("REM") @db.VarChar(10)
  remitoNextNumber   Int    @default(1)
  invoicePrefix      String @default("FA") @db.VarChar(10)
  paymentPrefix      String @default("REC") @db.VarChar(10)
  paymentNextNumber  Int    @default(1)

  // Punto de venta para facturas
  puntoVenta         String @default("0001") @db.VarChar(5)
  invoiceNextNumberA Int    @default(1)
  invoiceNextNumberB Int    @default(1)
  invoiceNextNumberC Int    @default(1)

  // Aprobaciones
  requiereAprobacionCotizacion Boolean  @default(false)
  montoMinimoAprobacionCot     Decimal? @db.Decimal(15, 2)
  requiereAprobacionDescuento  Boolean  @default(true)
  maxDescuentoSinAprobacion    Decimal  @default(10) @db.Decimal(5, 2)

  // Crédito
  validarLimiteCredito    Boolean @default(true)
  bloquearVentaSinCredito Boolean @default(false)
  diasVencimientoDefault  Int     @default(30)

  // Stock
  validarStockDisponible         Boolean @default(true)
  permitirVentaSinStock          Boolean @default(true) // Alertas pero flexible
  reservarStockEnCotizacion      Boolean @default(false)
  decrementarStockEnConfirmacion Boolean @default(true) @map("decrementar_stock_en_confirmacion") // Decrementar stock al confirmar orden

  // Márgenes
  margenMinimoPermitido Decimal @default(10) @db.Decimal(5, 2)
  alertarMargenBajo     Boolean @default(true)

  // Método de Pricing
  pricingMethod       String  @default("LIST") @db.VarChar(20) // LIST, MARGIN, DISCOUNT
  showCostsInQuotes   Boolean @default(false) // Mostrar costos en cotizaciones
  showMarginsInQuotes Boolean @default(false) // Mostrar márgenes en cotizaciones

  // Comisiones
  comisionVendedorDefault Decimal @default(0) @db.Decimal(5, 2)

  // IVA
  tasaIvaDefault Decimal @default(21) @db.Decimal(5, 2)

  // Validez cotización
  diasValidezCotizacion Int @default(30)

  // ═══════════════════════════════════════════════════════════════════════
  // IMPUESTOS Y PERCEPCIONES
  // ═══════════════════════════════════════════════════════════════════════

  // Alícuotas IVA permitidas (JSON array)
  ivaRates Json @default("[21, 10.5, 27, 0]") @map("iva_rates")

  // Percepciones
  percepcionIvaHabilitada  Boolean  @default(false) @map("percepcion_iva_habilitada")
  percepcionIvaTasa        Decimal? @map("percepcion_iva_tasa") @db.Decimal(5, 2)
  percepcionIIBBHabilitada Boolean  @default(false) @map("percepcion_iibb_habilitada")
  percepcionIIBBTasa       Decimal? @map("percepcion_iibb_tasa") @db.Decimal(5, 2)

  // ═══════════════════════════════════════════════════════════════════════
  // VENCIMIENTOS Y PLAZOS
  // ═══════════════════════════════════════════════════════════════════════

  // Facturas
  diasVencimientoFacturaDefault Int @default(30) @map("dias_vencimiento_factura_default")
  diasRecordatorioFactura       Int @default(5) @map("dias_recordatorio_factura")

  // ═══════════════════════════════════════════════════════════════════════
  // CRÉDITO AVANZADO
  // ═══════════════════════════════════════════════════════════════════════

  // Bloqueo por mora
  enableBlockByOverdue Boolean @default(false) @map("enable_block_by_overdue")
  overdueGraceDays     Int     @default(0) @map("overdue_grace_days")

  // Aging (envejecimiento de deuda)
  enableAging  Boolean @default(true) @map("enable_aging")
  agingBuckets Json    @default("[30, 60, 90, 120]") @map("aging_buckets")

  // Alertas de crédito
  creditAlertThreshold Decimal @default(80) @map("credit_alert_threshold") @db.Decimal(5, 2)

  // Límite de cheques
  enableCheckLimit  Boolean  @default(true) @map("enable_check_limit")
  defaultCheckLimit Decimal? @map("default_check_limit") @db.Decimal(15, 2)

  // ═══════════════════════════════════════════════════════════════════════
  // MÁRGENES Y APROBACIONES AVANZADAS
  // ═══════════════════════════════════════════════════════════════════════

  marginRequiresApproval  Boolean  @default(false) @map("margin_requires_approval")
  marginApprovalThreshold Decimal? @map("margin_approval_threshold") @db.Decimal(5, 2)

  // ═══════════════════════════════════════════════════════════════════════
  // MONEDAS
  // ═══════════════════════════════════════════════════════════════════════

  monedasHabilitadas  Json    @default("[\"ARS\", \"USD\"]") @map("monedas_habilitadas")
  monedaPrincipal     String  @default("ARS") @map("moneda_principal") @db.VarChar(10)
  permiteCambioMoneda Boolean @default(true) @map("permite_cambio_moneda")

  // ═══════════════════════════════════════════════════════════════════════
  // DESCUENTOS AVANZADOS
  // ═══════════════════════════════════════════════════════════════════════

  descuentoMaximoAutomatico    Decimal @default(5) @map("descuento_maximo_automatico") @db.Decimal(5, 2)
  descuentoMaximoConAprobacion Decimal @default(20) @map("descuento_maximo_con_aprobacion") @db.Decimal(5, 2)

  // ═══════════════════════════════════════════════════════════════════════
  // CONFIGURACIÓN DE PRODUCTOS
  // ═══════════════════════════════════════════════════════════════════════

  // Modo de actualización de costos: MANUAL, AUTO, WEIGHTED_AVG
  productCostUpdateMode    String   @default("MANUAL") @map("product_cost_update_mode") @db.VarChar(20)
  marginMinRequiredForSale Decimal? @map("margin_min_required_for_sale") @db.Decimal(5, 2)
  showCostInProductList    Boolean  @default(false) @map("show_cost_in_product_list")
  requireProductCodeUnique Boolean  @default(true) @map("require_product_code_unique")

  // ═══════════════════════════════════════════════════════════════════════
  // LOGÍSTICA Y TURNOS
  // ═══════════════════════════════════════════════════════════════════════

  turnoCapacidadMaximaDefault Int     @default(1) @map("turno_capacidad_maxima_default")
  turnoHoraInicioDefault      String  @default("08:00") @map("turno_hora_inicio_default") @db.VarChar(5)
  turnoHoraFinDefault         String  @default("18:00") @map("turno_hora_fin_default") @db.VarChar(5)
  rutaMaxParadas              Int     @default(15) @map("ruta_max_paradas")
  rutaMaxDistanciaKm          Decimal @default(5) @map("ruta_max_distancia_km") @db.Decimal(10, 2)

  // Portal del Cliente
  portalEnabled              Boolean  @default(false)
  portalShowStock            Boolean  @default(false)
  portalShowOriginalPrice    Boolean  @default(true)
  portalAutoApproveOrders    Boolean  @default(false)
  portalOrderMinAmount       Decimal? @db.Decimal(15, 2)
  portalSessionDays          Int      @default(7)
  portalInviteExpiryHours    Int      @default(48)
  portalWelcomeMessage       String?
  portalNotifyEmails         String?
  portalRequireApprovalAbove Decimal? @db.Decimal(15, 2)

  // Acopios
  habilitarAcopios             Boolean @default(true)
  acopioPrefix                 String  @default("ACO") @db.VarChar(10)
  acopioNextNumber             Int     @default(1)
  retiroPrefix                 String  @default("RET") @db.VarChar(10)
  retiroNextNumber             Int     @default(1)
  diasAlertaAcopioDefault      Int     @default(30) // Días antes de vencer para alertar
  diasVencimientoAcopioDefault Int     @default(90) // Días hasta vencimiento
  bloquearVentaAcopioExcedido  Boolean @default(false)
  alertarAcopioExcedido        Boolean @default(true)

  // ═══════════════════════════════════════════════════════════════════════
  // CONFIGURACIÓN DEL FORMULARIO DE CLIENTES (módulos habilitados)
  // ═══════════════════════════════════════════════════════════════════════
  // Campos habilitados por la empresa (JSON con keys de los campos)
  // Ejemplo: {"whatsapp": true, "visitDays": true, "taxExemptions": false}
  clientFormEnabledFields Json @default("{}")

  // Límite máximo de funcionalidades que puede habilitar (definido por superadmin)
  // null = sin límite (puede habilitar todas)
  maxClientFormFeatures Int?

  // Product form customization
  productFormEnabledFields Json @default("{}")
  maxProductFormFeatures   Int?

  // ═══════════════════════════════════════════════════════════════════════
  // WORKFLOW CONFIGURATION - Customizable per company
  // ═══════════════════════════════════════════════════════════════════════

  // Payment approval workflow
  requiereAprobacionPagos            Boolean  @default(false) @map("requiere_aprobacion_pagos")
  requiereAprobacionPagosMontoMinimo Decimal? @map("requiere_aprobacion_pagos_monto_minimo") @db.Decimal(15, 2)
  aprobacionPagosTiposRequieren      String?  @map("aprobacion_pagos_tipos_requieren") // JSON array: ["CHEQUE","ECHEQ"]

  // Invoice approval workflow
  requiereAprobacionFacturas            Boolean  @default(false) @map("requiere_aprobacion_facturas")
  requiereAprobacionFacturasMontoMinimo Decimal? @map("requiere_aprobacion_facturas_monto_minimo") @db.Decimal(15, 2)

  // Sales order confirmation
  requiereConfirmacionOrden Boolean @default(true) @map("requiere_confirmacion_orden")
  permitirOrdenSinStock     Boolean @default(true) @map("permitir_orden_sin_stock")
  permitirOrdenSinCredito   Boolean @default(false) @map("permitir_orden_sin_credito")

  // Notification settings
  notificarNuevaCotizacion   Boolean @default(true) @map("notificar_nueva_cotizacion")
  notificarOrdenConfirmada   Boolean @default(true) @map("notificar_orden_confirmada")
  notificarEntregaProgramada Boolean @default(true) @map("notificar_entrega_programada")
  notificarFacturaEmitida    Boolean @default(true) @map("notificar_factura_emitida")
  notificarPagoRecibido      Boolean @default(true) @map("notificar_pago_recibido")
  emailsNotificaciones       String? @map("emails_notificaciones") // Comma-separated

  // ═══════════════════════════════════════════════════════════════════════
  // SMART COLLECTIONS - AI-powered collection reminders
  // ═══════════════════════════════════════════════════════════════════════
  enableCollectionReminders  Boolean @default(false) @map("enable_collection_reminders")
  reminderDaysBefore         Int     @default(3) @map("reminder_days_before") // Days before due date to send first reminder
  reminderEscalationDays     Int     @default(7) @map("reminder_escalation_days") // Days between escalation reminders
  enableSmartCollections     Boolean @default(false) @map("enable_smart_collections")
  enablePaymentAnomalyDetect Boolean @default(false) @map("enable_payment_anomaly_detect")

  // Module enablement (some companies may not use all modules)
  moduloCotizacionesHabilitado Boolean @default(true) @map("modulo_cotizaciones_habilitado")
  moduloOrdenesHabilitado      Boolean @default(true) @map("modulo_ordenes_habilitado")
  moduloEntregasHabilitado     Boolean @default(true) @map("modulo_entregas_habilitado")
  moduloFacturasHabilitado     Boolean @default(true) @map("modulo_facturas_habilitado")
  moduloCobranzasHabilitado    Boolean @default(true) @map("modulo_cobranzas_habilitado")
  moduloRemitosHabilitado      Boolean @default(true) @map("modulo_remitos_habilitado")
  moduloNotasCreditoHabilitado Boolean @default(true) @map("modulo_notas_credito_habilitado")
  moduloTurnosHabilitado       Boolean @default(false) @map("modulo_turnos_habilitado")
  moduloDisputasHabilitado     Boolean @default(false) @map("modulo_disputas_habilitado")
  moduloValoresHabilitado      Boolean @default(true) @map("modulo_valores_habilitado")

  // Delivery/logistics requirements
  requiereConductorEnDespacho Boolean @default(false) @map("requiere_conductor_en_despacho")
  requiereVehiculoEnDespacho  Boolean @default(false) @map("requiere_vehiculo_en_despacho")
  requiereEvidenciaEntrega    Boolean @default(false) @map("requiere_evidencia_entrega")

  // ═══════════════════════════════════════════════════════════════════════
  // DELIVERY ADVANCED CONFIGURATION
  // ═══════════════════════════════════════════════════════════════════════

  // SLA (Service Level Agreements) - Max hours per stage
  deliverySlaPreparacionMaxHoras Int @default(24) @map("delivery_sla_preparacion_max_horas")
  deliverySlaTransitoMaxHoras    Int @default(48) @map("delivery_sla_transito_max_horas")
  deliverySlaAlertaRetrasoHoras  Int @default(2) @map("delivery_sla_alerta_retraso_horas")

  // Notification Templates (customizable messages)
  deliveryNotificationTemplates Json @default("{\"dispatched\": \"¡Tu pedido #{deliveryNumber} está en camino! 🚚\\nConductor: {driverName}\\nTracking: {trackingLink}\", \"delivered\": \"✅ Tu pedido #{deliveryNumber} ha sido entregado.\\n¡Gracias por tu compra!\", \"failed\": \"⚠️ No pudimos entregar tu pedido #{deliveryNumber}.\\nMotivo: {reason}\\nNos contactaremos pronto.\", \"retry\": \"🔄 Reintentaremos la entrega de tu pedido #{deliveryNumber}.\\nNueva fecha: {newDate}\"}") @map("delivery_notification_templates")

  // Workflow Customization
  deliveryOptionalStates  Json    @default("[]") @map("delivery_optional_states") // States that can be skipped
  permitirEntregaSinOrden Boolean @default(false) @map("permitir_entrega_sin_orden")
  deliveryTipoDefault     String  @default("ENVIO") @map("delivery_tipo_default") @db.VarChar(10) // ENVIO or RETIRO

  // Evidence Requirements
  requiereFirmaCliente Boolean @default(false) @map("requiere_firma_cliente")
  requiereFotoEntrega  Boolean @default(false) @map("requiere_foto_entrega")
  requiereDniReceptor  Boolean @default(false) @map("requiere_dni_receptor")

  // Cost Configuration
  costoFleteDefault       Decimal @default(0) @map("costo_flete_default") @db.Decimal(15, 2)
  calcularFleteAutomatico Boolean @default(false) @map("calcular_flete_automatico")

  // Document mandatory fields (JSON arrays)
  camposObligatoriosCotizacion String? @map("campos_obligatorios_cotizacion")
  camposObligatoriosOrden      String? @map("campos_obligatorios_orden")
  camposObligatoriosFactura    String? @map("campos_obligatorios_factura")

  // Enforcement levels
  nivelEnforcementCredito String @default("WARNING") @map("nivel_enforcement_credito") @db.VarChar(20) // STRICT, WARNING, DISABLED
  nivelEnforcementStock   String @default("WARNING") @map("nivel_enforcement_stock") @db.VarChar(20) // STRICT, WARNING, DISABLED

  // ═══════════════════════════════════════════════════════════════════════
  // NOTIFICATION TEMPLATES (WhatsApp/Email customizable per company)
  // ═══════════════════════════════════════════════════════════════════════
  quoteNotificationTemplates      Json @default("{}") @map("quote_notification_templates")
  orderNotificationTemplates      Json @default("{}") @map("order_notification_templates")
  invoiceNotificationTemplates    Json @default("{}") @map("invoice_notification_templates")
  paymentNotificationTemplates    Json @default("{}") @map("payment_notification_templates")
  collectionNotificationTemplates Json @default("{}") @map("collection_notification_templates")

  // ═══════════════════════════════════════════════════════════════════════
  // ADVANCED PRICING & DISCOUNTS
  // ═══════════════════════════════════════════════════════════════════════
  discountTiers Json @default("[]") @map("discount_tiers")
  // Format: [{"minAmount": 10000, "discountPercent": 5}, {"minAmount": 50000, "discountPercent": 8}]

  // ═══════════════════════════════════════════════════════════════════════
  // COMMISSION CONFIGURATION
  // ═══════════════════════════════════════════════════════════════════════
  commissionConfig Json @default("{}") @map("commission_config")
  // Types: FLAT, TIERED, BY_CATEGORY, BY_PRODUCT, MIXED

  // ═══════════════════════════════════════════════════════════════════════
  // DOCUMENT NUMBERING FORMAT
  // ═══════════════════════════════════════════════════════════════════════
  numberFormatConfig Json @default("{}") @map("number_format_config")
  // Allows: {prefix}-{number}, {prefix}-{year}-{number}, {prefix}-{year}{month}-{number}

  // ═══════════════════════════════════════════════════════════════════════
  // QUOTE FOLLOW-UP AUTOMATION
  // ═══════════════════════════════════════════════════════════════════════
  quoteFollowupConfig Json @default("{}") @map("quote_followup_config")
  // Config: {enabled, firstReminderDays, secondReminderDays, autoCloseAfterDays}

  // ═══════════════════════════════════════════════════════════════════════
  // CUSTOMER SEGMENT PRICING
  // ═══════════════════════════════════════════════════════════════════════
  segmentPricingConfig Json @default("{}") @map("segment_pricing_config")
  // Config: {enabled, segments: [{id, name, priceListId, discountPercent}]}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("sales_config")
}

// Cotización (Quote)
model Quote {
  id        Int         @id @default(autoincrement())
  numero    String      @db.VarChar(50)
  clientId  String
  sellerId  Int?
  estado    QuoteStatus @default(BORRADOR)
  quoteType QuoteType   @default(COTIZACION)

  // Fechas
  fechaEmision DateTime  @db.Date
  fechaValidez DateTime  @db.Date
  fechaEnvio   DateTime?
  fechaCierre  DateTime?

  // Montos
  subtotal        Decimal  @db.Decimal(15, 2)
  descuentoGlobal Decimal  @default(0) @db.Decimal(5, 2)
  descuentoMonto  Decimal  @default(0) @db.Decimal(15, 2)
  tasaIva         Decimal  @default(21) @db.Decimal(5, 2)
  impuestos       Decimal  @default(0) @db.Decimal(15, 2)
  total           Decimal  @db.Decimal(15, 2)
  moneda          String   @default("ARS") @db.VarChar(10)
  tipoCambio      Decimal? @db.Decimal(15, 4)

  // Condiciones
  condicionesPago    String? @db.VarChar(255)
  diasPlazo          Int?
  condicionesEntrega String? @db.VarChar(255)
  tiempoEntrega      String? @db.VarChar(100)
  lugarEntrega       String?

  // Descripción y Notas
  titulo        String? @db.VarChar(255)
  descripcion   String?
  notas         String?
  notasInternas String?

  // Aprobación
  requiereAprobacion Boolean   @default(false)
  aprobadoPor        Int?
  aprobadoAt         DateTime?

  // Cierre
  motivoPerdida     String?
  competidorGanador String?
  precioCompetidor  Decimal? @db.Decimal(15, 2)

  // Conversión
  convertidaAVentaId Int?
  convertidaAt       DateTime?

  // Vencimiento
  isExpired Boolean @default(false)

  // Versionado
  version Int @default(1)

  // Costos y Rentabilidad (solo visible con permiso)
  costoTotal       Decimal? @db.Decimal(15, 2)
  margenBruto      Decimal? @db.Decimal(15, 2)
  margenPorcentaje Decimal? @db.Decimal(5, 2)

  // Comisión
  comisionPorcentaje Decimal? @db.Decimal(5, 2)
  comisionMonto      Decimal? @db.Decimal(15, 2)

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  client         Client               @relation(fields: [clientId], references: [id])
  seller         User?                @relation("QuoteSeller", fields: [sellerId], references: [id])
  company        Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser  User                 @relation("QuoteCreatedBy", fields: [createdBy], references: [id])
  aprobadoByUser User?                @relation("QuoteApprovedBy", fields: [aprobadoPor], references: [id])
  items          QuoteItem[]
  attachments    QuoteAttachment[]
  versions       QuoteVersion[]
  sale           Sale?                @relation("SaleFromQuote")
  approvals      SalesApproval[]      @relation("QuoteApprovals")
  acceptance     QuoteAcceptance?
  portalAccess   ClientPortalAccess[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([clientId])
  @@index([sellerId])
  @@index([estado])
  @@index([fechaEmision])
  @@index([fechaValidez])
  @@index([docType])
  @@index([companyId, docType])
  @@index([companyId, docType, fechaEmision])
  @@index([quoteType])
  @@index([companyId, quoteType])
  // Índices para stats y dashboard
  @@index([companyId, estado, createdAt])
  @@index([companyId, fechaValidez])
  @@index([companyId, clientId, createdAt])
  @@index([companyId, sellerId, createdAt])
  @@index([companyId, isExpired])
  @@map("quotes")
}

model QuoteItem {
  id             Int      @id @default(autoincrement())
  quoteId        Int
  productId      String?
  codigo         String?  @db.VarChar(50)
  descripcion    String   @db.VarChar(500)
  cantidad       Decimal  @db.Decimal(15, 4)
  unidad         String   @db.VarChar(50)
  precioUnitario Decimal  @db.Decimal(15, 2)
  descuento      Decimal  @default(0) @db.Decimal(5, 2)
  subtotal       Decimal  @db.Decimal(15, 2)
  costoUnitario  Decimal? @db.Decimal(15, 2)
  margenItem     Decimal? @db.Decimal(5, 2)
  notas          String?
  orden          Int      @default(0)

  quote   Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([quoteId])
  @@index([productId])
  @@map("quote_items")
}

model QuoteAttachment {
  id        Int      @id @default(autoincrement())
  quoteId   Int
  nombre    String   @db.VarChar(255)
  url       String
  tipo      String   @db.VarChar(50)
  tamanio   Int?
  createdAt DateTime @default(now())

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_attachments")
}

model QuoteVersion {
  id        Int      @id @default(autoincrement())
  quoteId   Int
  version   Int
  datos     Json
  motivo    String?
  createdBy Int
  createdAt DateTime @default(now())

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [createdBy], references: [id])

  @@index([quoteId])
  @@map("quote_versions")
}

// Portal Cliente - Aceptación de Cotizaciones
model ClientPortalAccess {
  id        Int       @id @default(autoincrement())
  clientId  String
  quoteId   Int?
  token     String    @unique @db.VarChar(100)
  expiresAt DateTime
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quote  Quote? @relation(fields: [quoteId], references: [id])

  @@index([token])
  @@index([clientId])
  @@index([expiresAt])
  @@map("client_portal_access")
}

// =====================================================
// PORTAL DEL CLIENTE - Sistema de Autenticación
// =====================================================

// Estado de pedidos del portal
enum PortalOrderStatus {
  PENDIENTE
  EN_REVISION
  CONFIRMADO
  RECHAZADO
  CONVERTIDO
  CANCELADO
}

// Acciones de actividad del portal
enum PortalActivityAction {
  LOGIN
  LOGOUT
  VIEW_PRICES
  VIEW_QUOTE
  ACCEPT_QUOTE
  REJECT_QUOTE
  CREATE_ORDER
  CANCEL_ORDER
  VIEW_DOCUMENT
  DOWNLOAD_PDF
  CHANGE_PASSWORD
}

// Contactos del Cliente (personas reales)
model ClientContact {
  id        String @id @default(cuid())
  clientId  String
  companyId Int

  // Datos personales
  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  email     String  @db.VarChar(255)
  phone     String? @db.VarChar(50)
  whatsapp  String? @db.VarChar(50)
  position  String? @db.VarChar(100)

  // Estado
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  notes     String?

  // Relaciones
  client     Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company    Company           @relation(fields: [companyId], references: [id])
  portalUser ClientPortalUser?

  @@unique([clientId, email])
  @@index([clientId])
  @@index([companyId])
  @@index([email])
  @@map("client_contacts")
}

// Usuarios del Portal (credenciales)
model ClientPortalUser {
  id        String @id @default(cuid())
  contactId String @unique
  clientId  String
  companyId Int

  // Credenciales
  email        String @db.VarChar(255)
  passwordHash String @db.VarChar(255)

  // Estado de la cuenta
  isActive    Boolean   @default(true)
  isVerified  Boolean   @default(false)
  activatedAt DateTime?

  // Seguridad
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?   @db.VarChar(50)

  // Permisos
  canViewPrices    Boolean @default(true)
  canViewQuotes    Boolean @default(true)
  canAcceptQuotes  Boolean @default(true)
  canCreateOrders  Boolean @default(true)
  canViewHistory   Boolean @default(true)
  canViewDocuments Boolean @default(true)

  // Límites
  maxOrderAmount        Decimal? @db.Decimal(15, 2)
  requiresApprovalAbove Decimal? @db.Decimal(15, 2)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int?

  // Relaciones
  contact        ClientContact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  client         Client                 @relation(fields: [clientId], references: [id])
  company        Company                @relation(fields: [companyId], references: [id])
  sessions       ClientPortalSession[]
  activities     ClientPortalActivity[]
  invites        ClientPortalInvite[]
  acceptedQuotes QuoteAcceptance[]
  orders         ClientPortalOrder[]

  @@unique([companyId, email])
  @@index([clientId])
  @@index([companyId])
  @@index([email])
  @@map("client_portal_users")
}

// Invitaciones al Portal (tokens de activación)
model ClientPortalInvite {
  id           String @id @default(cuid())
  token        String @unique @db.VarChar(100)
  portalUserId String
  companyId    Int

  // Vigencia
  expiresAt DateTime
  usedAt    DateTime?

  // Tracking
  createdAt DateTime @default(now())
  createdBy Int
  sentVia   String?  @db.VarChar(20)

  // Relaciones
  portalUser ClientPortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)
  company    Company          @relation(fields: [companyId], references: [id])

  @@index([token])
  @@index([portalUserId])
  @@index([expiresAt])
  @@map("client_portal_invites")
}

// Sesiones del Portal
model ClientPortalSession {
  id           String @id @default(cuid())
  portalUserId String
  companyId    Int

  // Token de sesión (hash)
  tokenHash String @unique @db.VarChar(255)

  // Vigencia
  expiresAt DateTime
  isActive  Boolean  @default(true)

  // Tracking
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  ipAddress      String?  @db.VarChar(50)
  userAgent      String?

  // Relaciones
  portalUser ClientPortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)
  company    Company          @relation(fields: [companyId], references: [id])

  @@index([tokenHash])
  @@index([portalUserId])
  @@index([expiresAt])
  @@map("client_portal_sessions")
}

// Pedidos del Portal
model ClientPortalOrder {
  id              String @id @default(cuid())
  numero          String @db.VarChar(50)
  clientId        String
  companyId       Int
  createdByUserId String

  // Anti-duplicados
  clientRequestId String @unique @db.VarChar(100)

  // Referencia a cotización
  quoteId Int?

  // Estado
  estado PortalOrderStatus @default(PENDIENTE)

  // Datos del pedido
  subtotal Decimal @db.Decimal(15, 2)
  total    Decimal @db.Decimal(15, 2)
  moneda   String  @default("ARS") @db.VarChar(10)

  // Notas
  notasCliente String?

  // Datos de entrega
  direccionEntrega       String?
  fechaEntregaSolicitada DateTime?

  // Tracking
  createdAt DateTime @default(now())
  ipAddress String?  @db.VarChar(50)
  userAgent String?

  // Procesamiento
  processedAt     DateTime?
  processedBy     Int?
  processNotes    String?
  rejectionReason String?

  // Conversión
  convertedToQuoteId Int?
  convertedToSaleId  Int?
  convertedAt        DateTime?

  // Relaciones
  client        Client                  @relation(fields: [clientId], references: [id])
  company       Company                 @relation(fields: [companyId], references: [id])
  createdByUser ClientPortalUser        @relation(fields: [createdByUserId], references: [id])
  items         ClientPortalOrderItem[]

  @@index([companyId])
  @@index([clientId])
  @@index([estado])
  @@index([createdAt])
  @@map("client_portal_orders")
}

// Items de Pedidos del Portal
model ClientPortalOrderItem {
  id             String  @id @default(cuid())
  orderId        String
  productId      String
  descripcion    String  @db.VarChar(500)
  cantidad       Decimal @db.Decimal(15, 4)
  unidad         String  @db.VarChar(50)
  precioUnitario Decimal @db.Decimal(15, 2)
  subtotal       Decimal @db.Decimal(15, 2)
  notas          String?

  // Relaciones
  order   ClientPortalOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product           @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("client_portal_order_items")
}

// Log de Actividad del Portal
model ClientPortalActivity {
  id           String @id @default(cuid())
  portalUserId String
  clientId     String
  companyId    Int

  // Acción realizada
  action PortalActivityAction

  // Entidad relacionada
  entityType String? @db.VarChar(50)
  entityId   String?

  // Detalles adicionales
  details Json?

  // Tracking
  ipAddress String?  @db.VarChar(50)
  userAgent String?
  createdAt DateTime @default(now())

  // Relaciones
  portalUser ClientPortalUser @relation(fields: [portalUserId], references: [id])

  @@index([portalUserId])
  @@index([clientId])
  @@index([companyId])
  @@index([action])
  @@index([createdAt])
  @@map("client_portal_activity")
}

// =====================================================
// FIN PORTAL DEL CLIENTE
// =====================================================

model QuoteAcceptance {
  id      Int @id @default(autoincrement())
  quoteId Int @unique

  // Quién aceptó (Portal)
  acceptedByUserId    String?
  acceptedByContactId String?

  // Qué versión aceptó (inmutable)
  quoteVersionId Int?
  pdfHash        String? @db.VarChar(64)

  // Datos de aceptación
  aceptadoAt      DateTime @default(now())
  ipAddress       String?  @db.VarChar(50)
  userAgent       String?
  firmaDigital    String?
  nombreFirmante  String?  @db.VarChar(255)
  dniCuitFirmante String?  @db.VarChar(20)
  observaciones   String?

  // Relaciones
  quote          Quote             @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  acceptedByUser ClientPortalUser? @relation(fields: [acceptedByUserId], references: [id])

  @@map("quote_acceptances")
}

// Orden de Venta (Sale)
model Sale {
  id       Int        @id @default(autoincrement())
  numero   String     @db.VarChar(50)
  clientId String
  sellerId Int?
  quoteId  Int?       @unique
  estado   SaleStatus @default(BORRADOR)

  // Fechas
  fechaEmision         DateTime  @db.Date
  fechaEntregaEstimada DateTime? @db.Date
  fechaEntregaReal     DateTime? @db.Date

  // Montos
  subtotal        Decimal @db.Decimal(15, 2)
  descuentoGlobal Decimal @default(0) @db.Decimal(5, 2)
  descuentoMonto  Decimal @default(0) @db.Decimal(15, 2)
  tasaIva         Decimal @default(21) @db.Decimal(5, 2)
  impuestos       Decimal @default(0) @db.Decimal(15, 2)
  total           Decimal @db.Decimal(15, 2)
  moneda          String  @default("ARS") @db.VarChar(10)

  // Condiciones
  condicionesPago String? @db.VarChar(255)
  diasPlazo       Int?
  lugarEntrega    String?

  // Notas
  notas         String?
  notasInternas String?

  // Aprobación
  requiereAprobacion Boolean   @default(false)
  aprobadoPor        Int?
  aprobadoAt         DateTime?

  // Comisión
  comisionPorcentaje Decimal?  @db.Decimal(5, 2)
  comisionMonto      Decimal?  @db.Decimal(15, 2)
  comisionPagada     Boolean   @default(false)
  comisionPagadaAt   DateTime?

  // Rentabilidad (solo visible con permiso)
  costoTotal       Decimal? @db.Decimal(15, 2)
  margenBruto      Decimal? @db.Decimal(15, 2)
  margenPorcentaje Decimal? @db.Decimal(5, 2)

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  client         Client          @relation(fields: [clientId], references: [id])
  seller         User?           @relation("SaleSeller", fields: [sellerId], references: [id])
  quote          Quote?          @relation("SaleFromQuote", fields: [quoteId], references: [id])
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser  User            @relation("SaleCreatedBy", fields: [createdBy], references: [id])
  aprobadoByUser User?           @relation("SaleApprovedBy", fields: [aprobadoPor], references: [id])
  items          SaleItem[]
  deliveries     SaleDelivery[]
  loadOrders     LoadOrder[]
  remitos        SaleRemito[]
  invoices       SalesInvoice[]
  approvals      SalesApproval[] @relation("SaleApprovals")
  acopios        SaleAcopio[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([clientId])
  @@index([sellerId])
  @@index([estado])
  @@index([fechaEmision])
  @@index([docType])
  @@index([companyId, docType])
  @@index([companyId, docType, fechaEmision])
  // Additional compound indexes for report queries
  @@index([companyId, clientId, docType])
  @@index([companyId, sellerId, docType])
  @@index([clientId, estado])
  @@map("sales")
}

model SaleItem {
  id                Int      @id @default(autoincrement())
  saleId            Int
  productId         String?
  codigo            String?  @db.VarChar(50)
  descripcion       String   @db.VarChar(500)
  cantidad          Decimal  @db.Decimal(15, 4)
  cantidadEntregada Decimal  @default(0) @db.Decimal(15, 4)
  cantidadPendiente Decimal  @db.Decimal(15, 4)
  unidad            String   @db.VarChar(50)
  precioUnitario    Decimal  @db.Decimal(15, 2)
  descuento         Decimal  @default(0) @db.Decimal(5, 2)
  subtotal          Decimal  @db.Decimal(15, 2)
  costoUnitario     Decimal? @db.Decimal(15, 2)
  notas             String?
  orden             Int      @default(0)

  sale           Sale               @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product        Product?           @relation(fields: [productId], references: [id])
  deliveryItems  SaleDeliveryItem[]
  loadOrderItems LoadOrderItem[]
  remitoItems    SaleRemitoItem[]
  invoiceItems   SalesInvoiceItem[]

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

// Entrega FÍSICA (SaleDelivery)
model SaleDelivery {
  id       Int            @id @default(autoincrement())
  numero   String         @db.VarChar(50)
  saleId   Int
  clientId String
  estado   DeliveryStatus @default(PENDIENTE)

  // Programación
  fechaProgramada DateTime? @db.Date
  horaProgramada  String?   @db.VarChar(20)
  fechaEntrega    DateTime? @db.Date
  horaEntrega     String?   @db.VarChar(20)

  // Dirección
  direccionEntrega String?

  // Transporte y Costos
  transportista   String?  @db.VarChar(255)
  vehiculo        String?  @db.VarChar(100)
  conductorNombre String?  @db.VarChar(255)
  conductorDNI    String?  @db.VarChar(20)
  costoFlete      Decimal? @db.Decimal(15, 2)
  costoSeguro     Decimal? @db.Decimal(15, 2)
  otrosCostos     Decimal? @db.Decimal(15, 2)

  // Recepción
  recibeNombre   String? @db.VarChar(255)
  recibeDNI      String? @db.VarChar(20)
  firmaRecepcion String?

  // GPS
  latitudEntrega  Decimal? @db.Decimal(10, 8)
  longitudEntrega Decimal? @db.Decimal(11, 8)

  // Notas
  notas                String?
  observacionesEntrega String?

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  sale          Sale                   @relation(fields: [saleId], references: [id])
  client        Client                 @relation(fields: [clientId], references: [id])
  company       Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User                   @relation("DeliveryCreatedBy", fields: [createdBy], references: [id])
  items         SaleDeliveryItem[]
  evidences     SaleDeliveryEvidence[]
  loadOrders    LoadOrder[]
  remitos       SaleRemito[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([saleId])
  @@index([clientId])
  @@index([estado])
  @@index([fechaEntrega])
  @@index([docType])
  @@index([companyId, docType])
  @@map("sale_deliveries")
}

model SaleDeliveryItem {
  id         Int     @id @default(autoincrement())
  deliveryId Int
  saleItemId Int
  productId  String?
  cantidad   Decimal @db.Decimal(15, 4)
  notas      String?

  delivery SaleDelivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  saleItem SaleItem     @relation(fields: [saleItemId], references: [id])
  product  Product?     @relation(fields: [productId], references: [id])

  @@index([deliveryId])
  @@index([saleItemId])
  @@map("sale_delivery_items")
}

model SaleDeliveryEvidence {
  id          Int      @id @default(autoincrement())
  deliveryId  Int
  tipo        String   @db.VarChar(50) // foto, firma, documento
  url         String
  descripcion String?
  createdAt   DateTime @default(now())

  delivery SaleDelivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([deliveryId])
  @@map("sale_delivery_evidences")
}

// Orden de Carga (LoadOrder) - O2C Phase 2
model LoadOrder {
  id         Int             @id @default(autoincrement())
  numero     String          @db.VarChar(50)
  saleId     Int
  deliveryId Int?
  estado     LoadOrderStatus @default(PENDIENTE)

  // Fecha
  fecha DateTime @db.Date

  // Vehículo
  vehiculo        String? @db.VarChar(100)
  vehiculoPatente String? @db.VarChar(20)
  vehiculoTipo    String? @db.VarChar(50) // CAMIONETA, FURGON, CAMION_PEQUEÑO, etc.

  // Conductor
  chofer    String? @db.VarChar(255)
  choferDNI String? @db.VarChar(20)

  // Transportista
  transportista String? @db.VarChar(255)

  // Capacidad calculada
  pesoTotal    Decimal? @db.Decimal(15, 2) // kg
  volumenTotal Decimal? @db.Decimal(15, 4) // m³

  // Notas
  observaciones String?

  // Confirmación
  confirmadoAt  DateTime?
  confirmedById Int?

  // Firma del operario (base64)
  firmaOperario String?

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  sale          Sale            @relation(fields: [saleId], references: [id])
  delivery      SaleDelivery?   @relation(fields: [deliveryId], references: [id])
  company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User            @relation("LoadOrderCreatedBy", fields: [createdBy], references: [id])
  confirmedBy   User?           @relation("LoadOrderConfirmedBy", fields: [confirmedById], references: [id])
  items         LoadOrderItem[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([saleId])
  @@index([deliveryId])
  @@index([estado])
  @@index([fecha])
  @@index([docType])
  @@index([companyId, docType])
  @@map("load_orders")
}

model LoadOrderItem {
  id          Int     @id @default(autoincrement())
  loadOrderId Int
  saleItemId  Int
  productId   String?

  // Cantidades
  cantidad        Decimal  @db.Decimal(15, 4)
  cantidadCargada Decimal? @db.Decimal(15, 4)

  // Dimensiones para auto-acomodo
  pesoUnitario    Decimal? @db.Decimal(15, 4) // kg por unidad
  volumenUnitario Decimal? @db.Decimal(15, 6) // m³ por unidad
  largoUnitario   Decimal? @db.Decimal(10, 3) // metros
  anchoUnitario   Decimal? @db.Decimal(10, 3) // metros
  altoUnitario    Decimal? @db.Decimal(10, 3) // metros

  // Posición en el vehículo (bin packing)
  secuencia Int? // Orden de carga
  posX      Decimal? @db.Decimal(10, 3) // Posición X en metros
  posY      Decimal? @db.Decimal(10, 3) // Posición Y en metros
  posZ      Decimal? @db.Decimal(10, 3) // Posición Z en metros

  // Diferencias
  motivoDiferencia String?

  // Notas
  observaciones String?

  createdAt DateTime @default(now())

  // Relaciones
  loadOrder LoadOrder @relation(fields: [loadOrderId], references: [id], onDelete: Cascade)
  saleItem  SaleItem  @relation(fields: [saleItemId], references: [id])
  product   Product?  @relation(fields: [productId], references: [id])

  @@index([loadOrderId])
  @@index([saleItemId])
  @@index([productId])
  @@map("load_order_items")
}

// Remito FISCAL (SaleRemito)
model SaleRemito {
  id         Int          @id @default(autoincrement())
  numero     String       @db.VarChar(50)
  saleId     Int
  deliveryId Int?
  clientId   String
  estado     RemitoStatus @default(BORRADOR)

  fechaEmision DateTime @db.Date

  // CAI si aplica
  cai         String?   @db.VarChar(20)
  fechaVtoCai DateTime? @db.Date

  notas String?

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  sale          Sale             @relation(fields: [saleId], references: [id])
  delivery      SaleDelivery?    @relation(fields: [deliveryId], references: [id])
  client        Client           @relation(fields: [clientId], references: [id])
  company       Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User             @relation("RemitoCreatedBy", fields: [createdBy], references: [id])
  items         SaleRemitoItem[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([saleId])
  @@index([deliveryId])
  @@index([clientId])
  @@index([estado])
  @@index([docType])
  @@map("sale_remitos")
}

model SaleRemitoItem {
  id         Int     @id @default(autoincrement())
  remitoId   Int
  saleItemId Int
  productId  String?
  cantidad   Decimal @db.Decimal(15, 4)

  remito   SaleRemito @relation(fields: [remitoId], references: [id], onDelete: Cascade)
  saleItem SaleItem   @relation(fields: [saleItemId], references: [id])
  product  Product?   @relation(fields: [productId], references: [id])

  @@index([remitoId])
  @@index([saleItemId])
  @@map("sale_remito_items")
}

// Factura de Venta
model SalesInvoice {
  id             Int              @id @default(autoincrement())
  tipo           SalesInvoiceType
  letra          String           @db.VarChar(1)
  puntoVenta     String           @db.VarChar(5)
  numero         String           @db.VarChar(8)
  numeroCompleto String           @db.VarChar(20)

  clientId String
  saleId   Int?
  estado   SalesInvoiceStatus @default(BORRADOR)

  // Fechas
  fechaEmision       DateTime  @db.Date
  fechaVencimiento   DateTime  @db.Date
  fechaServicioDesde DateTime? @db.Date
  fechaServicioHasta DateTime? @db.Date

  // Montos
  netoGravado    Decimal  @db.Decimal(15, 2)
  netoNoGravado  Decimal  @default(0) @db.Decimal(15, 2)
  exento         Decimal  @default(0) @db.Decimal(15, 2)
  iva21          Decimal  @default(0) @db.Decimal(15, 2)
  iva105         Decimal  @default(0) @db.Decimal(15, 2)
  iva27          Decimal  @default(0) @db.Decimal(15, 2)
  percepcionIVA  Decimal  @default(0) @db.Decimal(15, 2)
  percepcionIIBB Decimal  @default(0) @db.Decimal(15, 2)
  otrosImpuestos Decimal  @default(0) @db.Decimal(15, 2)
  total          Decimal  @db.Decimal(15, 2)
  moneda         String   @default("ARS") @db.VarChar(10)
  tipoCambio     Decimal? @db.Decimal(15, 4)

  // Saldos
  totalCobrado   Decimal @default(0) @db.Decimal(15, 2)
  saldoPendiente Decimal @db.Decimal(15, 2)

  // AFIP (preparado pero no implementado)
  cae         String?     @db.VarChar(20)
  fechaVtoCae DateTime?   @db.Date
  estadoAFIP  AFIPStatus?

  // Condiciones
  condicionesPago String? @db.VarChar(255)

  // Notas
  notas         String?
  notasInternas String?

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  client             Client                     @relation(fields: [clientId], references: [id])
  sale               Sale?                      @relation(fields: [saleId], references: [id])
  company            Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser      User                       @relation("InvoiceCreatedBy", fields: [createdBy], references: [id])
  items              SalesInvoiceItem[]
  paymentAllocations InvoicePaymentAllocation[]
  creditNotes        SalesCreditDebitNote[]     @relation("InvoiceCreditNotes")
  ledgerEntries      ClientLedgerEntry[]
  collectionAttempts CollectionAttempt[]

  @@unique([companyId, tipo, puntoVenta, numero])
  @@index([companyId])
  @@index([clientId])
  @@index([saleId])
  @@index([estado])
  @@index([fechaEmision])
  @@index([fechaVencimiento])
  @@index([cae])
  @@index([docType])
  @@index([companyId, docType])
  @@index([companyId, docType, fechaEmision])
  // Additional compound indexes for report queries
  @@index([companyId, clientId, estado])
  @@index([companyId, estado, saldoPendiente])
  @@index([clientId, estado, fechaVencimiento])
  @@map("sales_invoices")
}

model SalesInvoiceItem {
  id             Int     @id @default(autoincrement())
  invoiceId      Int
  saleItemId     Int?
  productId      String?
  codigo         String? @db.VarChar(50)
  descripcion    String  @db.VarChar(500)
  cantidad       Decimal @db.Decimal(15, 4)
  unidad         String  @db.VarChar(50)
  precioUnitario Decimal @db.Decimal(15, 2)
  descuento      Decimal @default(0) @db.Decimal(5, 2)
  alicuotaIVA    Decimal @default(21) @db.Decimal(5, 2)
  subtotal       Decimal @db.Decimal(15, 2)

  invoice  SalesInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  saleItem SaleItem?    @relation(fields: [saleItemId], references: [id])
  product  Product?     @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@index([saleItemId])
  @@map("sales_invoice_items")
}

// Nota de Crédito/Débito de Ventas
model SalesCreditDebitNote {
  id             Int                  @id @default(autoincrement())
  tipo           SalesCreditDebitType
  letra          String               @db.VarChar(1)
  puntoVenta     String               @db.VarChar(5)
  numero         String               @db.VarChar(8)
  numeroCompleto String               @db.VarChar(20)

  clientId  String
  facturaId Int?
  estado    CreditDebitNoteStatus @default(BORRADOR)

  fechaEmision DateTime @db.Date
  motivo       String

  // Montos
  netoGravado Decimal @db.Decimal(15, 2)
  iva21       Decimal @default(0) @db.Decimal(15, 2)
  iva105      Decimal @default(0) @db.Decimal(15, 2)
  iva27       Decimal @default(0) @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)

  // AFIP (preparado)
  cae         String?   @db.VarChar(20)
  fechaVtoCae DateTime? @db.Date

  // Aplicación
  aplicada   Boolean   @default(false)
  aplicadaAt DateTime?

  // Notas
  notas String?

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  client        Client                     @relation(fields: [clientId], references: [id])
  factura       SalesInvoice?              @relation("InvoiceCreditNotes", fields: [facturaId], references: [id])
  company       Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User                       @relation("CreditNoteCreatedBy", fields: [createdBy], references: [id])
  items         SalesCreditDebitNoteItem[]
  ledgerEntries ClientLedgerEntry[]

  @@index([companyId])
  @@index([clientId])
  @@index([facturaId])
  @@index([tipo])
  @@index([estado])
  @@index([docType])
  @@map("sales_credit_debit_notes")
}

model SalesCreditDebitNoteItem {
  id             Int     @id @default(autoincrement())
  noteId         Int
  productId      String?
  descripcion    String  @db.VarChar(500)
  cantidad       Decimal @db.Decimal(15, 4)
  unidad         String  @db.VarChar(50)
  precioUnitario Decimal @db.Decimal(15, 2)
  alicuotaIVA    Decimal @default(21) @db.Decimal(5, 2)
  subtotal       Decimal @db.Decimal(15, 2)

  note    SalesCreditDebitNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  product Product?             @relation(fields: [productId], references: [id])

  @@index([noteId])
  @@map("sales_credit_debit_note_items")
}

// Pagos de Clientes
model ClientPayment {
  id        Int      @id @default(autoincrement())
  numero    String   @db.VarChar(50)
  clientId  String
  fechaPago DateTime @db.Date

  // Montos por método
  totalPago       Decimal @db.Decimal(15, 2)
  efectivo        Decimal @default(0) @db.Decimal(15, 2)
  transferencia   Decimal @default(0) @db.Decimal(15, 2)
  chequesTerceros Decimal @default(0) @db.Decimal(15, 2)
  chequesPropios  Decimal @default(0) @db.Decimal(15, 2)
  tarjetaCredito  Decimal @default(0) @db.Decimal(15, 2)
  tarjetaDebito   Decimal @default(0) @db.Decimal(15, 2)
  otrosMedios     Decimal @default(0) @db.Decimal(15, 2)

  // Retenciones aplicadas
  retIVA       Decimal @default(0) @db.Decimal(15, 2)
  retGanancias Decimal @default(0) @db.Decimal(15, 2)
  retIngBrutos Decimal @default(0) @db.Decimal(15, 2)

  // Estado
  estado ClientPaymentStatus @default(CONFIRMADO)

  // Anulación
  motivoAnulacion String?
  fechaAnulacion  DateTime?
  anuladoPor      Int?

  // Rechazo (cheque rechazado, transferencia fallida, etc.)
  motivoRechazo String?
  fechaRechazo  DateTime?

  // Datos bancarios
  bancoOrigen     String? @db.VarChar(100)
  numeroOperacion String? @db.VarChar(50)

  // Notas
  notas String?

  // Medios de pago (JSON) - stores payment medium details for creating treasury movements
  // Format: [{ tipo, monto, accountId, accountType, numeroComprobante, fechaAcreditacion, chequeData }]
  mediosData Json?

  // ViewMode
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  client        Client                     @relation(fields: [clientId], references: [id])
  company       Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User                       @relation("PaymentCreatedBy", fields: [createdBy], references: [id])
  allocations   InvoicePaymentAllocation[]
  cheques       ClientPaymentCheque[]
  ledgerEntries ClientLedgerEntry[]
  acopios       SaleAcopio[]

  // Tesorería
  cashMovements    CashMovement[]
  bankMovements    BankMovement[]
  chequesRecibidos Cheque[]       @relation("ChequeClientPayment")

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([clientId])
  @@index([fechaPago])
  @@index([estado])
  @@index([docType])
  @@index([companyId, docType])
  @@index([companyId, docType, fechaPago])
  // Additional compound indexes for report queries
  @@index([companyId, clientId, estado])
  @@index([clientId, estado, fechaPago])
  @@map("client_payments")
}

// Aplicación de Pagos a Facturas (Pagos Parciales)
model InvoicePaymentAllocation {
  id              Int      @id @default(autoincrement())
  paymentId       Int
  invoiceId       Int
  montoAplicado   Decimal  @db.Decimal(15, 2)
  fechaAplicacion DateTime @default(now())
  createdAt       DateTime @default(now())

  payment ClientPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice SalesInvoice  @relation(fields: [invoiceId], references: [id])

  @@index([paymentId])
  @@index([invoiceId])
  @@map("invoice_payment_allocations")
}

model ClientPaymentCheque {
  id               Int          @id @default(autoincrement())
  paymentId        Int
  tipo             String       @db.VarChar(20)
  numero           String       @db.VarChar(50)
  banco            String?      @db.VarChar(100)
  titular          String?      @db.VarChar(255)
  cuit             String?      @db.VarChar(20)
  fechaEmision     DateTime?    @db.Date
  fechaVencimiento DateTime?    @db.Date
  importe          Decimal      @db.Decimal(15, 2)
  estado           ChequeStatus @default(CARTERA)

  payment ClientPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([estado])
  @@map("client_payment_cheques")
}

// Cuenta Corriente - Ledger Inmutable
model ClientLedgerEntry {
  id        Int                @id @default(autoincrement())
  clientId  String
  companyId Int
  tipo      ClientMovementType

  // Referencias a documentos
  facturaId           Int?
  notaCreditoDebitoId Int?
  pagoId              Int?

  // Fechas
  fecha            DateTime  @db.Date
  fechaVencimiento DateTime? @db.Date

  // Montos (debe = aumenta deuda, haber = disminuye deuda)
  debe  Decimal @default(0) @db.Decimal(15, 2)
  haber Decimal @default(0) @db.Decimal(15, 2)

  // Información
  comprobante String? @db.VarChar(100)
  descripcion String?

  // Anulación (ledger inmutable - se anula con contraasiento)
  anulado    Boolean   @default(false)
  anuladoPor Int?
  anuladoAt  DateTime?

  // Conciliación (fase futura)
  conciliado   Boolean   @default(false)
  conciliadoAt DateTime?
  conciliadoBy Int?

  // Tracking
  createdBy Int?
  createdAt DateTime @default(now())

  // Relaciones
  client            Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company           Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  factura           SalesInvoice?         @relation(fields: [facturaId], references: [id])
  notaCreditoDebito SalesCreditDebitNote? @relation(fields: [notaCreditoDebitoId], references: [id])
  pago              ClientPayment?        @relation(fields: [pagoId], references: [id])
  asientoAnulacion  ClientLedgerEntry?    @relation("LedgerAnulacion", fields: [anuladoPor], references: [id])
  asientosAnulados  ClientLedgerEntry[]   @relation("LedgerAnulacion")

  @@index([clientId])
  @@index([companyId])
  @@index([fecha])
  @@index([tipo])
  @@index([anulado])
  // Compound indexes for common queries
  @@index([companyId, clientId])
  @@index([companyId, clientId, fecha])
  @@index([clientId, fecha])
  @@index([companyId, anulado, tipo])
  @@map("client_ledger_entries")
}

// Collection Attempts - Smart Collections AI Feature
model CollectionAttempt {
  id        Int @id @default(autoincrement())
  invoiceId Int
  companyId Int
  userId    Int

  // Attempt details
  attemptType   String  @db.VarChar(50) // 'EMAIL', 'PHONE', 'VISIT', 'LETTER', 'WHATSAPP', 'SMS'
  result        String  @db.VarChar(50) // 'CONTACTADO', 'NO_RESPUESTA', 'COMPROMISO_PAGO', 'RECHAZADO', 'PAGO_PARCIAL', 'PAGO_TOTAL'
  contactMethod String? @db.VarChar(100)
  notes         String?

  // Follow-up
  nextFollowUpDate DateTime? @db.Date

  // Timestamps
  attemptDate DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  invoice SalesInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  company Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User         @relation("CollectionAttemptUser", fields: [userId], references: [id])

  @@index([invoiceId])
  @@index([companyId])
  @@index([attemptDate])
  @@index([result])
  @@index([companyId, invoiceId])
  @@map("collection_attempts")
}

// Lista de Precios
model SalesPriceList {
  id             Int       @id @default(autoincrement())
  nombre         String    @db.VarChar(100)
  descripcion    String?
  moneda         String    @default("ARS") @db.VarChar(10)
  porcentajeBase Decimal?  @db.Decimal(5, 2)
  esDefault      Boolean   @default(false)
  isActive       Boolean   @default(true)
  validFrom      DateTime? @db.Date
  validUntil     DateTime? @db.Date

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items     SalesPriceListItem[]
  clients   Client[]             @relation("ClientDefaultPriceList") // Clientes con esta lista por defecto
  priceLogs SalesPriceLog[]

  @@index([companyId])
  @@index([isActive])
  @@map("sales_price_lists")
}

model SalesPriceListItem {
  id             Int      @id @default(autoincrement())
  priceListId    Int
  productId      String
  precioUnitario Decimal  @db.Decimal(15, 2)
  porcentaje     Decimal? @db.Decimal(5, 2)

  priceList SalesPriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product   Product        @relation(fields: [productId], references: [id])

  @@unique([priceListId, productId])
  @@index([priceListId])
  @@index([productId])
  @@map("sales_price_list_items")
}

// Sistema de Aprobaciones
model SalesApproval {
  id        Int                 @id @default(autoincrement())
  entidad   String              @db.VarChar(50)
  entidadId Int
  tipo      SalesApprovalType
  estado    SalesApprovalStatus @default(PENDIENTE)

  motivo     String?
  monto      Decimal? @db.Decimal(15, 2)
  porcentaje Decimal? @db.Decimal(5, 2)

  solicitadoPor Int
  asignadoA     Int?
  resueltoPor   Int?
  resueltoAt    DateTime?
  comentarios   String?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones polimórficas
  quote       Quote? @relation("QuoteApprovals", fields: [entidadId], references: [id], map: "sales_approvals_quote_fk")
  sale        Sale?  @relation("SaleApprovals", fields: [entidadId], references: [id], map: "sales_approvals_sale_fk")
  solicitante User   @relation("ApprovalSolicitante", fields: [solicitadoPor], references: [id])
  asignado    User?  @relation("ApprovalAsignado", fields: [asignadoA], references: [id])
  resolutor   User?  @relation("ApprovalResolutor", fields: [resueltoPor], references: [id])

  @@index([companyId])
  @@index([entidad, entidadId])
  @@index([estado])
  @@map("sales_approvals")
}

// Auditoría de Ventas
model SalesAuditLog {
  id                Int      @id @default(autoincrement())
  entidad           String   @db.VarChar(100)
  entidadId         Int
  accion            String   @db.VarChar(50)
  camposModificados Json?
  datosAnteriores   Json?
  datosNuevos       Json?
  ip                String?  @db.VarChar(50)
  userAgent         String?
  companyId         Int
  userId            Int
  createdAt         DateTime @default(now())

  user User @relation("SalesAuditLogUser", fields: [userId], references: [id])

  @@index([companyId])
  @@index([entidad, entidadId])
  @@index([userId])
  @@index([createdAt])
  @@map("sales_audit_logs")
}

// KPIs de Vendedor
model SellerKPI {
  id       Int      @id @default(autoincrement())
  sellerId Int
  periodo  DateTime @db.Date

  // Métricas
  cotizacionesCreadas  Int     @default(0)
  cotizacionesGanadas  Int     @default(0)
  cotizacionesPerdidas Int     @default(0)
  tasaConversion       Decimal @default(0) @db.Decimal(5, 2)

  ventasTotales  Decimal @default(0) @db.Decimal(15, 2)
  margenPromedio Decimal @default(0) @db.Decimal(5, 2)

  comisionesGeneradas Decimal @default(0) @db.Decimal(15, 2)
  comisionesPagadas   Decimal @default(0) @db.Decimal(15, 2)

  clientesNuevos Int     @default(0)
  ticketPromedio Decimal @default(0) @db.Decimal(15, 2)

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seller User @relation(fields: [sellerId], references: [id])

  @@unique([sellerId, periodo, companyId])
  @@index([sellerId])
  @@index([periodo])
  @@index([companyId])
  @@map("seller_kpis")
}

// =============================================
// POSTVENTA: RMA, DEVOLUCIONES Y GARANTÍAS
// =============================================

enum RMAStatus {
  SOLICITADO // Cliente solicitó devolución
  EN_REVISION // Equipo revisando solicitud
  APROBADO // RMA aprobado, esperando producto
  RECHAZADO // RMA rechazado
  EN_TRANSITO // Producto en camino
  RECIBIDO // Producto recibido en almacén
  EN_EVALUACION // Evaluando estado del producto
  PROCESADO // Devolución procesada (NC emitida o producto cambiado)
  CERRADO // Caso cerrado
  CANCELADO // Cancelado por cliente
}

enum RMAType {
  DEVOLUCION // Devolución con reembolso
  CAMBIO // Cambio por otro producto
  REPARACION // Envío a reparación
  GARANTIA // Reclamo de garantía
}

enum RMAReasonCategory {
  DEFECTO_FABRICACION // Producto defectuoso
  ERROR_ENVIO // Se envió producto incorrecto
  DANO_TRANSPORTE // Dañado durante envío
  NO_CONFORME // No cumple expectativas
  ARREPENTIMIENTO // Cambio de opinión
  GARANTIA // Falla dentro de garantía
  OTRO // Otra razón
}

// RMA (Return Merchandise Authorization)
model SaleRMA {
  id        String  @id @default(cuid())
  numero    String // RMA-00001
  companyId Int
  clientId  String
  saleId    String? // Venta original (opcional)
  invoiceId String? // Factura original (opcional)

  tipo            RMAType
  estado          RMAStatus         @default(SOLICITADO)
  categoriaMotivo RMAReasonCategory
  motivoDetallado String            @db.Text

  // Fechas del proceso
  fechaSolicitud  DateTime  @default(now())
  fechaAprobacion DateTime?
  fechaRecepcion  DateTime?
  fechaCierre     DateTime?

  // Responsables
  solicitadoPor Int // Usuario que creó el RMA
  aprobadoPor   Int? // Usuario que aprobó
  procesadoPor  Int? // Usuario que procesó

  // Información de envío
  numeroSeguimiento String?
  transportista     String?

  // Evaluación
  estadoProducto  String? // NUEVO, USADO, DANADO, etc.
  notasEvaluacion String?  @db.Text
  fotoRecepcion   String[] // URLs de fotos

  // Resolución
  tipoResolucion String? // NC_EMITIDA, PRODUCTO_CAMBIADO, REPARADO, etc.
  creditNoteId   String? // ID de nota de crédito generada
  nuevaVentaId   String? // ID de nueva venta (si es cambio)
  montoDevuelto  Decimal? @db.Decimal(15, 2)

  // Documentos
  documentType String @default("N")
  docType      String @default("N")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client      Client           @relation("ClientRMAs", fields: [clientId], references: [id])
  solicitante User             @relation("RMASolicitante", fields: [solicitadoPor], references: [id])
  aprobador   User?            @relation("RMAAprobador", fields: [aprobadoPor], references: [id])
  procesador  User?            @relation("RMAProcesador", fields: [procesadoPor], references: [id])
  items       SaleRMAItem[]
  historial   SaleRMAHistory[]

  @@index([companyId])
  @@index([clientId])
  @@index([estado])
  @@index([fechaSolicitud])
  @@index([numero])
  @@map("sale_rmas")
}

// Items de un RMA
model SaleRMAItem {
  id                 Int    @id @default(autoincrement())
  rmaId              String
  productId          String
  cantidadSolicitada Int
  cantidadRecibida   Int    @default(0)
  cantidadAprobada   Int    @default(0)

  precioUnitario Decimal @db.Decimal(15, 2)
  subtotal       Decimal @db.Decimal(15, 2)

  motivoEspecifico String? @db.Text
  lote             String?
  numeroSerie      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rma     SaleRMA @relation(fields: [rmaId], references: [id], onDelete: Cascade)
  product Product @relation("RMAProducts", fields: [productId], references: [id])

  @@index([rmaId])
  @@index([productId])
  @@map("sale_rma_items")
}

// Historial de cambios de estado del RMA
model SaleRMAHistory {
  id             Int        @id @default(autoincrement())
  rmaId          String
  estadoAnterior RMAStatus?
  estadoNuevo    RMAStatus
  userId         Int
  notas          String?    @db.Text
  createdAt      DateTime   @default(now())

  rma  SaleRMA @relation(fields: [rmaId], references: [id], onDelete: Cascade)
  user User    @relation("RMAHistoryUser", fields: [userId], references: [id])

  @@index([rmaId])
  @@index([createdAt])
  @@map("sale_rma_history")
}

// Garantías de productos vendidos
model ProductWarranty {
  id        String  @id @default(cuid())
  companyId Int
  clientId  String
  productId String
  saleId    String?
  invoiceId String?

  numeroSerie String?
  lote        String?

  fechaCompra      DateTime
  fechaActivacion  DateTime?
  fechaVencimiento DateTime

  duracionMeses Int // Duración en meses
  tipoGarantia  String // FABRICANTE, EXTENDIDA, COMERCIAL
  cobertura     String @db.Text // Descripción de cobertura

  estado String @default("ACTIVA") // ACTIVA, VENCIDA, UTILIZADA, CANCELADA

  // Si se utilizó la garantía
  rmaId         String?
  fechaReclamo  DateTime?
  motivoReclamo String?   @db.Text
  resolucion    String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client  @relation("ClientWarranties", fields: [clientId], references: [id])
  product Product @relation("ProductWarranties", fields: [productId], references: [id])

  @@index([companyId])
  @@index([clientId])
  @@index([productId])
  @@index([fechaVencimiento])
  @@index([estado])
  @@map("product_warranties")
}

// =============================================
// METAS Y OBJETIVOS DE VENTAS
// =============================================

enum GoalPeriod {
  MENSUAL
  TRIMESTRAL
  SEMESTRAL
  ANUAL
}

enum GoalType {
  VENTAS_MONTO // Meta en dinero
  VENTAS_CANTIDAD // Meta en unidades vendidas
  CLIENTES_NUEVOS // Meta de nuevos clientes
  MARGEN // Meta de margen
  CONVERSION // Meta de tasa de conversión
  COBRANZAS // Meta de cobranzas
}

enum GoalLevel {
  EMPRESA // Meta a nivel empresa
  VENDEDOR // Meta por vendedor
  EQUIPO // Meta por equipo/zona
  PRODUCTO // Meta por producto
  CATEGORIA // Meta por categoría
}

// Definición de Metas
model SalesGoal {
  id          String  @id @default(cuid())
  companyId   Int
  nombre      String
  descripcion String? @db.Text

  // Tipo y alcance
  tipo    GoalType
  nivel   GoalLevel
  periodo GoalPeriod

  // Fechas
  fechaInicio DateTime
  fechaFin    DateTime

  // Objetivo
  metaValor Decimal @db.Decimal(15, 2)
  unidad    String? // ARS, USD, unidades, %

  // Asignación
  vendedorId  Int? // Si es meta de vendedor
  equipoId    String? // Si es meta de equipo
  productoId  String? // Si es meta de producto
  categoriaId Int? // Si es meta de categoría

  // Estado
  isActive Boolean @default(true)
  isClosed Boolean @default(false)

  // Incentivos
  tieneIncentivo       Boolean  @default(false)
  incentivoPorcentaje  Decimal? @db.Decimal(5, 2)
  incentivoFijo        Decimal? @db.Decimal(15, 2)
  descripcionIncentivo String?  @db.Text

  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company  Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendedor User?               @relation("GoalVendedor", fields: [vendedorId], references: [id])
  creator  User                @relation("GoalCreator", fields: [createdBy], references: [id])
  progress SalesGoalProgress[]

  @@index([companyId])
  @@index([vendedorId])
  @@index([periodo])
  @@index([fechaInicio, fechaFin])
  @@index([isActive])
  @@map("sales_goals")
}

// Progreso de Metas (tracking diario/semanal)
model SalesGoalProgress {
  id                     Int      @id @default(autoincrement())
  goalId                 String
  fecha                  DateTime @db.Date
  valorAlcanzado         Decimal  @db.Decimal(15, 2)
  porcentajeCumplimiento Decimal  @db.Decimal(5, 2)

  // Detalles
  cantidadVentas Int?
  montoVentas    Decimal? @db.Decimal(15, 2)
  clientesNuevos Int?
  margenPromedio Decimal? @db.Decimal(5, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  goal SalesGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, fecha])
  @@index([goalId])
  @@index([fecha])
  @@map("sales_goal_progress")
}

// Dashboard de Cumplimiento (snapshot mensual)
model SalesPerformanceDashboard {
  id         String   @id @default(cuid())
  companyId  Int
  vendedorId Int?
  periodo    DateTime @db.Date // Primer día del mes

  // Métricas generales
  ventasTotales      Decimal @db.Decimal(15, 2)
  metaVentas         Decimal @db.Decimal(15, 2)
  cumplimientoVentas Decimal @db.Decimal(5, 2)

  // Métricas adicionales
  clientesNuevos     Int
  metaClientesNuevos Int
  margenPromedio     Decimal @db.Decimal(5, 2)
  tasaConversion     Decimal @db.Decimal(5, 2)

  // Rankings
  rankingVentas         Int?
  rankingMargen         Int?
  rankingClientesNuevos Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendedor User?   @relation("PerformanceVendedor", fields: [vendedorId], references: [id])

  @@unique([companyId, vendedorId, periodo])
  @@index([companyId, periodo])
  @@index([vendedorId])
  @@map("sales_performance_dashboard")
}

// =============================================
// SISTEMA DE MÓDULOS POR EMPRESA (SUPERADMIN)
// =============================================

// Catálogo de Módulos del Sistema
model Module {
  id           String         @id @default(cuid())
  key          String         @unique // "acopios", "multi_price_lists", etc.
  name         String // "Sistema de Acopios"
  description  String?
  category     ModuleCategory
  icon         String? // Icono Lucide (ej: "Package", "DollarSign")
  isActive     Boolean        @default(true)
  sortOrder    Int            @default(0)
  dependencies String[] // Keys de módulos requeridos
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  companies CompanyModule[]

  @@map("modules")
}

// Configuración de Módulos por Empresa
model CompanyModule {
  id        String   @id @default(cuid())
  companyId Int
  moduleId  String
  isEnabled Boolean  @default(true)
  enabledAt DateTime @default(now())
  enabledBy Int?
  config    Json? // Configuración específica del módulo por empresa

  company       Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  module        Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  enabledByUser User?   @relation("ModuleEnabledBy", fields: [enabledBy], references: [id])

  @@unique([companyId, moduleId])
  @@index([companyId])
  @@index([moduleId])
  @@index([isEnabled])
  @@map("company_modules")
}

// =============================================
// SISTEMA DE ACOPIOS (Mercadería Pagada No Retirada)
// =============================================

// Acopio Principal
model SaleAcopio {
  id        Int          @id @default(autoincrement())
  numero    String       @db.VarChar(50)
  clientId  String
  saleId    Int
  paymentId Int? // Pago que generó el acopio
  estado    AcopioStatus @default(ACTIVO)

  // Fechas
  fechaIngreso     DateTime  @db.Date
  fechaVencimiento DateTime? @db.Date

  // Montos
  montoTotal     Decimal @db.Decimal(15, 2)
  montoRetirado  Decimal @default(0) @db.Decimal(15, 2)
  montoPendiente Decimal @db.Decimal(15, 2)

  // Información adicional
  notas   String?
  docType DocType @default(T1)

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  client        Client           @relation(fields: [clientId], references: [id])
  sale          Sale             @relation(fields: [saleId], references: [id])
  payment       ClientPayment?   @relation(fields: [paymentId], references: [id])
  company       Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User             @relation("AcopioCreatedBy", fields: [createdBy], references: [id])
  items         SaleAcopioItem[]
  retiros       AcopioRetiro[]

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([clientId])
  @@index([saleId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("sale_acopios")
}

// Items del Acopio
model SaleAcopioItem {
  id             Int     @id @default(autoincrement())
  acopioId       Int
  saleItemId     Int?
  productId      String?
  codigo         String? @db.VarChar(50)
  descripcion    String  @db.VarChar(500)
  unidad         String  @db.VarChar(50)
  precioUnitario Decimal @db.Decimal(15, 2)

  // Cantidades
  cantidad          Decimal @db.Decimal(15, 4)
  cantidadRetirada  Decimal @default(0) @db.Decimal(15, 4)
  cantidadPendiente Decimal @db.Decimal(15, 4)

  acopio  SaleAcopio @relation(fields: [acopioId], references: [id], onDelete: Cascade)
  product Product?   @relation("AcopioItemProduct", fields: [productId], references: [id])

  @@index([acopioId])
  @@index([productId])
  @@map("sale_acopio_items")
}

// Retiro de Acopio
model AcopioRetiro {
  id       Int    @id @default(autoincrement())
  numero   String @db.VarChar(50)
  acopioId Int

  // Fecha
  fechaRetiro DateTime @db.Date

  // Datos de quien retira
  retiraNombre   String? @db.VarChar(255)
  retiraDNI      String? @db.VarChar(20)
  retiraRelacion String? @db.VarChar(100) // "Titular", "Empleado", "Transportista"

  // Monto
  montoRetirado Decimal @db.Decimal(15, 2)

  // Transporte
  transportista String? @db.VarChar(255)
  vehiculo      String? @db.VarChar(100)
  patente       String? @db.VarChar(20)

  // Evidencia
  firmaRetiro String? // Base64 o URL de firma digital
  fotoEntrega String? // URL de foto
  gpsEntrega  String? @db.VarChar(100) // Coordenadas

  // Documento
  docType       DocType @default(T1)
  observaciones String?

  // Tracking
  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  acopio        SaleAcopio         @relation(fields: [acopioId], references: [id], onDelete: Cascade)
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User               @relation("RetiroCreatedBy", fields: [createdBy], references: [id])
  items         AcopioRetiroItem[]

  @@unique([companyId, numero])
  @@index([acopioId])
  @@index([companyId])
  @@index([fechaRetiro])
  @@map("acopio_retiros")
}

// Items del Retiro
model AcopioRetiroItem {
  id           Int     @id @default(autoincrement())
  retiroId     Int
  acopioItemId Int
  cantidad     Decimal @db.Decimal(15, 4)

  retiro AcopioRetiro @relation(fields: [retiroId], references: [id], onDelete: Cascade)

  @@index([retiroId])
  @@index([acopioItemId])
  @@map("acopio_retiro_items")
}

// ============================================
// MÓDULO DE TESORERÍA
// ============================================

// Tipos de movimiento de caja
enum CashMovementType {
  INGRESO_COBRO // Cobro de cliente (efectivo)
  EGRESO_PAGO // Pago a proveedor (efectivo)
  INGRESO_DEPOSITO // Ingreso manual/depósito
  EGRESO_RETIRO // Retiro manual
  INGRESO_CAMBIO // Cambio de moneda (entrada)
  EGRESO_CAMBIO // Cambio de moneda (salida)
  AJUSTE_POSITIVO // Ajuste de arqueo (+)
  AJUSTE_NEGATIVO // Ajuste de arqueo (-)
  TRANSFERENCIA_IN // Transferencia desde otra caja
  TRANSFERENCIA_OUT // Transferencia a otra caja
}

// Tipos de movimiento bancario
enum BankMovementType {
  TRANSFERENCIA_IN // Transferencia recibida
  TRANSFERENCIA_OUT // Transferencia enviada
  DEPOSITO_EFECTIVO // Depósito de efectivo
  DEPOSITO_CHEQUE // Depósito de cheque
  DEBITO_CHEQUE // Débito por cheque emitido
  DEBITO_AUTOMATICO // Débito automático
  CREDITO_AUTOMATICO // Crédito automático
  COMISION // Comisión bancaria
  IMPUESTO // Imp. débitos/créditos
  INTERES // Intereses
  AJUSTE // Ajuste de conciliación
}

// Origen del cheque
enum ChequeOrigen {
  RECIBIDO // De cliente
  EMITIDO // A proveedor
}

// Tipo de cheque
enum ChequeTipo {
  FISICO
  ECHEQ
}

// Estado del cheque
enum ChequeEstado {
  CARTERA // En cartera (no depositado)
  DEPOSITADO // Depositado, esperando acreditación
  COBRADO // Cobrado/acreditado
  RECHAZADO // Rechazado por el banco
  ENDOSADO // Endosado a tercero
  ANULADO // Anulado
  VENCIDO // Vencido sin depositar
}

// Estado de transferencia interna
enum TreasuryTransferStatus {
  PENDIENTE
  COMPLETADA
  ANULADA
}

// Caja (efectivo)
model CashAccount {
  id        Int    @id @default(autoincrement())
  companyId Int
  codigo    String @db.VarChar(20)
  nombre    String @db.VarChar(100)
  moneda    String @default("ARS") @db.VarChar(3) // ARS, USD

  // Saldo calculado
  saldoActual Decimal @default(0) @db.Decimal(15, 2)

  // Config
  isActive  Boolean @default(true)
  esDefault Boolean @default(false) // Caja por defecto

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company            Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser      User               @relation("CashAccountCreatedBy", fields: [createdBy], references: [id])
  movements          CashMovement[]
  treasuryMovements  TreasuryMovement[]
  transfersOut       TreasuryTransfer[] @relation("TransferOrigenCaja")
  transfersIn        TreasuryTransfer[] @relation("TransferDestinoCaja")

  @@unique([companyId, codigo])
  @@index([companyId])
  @@index([isActive])
  @@map("cash_accounts")
}

// Movimiento de caja
model CashMovement {
  id            Int              @id @default(autoincrement())
  cashAccountId Int
  companyId     Int
  tipo          CashMovementType

  // Referencias opcionales según origen
  paymentOrderId  Int? // Pago a proveedor
  clientPaymentId Int? // Cobro de cliente
  chequeId        Int? // Depósito/retiro de cheque
  transferId      Int? // Transferencia interna

  // Montos
  ingreso        Decimal @default(0) @db.Decimal(15, 2)
  egreso         Decimal @default(0) @db.Decimal(15, 2)
  saldoAnterior  Decimal @db.Decimal(15, 2)
  saldoPosterior Decimal @db.Decimal(15, 2)

  // Info
  fecha       DateTime @db.Date
  descripcion String?
  comprobante String?  @db.VarChar(100)

  // ViewMode - Caja SÍ soporta T2
  docType DocType @default(T1)

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())

  // Relaciones
  cashAccount   CashAccount    @relation(fields: [cashAccountId], references: [id], onDelete: Cascade)
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User           @relation("CashMovementCreatedBy", fields: [createdBy], references: [id])
  paymentOrder  PaymentOrder?  @relation(fields: [paymentOrderId], references: [id])
  clientPayment ClientPayment? @relation(fields: [clientPaymentId], references: [id])

  @@index([cashAccountId])
  @@index([companyId])
  @@index([fecha])
  @@index([tipo])
  @@index([docType])
  @@map("cash_movements")
}

// Cuenta bancaria
model BankAccount {
  id           Int     @id @default(autoincrement())
  companyId    Int
  codigo       String  @db.VarChar(20)
  nombre       String  @db.VarChar(100)
  banco        String  @db.VarChar(100)
  tipoCuenta   String  @db.VarChar(50) // CC, CA
  numeroCuenta String  @db.VarChar(50)
  cbu          String? @db.VarChar(22)
  alias        String? @db.VarChar(50)
  moneda       String  @default("ARS") @db.VarChar(3)

  // Saldos
  saldoContable Decimal @default(0) @db.Decimal(15, 2) // Según sistema
  saldoBancario Decimal @default(0) @db.Decimal(15, 2) // Según extracto

  // Config
  isActive  Boolean @default(true)
  esDefault Boolean @default(false)

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser     User               @relation("BankAccountCreatedBy", fields: [createdBy], references: [id])
  movements         BankMovement[]
  cheques           Cheque[]           @relation("ChequeBankAccount")
  chequesDeposit    Cheque[]           @relation("ChequeDepositBank")
  transfersOut      TreasuryTransfer[] @relation("TransferOrigenBanco")
  transfersIn       TreasuryTransfer[] @relation("TransferDestinoBanco")
  bankStatements    BankStatement[]
  treasuryMovements TreasuryMovement[]

  @@unique([companyId, codigo])
  @@index([companyId])
  @@index([isActive])
  @@map("bank_accounts")
}

// Movimiento bancario
model BankMovement {
  id            Int              @id @default(autoincrement())
  bankAccountId Int
  companyId     Int
  tipo          BankMovementType

  // Referencias opcionales
  paymentOrderId  Int? // Transferencia a proveedor
  clientPaymentId Int? // Transferencia de cliente
  chequeId        Int? // Depósito/débito de cheque

  // Montos
  ingreso        Decimal @default(0) @db.Decimal(15, 2)
  egreso         Decimal @default(0) @db.Decimal(15, 2)
  saldoAnterior  Decimal @db.Decimal(15, 2)
  saldoPosterior Decimal @db.Decimal(15, 2)

  // Info
  fecha             DateTime  @db.Date
  fechaValor        DateTime? @db.Date // Fecha efectiva banco
  descripcion       String?
  comprobante       String?   @db.VarChar(100)
  referenciaExterna String?   @db.VarChar(100) // Ref del extracto

  // Conciliación
  conciliado   Boolean   @default(false)
  conciliadoAt DateTime?
  conciliadoBy Int?

  // IMPORTANTE: Banco SOLO T1 (rastro electrónico)
  // NO tiene campo docType - siempre se considera T1

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())

  // Relaciones
  bankAccount      BankAccount    @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company          Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser    User           @relation("BankMovementCreatedBy", fields: [createdBy], references: [id])
  paymentOrder     PaymentOrder?  @relation(fields: [paymentOrderId], references: [id])
  clientPayment    ClientPayment? @relation(fields: [clientPaymentId], references: [id])
  cheque           Cheque?        @relation(fields: [chequeId], references: [id])
  conciliadoByUser User?          @relation("BankMovementConciliadoBy", fields: [conciliadoBy], references: [id])

  @@index([bankAccountId])
  @@index([companyId])
  @@index([fecha])
  @@index([conciliado])
  @@map("bank_movements")
}

// Cheque (Cartera Unificada)
model Cheque {
  id        Int          @id @default(autoincrement())
  companyId Int
  origen    ChequeOrigen // RECIBIDO, EMITIDO
  tipo      ChequeTipo // FISICO, ECHEQ

  // Datos del cheque
  numero      String  @db.VarChar(50)
  banco       String  @db.VarChar(100)
  sucursal    String? @db.VarChar(50)
  titular     String  @db.VarChar(255)
  cuitTitular String? @db.VarChar(20)

  // Montos
  importe Decimal @db.Decimal(15, 2)
  moneda  String  @default("ARS") @db.VarChar(3)

  // Fechas
  fechaEmision     DateTime  @db.Date
  fechaVencimiento DateTime  @db.Date
  fechaDeposito    DateTime? @db.Date
  fechaCobro       DateTime? @db.Date

  // Estado
  estado ChequeEstado @default(CARTERA)

  // Relaciones de origen
  clientPaymentId Int? // Si es RECIBIDO de cliente
  paymentOrderId  Int? // Si es EMITIDO a proveedor

  // Si es EMITIDO, de qué cuenta
  bankAccountId Int? // Cuenta bancaria de origen (chequera)

  // Si fue depositado
  depositoBankAccountId Int? // En qué banco se depositó

  // Si fue endosado
  endosadoA              String? @db.VarChar(255)
  endosadoPaymentOrderId Int? // A qué pago se endosó

  // ViewMode - Cheque físico SÍ puede ser T2, ECHEQ NO
  docType DocType @default(T1)

  // Motivo rechazo si aplica
  motivoRechazo String?

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company              Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser        User           @relation("ChequeCreatedBy", fields: [createdBy], references: [id])
  clientPayment        ClientPayment? @relation("ChequeClientPayment", fields: [clientPaymentId], references: [id])
  paymentOrder         PaymentOrder?  @relation("ChequePaymentOrder", fields: [paymentOrderId], references: [id])
  bankAccount          BankAccount?   @relation("ChequeBankAccount", fields: [bankAccountId], references: [id])
  depositoBankAccount  BankAccount?   @relation("ChequeDepositBank", fields: [depositoBankAccountId], references: [id])
  endosadoPaymentOrder PaymentOrder?  @relation("ChequeEndosado", fields: [endosadoPaymentOrderId], references: [id])
  bankMovements        BankMovement[]

  @@index([companyId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@index([origen])
  @@index([docType])
  @@map("cheques")
}

// Transferencia interna de tesorería
model TreasuryTransfer {
  id        Int    @id @default(autoincrement())
  companyId Int
  numero    String @db.VarChar(50)

  // Origen (uno de los dos)
  origenCajaId  Int?
  origenBancoId Int?

  // Destino (uno de los dos)
  destinoCajaId  Int?
  destinoBancoId Int?

  // Monto
  importe Decimal @db.Decimal(15, 2)
  moneda  String  @default("ARS") @db.VarChar(3)

  // Fechas
  fecha       DateTime @db.Date
  descripcion String?

  // Estado
  estado TreasuryTransferStatus @default(PENDIENTE)

  // ViewMode - T1 por defecto, T2 para transferencias en efectivo
  docType DocType @default(T1)

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company       Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User         @relation("TreasuryTransferCreatedBy", fields: [createdBy], references: [id])
  origenCaja    CashAccount? @relation("TransferOrigenCaja", fields: [origenCajaId], references: [id])
  origenBanco   BankAccount? @relation("TransferOrigenBanco", fields: [origenBancoId], references: [id])
  destinoCaja   CashAccount? @relation("TransferDestinoCaja", fields: [destinoCajaId], references: [id])
  destinoBanco  BankAccount? @relation("TransferDestinoBanco", fields: [destinoBancoId], references: [id])

  @@unique([companyId, numero])
  @@index([companyId])
  @@index([fecha])
  @@index([estado])
  @@index([docType])
  @@map("treasury_transfers")
}

// ============================================
// CONCILIACIÓN BANCARIA
// ============================================

// Estado del extracto bancario
enum BankStatementStatus {
  PENDIENTE
  EN_PROCESO
  COMPLETADA
  CON_DIFERENCIAS
  CERRADA
}

// Tipo de match en conciliación
enum MatchType {
  EXACT
  FUZZY
  REFERENCE
  MANUAL
}

// Tipo de movimiento de tesorería
enum TreasuryMovementType {
  INGRESO
  EGRESO
  TRANSFERENCIA_INTERNA
  AJUSTE
}

// Medio de pago del movimiento
enum PaymentMedium {
  EFECTIVO
  TRANSFERENCIA
  CHEQUE_TERCERO
  CHEQUE_PROPIO
  ECHEQ
  TARJETA_CREDITO
  TARJETA_DEBITO
  DEPOSITO
  COMISION
  INTERES
  AJUSTE
}

// Estado del movimiento de tesorería
enum TreasuryMovementStatus {
  PENDIENTE
  CONFIRMADO
  REVERSADO
}

// Extracto bancario importado
model BankStatement {
  id            Int                 @id @default(autoincrement())
  bankAccountId Int
  companyId     Int
  periodo       String              @db.VarChar(7) // "YYYY-MM"
  estado        BankStatementStatus @default(PENDIENTE)

  // Saldos
  saldoInicial  Decimal @db.Decimal(15, 2)
  saldoFinal    Decimal @default(0) @db.Decimal(15, 2)
  totalDebitos  Decimal @default(0) @db.Decimal(15, 2)
  totalCreditos Decimal @default(0) @db.Decimal(15, 2)

  // Estadísticas
  totalItems       Int @default(0)
  itemsConciliados Int @default(0)
  itemsPendientes  Int @default(0)
  itemsSuspense    Int @default(0)

  // Tolerancias de matching
  toleranciaMonto Decimal @default(0.01) @db.Decimal(15, 2)
  toleranciaDias  Int     @default(3)

  // ViewMode
  docType DocType @default(T1)

  // Cierre
  cerradoAt   DateTime?
  cerradoPor  Int?
  notasCierre String?

  // Justificación de diferencias (JSON: [{monto, concepto, justificacion}])
  diferenciasJustificadas Json?

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  bankAccount    BankAccount         @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company        Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser  User                @relation("BankStatementCreatedBy", fields: [createdBy], references: [id])
  cerradoPorUser User?               @relation("BankStatementCerradoPor", fields: [cerradoPor], references: [id])
  items          BankStatementItem[]

  @@unique([bankAccountId, periodo])
  @@index([companyId])
  @@index([estado])
  @@index([periodo])
  @@index([docType])
  @@map("bank_statements")
}

// Item individual del extracto bancario
model BankStatementItem {
  id          Int @id @default(autoincrement())
  statementId Int
  lineNumber  Int

  // Datos del extracto
  fecha       DateTime  @db.Date
  fechaValor  DateTime? @db.Date
  descripcion String
  referencia  String?   @db.VarChar(100)

  // Montos
  debito  Decimal @default(0) @db.Decimal(15, 2)
  credito Decimal @default(0) @db.Decimal(15, 2)
  saldo   Decimal @db.Decimal(15, 2)

  // Conciliación
  conciliado         Boolean    @default(false)
  treasuryMovementId Int?
  matchType          MatchType?
  matchConfidence    Float?
  conciliadoAt       DateTime?
  conciliadoBy       Int?

  // Suspense
  esSuspense       Boolean @default(false)
  suspenseResuelto Boolean @default(false)
  suspenseNotas    String?

  // Relaciones
  statement        BankStatement     @relation(fields: [statementId], references: [id], onDelete: Cascade)
  treasuryMovement TreasuryMovement? @relation(fields: [treasuryMovementId], references: [id])
  conciliadoByUser User?             @relation("BankStatementItemConciliadoBy", fields: [conciliadoBy], references: [id])

  @@index([statementId])
  @@index([conciliado])
  @@index([treasuryMovementId])
  @@index([fecha])
  @@map("bank_statement_items")
}

// Movimiento de tesorería unificado (para conciliar contra extractos)
model TreasuryMovement {
  id            Int  @id @default(autoincrement())
  companyId     Int
  bankAccountId Int?
  cashAccountId Int?
  chequeId      Int?

  // Datos del movimiento
  fecha       DateTime               @db.Date
  fechaValor  DateTime?              @db.Date
  tipo        TreasuryMovementType
  medio       PaymentMedium
  monto       Decimal                @db.Decimal(15, 2)
  moneda      String                 @default("ARS") @db.VarChar(3)
  accountType String                 @db.VarChar(20) // CASH, BANK, CHECK_PORTFOLIO
  estado      TreasuryMovementStatus @default(PENDIENTE)

  // Referencias
  referenceType     String? @db.VarChar(50) // Tipo: FACTURA, COBRO, PAGO, etc.
  referenceId       Int?
  descripcion       String?
  numeroComprobante String? @db.VarChar(100)
  comprobanteUrl    String? @db.VarChar(500)

  // Conciliación
  conciliado   Boolean   @default(false)
  conciliadoAt DateTime?
  conciliadoBy Int?

  // ViewMode
  docType DocType @default(T1)

  // Auditoría
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company          Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankAccount      BankAccount?        @relation(fields: [bankAccountId], references: [id])
  cashAccount      CashAccount?        @relation(fields: [cashAccountId], references: [id])
  createdByUser    User                @relation("TreasuryMovementCreatedBy", fields: [createdBy], references: [id])
  conciliadoByUser User?               @relation("TreasuryMovementConciliadoBy", fields: [conciliadoBy], references: [id])
  statementItems   BankStatementItem[]

  @@index([companyId])
  @@index([bankAccountId])
  @@index([cashAccountId])
  @@index([fecha])
  @@index([tipo])
  @@index([conciliado])
  @@index([docType])
  @@map("treasury_movements")
}

// Clave de idempotencia para operaciones de tesorería
model IdempotencyKey {
  id         Int      @id @default(autoincrement())
  key        String   @db.VarChar(255)
  companyId  Int
  operation  String   @db.VarChar(50)
  status     String   @default("PROCESSING") @db.VarChar(20) // PROCESSING, COMPLETED, FAILED
  response   Json?
  entityType String?  @db.VarChar(50)
  entityId   Int?
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([key, companyId])
  @@index([companyId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

// ============================================
// SISTEMA DE BILLING (SaaS)
// ============================================

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED

  @@map("subscription_status")
}

enum BillingInvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE

  @@map("invoice_status")
}

enum BillingCycle {
  MONTHLY
  ANNUAL

  @@map("billing_cycle")
}

enum TokenTransactionType {
  MONTHLY_CREDIT
  PURCHASE
  USAGE
  REFUND
  ADJUSTMENT
  EXPIRATION

  @@map("token_transaction_type")
}

enum BillingPaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED

  @@map("payment_status")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// Templates de Empresa
model CompanyTemplate {
  id          String  @id
  name        String  @unique
  description String?
  icon        String?
  color       String  @default("#8B5CF6")

  // Módulos que incluye el template
  moduleKeys String[] @default([])

  // Config adicional (JSON)
  config Json @default("{}")

  // Flags
  isDefault Boolean @default(false)

  // Stats
  usageCount Int @default(0)

  // Audit
  createdBy Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  companies Company[]

  @@map("company_templates")
}

// Planes de Suscripción
model SubscriptionPlan {
  id          String  @id
  name        String  @unique
  displayName String
  description String?

  // Precios con moneda
  currency     String   @default("ARS")
  monthlyPrice Decimal  @db.Decimal(12, 2)
  annualPrice  Decimal? @db.Decimal(12, 2)

  // Límites (NULL = ilimitado)
  maxCompanies          Int?
  maxUsersPerCompany    Int?
  maxStorageGB          Int?
  includedTokensMonthly Int  @default(0)

  // Módulos permitidos (entitlement)
  moduleKeys String[] @default([])
  features   String[] @default([])

  // Estado y orden
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)
  color     String  @default("#8B5CF6")
  icon      String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  subscriptions Subscription[]

  @@map("subscription_plans")
}

// Suscripciones (1 por owner/cuenta)
model Subscription {
  id     String @id
  userId Int    @unique
  planId String

  // Estado
  status SubscriptionStatus @default(ACTIVE)

  // Fechas
  startDate          DateTime @default(now())
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime

  // Cancelación
  cancelAtPeriodEnd Boolean   @default(false)
  canceledAt        DateTime?

  // Ciclo
  billingCycle BillingCycle @default(MONTHLY)

  // Tokens: 2 bolsillos separados
  includedTokensRemaining Int @default(0) // Allowance del período (resetea)
  purchasedTokensBalance  Int @default(0) // Comprados (carry-over)
  tokensUsedThisPeriod    Int @default(0)

  // Trial
  trialEndsAt DateTime?

  // Provider (para futuro Stripe/MP)
  providerCustomerId     String?
  providerSubscriptionId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user              User                      @relation("UserSubscription", fields: [userId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan          @relation(fields: [planId], references: [id])
  companies         Company[]                 @relation("CompanySubscription")
  invoices          BillingInvoice[]
  tokenTransactions TokenTransaction[]
  couponRedemptions BillingCouponRedemption[]
  autoPaymentConfig BillingAutoPaymentConfig?

  @@index([status])
  @@index([nextBillingDate])
  @@index([planId])
  @@map("subscriptions")
}

// Facturas
model BillingInvoice {
  id             String @id
  number         String @unique
  subscriptionId String

  // Montos con moneda
  currency String  @default("ARS")
  subtotal Decimal @db.Decimal(12, 2)
  tax      Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @db.Decimal(12, 2)

  // Estado
  status BillingInvoiceStatus @default(DRAFT)

  // Período facturado
  periodStart DateTime
  periodEnd   DateTime
  dueDate     DateTime
  paidAt      DateTime?

  // Snapshot del plan (no muta si cambia el plan)
  planSnapshot Json // {planId, displayName, monthlyPrice, billingCycle}

  // ViewMode (T1=fiscal, T2=efectivo sin factura)
  docType DocType @default(T1)

  // Descuentos/Cupones
  discountAmount Decimal? @default(0) @db.Decimal(12, 2)
  couponId       String?

  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  subscription      Subscription              @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  items             BillingInvoiceItem[]
  payments          BillingPayment[]
  coupon            BillingCoupon?            @relation(fields: [couponId], references: [id])
  couponRedemptions BillingCouponRedemption[]

  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
  @@map("invoices")
}

// Items de Factura
model BillingInvoiceItem {
  id        String @id
  invoiceId String

  type        String // 'SUBSCRIPTION', 'TOKENS', 'ADDON', 'PRORATION'
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)

  metadata Json?

  createdAt DateTime @default(now())

  // Relaciones
  invoice BillingInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([type])
  @@map("invoice_items")
}

// Pagos
model BillingPayment {
  id        String @id
  invoiceId String

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("ARS")

  // Método
  method String // 'CASH', 'TRANSFER', 'CARD', 'MERCADOPAGO', 'STRIPE'
  status BillingPaymentStatus @default(PENDING)

  // Provider (Stripe/MP)
  providerPaymentId String?
  providerRef       String?

  // ViewMode (T1=fiscal, T2=efectivo)
  docType DocType @default(T1)

  // Datos adicionales
  notes      String?
  receivedBy Int?

  paidAt    DateTime?
  createdAt DateTime  @default(now())

  // Relaciones
  invoice        BillingInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  receivedByUser User?          @relation("PaymentReceivedBy", fields: [receivedBy], references: [id])

  @@index([invoiceId])
  @@index([status])
  @@map("billing_payments")
}

// Transacciones de Tokens
model TokenTransaction {
  id             String @id
  subscriptionId String

  type   TokenTransactionType
  amount Int // Positivo=crédito, Negativo=débito

  // Balance después de la transacción
  includedBalanceAfter  Int
  purchasedBalanceAfter Int

  description String

  // Referencia (para idempotencia y trazabilidad)
  referenceType  String? // 'AI_QUERY', 'PDF_EXPORT', 'STORAGE', etc.
  referenceId    String?
  idempotencyKey String?

  // Precio si fue compra
  unitPrice  Decimal? @db.Decimal(12, 2)
  totalPrice Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  // Relaciones
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([idempotencyKey])
  @@index([subscriptionId])
  @@index([createdAt])
  @@index([type])
  @@map("token_transactions")
}

// Audit Log de Billing
model BillingAuditLog {
  id         String   @id
  userId     Int?
  action     String // 'PLAN_CHANGE', 'TOKENS_ADDED', 'INVOICE_PAID', etc.
  entityType String // 'subscription', 'invoice', 'payment'
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  // Relaciones
  user User? @relation("BillingAuditLogUser", fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("billing_audit_log")
}

// Cupones de Descuento
model BillingCoupon {
  id          String  @id
  code        String  @unique
  name        String
  description String?

  // Tipo de descuento
  discountType  DiscountType @default(PERCENTAGE)
  discountValue Decimal      @db.Decimal(12, 2)
  currency      String       @default("ARS")

  // Restricciones
  maxUses        Int? // NULL = ilimitado
  maxUsesPerUser Int  @default(1)
  currentUses    Int  @default(0)

  // Validez
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  // Aplicabilidad
  appliesToPlans   String[] @default([])
  appliesToCycles  String[] @default([])
  minAmount        Decimal? @db.Decimal(12, 2)
  firstPaymentOnly Boolean  @default(false)

  // Duración del descuento
  durationMonths Int? // NULL = aplica solo una vez

  // Estado
  isActive Boolean @default(true)

  // Metadata
  createdBy Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  createdByUser User?                     @relation("CouponCreatedBy", fields: [createdBy], references: [id])
  redemptions   BillingCouponRedemption[]
  invoices      BillingInvoice[]

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("billing_coupons")
}

// Uso de Cupones (Redemptions)
model BillingCouponRedemption {
  id             String  @id
  couponId       String
  subscriptionId String
  invoiceId      String?

  // Descuento aplicado
  discountAmount Decimal @db.Decimal(12, 2)

  // Control de duración
  appliedCount Int       @default(1)
  expiresAt    DateTime?

  redeemedAt DateTime @default(now())

  // Relaciones
  coupon       BillingCoupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  subscription Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  invoice      BillingInvoice? @relation(fields: [invoiceId], references: [id])

  @@unique([couponId, subscriptionId])
  @@index([subscriptionId])
  @@index([couponId])
  @@map("billing_coupon_redemptions")
}

// Configuración de Débito Automático
model BillingAutoPaymentConfig {
  id             String @id
  subscriptionId String @unique

  // Proveedor
  provider String // 'STRIPE', 'MERCADOPAGO'

  // Datos del proveedor
  providerCustomerId      String?
  providerPaymentMethodId String?
  providerSubscriptionId  String?

  // Datos de la tarjeta (para mostrar)
  cardLast4    String?
  cardBrand    String? // visa, mastercard, amex
  cardExpMonth Int?
  cardExpYear  Int?

  // Estado
  isEnabled         Boolean   @default(true)
  failedAttempts    Int       @default(0)
  lastFailureReason String?
  lastPaymentAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([provider])
  @@map("billing_auto_payment_configs")
}

// =============================================================================
// MÓDULO DE NÓMINAS / PAYROLL
// =============================================================================

// Configuración de Nómina por Empresa
model PayrollConfig {
  id                  Int      @id @default(autoincrement())
  company_id          Int      @unique
  payment_frequency   String   @default("BIWEEKLY") // MONTHLY, BIWEEKLY
  first_payment_day   Int      @default(15)
  second_payment_day  Int      @default(30)
  quincena_percentage Decimal  @default(50) @db.Decimal(5, 2)
  payment_day_rule    String   @default("PREVIOUS_BUSINESS_DAY") // PREVIOUS_BUSINESS_DAY, NEXT_BUSINESS_DAY, EXACT
  max_advance_percent Decimal  @default(30) @db.Decimal(5, 2)
  max_active_advances Int      @default(1)
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  Company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("payroll_configs")
}

// Feriados / Días No Laborables
model CompanyHoliday {
  id          Int      @id @default(autoincrement())
  company_id  Int
  date        DateTime @db.Date
  name        String   @db.VarChar(255)
  is_national Boolean  @default(true)
  created_at  DateTime @default(now())

  Company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@unique([company_id, date])
  @@index([company_id, date])
  @@map("company_holidays")
}

// Componentes Salariales / Fórmulas
model SalaryComponent {
  id         Int    @id @default(autoincrement())
  company_id Int
  code       String @db.VarChar(50)
  name       String @db.VarChar(255)
  type       String @db.VarChar(20) // EARNING | DEDUCTION | EMPLOYER_COST

  // Tipo de concepto v4
  concept_type String @default("CALCULATED") @db.VarChar(30)
  // CALCULATED: fórmula automática
  // FIXED_INPUT: se carga en conceptos fijos del empleado
  // VARIABLE_INPUT: se carga por período
  // AGREEMENT_LINKED: toma valor de AgreementRate

  calc_type         String   @db.VarChar(20) // FIXED | PERCENTAGE | FORMULA | DAYS_BASED
  calc_value        Decimal? @db.Decimal(12, 4)
  calc_formula      String?
  base_variable     String   @default("GROSS_REMUNERATIVE") @db.VarChar(30)
  // GROSS_REMUNERATIVE | GROSS_TOTAL | BASIC | NET | AGREEMENT_DAILY_RATE
  depends_on        Int[]    @default([]) // IDs de componentes (validados)
  rounding_mode     String   @default("HALF_UP") @db.VarChar(20)
  rounding_decimals Int      @default(2)
  cap_min           Decimal? @db.Decimal(12, 2)
  cap_max           Decimal? @db.Decimal(12, 2)

  // FLAGS v4 - Argentina
  is_remunerative          Boolean @default(true) // Remunerativo vs No remunerativo
  affects_employee_contrib Boolean @default(true) // Base para aportes empleado
  affects_employer_contrib Boolean @default(true) // Base para contribuciones empleador
  affects_income_tax       Boolean @default(false) // Base para ganancias (futuro)

  is_taxable         Boolean  @default(true)
  is_active          Boolean  @default(true)
  apply_to           String   @default("ALL") @db.VarChar(100)
  prorate_on_partial Boolean  @default(true)
  order              Int      @default(0)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  Company            Company                   @relation(fields: [company_id], references: [id], onDelete: Cascade)
  employeeComponents EmployeeSalaryComponent[]
  payrollLines       PayrollItemLine[]

  // Nuevas relaciones v4
  categoryDefaults CategoryDefaultConcept[]
  employeeFixed    EmployeeFixedConcept[]
  variableConcepts PayrollVariableConcept[]
  runItemLines     PayrollRunItemLine[]

  @@unique([company_id, code])
  @@index([company_id, is_active])
  @@map("salary_components")
}

// Override de Componente por Empleado
model EmployeeSalaryComponent {
  id             Int       @id @default(autoincrement())
  employee_id    String    @db.VarChar(255)
  component_id   Int
  custom_value   Decimal?  @db.Decimal(12, 2)
  is_active      Boolean   @default(true)
  effective_from DateTime  @default(now())
  effective_to   DateTime?

  employee  Employee        @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  component SalaryComponent @relation(fields: [component_id], references: [id], onDelete: Cascade)

  @@index([employee_id, effective_from])
  @@index([component_id])
  @@map("employee_salary_components")
}

// Período de Nómina
model PayrollPeriod {
  id            Int      @id @default(autoincrement())
  company_id    Int
  union_id      Int? // v4.1: Período por Gremio (UOCRA = quincenal, Comercio = mensual)
  category_id   Int? // Legacy: Período por categoría (deprecated)
  period_type   String   @db.VarChar(20) // QUINCENA_1, QUINCENA_2, MONTHLY
  year          Int
  month         Int
  period_start  DateTime @db.Date
  period_end    DateTime @db.Date
  payment_date  DateTime @db.Date
  business_days Int
  is_closed     Boolean  @default(false)
  created_at    DateTime @default(now())

  Company  Company           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  union    PayrollUnion?     @relation("UnionPeriods", fields: [union_id], references: [id], onDelete: SetNull)
  category EmployeeCategory? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  payrolls Payroll[]
  inputs   PayrollInput[]

  // Nuevas relaciones v4
  runs             PayrollRun[]
  variableConcepts PayrollVariableConcept[]
  attendanceEvents AttendanceEvent[]

  @@unique([company_id, year, month, period_type, union_id])
  @@index([company_id, year, month])
  @@index([union_id])
  @@index([category_id])
  @@map("payroll_periods")
}

// Variables de Período por Empleado (días trabajados, ausencias, horas extra, etc.)
model PayrollInput {
  id          Int      @id @default(autoincrement())
  period_id   Int
  employee_id String   @db.VarChar(255)
  input_key   String   @db.VarChar(50)
  input_value Decimal  @db.Decimal(12, 4)
  meta        Json?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  period   PayrollPeriod @relation(fields: [period_id], references: [id], onDelete: Cascade)
  employee Employee      @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@unique([period_id, employee_id, input_key])
  @@index([period_id])
  @@index([employee_id])
  @@map("payroll_inputs")
}

// Liquidación de Nómina
model Payroll {
  id                  Int       @id @default(autoincrement())
  company_id          Int
  period_id           Int
  status              String    @default("DRAFT") @db.VarChar(20) // DRAFT, CALCULATED, APPROVED, PAID, CANCELLED
  total_gross         Decimal   @db.Decimal(14, 2)
  total_deductions    Decimal   @db.Decimal(14, 2)
  total_net           Decimal   @db.Decimal(14, 2)
  total_employer_cost Decimal   @db.Decimal(14, 2)
  employee_count      Int
  notes               String?
  calculated_at       DateTime?
  calculated_by       Int?
  approved_at         DateTime?
  approved_by         Int?
  paid_at             DateTime?
  paid_by             Int?
  cancelled_at        DateTime?
  cancelled_by        Int?
  cancel_reason       String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  Company   Company           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  period    PayrollPeriod     @relation(fields: [period_id], references: [id], onDelete: Cascade)
  items     PayrollItem[]
  advances  SalaryAdvance[]
  auditLogs PayrollAuditLog[]

  @@index([company_id, status])
  @@index([period_id])
  @@map("payrolls")
}

// Detalle de Liquidación por Empleado
model PayrollItem {
  id                  Int     @id @default(autoincrement())
  payroll_id          Int
  employee_id         String  @db.VarChar(255)
  cost_center_id      Int?
  days_worked         Int     @default(30)
  days_in_period      Int     @default(30)
  prorate_factor      Decimal @default(1) @db.Decimal(5, 4)
  base_salary         Decimal @db.Decimal(12, 2)
  total_earnings      Decimal @db.Decimal(12, 2)
  total_deductions    Decimal @db.Decimal(12, 2)
  advances_discounted Decimal @default(0) @db.Decimal(12, 2)
  net_salary          Decimal @db.Decimal(12, 2)
  employer_cost       Decimal @db.Decimal(12, 2)
  snapshot            Json

  payroll  Payroll           @relation(fields: [payroll_id], references: [id], onDelete: Cascade)
  employee Employee          @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  lines    PayrollItemLine[]

  @@unique([payroll_id, employee_id])
  @@index([payroll_id])
  @@index([employee_id])
  @@map("payroll_items")
}

// Línea de Detalle por Componente (normalizado para analytics)
model PayrollItemLine {
  id                Int     @id @default(autoincrement())
  payroll_item_id   Int
  component_id      Int?
  code              String  @db.VarChar(50)
  name              String  @db.VarChar(255)
  type              String  @db.VarChar(20) // EARNING | DEDUCTION
  base_amount       Decimal @db.Decimal(12, 2)
  calculated_amount Decimal @db.Decimal(12, 2)
  final_amount      Decimal @db.Decimal(12, 2)
  formula_used      String?
  meta              Json?

  payrollItem PayrollItem      @relation(fields: [payroll_item_id], references: [id], onDelete: Cascade)
  component   SalaryComponent? @relation(fields: [component_id], references: [id], onDelete: SetNull)

  @@index([payroll_item_id])
  @@index([code])
  @@index([component_id])
  @@map("payroll_item_lines")
}

// Adelantos de Sueldo
model SalaryAdvance {
  id                 Int       @id @default(autoincrement())
  company_id         Int
  employee_id        String    @db.VarChar(255)
  amount             Decimal   @db.Decimal(12, 2)
  installments_count Int       @default(1)
  installment_amount Decimal   @db.Decimal(12, 2)
  remaining_amount   Decimal   @db.Decimal(12, 2)
  request_date       DateTime  @default(now())
  status             String    @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, ACTIVE, COMPLETED, REJECTED, CANCELLED
  notes              String?
  approved_at        DateTime?
  approved_by        Int?
  rejected_at        DateTime?
  rejected_by        Int?
  reject_reason      String?
  payroll_id         Int?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  Company      Company              @relation(fields: [company_id], references: [id], onDelete: Cascade)
  employee     Employee             @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  payroll      Payroll?             @relation(fields: [payroll_id], references: [id], onDelete: SetNull)
  installments AdvanceInstallment[]

  @@index([company_id, status])
  @@index([employee_id])
  @@index([payroll_id])
  @@map("salary_advances")
}

// Cuotas de Adelanto
model AdvanceInstallment {
  id              Int       @id @default(autoincrement())
  advance_id      Int
  installment_num Int
  amount          Decimal   @db.Decimal(12, 2)
  due_period_id   Int?
  status          String    @default("PENDING") @db.VarChar(20) // PENDING, DISCOUNTED
  discounted_at   DateTime?
  payroll_item_id Int?

  advance SalaryAdvance @relation(fields: [advance_id], references: [id], onDelete: Cascade)

  @@index([advance_id])
  @@index([due_period_id, status])
  @@map("advance_installments")
}

// Auditoría de Nóminas
model PayrollAuditLog {
  id         Int      @id @default(autoincrement())
  payroll_id Int?
  run_id     Int? // v4: auditoría de corridas
  action     String   @db.VarChar(50) // CREATED, CALCULATED, RECALCULATED, APPROVED, PAID, CANCELLED, REOPENED, LOCKED
  user_id    Int
  details    Json?
  ip_address String?  @db.VarChar(50)
  created_at DateTime @default(now())

  payroll Payroll?    @relation(fields: [payroll_id], references: [id], onDelete: Cascade)
  run     PayrollRun? @relation(fields: [run_id], references: [id], onDelete: Cascade)

  @@index([payroll_id])
  @@index([run_id])
  @@index([user_id])
  @@map("payroll_audit_logs")
}

// =============================================================================
// MÓDULO DE NÓMINAS v4 - Modelos Adicionales
// =============================================================================

// Plantilla de Gremio (system-level, sin company_id)
model GremioTemplate {
  id                      Int      @id @default(autoincrement())
  code                    String   @unique @db.VarChar(50)
  name                    String   @db.VarChar(255)
  full_name               String?  @db.VarChar(500)
  convention_code         String?  @db.VarChar(50)
  payment_schedule_type   String   @default("BIWEEKLY_FIXED") @db.VarChar(50)
  payment_rule_json       Json?
  attendance_policy_json  Json?
  contribution_rules_json Json?
  description             String?
  is_active               Boolean  @default(true)
  created_at              DateTime @default(now())

  categories    GremioCategoryTemplate[]
  enabledUnions PayrollUnion[]

  @@map("gremio_templates")
}

// Plantilla de Categoría por Gremio (system-level)
model GremioCategoryTemplate {
  id                 Int      @id @default(autoincrement())
  gremio_template_id Int
  code               String?  @db.VarChar(50)
  name               String   @db.VarChar(255)
  group_name         String?  @db.VarChar(100)
  description        String?
  level              Int      @default(0)
  is_active          Boolean  @default(true)
  created_at         DateTime @default(now())

  gremioTemplate GremioTemplate @relation(fields: [gremio_template_id], references: [id], onDelete: Cascade)

  @@index([gremio_template_id])
  @@map("gremio_category_templates")
}

// Gremio/Sindicato - Define reglas de pago y convenio colectivo
model PayrollUnion {
  id              Int     @id @default(autoincrement())
  company_id      Int
  name            String  @db.VarChar(100) // UOCRA, Comercio, Fuera de Convenio
  code            String? @db.VarChar(20) // Código corto
  convention_code String? @db.VarChar(50) // Código convenio: 76/75

  // Regla de pago
  payment_schedule_type String @default("BIWEEKLY_FIXED") @db.VarChar(50)
  // BIWEEKLY_FIXED | BIWEEKLY_1_15_16_EOM | MONTHLY_SAME_MONTH | MONTHLY_NEXT_MONTH
  payment_rule_json     Json?

  // Política de asistencia del gremio
  attendance_policy_json Json?

  // Reglas de aportes y contribuciones
  contribution_rules_json Json? // { jubilacion: 11, obraSocial: 3, ... }

  // Origen de plantilla (si fue creado desde una plantilla del sistema)
  source_template_id Int?

  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  Company        Company         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  sourceTemplate GremioTemplate? @relation(fields: [source_template_id], references: [id], onDelete: SetNull)
  categories     UnionCategory[]
  periods        PayrollPeriod[] @relation("UnionPeriods")

  @@unique([company_id, name])
  @@index([company_id])
  @@index([source_template_id])
  @@map("payroll_unions")
}

// Categoría dentro del Gremio - Define escala salarial (OFICIAL, AYUDANTE, etc.)
model UnionCategory {
  id          Int     @id @default(autoincrement())
  union_id    Int
  name        String  @db.VarChar(100) // OFICIAL, MEDIO OFICIAL, AYUDANTE, SERENO
  code        String? @db.VarChar(20) // Código corto
  description String?
  level       Int     @default(0) // Nivel jerárquico para ordenar

  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  union           PayrollUnion             @relation(fields: [union_id], references: [id], onDelete: Cascade)
  employees       Employee[]               @relation("UnionCategoryEmployees")
  agreementRates  AgreementRate[]
  defaultConcepts CategoryDefaultConcept[]

  @@unique([union_id, name])
  @@index([union_id])
  @@map("union_categories")
}

// Sector/Área de Trabajo - Para centro de costo y reportes
model WorkSector {
  id               Int     @id @default(autoincrement())
  company_id       Int
  name             String  @db.VarChar(100) // Albañilería, Electricidad, Oficina
  code             String? @db.VarChar(20)
  description      String?
  cost_center_id   Int? // Opcional: vincular a centro de costo contable
  source_sector_id Int? // Si fue importado de Sector de mantenimiento

  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  Company      Company    @relation(fields: [company_id], references: [id], onDelete: Cascade)
  sourceSector Sector?    @relation("SectorToWorkSector", fields: [source_sector_id], references: [id], onDelete: SetNull)
  employees    Employee[] @relation("WorkSectorEmployees")

  @@unique([company_id, name])
  @@index([company_id])
  @@index([source_sector_id])
  @@map("work_sectors")
}

// Puestos de Trabajo por Sector (para asignar en rutinas de producción)
model WorkPosition {
  id          Int     @id @default(autoincrement())
  company_id  Int
  sector_id   Int // Sector al que pertenece este puesto
  name        String  @db.VarChar(100) // "Zunchado de Paquetes", "Mulero", etc.
  code        String? @db.VarChar(20)
  description String?
  is_active   Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  Company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)
  sector  Sector  @relation("SectorWorkPositions", fields: [sector_id], references: [id], onDelete: Cascade)

  @@unique([company_id, sector_id, name])
  @@index([company_id])
  @@index([sector_id])
  @@map("work_positions")
}

// Tasas de Convenio por Categoría Gremial (evita actualizar 45+ empleados manualmente)
model AgreementRate {
  id                Int       @id @default(autoincrement())
  company_id        Int
  union_category_id Int // Nueva FK a UnionCategory
  category_id       Int? // Legacy FK a EmployeeCategory (deprecated)
  effective_from    DateTime  @db.Date
  effective_to      DateTime? @db.Date

  // Valores del convenio
  daily_rate        Decimal  @db.Decimal(12, 2) // Valor día básico
  hourly_rate       Decimal? @db.Decimal(12, 2) // Valor hora
  presenteeism_rate Decimal? @db.Decimal(12, 2) // Valor presentismo/día
  seniority_pct     Decimal? @db.Decimal(5, 2) // % antigüedad por año

  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  Company       Company           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  unionCategory UnionCategory     @relation(fields: [union_category_id], references: [id], onDelete: Cascade)
  category      EmployeeCategory? @relation(fields: [category_id], references: [id], onDelete: SetNull)

  @@index([union_category_id, effective_from])
  @@index([category_id, effective_from])
  @@index([company_id])
  @@map("agreement_rates")
}

// Conceptos Default por Categoría Gremial (template para nuevos empleados)
model CategoryDefaultConcept {
  id                Int     @id @default(autoincrement())
  union_category_id Int // Nueva FK a UnionCategory
  category_id       Int? // Legacy FK a EmployeeCategory (deprecated)
  component_id      Int
  quantity          Decimal @default(1) @db.Decimal(10, 2)
  unit_amount       Decimal @default(0) @db.Decimal(12, 2)
  comment           String? @db.VarChar(500)
  no_delete         Boolean @default(false) // Concepto obligatorio
  order             Int     @default(0)

  created_at DateTime @default(now())

  unionCategory UnionCategory     @relation(fields: [union_category_id], references: [id], onDelete: Cascade)
  category      EmployeeCategory? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  component     SalaryComponent   @relation(fields: [component_id], references: [id], onDelete: Cascade)

  @@unique([union_category_id, component_id])
  @@index([union_category_id])
  @@index([category_id])
  @@map("category_default_concepts")
}

// Conceptos Fijos por Empleado (con vigencia para histórico de aumentos)
model EmployeeFixedConcept {
  id           Int    @id @default(autoincrement())
  employee_id  String @db.VarChar(255)
  component_id Int

  // Valores
  quantity    Decimal @db.Decimal(10, 2)
  unit_amount Decimal @db.Decimal(12, 2)
  comment     String? @db.VarChar(500)
  no_delete   Boolean @default(false)

  // VIGENCIA (crítico para aumentos)
  effective_from DateTime  @db.Date
  effective_to   DateTime? @db.Date // null = vigente

  // Origen
  source String @default("MANUAL") @db.VarChar(30)
  // MANUAL | CATEGORY_DEFAULT | AGREEMENT_TABLE | IMPORT

  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  created_by Int?

  employee  Employee        @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  component SalaryComponent @relation(fields: [component_id], references: [id], onDelete: Cascade)

  @@index([employee_id, effective_from])
  @@index([component_id])
  @@map("employee_fixed_concepts")
}

// Conceptos Variables por Período (adelantos, extras, descuentos)
model PayrollVariableConcept {
  id           Int    @id @default(autoincrement())
  period_id    Int
  employee_id  String @db.VarChar(255)
  component_id Int

  // Valores
  quantity         Decimal   @db.Decimal(10, 2)
  unit_amount      Decimal   @db.Decimal(12, 2)
  settlement_date  DateTime? @db.Date
  transaction_date DateTime? @db.Date
  comment          String?   @db.VarChar(500)

  // STATUS (permite aprobar antes de liquidar)
  status String @default("DRAFT") @db.VarChar(20)
  // DRAFT | APPROVED | VOID

  // ORIGEN (auditoría)
  source String @default("MANUAL") @db.VarChar(30)
  // MANUAL | IMPORT | ADVANCE_SYSTEM | ATTENDANCE | TIME_CLOCK

  created_by    Int?
  approved_by   Int?
  approved_at   DateTime?
  attachment_id Int? // Si adjunta comprobante

  created_at DateTime @default(now())

  period    PayrollPeriod   @relation(fields: [period_id], references: [id], onDelete: Cascade)
  employee  Employee        @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  component SalaryComponent @relation(fields: [component_id], references: [id], onDelete: Cascade)

  @@index([period_id, employee_id])
  @@index([status])
  @@map("payroll_variable_concepts")
}

// Eventos de Asistencia (faltas, llegadas tarde, licencias)
model AttendanceEvent {
  id          Int    @id @default(autoincrement())
  period_id   Int
  employee_id String @db.VarChar(255)
  event_type  String @db.VarChar(30)
  // ABSENCE | LATE_ARRIVAL | EARLY_LEAVE | VACATION | SICK_LEAVE | ACCIDENT | SUSPENSION

  event_date   DateTime @db.Date
  quantity     Decimal  @db.Decimal(5, 2) // Días u horas
  minutes_late Int? // Para llegadas tarde
  comment      String?

  // Si genera concepto variable automáticamente
  generated_concept_id Int?

  source String @default("MANUAL") @db.VarChar(30)
  // MANUAL | TIME_CLOCK | IMPORT | ROUTINE

  created_by Int?
  created_at DateTime @default(now())

  period   PayrollPeriod @relation(fields: [period_id], references: [id], onDelete: Cascade)
  employee Employee      @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@index([period_id, employee_id])
  @@index([event_type])
  @@map("attendance_events")
}

// Corrida de Liquidación (versión de cálculo de un período)
model PayrollRun {
  id         Int    @id @default(autoincrement())
  period_id  Int
  company_id Int
  run_number Int    @default(1) // 1, 2, 3... para recálculos
  run_type   String @default("REGULAR") @db.VarChar(20)
  // REGULAR | ADJUSTMENT | RETROACTIVE

  // Estado
  status String @default("DRAFT") @db.VarChar(20)
  // DRAFT | CALCULATED | APPROVED | PAID | VOID

  // Totales
  total_gross         Decimal @db.Decimal(14, 2)
  total_deductions    Decimal @db.Decimal(14, 2)
  total_net           Decimal @db.Decimal(14, 2)
  total_employer_cost Decimal @db.Decimal(14, 2)
  employee_count      Int

  // Auditoría
  calculated_at DateTime?
  calculated_by Int?
  approved_at   DateTime?
  approved_by   Int?
  paid_at       DateTime?
  paid_by       Int?
  locked_at     DateTime? // CRÍTICO: cuando se cierra, no se toca
  locked_by     Int?
  voided_at     DateTime?
  voided_by     Int?
  void_reason   String?

  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  period    PayrollPeriod     @relation(fields: [period_id], references: [id], onDelete: Cascade)
  Company   Company           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  items     PayrollRunItem[]
  auditLogs PayrollAuditLog[]

  @@unique([period_id, run_number])
  @@index([status])
  @@index([company_id])
  @@map("payroll_runs")
}

// Detalle de Liquidación por Empleado en una Corrida
model PayrollRunItem {
  id          Int    @id @default(autoincrement())
  run_id      Int
  employee_id String @db.VarChar(255)

  // Snapshot del empleado al momento del cálculo
  employee_snapshot Json // { category_id, category_name, hire_date, ... }

  // Cálculos
  days_worked    Int     @default(30)
  days_in_period Int     @default(30)
  prorate_factor Decimal @default(1) @db.Decimal(5, 4)

  base_salary         Decimal @db.Decimal(12, 2)
  gross_remunerative  Decimal @db.Decimal(12, 2)
  gross_total         Decimal @db.Decimal(12, 2)
  total_deductions    Decimal @db.Decimal(12, 2)
  advances_discounted Decimal @default(0) @db.Decimal(12, 2)
  net_salary          Decimal @db.Decimal(12, 2)
  employer_cost       Decimal @db.Decimal(12, 2)

  run      PayrollRun           @relation(fields: [run_id], references: [id], onDelete: Cascade)
  employee Employee             @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  lines    PayrollRunItemLine[]

  @@unique([run_id, employee_id])
  @@index([run_id])
  @@map("payroll_run_items")
}

// Línea de Detalle por Componente (para PayrollRunItem)
model PayrollRunItemLine {
  id           Int    @id @default(autoincrement())
  run_item_id  Int
  component_id Int?
  code         String @db.VarChar(50)
  name         String @db.VarChar(255)
  type         String @db.VarChar(20) // EARNING | DEDUCTION | EMPLOYER_COST

  quantity          Decimal @db.Decimal(10, 2)
  unit_amount       Decimal @db.Decimal(12, 2)
  base_amount       Decimal @db.Decimal(12, 2)
  calculated_amount Decimal @db.Decimal(12, 2)
  final_amount      Decimal @db.Decimal(12, 2)

  formula_used String?
  meta         Json?

  runItem   PayrollRunItem   @relation(fields: [run_item_id], references: [id], onDelete: Cascade)
  component SalaryComponent? @relation(fields: [component_id], references: [id], onDelete: SetNull)

  @@index([run_item_id])
  @@index([code])
  @@index([component_id])
  @@map("payroll_run_item_lines")
}

// =============================================
// SISTEMA DE COSTOS DE MANTENIMIENTO (PACK 6)
// =============================================

/// Desglose de costos de una orden de trabajo
model MaintenanceCostBreakdown {
  id          Int @id @default(autoincrement())
  workOrderId Int @unique
  companyId   Int

  // Costos desglosados
  laborCost      Decimal @default(0) @db.Decimal(12, 2) // Mano de obra interna
  sparePartsCost Decimal @default(0) @db.Decimal(12, 2) // Repuestos usados
  thirdPartyCost Decimal @default(0) @db.Decimal(12, 2) // Servicios externos
  extrasCost     Decimal @default(0) @db.Decimal(12, 2) // Otros costos
  totalCost      Decimal @default(0) @db.Decimal(12, 2) // Total calculado

  // Metadata
  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt
  notes        String?

  // Relaciones
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([calculatedAt])
  @@map("maintenance_cost_breakdowns")
}

/// Tarifas por hora de técnicos
model TechnicianCostRate {
  id        Int @id @default(autoincrement())
  userId    Int
  companyId Int

  hourlyRate   Decimal  @db.Decimal(10, 2) // Tarifa normal por hora
  overtimeRate Decimal? @db.Decimal(10, 2) // Tarifa horas extra (opcional)
  role         String? // Rol o especialidad del técnico
  currency     String   @default("ARS")
  isActive     Boolean  @default(true)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId, effectiveFrom])
  @@index([companyId, isActive])
  @@map("technician_cost_rates")
}

/// Costos de terceros (servicios externos)
model ThirdPartyCost {
  id          Int @id @default(autoincrement())
  workOrderId Int
  companyId   Int

  supplierName  String // Nombre del proveedor/tercero
  supplierRUT   String? // CUIT/RUT del proveedor
  description   String? // Descripción del servicio
  amount        Decimal   @db.Decimal(12, 2)
  currency      String    @default("ARS")
  costType      String // LABOR, PARTS, SERVICE, TRANSPORT, OTHER
  invoiceNumber String? // Número de factura
  invoiceDate   DateTime?

  createdAt   DateTime @default(now())
  createdById Int?

  // Relaciones
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User?     @relation("ThirdPartyCostCreator", fields: [createdById], references: [id])

  @@index([workOrderId])
  @@index([companyId])
  @@map("third_party_costs")
}

/// Presupuesto de mantenimiento
model MaintenanceBudget {
  id        Int  @id @default(autoincrement())
  companyId Int
  year      Int
  month     Int? // null = presupuesto anual
  sectorId  Int? // null = toda la empresa

  totalBudget      Decimal  @db.Decimal(14, 2)
  laborBudget      Decimal? @db.Decimal(14, 2)
  partsBudget      Decimal? @db.Decimal(14, 2)
  thirdPartyBudget Decimal? @db.Decimal(14, 2)

  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById Int?

  // Relaciones
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sector    Sector? @relation(fields: [sectorId], references: [id])
  createdBy User?   @relation("BudgetCreator", fields: [createdById], references: [id])

  @@unique([companyId, year, month, sectorId])
  @@index([companyId, year])
  @@map("maintenance_budgets")
}

// ============================================================================
// MOTOR DE AUTOMATIZACIONES
// ============================================================================

enum AutomationTriggerType {
  WORK_ORDER_CREATED // Nueva OT creada
  WORK_ORDER_STATUS_CHANGED // Cambio de estado de OT
  WORK_ORDER_ASSIGNED // OT asignada
  FAILURE_REPORTED // Falla reportada
  FAILURE_RECURRENCE // Falla recurrente (N ocurrencias en X días)
  STOCK_LOW // Stock bajo mínimo
  PREVENTIVE_DUE // Mantenimiento preventivo próximo
  MACHINE_STATUS_CHANGED // Cambio de estado de máquina
  SCHEDULED // Programado (cron)
}

enum AutomationExecutionStatus {
  PENDING // Pendiente de ejecución
  RUNNING // En ejecución
  COMPLETED // Completado exitosamente
  FAILED // Error en ejecución
  SKIPPED // Saltado (condiciones no cumplidas)
  SIMULATED // Simulación (modo test)
}

/// Regla de automatización
model AutomationRule {
  id          Int     @id @default(autoincrement())
  companyId   Int
  name        String // Nombre descriptivo
  description String? // Descripción detallada

  isActive   Boolean @default(true)
  isTestMode Boolean @default(false) // Solo simula, no ejecuta
  priority   Int     @default(100) // Menor = mayor prioridad

  // Configuración del trigger
  triggerType   AutomationTriggerType
  triggerConfig Json? // Configuración específica del trigger
  // Ej: { "statuses": ["URGENT"], "machineIds": [1,2] }

  // Condiciones (todas deben cumplirse)
  conditions Json @default("[]")
  // [{field, operator, value}]
  // Ej: [{"field":"priority","operator":"equals","value":"URGENT"}]

  // Acciones a ejecutar
  actions Json @default("[]")
  // [{type, config}]
  // Ej: [{"type":"NOTIFY_USER","config":{"userId":1,"message":"..."}}]

  // Estadísticas
  executionCount Int       @default(0)
  lastExecutedAt DateTime?

  // Auditoría
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  company    Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy  User                  @relation("AutomationRuleCreator", fields: [createdById], references: [id])
  executions AutomationExecution[]

  @@index([companyId, isActive])
  @@index([companyId, triggerType])
  @@map("automation_rules")
}

/// Log de ejecución de automatización
model AutomationExecution {
  id        Int @id @default(autoincrement())
  ruleId    Int
  companyId Int

  // Información del trigger
  triggerType String // Tipo de trigger que activó la regla
  triggerData Json // Datos del evento que disparó la ejecución

  // Resultado
  status           AutomationExecutionStatus @default(PENDING)
  conditionsPassed Boolean                   @default(false)
  actionsExecuted  Json? // Resultado de cada acción ejecutada
  errorMessage     String? // Mensaje de error si falló

  // Tiempos
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationMs  Int? // Duración en milisegundos

  // Relaciones
  rule    AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  company Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([companyId, startedAt])
  @@index([companyId, status])
  @@map("automation_executions")
}

// ============================================================================
// LIBRO DE IDEAS
// ============================================================================

enum IdeaCategory {
  SOLUCION_FALLA // Propuesta de solución a falla
  MEJORA_PROCESO // Mejora de proceso
  MEJORA_EQUIPO // Mejora de equipo/máquina
  SEGURIDAD // Mejora de seguridad
  AHORRO_COSTOS // Reducción de costos
  CALIDAD // Mejora de calidad
  OTRO
}

enum IdeaPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IdeaStatus {
  NEW // Recién creada
  UNDER_REVIEW // En evaluación
  APPROVED // Aprobada para implementar
  IN_PROGRESS // En implementación
  IMPLEMENTED // Implementada
  REJECTED // Rechazada
  ARCHIVED // Archivada
}

/// Idea de mejora o solución
model Idea {
  id          Int    @id @default(autoincrement())
  companyId   Int
  title       String
  description String @db.Text

  // Vinculación opcional a entidades relacionadas
  machineId           Int?
  componentId         Int?
  failureOccurrenceId Int? // Vinculación a falla específica
  workOrderId         Int? // Vinculación a OT específica

  // Categorización
  category IdeaCategory
  priority IdeaPriority @default(MEDIUM)
  tags     Json? // Tags adicionales

  // Workflow
  status       IdeaStatus @default(NEW)
  reviewedById Int?
  reviewedAt   DateTime?
  reviewNotes  String?    @db.Text

  // Implementación
  implementedAt       DateTime?
  implementedById     Int?
  implementationNotes String?   @db.Text

  // Metadata
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Adjuntos (URLs de archivos)
  attachments Json? // [{url, name, type, size}]

  // Relaciones
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  machine           Machine?           @relation(fields: [machineId], references: [id])
  component         Component?         @relation("IdeaComponent", fields: [componentId], references: [id])
  failureOccurrence FailureOccurrence? @relation(fields: [failureOccurrenceId], references: [id])
  workOrder         WorkOrder?         @relation(fields: [workOrderId], references: [id])
  createdBy         User               @relation("IdeaCreator", fields: [createdById], references: [id])
  reviewedBy        User?              @relation("IdeaReviewer", fields: [reviewedById], references: [id])
  implementedBy     User?              @relation("IdeaImplementer", fields: [implementedById], references: [id])
  votes             IdeaVote[]
  comments          IdeaComment[]

  @@index([companyId, status])
  @@index([companyId, category])
  @@index([companyId, createdAt])
  @@index([machineId])
  @@map("ideas")
}

/// Voto en una idea
model IdeaVote {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  userId    Int
  createdAt DateTime @default(now())

  // Relaciones
  idea Idea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([ideaId, userId])
  @@map("idea_votes")
}

/// Comentario en una idea
model IdeaComment {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  userId    Int
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  idea Idea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user User @relation("IdeaCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@index([ideaId])
  @@map("idea_comments")
}

// ============================================================================
// CENTRO DE COSTOS EMPRESARIAL V2
// ============================================================================

/// Configuración del sistema de costos por empresa
model CostSystemConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  version String @default("V1") // "V1" | "V2" | "HYBRID"

  // Fuentes habilitadas para V2
  usePayrollData  Boolean @default(false)
  useComprasData  Boolean @default(false)
  useVentasData   Boolean @default(false)
  useProdData     Boolean @default(false)
  useIndirectData Boolean @default(false)
  useMaintData    Boolean @default(false) // Read-only desde MaintenanceCostBreakdown

  // Simulación especial por tipo de empresa (solo habilitado por superadmin)
  enablePretensadosSim Boolean @default(false) // Viguetas×bancos, Bloques×placas, Adoquines×m²

  v2EnabledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relaciones
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("cost_system_configs")
}

/// Consolidación mensual de costos (SNAPSHOT pattern)
model MonthlyCostConsolidation {
  id        Int    @id @default(autoincrement())
  companyId Int
  month     String // Formato "2026-01"

  // Costos por categoría (calculados automáticamente)
  payrollCost     Decimal @default(0) @db.Decimal(14, 2) // Nóminas
  purchasesCost   Decimal @default(0) @db.Decimal(14, 2) // Compras
  indirectCost    Decimal @default(0) @db.Decimal(14, 2) // Indirectos
  productionCost  Decimal @default(0) @db.Decimal(14, 2) // Producción (insumos)
  maintenanceCost Decimal @default(0) @db.Decimal(14, 2) // Mantenimiento (read-only)

  // Ingresos
  salesRevenue Decimal @default(0) @db.Decimal(14, 2) // Ventas (facturado)
  salesCost    Decimal @default(0) @db.Decimal(14, 2) // COGS real o fallback
  grossMargin  Decimal @default(0) @db.Decimal(14, 2) // salesRevenue - salesCost

  // Totales
  totalCost    Decimal @default(0) @db.Decimal(14, 2) // SUM de todos los costos
  totalRevenue Decimal @default(0) @db.Decimal(14, 2)
  netResult    Decimal @default(0) @db.Decimal(14, 2) // totalRevenue - totalCost

  // Metadata - SNAPSHOT pattern
  calculatedAt   DateTime @default(now())
  calculatedById Int? // Usuario que recalculó
  version        String   @default("V1") // "V1" | "V2"
  details        Json? // Desglose detallado por fuente
  isClosed       Boolean  @default(false) // Período cerrado (no recalcular)

  // Relaciones
  company      Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  calculatedBy User?   @relation("CostConsolidationCalculator", fields: [calculatedById], references: [id])

  @@unique([companyId, month])
  @@index([companyId, month])
  @@map("monthly_cost_consolidations")
}

// ============================================================
// AUDIT LOG - Trazabilidad completa de operaciones
// ============================================================

model AuditLog {
  id Int @id @default(autoincrement())

  // Qué se auditó
  entityType String // WorkOrder, FailureOccurrence, PTW, Machine, etc.
  entityId   Int // ID de la entidad

  // Qué pasó
  action AuditAction

  // Detalle del cambio
  fieldChanged String? // Campo específico que cambió
  oldValue     Json? // Valor anterior
  newValue     Json? // Valor nuevo
  summary      String? // Resumen legible del cambio

  // Quién y cuándo
  performedById Int?
  performedBy   User?    @relation("AuditPerformedBy", fields: [performedById], references: [id])
  performedAt   DateTime @default(now())

  // Contexto adicional
  ipAddress String?
  userAgent String?
  sessionId String?
  notes     String?

  // Multi-tenancy
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([performedById])
  @@index([performedAt])
  @@index([companyId, entityType])
  @@index([companyId, performedAt])
  @@map("audit_logs")
}

// ============================================================
// CMMS: PTW/LOTO MODELS (Permit to Work / Lockout-Tagout)
// ============================================================

// LOTO Procedure: Template for lockout-tagout procedures per machine
model LOTOProcedure {
  id          Int     @id @default(autoincrement())
  machineId   Int
  name        String
  description String?
  version     Int     @default(1)

  // Energy sources to isolate
  // Format: [{"type": "ELECTRICAL", "location": "Panel A", "method": "Breaker 15", "verification": "Multimeter test"}]
  energySources Json @default("[]")

  // Steps for lockout procedure
  // Format: [{"order": 1, "description": "Turn off main breaker", "energySourceId": 1, "photo": "url"}]
  lockoutSteps Json @default("[]")

  // Steps for verification (zero energy state)
  // Format: [{"order": 1, "description": "Try start button", "expectedResult": "No movement"}]
  verificationSteps Json @default("[]")

  // Steps for restoration
  // Format: [{"order": 1, "description": "Remove all locks", "warning": "Verify area clear"}]
  restorationSteps Json @default("[]")

  // Verification method after lockout
  verificationMethod String?

  // PPE required during LOTO
  requiredPPE Json? @default("[]")

  // Estimated time in minutes
  estimatedMinutes Int?

  // Warnings and special considerations
  warnings              String?
  specialConsiderations String?

  // Status
  isActive     Boolean   @default(true)
  isApproved   Boolean   @default(false)
  approvedById Int?
  approvedAt   DateTime?

  // Metadata
  companyId   Int
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  machine    Machine         @relation(fields: [machineId], references: [id], onDelete: Cascade)
  company    Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy  User            @relation("LOTOProcedureCreator", fields: [createdById], references: [id])
  approvedBy User?           @relation("LOTOProcedureApprover", fields: [approvedById], references: [id])
  executions LOTOExecution[]

  @@index([machineId])
  @@index([companyId])
  @@index([isActive])
  @@map("loto_procedures")
}

// Permit to Work: Safety permit for hazardous work
model PermitToWork {
  id     Int       @id @default(autoincrement())
  number String // PTW-2024-0001
  type   PTWType
  status PTWStatus @default(DRAFT)

  // Linked entities
  workOrderId Int?
  machineId   Int?
  sectorId    Int?

  // Description of work
  title        String
  description  String  @db.Text
  workLocation String?

  // Hazards and controls
  // Format: [{"hazard": "Fire", "severity": "HIGH", "controls": ["Fire extinguisher nearby"]}]
  hazardsIdentified Json @default("[]")
  // Format: [{"measure": "Fire watch", "responsible": "John Doe", "verified": true}]
  controlMeasures   Json @default("[]")
  // Format: [{"type": "HELMET", "mandatory": true, "specification": "Heat resistant"}]
  requiredPPE       Json @default("[]")

  // Emergency procedures
  emergencyProcedures String?
  emergencyContacts   Json?   @default("[]")

  // Validity period
  validFrom DateTime
  validTo   DateTime

  // Request flow
  requestedById Int
  requestedAt   DateTime @default(now())

  // Approval flow (segregation of duties: requestedBy != approvedBy)
  approvedById  Int?
  approvedAt    DateTime?
  approvalNotes String?

  // Rejection (if rejected)
  rejectedById    Int?
  rejectedAt      DateTime?
  rejectionReason String?

  // Activation (when work starts)
  activatedById Int?
  activatedAt   DateTime?

  // Suspension (if temporarily stopped)
  suspendedById    Int?
  suspendedAt      DateTime?
  suspensionReason String?
  resumedById      Int?
  resumedAt        DateTime?

  // Closure
  closedById                Int?
  closedAt                  DateTime?
  closeNotes                String?
  workCompletedSuccessfully Boolean?

  // Final verification checklist
  // Format: [{"item": "All workers evacuated", "verified": true, "verifiedById": 1}]
  finalVerificationChecklist Json?     @default("[]")
  finalVerifiedById          Int?
  finalVerifiedAt            DateTime?

  // PPE verification
  ppeVerifiedById Int?
  ppeVerifiedAt   DateTime?

  // Signatures (digital)
  // Format: [{"userId": 1, "role": "REQUESTER", "signedAt": "2024-01-01T00:00:00Z", "ipAddress": "..."}]
  signatures Json? @default("[]")

  // Attachments
  // Format: [{"name": "JSA Form", "url": "...", "type": "PDF"}]
  attachments Json? @default("[]")

  // Metadata
  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workOrder       WorkOrder?      @relation(fields: [workOrderId], references: [id])
  machine         Machine?        @relation(fields: [machineId], references: [id])
  sector          Sector?         @relation(fields: [sectorId], references: [id])
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requestedBy     User            @relation("PTWRequested", fields: [requestedById], references: [id])
  approvedBy      User?           @relation("PTWApproved", fields: [approvedById], references: [id])
  rejectedBy      User?           @relation("PTWRejected", fields: [rejectedById], references: [id])
  activatedBy     User?           @relation("PTWActivated", fields: [activatedById], references: [id])
  suspendedBy     User?           @relation("PTWSuspended", fields: [suspendedById], references: [id])
  resumedBy       User?           @relation("PTWResumed", fields: [resumedById], references: [id])
  closedBy        User?           @relation("PTWClosed", fields: [closedById], references: [id])
  finalVerifiedBy User?           @relation("PTWFinalVerified", fields: [finalVerifiedById], references: [id])
  ppeVerifiedBy   User?           @relation("PTWPPEVerified", fields: [ppeVerifiedById], references: [id])
  lotoExecutions  LOTOExecution[]

  @@unique([number, companyId])
  @@index([status])
  @@index([type])
  @@index([companyId, status])
  @@index([workOrderId])
  @@index([machineId])
  @@index([validTo])
  @@map("permits_to_work")
}

// LOTO Execution: Actual lockout-tagout event linked to work
model LOTOExecution {
  id          Int  @id @default(autoincrement())
  procedureId Int
  workOrderId Int
  ptwId       Int? // Optional link to Permit to Work

  // Status
  status LOTOStatus @default(LOCKED)

  // Lock application
  lockedById Int
  lockedAt   DateTime @default(now())

  // Lock details
  // Format: [{"lockNumber": "L-001", "location": "Panel A", "energySource": "Electrical", "lockedById": 1, "lockedAt": "..."}]
  lockDetails Json @default("[]")

  // Zero energy verification
  zeroEnergyVerified          Boolean   @default(false)
  zeroEnergyVerifiedById      Int?
  zeroEnergyVerifiedAt        DateTime?
  zeroEnergyVerificationPhoto String? // URL to photo proof
  // Format: [{"step": "Try start button", "result": "OK", "verifiedById": 1, "verifiedAt": "..."}]
  zeroEnergyChecklist         Json?     @default("[]")

  // Unlock (when work complete)
  unlockedById            Int?
  unlockedAt              DateTime?
  unlockVerificationPhoto String?

  // All workers accounted for before unlock
  // Format: [{"userId": 1, "name": "John Doe", "confirmedAt": "..."}]
  workersAccountedFor Json? @default("[]")

  // Notes
  notes             String?
  incidentsReported String?

  // Metadata
  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  procedure            LOTOProcedure @relation(fields: [procedureId], references: [id])
  workOrder            WorkOrder     @relation(fields: [workOrderId], references: [id])
  ptw                  PermitToWork? @relation(fields: [ptwId], references: [id])
  company              Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lockedBy             User          @relation("LOTOLockedBy", fields: [lockedById], references: [id])
  zeroEnergyVerifiedBy User?         @relation("LOTOZeroEnergyVerifiedBy", fields: [zeroEnergyVerifiedById], references: [id])
  unlockedBy           User?         @relation("LOTOUnlockedBy", fields: [unlockedById], references: [id])

  @@index([procedureId])
  @@index([workOrderId])
  @@index([ptwId])
  @@index([status])
  @@index([companyId, status])
  @@map("loto_executions")
}

// ============================================================
// CMMS: FMEA - Failure Modes and Effects Analysis
// ============================================================

model ComponentFailureMode {
  id          Int @id @default(autoincrement())
  componentId Int
  companyId   Int

  // Basic info
  name        String // Nombre del modo de falla (ej: "Desgaste de rodamiento")
  code        String? // Código interno (ej: "FM-001")
  description String? // Descripción detallada
  category    String? // Categoría (Mecánica, Eléctrica, Hidráulica, etc.)

  // Symptoms and causes
  symptoms Json? @default("[]") // Array de síntomas típicos
  // Format: [{"symptom": "Vibración excesiva", "severity": "high"}, ...]
  causes   Json? @default("[]") // Causas comunes
  // Format: [{"cause": "Lubricación insuficiente", "probability": "high"}, ...]
  effects  Json? @default("[]") // Efectos en producción/seguridad
  // Format: [{"effect": "Parada de línea", "impactType": "production", "severity": "critical"}, ...]

  // FMEA Scores (1-10)
  detectability Int? // Dificultad de detección (1=fácil, 10=difícil)
  severity      Int? // Severidad del impacto (1=menor, 10=catastrófico)
  occurrence    Int? // Frecuencia de ocurrencia (1=raro, 10=muy frecuente)
  rpn           Int? // Risk Priority Number = detectability * severity * occurrence

  // Recommended actions
  recommendedActions   Json?   @default("[]")
  // Format: [{"action": "Inspección mensual", "type": "preventive", "frequency": "monthly"}, ...]
  preventiveMeasures   String? // Medidas preventivas recomendadas
  predictiveIndicators String? // Indicadores predictivos a monitorear

  // Status and metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([componentId, name])
  @@index([componentId])
  @@index([companyId])
  @@index([category])
  @@index([rpn])
  @@map("component_failure_modes")
}

// ============================================================
// CMMS: Skills & Certifications System
// ============================================================

enum CertificationStatus {
  ACTIVE
  EXPIRED
  PENDING_RENEWAL
  REVOKED
}

model Skill {
  id          Int      @id @default(autoincrement())
  companyId   Int
  name        String // Nombre de la habilidad (ej: "Soldadura TIG")
  code        String? // Código interno (ej: "SK-001")
  category    String // Categoría (Mecánica, Eléctrica, Hidráulica, Instrumentación, etc.)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company          Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userSkills       UserSkill[]
  taskRequirements TaskSkillRequirement[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([category])
  @@map("skills")
}

model UserSkill {
  id               Int       @id @default(autoincrement())
  userId           Int
  skillId          Int
  level            Int       @default(1) // 1-5 (1=Básico, 2=Intermedio, 3=Avanzado, 4=Experto, 5=Instructor)
  certifiedAt      DateTime? // Fecha de certificación
  expiresAt        DateTime? // Fecha de vencimiento (null = no vence)
  certificationDoc String? // URL al documento de certificación
  verifiedById     Int? // Usuario que verificó/aprobó la habilidad
  verifiedAt       DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user       User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill      Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)
  verifiedBy User? @relation("SkillVerifiedBy", fields: [verifiedById], references: [id])

  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
  @@index([expiresAt])
  @@map("user_skills")
}

model UserCertification {
  id          Int                 @id @default(autoincrement())
  userId      Int
  companyId   Int
  name        String // Nombre de la certificación (ej: "Operador de Autoelevadores")
  code        String? // Código interno
  issuedBy    String // Organismo emisor (ej: "IRAM", "Ministerio de Trabajo")
  issuedAt    DateTime // Fecha de emisión
  expiresAt   DateTime? // Fecha de vencimiento (null = no vence)
  documentUrl String? // URL al documento
  status      CertificationStatus @default(ACTIVE)
  category    String? // Categoría (Seguridad, Calidad, Operación, etc.)
  notes       String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@index([expiresAt])
  @@map("user_certifications")
}

model TaskSkillRequirement {
  id        Int     @id @default(autoincrement())
  skillId   Int
  minLevel  Int     @default(1) // Nivel mínimo requerido (1-5)
  companyId Int
  isActive  Boolean @default(true)

  // Puede vincularse a diferentes entidades (solo uno a la vez)
  checklistId     Int? // Requerido para ejecutar este checklist
  machineId       Int? // Requerido para trabajar en esta máquina
  maintenanceType String? // Requerido para este tipo de mantenimiento
  ptwType         String? // Requerido para este tipo de PTW (castear a PTWType)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  skill     Skill                 @relation(fields: [skillId], references: [id], onDelete: Cascade)
  company   Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  checklist MaintenanceChecklist? @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  machine   Machine?              @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@index([companyId])
  @@index([checklistId])
  @@index([machineId])
  @@index([maintenanceType])
  @@map("task_skill_requirements")
}

// ============================================================
// CMMS PHASE 5: MACHINE COUNTERS - Usage-Based Maintenance
// ============================================================

model MachineCounter {
  id              Int       @id @default(autoincrement())
  machineId       Int
  name            String // "Horas de operación", "Ciclos", "Kilómetros"
  unit            String // "horas", "ciclos", "km", "unidades"
  currentValue    Decimal   @default(0)
  lastReadingAt   DateTime?
  lastReadingById Int?
  source          String    @default("MANUAL") // MANUAL, IOT, PLC
  companyId       Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  machine       Machine                     @relation(fields: [machineId], references: [id], onDelete: Cascade)
  lastReadingBy User?                       @relation("CounterLastReadingBy", fields: [lastReadingById], references: [id])
  company       Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  readings      MachineCounterReading[]
  triggers      CounterMaintenanceTrigger[]

  @@index([machineId])
  @@index([companyId])
  @@map("machine_counters")
}

model MachineCounterReading {
  id            Int      @id @default(autoincrement())
  counterId     Int
  value         Decimal
  previousValue Decimal?
  delta         Decimal?
  recordedAt    DateTime @default(now())
  recordedById  Int
  source        String   @default("MANUAL") // MANUAL, IOT, PLC
  notes         String?

  // Relations
  counter    MachineCounter @relation(fields: [counterId], references: [id], onDelete: Cascade)
  recordedBy User           @relation("CounterReadingRecordedBy", fields: [recordedById], references: [id])

  @@index([counterId])
  @@index([recordedAt])
  @@map("machine_counter_readings")
}

model CounterMaintenanceTrigger {
  id                 Int      @id @default(autoincrement())
  counterId          Int
  checklistId        Int
  triggerEvery       Decimal // Cada X unidades
  lastTriggeredValue Decimal  @default(0)
  nextTriggerValue   Decimal?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  counter   MachineCounter       @relation(fields: [counterId], references: [id], onDelete: Cascade)
  checklist MaintenanceChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([counterId])
  @@index([checklistId])
  @@map("counter_maintenance_triggers")
}

// ============================================================
// CMMS: MANAGEMENT OF CHANGE (MOC)
// ============================================================

enum MOCChangeType {
  EQUIPMENT
  PROCESS
  PROCEDURE
  MATERIAL
  PERSONNEL
}

enum MOCStatus {
  DRAFT
  PENDING_REVIEW
  UNDER_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTING
  COMPLETED
  CANCELLED
}

model ManagementOfChange {
  id          Int           @id @default(autoincrement())
  mocNumber   String        @unique
  title       String
  description String        @db.Text
  changeType  MOCChangeType
  priority    Priority      @default(MEDIUM)
  status      MOCStatus     @default(DRAFT)

  // Justificación y alcance
  justification    String? @db.Text
  scope            String? @db.Text
  impactAssessment String? @db.Text
  riskAssessment   String? @db.Text

  // Fechas
  requestedDate    DateTime  @default(now())
  plannedStartDate DateTime?
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  // Entidades afectadas
  machineId   Int?
  componentId Int?
  areaId      Int?
  sectorId    Int?

  // Usuarios
  requestedById   Int
  reviewedById    Int?
  approvedById    Int?
  implementedById Int?

  // Aprobación
  approvalDate    DateTime?
  approvalNotes   String?   @db.Text
  rejectionReason String?   @db.Text

  // Metadatos
  isTemporary       Boolean   @default(false)
  temporaryUntil    DateTime?
  requiresTraining  Boolean   @default(false)
  trainingCompleted Boolean   @default(false)

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  machine       Machine?   @relation(fields: [machineId], references: [id])
  component     Component? @relation(fields: [componentId], references: [id])
  area          Area?      @relation(fields: [areaId], references: [id])
  sector        Sector?    @relation(fields: [sectorId], references: [id])
  requestedBy   User       @relation("MOCRequestedBy", fields: [requestedById], references: [id])
  reviewedBy    User?      @relation("MOCReviewedBy", fields: [reviewedById], references: [id])
  approvedBy    User?      @relation("MOCApprovedBy", fields: [approvedById], references: [id])
  implementedBy User?      @relation("MOCImplementedBy", fields: [implementedById], references: [id])
  company       Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  documents MOCDocument[]
  history   MOCHistory[]
  tasks     MOCTask[]

  @@index([companyId, status])
  @@index([machineId])
  @@index([requestedById])
  @@map("management_of_change")
}

model MOCDocument {
  id           Int      @id @default(autoincrement())
  mocId        Int
  name         String
  fileUrl      String
  fileType     String?
  documentType String? // BEFORE_PHOTO, AFTER_PHOTO, PROCEDURE, DRAWING, OTHER
  uploadedById Int
  uploadedAt   DateTime @default(now())

  // Relations
  moc        ManagementOfChange @relation(fields: [mocId], references: [id], onDelete: Cascade)
  uploadedBy User               @relation("MOCDocumentUploadedBy", fields: [uploadedById], references: [id])

  @@index([mocId])
  @@map("moc_documents")
}

model MOCHistory {
  id          Int      @id @default(autoincrement())
  mocId       Int
  fromStatus  String?
  toStatus    String
  changedById Int
  changedAt   DateTime @default(now())
  notes       String?  @db.Text

  // Relations
  moc       ManagementOfChange @relation(fields: [mocId], references: [id], onDelete: Cascade)
  changedBy User               @relation("MOCHistoryChangedBy", fields: [changedById], references: [id])

  @@index([mocId])
  @@map("moc_history")
}

model MOCTask {
  id            Int       @id @default(autoincrement())
  mocId         Int
  title         String
  description   String?   @db.Text
  sequence      Int       @default(0)
  status        String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, SKIPPED
  assignedToId  Int?
  dueDate       DateTime?
  completedAt   DateTime?
  completedById Int?
  notes         String?   @db.Text

  // Relations
  moc         ManagementOfChange @relation(fields: [mocId], references: [id], onDelete: Cascade)
  assignedTo  User?              @relation("MOCTaskAssignedTo", fields: [assignedToId], references: [id])
  completedBy User?              @relation("MOCTaskCompletedBy", fields: [completedById], references: [id])

  @@index([mocId])
  @@map("moc_tasks")
}

// ============================================
// MÓDULO DE PRODUCCIÓN
// Sistema de Producción Industrial (MES liviano)
// ============================================

// === TURNOS DE TRABAJO ===
model WorkShift {
  id           Int      @id @default(autoincrement())
  code         String
  name         String
  type         String // 'MORNING', 'AFTERNOON', 'NIGHT', 'SPLIT', custom
  startTime    String // "06:00"
  endTime      String // "14:00"
  breakMinutes Int      @default(30)
  isActive     Boolean  @default(true)
  companyId    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company                 Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  dailyReports            DailyProductionReport[]
  downtimes               ProductionDowntime[]
  routines                ProductionRoutine[]
  dailyProductionSessions DailyProductionSession[] @relation("SessionShift")

  @@unique([companyId, code])
  @@index([companyId, isActive])
  @@map("work_shifts")
}

// === CENTRO DE TRABAJO (genérico) ===
// Representa: Línea, Máquina, Estación, Célula, Cama, Molde, etc.
model WorkCenter {
  id          Int     @id @default(autoincrement())
  code        String
  name        String
  type        String // 'LINE', 'MACHINE', 'STATION', 'CELL', 'MOLD', custom
  description String?

  // Jerarquía opcional
  parentId Int?
  parent   WorkCenter?  @relation("WorkCenterHierarchy", fields: [parentId], references: [id])
  children WorkCenter[] @relation("WorkCenterHierarchy")

  // Capacidad (opcional, para OEE PRO)
  theoreticalCapacity  Decimal? @db.Decimal(12, 4)
  capacityUnit         String? // "unidades/hora", "m3/turno"
  standardCycleSeconds Int?
  standardSetupMinutes Int?

  // Estado
  status String @default("ACTIVE") // ACTIVE, MAINTENANCE, INACTIVE

  // Vincular con Machine existente (si aplica)
  machineId Int?
  machine   Machine? @relation(fields: [machineId], references: [id])

  // Vincular con Line existente (si aplica)
  lineId String?
  line   Line?   @relation(fields: [lineId], references: [id])

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company                Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  productionOrders       ProductionOrder[]
  dailyReports           DailyProductionReport[]
  downtimes              ProductionDowntime[]
  routines               ProductionRoutine[]
  routineTemplates       ProductionRoutineTemplate[]
  prestressedMolds       PrestressedMold[]
  productionResources    ProductionResource[]
  dailyProductionEntries DailyProductionEntry[]

  @@unique([companyId, code])
  @@index([companyId, type, status])
  @@map("work_centers")
}

// === REASON CODES (jerárquicos, configurables) ===
model ProductionReasonCode {
  id   Int    @id @default(autoincrement())
  code String
  name String
  type String // 'DOWNTIME', 'SCRAP', 'REWORK', 'QUALITY_HOLD'

  // Jerarquía: categoría → motivo → submotivo
  parentId Int?
  parent   ProductionReasonCode?  @relation("ReasonHierarchy", fields: [parentId], references: [id])
  children ProductionReasonCode[] @relation("ReasonHierarchy")

  // Comportamiento
  requiresNote        Boolean @default(false)
  triggersMaintenance Boolean @default(false) // Si true, sugiere crear OT
  affectsOEE          Boolean @default(true)

  // Orden de display
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  downtimes ProductionDowntime[]
  defects   ProductionDefect[]

  @@unique([companyId, code])
  @@index([companyId, type, isActive])
  @@map("production_reason_codes")
}

// === ORDEN DE PRODUCCIÓN ===
model ProductionOrder {
  id   Int    @id @default(autoincrement())
  code String // "OP-2025-00001" (auto)

  // Producto
  productId        String
  product          CostProduct @relation(fields: [productId], references: [id])
  productVariantId String? // Si aplica variantes
  recipeId         String?
  recipe           Recipe?     @relation(fields: [recipeId], references: [id])

  // Cantidades
  plannedQuantity  Decimal @db.Decimal(12, 4)
  producedQuantity Decimal @default(0) @db.Decimal(12, 4)
  scrapQuantity    Decimal @default(0) @db.Decimal(12, 4)
  reworkQuantity   Decimal @default(0) @db.Decimal(12, 4)
  targetUom        String // "unidades", "m2", "metros", "toneladas"

  // PRO: tiempos estándar
  plannedCycleTimeSec Int?
  plannedSetupMinutes Int?

  // Fechas
  plannedStartDate DateTime
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  // Asignación
  workCenterId  Int?
  workCenter    WorkCenter? @relation(fields: [workCenterId], references: [id])
  sectorId      Int?
  sector        Sector?     @relation(fields: [sectorId], references: [id])
  responsibleId Int?
  responsible   User?       @relation("ProductionOrderResponsible", fields: [responsibleId], references: [id])

  // Estado
  status   String @default("DRAFT")
  // DRAFT, RELEASED, IN_PROGRESS, PAUSED, COMPLETED, CANCELLED
  priority String @default("NORMAL")
  // LOW, NORMAL, HIGH, URGENT

  notes String?

  companyId   Int
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User    @relation("ProductionOrderCreator", fields: [createdById], references: [id])

  // Relaciones
  dailyReports      DailyProductionReport[]
  downtimes         ProductionDowntime[]
  qualityControls   ProductionQualityControl[]
  batchLots         ProductionBatchLot[]
  events            ProductionEvent[]
  defects           ProductionDefect[]
  curingRecords     CuringRecord[]
  // Módulo Almacén
  stockReservations StockReservation[]
  materialRequests  MaterialRequest[]
  despachos         Despacho[]
  stockMovements    StockMovement[]            @relation("StockMovementProductionOrder")

  @@unique([companyId, code])
  @@index([companyId, status])
  @@index([productId])
  @@index([workCenterId])
  @@index([plannedStartDate])
  @@map("production_orders")
}

// === PARTE DIARIO DE PRODUCCIÓN ===
model DailyProductionReport {
  id Int @id @default(autoincrement())

  // Contexto
  date              DateTime         @db.Date
  shiftId           Int
  shift             WorkShift        @relation(fields: [shiftId], references: [id])
  productionOrderId Int?
  productionOrder   ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  workCenterId      Int?
  workCenter        WorkCenter?      @relation(fields: [workCenterId], references: [id])

  // Equipo
  operatorId   Int
  operator     User  @relation("DailyReportOperator", fields: [operatorId], references: [id])
  supervisorId Int?
  supervisor   User? @relation("DailyReportSupervisor", fields: [supervisorId], references: [id])
  teamSize     Int? // Cantidad de personas en el turno
  crewMembers  Json? // [{userId, role}] - opcional

  // Producción
  goodQuantity   Decimal @db.Decimal(12, 4)
  scrapQuantity  Decimal @default(0) @db.Decimal(12, 4)
  reworkQuantity Decimal @default(0) @db.Decimal(12, 4)
  uom            String // "unidades", "m2", "metros"

  // Desglose por variante (opcional)
  variantBreakdown Json? // [{variantCode, quantity, uom}]

  // Tiempos
  shiftDurationMinutes Int
  productiveMinutes    Int
  downtimeMinutes      Int @default(0)
  setupMinutes         Int @default(0)

  // Observaciones
  observations   String?
  issues         String?
  attachmentUrls Json? // URLs de fotos/documentos

  // Confirmación
  isConfirmed   Boolean   @default(false)
  confirmedAt   DateTime?
  confirmedById Int?
  confirmedBy   User?     @relation("DailyReportConfirmer", fields: [confirmedById], references: [id])

  // Revisión opcional (segundo nivel)
  isReviewed   Boolean   @default(false)
  reviewedAt   DateTime?
  reviewedById Int?
  reviewedBy   User?     @relation("DailyReportReviewer", fields: [reviewedById], references: [id])
  reviewNotes  String?

  // Offline sync
  offlineId String?
  syncedAt  DateTime?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company         Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  downtimes       ProductionDowntime[]
  qualityControls ProductionQualityControl[]
  defects         ProductionDefect[]
  // Módulo Almacén
  stockMovements  StockMovement[]

  @@unique([companyId, offlineId])
  @@index([companyId, date])
  @@index([productionOrderId])
  @@index([operatorId, date])
  @@map("daily_production_reports")
}

// === PARADAS DE PRODUCCIÓN ===
model ProductionDowntime {
  id Int @id @default(autoincrement())

  // Contexto
  dailyReportId     Int?
  dailyReport       DailyProductionReport? @relation(fields: [dailyReportId], references: [id])
  productionOrderId Int?
  productionOrder   ProductionOrder?       @relation(fields: [productionOrderId], references: [id])
  shiftId           Int?
  shift             WorkShift?             @relation(fields: [shiftId], references: [id])
  workCenterId      Int?
  workCenter        WorkCenter?            @relation(fields: [workCenterId], references: [id])
  machineId         Int? // Si es específico de una máquina
  machine           Machine?               @relation("ProductionDowntimeMachine", fields: [machineId], references: [id])

  // Tipo y Reason Code
  type         String // 'PLANNED', 'UNPLANNED'
  reasonCodeId Int?
  reasonCode   ProductionReasonCode? @relation(fields: [reasonCodeId], references: [id])

  // Detalle
  description String
  rootCause   String?

  // Tiempos
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int? // Calculado o manual

  // Alcance
  affectsLine Boolean @default(true) // Paro total vs parcial
  isMicrostop Boolean @default(false) // PRO: <5 min

  // Detección
  detectedBy String @default("MANUAL") // 'MANUAL', 'SUPERVISOR', 'SENSOR'

  // Vinculación Mantenimiento
  workOrderId         Int?
  workOrder           WorkOrder? @relation("ProductionDowntimeWorkOrder", fields: [workOrderId], references: [id])
  failureOccurrenceId Int?

  // Vinculación Calidad
  qualityHoldId Int? // Si derivó en retención de lote

  // Reportado por
  reportedById Int
  reportedBy   User @relation("DowntimeReportedBy", fields: [reportedById], references: [id])

  // Offline
  offlineId String?
  syncedAt  DateTime?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, offlineId])
  @@index([companyId, startTime])
  @@index([reasonCodeId])
  @@index([workOrderId])
  @@index([machineId, startTime])
  @@map("production_downtimes")
}

// === CONTROL DE CALIDAD ===
model ProductionQualityControl {
  id Int @id @default(autoincrement())

  // Contexto
  dailyReportId     Int?
  dailyReport       DailyProductionReport? @relation(fields: [dailyReportId], references: [id])
  productionOrderId Int?
  productionOrder   ProductionOrder?       @relation(fields: [productionOrderId], references: [id])
  batchLotId        Int?
  batchLot          ProductionBatchLot?    @relation(fields: [batchLotId], references: [id])

  // Inspección
  controlType   String // 'VISUAL', 'DIMENSIONAL', 'FUNCTIONAL', custom
  parameter     String? // Parámetro medido
  expectedValue String?
  actualValue   String?
  unit          String?

  // Resultado
  result          String // 'APPROVED', 'REJECTED', 'HOLD', 'PENDING'
  rejectionReason String?

  // Inspector
  inspectedById Int
  inspectedBy   User     @relation("QualityControlInspector", fields: [inspectedById], references: [id])
  inspectedAt   DateTime @default(now())

  // Evidencia
  notes          String?
  attachmentUrls Json?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productionOrderId])
  @@index([batchLotId])
  @@index([result])
  @@map("production_quality_controls")
}

// === DEFECTOS ===
model ProductionDefect {
  id Int @id @default(autoincrement())

  // Contexto
  dailyReportId     Int?
  dailyReport       DailyProductionReport? @relation(fields: [dailyReportId], references: [id])
  productionOrderId Int?
  productionOrder   ProductionOrder?       @relation(fields: [productionOrderId], references: [id])
  batchLotId        Int?
  batchLot          ProductionBatchLot?    @relation(fields: [batchLotId], references: [id])

  // Defecto
  reasonCodeId Int // Reason Code de tipo SCRAP
  reasonCode   ProductionReasonCode @relation(fields: [reasonCodeId], references: [id])
  quantity     Decimal              @db.Decimal(12, 4)
  uom          String

  // Destino
  disposition String @default("SCRAP") // 'SCRAP', 'REWORK', 'DOWNGRADE'

  // Detalle
  description    String?
  attachmentUrls Json?

  reportedById Int
  reportedBy   User @relation("DefectReportedBy", fields: [reportedById], references: [id])

  companyId Int
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productionOrderId])
  @@index([reasonCodeId])
  @@map("production_defects")
}

// === LOTES DE PRODUCCIÓN ===
model ProductionBatchLot {
  id      Int    @id @default(autoincrement())
  lotCode String // "L-2025-01-001"

  productionOrderId Int
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id])

  quantity Decimal @db.Decimal(12, 4)
  uom      String

  // Estado
  qualityStatus String @default("PENDING")
  // PENDING, APPROVED, BLOCKED, REJECTED

  // Bloqueo
  blockedReason String?
  blockedAt     DateTime?
  blockedById   Int?
  blockedBy     User?     @relation("LotBlocker", fields: [blockedById], references: [id])

  // Liberación
  releasedAt   DateTime?
  releasedById Int?
  releasedBy   User?     @relation("LotReleaser", fields: [releasedById], references: [id])

  // Trazabilidad básica
  productionDate DateTime
  expirationDate DateTime?

  // OPCIONAL: trazabilidad de materias primas
  rawMaterialLots Json? // [{inputId, lotNumber, quantity}]

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company         Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  qualityControls ProductionQualityControl[]
  defects         ProductionDefect[]

  @@unique([companyId, lotCode])
  @@index([qualityStatus])
  @@index([productionOrderId])
  @@map("production_batch_lots")
}

// === EVENTOS DE PRODUCCIÓN (Bitácora) ===
model ProductionEvent {
  id Int @id @default(autoincrement())

  // Entidad afectada
  entityType String // 'PRODUCTION_ORDER', 'DAILY_REPORT', 'BATCH_LOT', etc.
  entityId   Int

  // Evento
  eventType String
  // OP: CREATED, RELEASED, STARTED, PAUSED, RESUMED, COMPLETED, CANCELLED
  // REPORT: CREATED, UPDATED, CONFIRMED, REVIEWED
  // LOT: CREATED, BLOCKED, RELEASED, SHIPPED
  // DOWNTIME: STARTED, ENDED, LINKED_TO_WO

  // Detalle
  previousValue Json?
  newValue      Json?
  notes         String?

  // Quién y cuándo
  performedById Int
  performedBy   User     @relation("ProductionEventPerformer", fields: [performedById], references: [id])
  performedAt   DateTime @default(now())

  // Contexto
  productionOrderId Int?
  productionOrder   ProductionOrder? @relation(fields: [productionOrderId], references: [id])

  companyId Int

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([productionOrderId])
  @@index([performedAt])
  @@map("production_events")
}

// === PLANTILLAS DE RUTINAS ===
model ProductionRoutineTemplate {
  id   Int    @id @default(autoincrement())
  code String
  name String
  type String // 'SHIFT_START', 'SHIFT_END', 'SETUP', 'SAFETY', '5S'

  // Aplica a
  workCenterId Int?
  workCenter   WorkCenter? @relation(fields: [workCenterId], references: [id])

  // Sector (para filtrar empleados en ejecución)
  sectorId Int?
  sector   Sector? @relation("SectorRoutineTemplates", fields: [sectorId], references: [id])

  // Checklist items
  items Json // [{id, description, type: 'CHECK'|'VALUE'|'TEXT', required}]

  // Frecuencia
  frequency String @default("EVERY_SHIFT") // 'EVERY_SHIFT', 'DAILY', 'WEEKLY'

  isActive Boolean @default(true)

  // Configuración de tiempos de completado
  maxCompletionTimeMinutes  Int?
  enableCompletionReminders Boolean @default(false)

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company    Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  executions ProductionRoutine[]

  @@unique([companyId, code])
  @@index([companyId, isActive])
  @@map("production_routine_templates")
}

// === EJECUCIÓN DE RUTINAS ===
model ProductionRoutine {
  id Int @id @default(autoincrement())

  templateId   Int
  template     ProductionRoutineTemplate @relation(fields: [templateId], references: [id])
  workCenterId Int?
  workCenter   WorkCenter?               @relation(fields: [workCenterId], references: [id])
  shiftId      Int?
  shift        WorkShift?                @relation(fields: [shiftId], references: [id])

  date DateTime @db.Date

  // Estado de la rutina (DRAFT = en progreso, COMPLETED = finalizada)
  status    String   @default("COMPLETED") // 'DRAFT', 'COMPLETED'
  startedAt DateTime @default(now())

  // Respuestas
  responses Json // [{itemId, value, notes, photoUrl}]

  // Si hay problema
  hasIssues        Boolean @default(false)
  issueDescription String?

  // Acción derivada
  linkedDowntimeId  Int? // Si derivó en parada
  linkedWorkOrderId Int? // Si derivó en OT de mantenimiento

  executedById Int
  executedBy   User     @relation("RoutineExecutedBy", fields: [executedById], references: [id])
  executedAt   DateTime @default(now())

  // Control de draft/reminders
  updatedAt      DateTime  @updatedAt
  lastReminderAt DateTime?
  reminderCount  Int       @default(0)

  companyId Int

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, date])
  @@index([companyId, status])
  @@index([templateId])
  @@map("production_routines")
}

// === SESIÓN DE PRODUCCIÓN DIARIA (encabezado por día/turno/sector) ===
model DailyProductionSession {
  id             Int       @id @default(autoincrement())
  productionDate DateTime  @db.Date
  sectorId       Int
  shiftId        Int?
  status         String    @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, LOCKED
  submittedAt    DateTime?
  submittedById  Int?
  approvedAt     DateTime?
  approvedById   Int?
  lockedAt       DateTime?
  notes          String?
  companyId      Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  sector      Sector                 @relation(fields: [sectorId], references: [id])
  shift       WorkShift?             @relation("SessionShift", fields: [shiftId], references: [id])
  submittedBy User?                  @relation("SessionSubmitter", fields: [submittedById], references: [id])
  approvedBy  User?                  @relation("SessionApprover", fields: [approvedById], references: [id])
  company     Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  entries     DailyProductionEntry[]

  @@unique([companyId, sectorId, productionDate, shiftId])
  @@index([companyId, sectorId, productionDate])
  @@map("daily_production_sessions")
}

// === LÍNEAS DE PRODUCCIÓN DIARIA ===
model DailyProductionEntry {
  id             Int      @id @default(autoincrement())
  sessionId      Int
  productId      String
  sectorId       Int
  quantity       Decimal  @db.Decimal(12, 2)
  scrapQuantity  Decimal  @default(0) @db.Decimal(12, 2)
  uom            String   @default("unidad")
  workCenterId   Int?
  batchNumber    String?
  notes          String?
  registeredById Int
  recordedAt     DateTime @default(now())
  companyId      Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  session      DailyProductionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  product      Product                @relation(fields: [productId], references: [id])
  sector       Sector                 @relation("EntryBySector", fields: [sectorId], references: [id])
  workCenter   WorkCenter?            @relation(fields: [workCenterId], references: [id])
  registeredBy User                   @relation("DailyEntryRegisteredBy", fields: [registeredById], references: [id])
  company      Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([companyId, sectorId, recordedAt])
  @@index([productId])
  @@map("daily_production_entries")
}

// === TIPOS DE RECURSOS DE PRODUCCIÓN ===
model ProductionResourceType {
  id          Int     @id @default(autoincrement())
  code        String // "BANCO", "SILO", "ESTACION"
  name        String // "Banco de Pretensado", "Silo de Cemento"
  description String?
  uomCode     String? // "m", "tn", "m3", "u"

  // Schema de atributos dinámicos
  attributesSchema Json? // { "largo": { type: "number", label: "Largo", unit: "m" }, ... }

  // Configuración del tipo
  config Json? // { "requiresPhotos": true, "hasCapacity": true, "hasOrder": true }

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  resources ProductionResource[]

  @@unique([companyId, code])
  @@index([companyId])
  @@map("production_resource_types")
}

// === RECURSOS DE PRODUCCIÓN (instancias) ===
model ProductionResource {
  id   Int    @id @default(autoincrement())
  code String // "BANCO_01", "SILO_A"
  name String // "Banco 1", "Silo A"

  resourceTypeId Int
  resourceType   ProductionResourceType @relation(fields: [resourceTypeId], references: [id])

  workCenterId Int?
  workCenter   WorkCenter? @relation(fields: [workCenterId], references: [id])

  // Atributos dinámicos según el schema del tipo
  metadata Json? // { "largo": 100, "capacidad": 50 }

  status String @default("ACTIVE") // ACTIVE, MAINTENANCE, INACTIVE
  order  Int    @default(0)

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId, resourceTypeId])
  @@index([companyId, status])
  @@map("production_resources")
}

// ============================================
// EXTENSIÓN PRETENSADOS / PRECAST (Opcional)
// ============================================

// === MOLDES / CAMAS DE PRETENSADO ===
model PrestressedMold {
  id       Int    @id @default(autoincrement())
  code     String
  name     String
  moldType String // 'LONG_BED', 'SHORT_BED', 'INDIVIDUAL'

  lengthMeters Decimal  @db.Decimal(8, 2)
  widthMeters  Decimal  @db.Decimal(8, 2)
  maxCables    Int
  maxTensionKN Decimal? @db.Decimal(10, 2)

  status String @default("AVAILABLE")
  // AVAILABLE, IN_USE, MAINTENANCE

  currentOrderId Int?
  workCenterId   Int?
  workCenter     WorkCenter? @relation(fields: [workCenterId], references: [id])

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  curingRecords CuringRecord[]

  @@unique([companyId, code])
  @@index([companyId, status])
  @@map("prestressed_molds")
}

// === REGISTRO DE CURADO ===
model CuringRecord {
  id Int @id @default(autoincrement())

  productionOrderId Int
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id])
  moldId            Int
  mold              PrestressedMold @relation(fields: [moldId], references: [id])
  batchLotId        Int?

  // Tiempos
  castingDateTime     DateTime
  curingStartDateTime DateTime?
  curingEndDateTime   DateTime?
  demoldingDateTime   DateTime?

  // Condiciones
  ambientTemp  Decimal? @db.Decimal(5, 2)
  concreteTemp Decimal? @db.Decimal(5, 2)
  humidity     Decimal? @db.Decimal(5, 2)

  // Curado vapor (si aplica)
  steamCuringUsed Boolean  @default(false)
  steamTemp       Decimal? @db.Decimal(5, 2)

  // Resistencia
  targetStrengthMPa Decimal? @db.Decimal(8, 2)
  actualStrengthMPa Decimal? @db.Decimal(8, 2)

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productionOrderId])
  @@index([moldId])
  @@map("curing_records")
}

// ============================================
// Pedidos de Compra por Voz
// ============================================

model VoicePurchaseLog {
  id                  Int       @id @default(autoincrement())
  companyId           Int
  userId              Int
  discordUserId       String
  discordMessageId    String    @unique // Para idempotencia
  discordAttachmentId String
  discordChannelId    String?
  audioUrl            String? // URL o referencia S3
  audioHash           String? // Hash SHA256 para dedup adicional
  transcript          String?   @db.Text
  extractedData       Json? // JSON del GPT
  confidence          Int? // 0-100
  status              String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorMessage        String?
  purchaseRequestId   Int?      @unique // FK al pedido creado
  createdAt           DateTime  @default(now())
  processedAt         DateTime?

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User             @relation("VoicePurchaseLogUser", fields: [userId], references: [id])
  purchaseRequest PurchaseRequest? @relation("VoicePurchaseRequest", fields: [purchaseRequestId], references: [id])

  @@index([discordMessageId])
  @@index([status])
  @@index([companyId])
  @@index([userId])
  @@map("voice_purchase_logs")
}

// ============================================
// Reporte de Fallas por Voz
// ============================================

model VoiceFailureLog {
  id                  Int     @id @default(autoincrement())
  companyId           Int
  userId              Int
  discordUserId       String
  discordMessageId    String  @unique // Idempotencia nivel 1
  discordAttachmentId String? // Idempotencia nivel 2
  discordChannelId    String?

  // Audio y procesamiento
  audioUrl  String? // URL de Discord (expira)
  audioHash String? // SHA256 - Idempotencia nivel 3
  audioSize Int?
  mimeType  String? @db.VarChar(50)

  // Pipeline de IA
  transcript       String? @db.Text
  extractedData    Json? // JSON completo extraído por GPT
  confidence       Int? // 0-100
  machineMatchedId Int? // Máquina identificada (o null si clarificación)

  // Estado de procesamiento
  // PENDING → QUEUED → PROCESSING → COMPLETED/FAILED/CLARIFICATION_NEEDED
  status       String  @default("PENDING")
  errorMessage String?
  retryCount   Int     @default(0)

  // Resultado
  failureOccurrenceId Int? @unique

  // Timestamps
  createdAt           DateTime  @default(now())
  queuedAt            DateTime?
  processingStartedAt DateTime?
  processedAt         DateTime?

  // Relaciones
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user              User               @relation("VoiceFailureLogUser", fields: [userId], references: [id])
  failureOccurrence FailureOccurrence? @relation("VoiceFailureOccurrence", fields: [failureOccurrenceId], references: [id])

  @@index([discordMessageId])
  @@index([audioHash])
  @@index([status])
  @@index([companyId])
  @@index([userId])
  @@map("voice_failure_logs")
}

// ============================================
// Pedidos de Compra Recurrentes
// ============================================

model RecurringPurchaseOrder {
  id                Int                @id @default(autoincrement())
  nombre            String             @db.VarChar(200) // "Insumos mensuales", "Limpieza semanal"
  descripcion       String?
  // Frecuencia
  frecuencia        RecurringFrequency @default(MENSUAL)
  diaSemana         Int? // 0-6 para SEMANAL (0=Domingo)
  diaMes            Int? // 1-31 para MENSUAL
  horaEjecucion     Int                @default(8) // Hora del día (0-23)
  // Control
  isActive          Boolean            @default(true)
  proximaEjecucion  DateTime? // Próxima fecha de ejecución
  ultimaEjecucion   DateTime? // Última ejecución
  totalEjecuciones  Int                @default(0)
  // Configuración del pedido que se genera
  tituloPedido      String             @db.VarChar(200) // Título del pedido generado
  prioridad         RequestPriority    @default(NORMAL)
  departamento      String?            @db.VarChar(100)
  diasParaNecesidad Int                @default(7) // Fecha necesidad = ejecución + N días
  notas             String?
  // Usuario que lo creó y será el solicitante
  creadorId         Int
  // Multi-tenant
  companyId         Int
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relaciones
  items     RecurringPurchaseItem[]
  historial RecurringPurchaseHistory[]
  creador   User                       @relation("RecurringOrderCreador", fields: [creadorId], references: [id])
  company   Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isActive])
  @@index([proximaEjecucion])
  @@map("recurring_purchase_orders")
}

model RecurringPurchaseItem {
  id               Int     @id @default(autoincrement())
  recurringOrderId Int
  descripcion      String  @db.VarChar(500)
  cantidad         Decimal @db.Decimal(15, 4)
  unidad           String  @db.VarChar(50)
  especificaciones String?

  recurringOrder RecurringPurchaseOrder @relation(fields: [recurringOrderId], references: [id], onDelete: Cascade)

  @@index([recurringOrderId])
  @@map("recurring_purchase_items")
}

model RecurringPurchaseHistory {
  id                Int      @id @default(autoincrement())
  recurringOrderId  Int
  purchaseRequestId Int? // ID del pedido generado (puede ser null si falló)
  fechaEjecucion    DateTime @default(now())
  estado            String   @default("SUCCESS") // SUCCESS, FAILED
  errorMessage      String?

  recurringOrder RecurringPurchaseOrder @relation(fields: [recurringOrderId], references: [id], onDelete: Cascade)

  @@index([recurringOrderId])
  @@index([fechaEjecucion])
  @@map("recurring_purchase_history")
}

enum RecurringFrequency {
  DIARIO
  SEMANAL
  QUINCENAL
  MENSUAL
}

// ============================================================
// AGENDA: Tareas personales y recordatorios
// ============================================================

model AgendaTask {
  id          Int              @id @default(autoincrement())
  title       String           @db.VarChar(200)
  description String?
  dueDate     DateTime?
  priority    Priority         @default(MEDIUM)
  status      AgendaTaskStatus @default(PENDING)
  category    String?          @db.VarChar(100)

  // Quien creó (siempre el usuario que pide)
  createdById Int
  createdBy   User @relation("AgendaTasksCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  // A quien se le pide (usuario del sistema O contacto externo)
  assignedToUserId    Int?
  assignedToUser      User?    @relation("AgendaTasksAssignedToUser", fields: [assignedToUserId], references: [id])
  assignedToContactId Int?
  assignedToContact   Contact? @relation("AgendaTasksAssignedToContact", fields: [assignedToContactId], references: [id])
  assignedToName      String?  @db.VarChar(200) // Nombre para display rápido

  // Origen de la tarea
  source           TaskSource @default(WEB)
  discordMessageId String?    @unique

  // Multi-tenant
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Recordatorios asociados
  reminders AgendaReminder[]

  // Notas adicionales (JSON array)
  notes Json?

  // Completado
  completedAt   DateTime?
  completedNote String?

  // Notificación de recordatorio (15 min antes)
  reminder15MinSentAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Log de voz (si se creó por audio)
  voiceLog VoiceTaskLog?

  @@index([createdById, status])
  @@index([assignedToUserId])
  @@index([assignedToContactId])
  @@index([companyId, dueDate])
  @@index([companyId, status])
  @@map("agenda_tasks")
}

model AgendaReminder {
  id        Int                   @id @default(autoincrement())
  title     String                @db.VarChar(200)
  message   String?
  remindAt  DateTime
  notifyVia NotificationChannel[] @default([DISCORD])

  // Estado
  isSent Boolean   @default(false)
  sentAt DateTime?
  isRead Boolean   @default(false)
  readAt DateTime?

  // Relación con tarea (opcional - puede ser recordatorio standalone)
  taskId Int?
  task   AgendaTask? @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Usuario dueño del recordatorio
  userId Int
  user   User @relation("AgendaRemindersUser", fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, remindAt, isSent])
  @@index([companyId])
  @@map("agenda_reminders")
}

model VoiceTaskLog {
  id Int @id @default(autoincrement())

  // Discord info
  discordUserId       String
  discordMessageId    String  @unique
  discordAttachmentId String?
  discordChannelId    String?

  // Audio
  audioUrl      String?
  audioHash     String?
  transcription String?

  // Resultado del procesamiento
  status        VoiceLogStatus @default(PENDING)
  extractedData Json?
  errorMessage  String?

  // Tarea creada (si fue exitoso)
  taskId Int?        @unique
  task   AgendaTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)

  // Usuario y empresa
  userId    Int
  user      User    @relation("VoiceTaskLogsUser", fields: [userId], references: [id], onDelete: Cascade)
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([discordUserId])
  @@index([status])
  @@index([companyId])
  @@map("voice_task_logs")
}

// Enums para Agenda
enum AgendaTaskStatus {
  PENDING // Pendiente - recién creada
  IN_PROGRESS // En progreso - se está trabajando
  WAITING // Esperando respuesta
  COMPLETED // Completada
  CANCELLED // Cancelada
}

enum TaskSource {
  WEB // Creada desde la web
  DISCORD_TEXT // Creada desde Discord por texto
  DISCORD_VOICE // Creada desde Discord por audio
  API // Creada via API externa
}

enum NotificationChannel {
  DISCORD // Notificación por Discord DM
  EMAIL // Notificación por email
  WEB_PUSH // Push notification web
  SSE // Server-Sent Events (in-app)
}

enum VoiceLogStatus {
  PENDING // Pendiente de procesar
  PROCESSING // En proceso
  COMPLETED // Procesado exitosamente
  FAILED // Falló el procesamiento
}

// ============================================================
// MÓDULO ALMACÉN - Sistema de Despachos y Solicitudes
// ============================================================

// Reserva de stock de suministros (bloquea disponibilidad)
model StockReservation {
  id                Int                    @id @default(autoincrement())
  supplierItemId    Int
  warehouseId       Int
  cantidad          Decimal                @db.Decimal(15, 4)
  cantidadConsumida Decimal                @default(0) @db.Decimal(15, 4)
  estado            StockReservationStatus @default(ACTIVA)

  // Referencia a origen (solo uno debe estar seteado según tipo)
  tipo              StockReservationType
  materialRequestId Int?
  productionOrderId Int?
  workOrderId       Int?

  fechaReserva    DateTime  @default(now())
  fechaExpiracion DateTime? // Auto-liberar si no se usa
  motivo          String?

  companyId Int
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierItem    SupplierItem     @relation(fields: [supplierItemId], references: [id])
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id])
  materialRequest MaterialRequest? @relation(fields: [materialRequestId], references: [id])
  productionOrder ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  workOrder       WorkOrder?       @relation(fields: [workOrderId], references: [id])
  createdByUser   User             @relation("StockReservationCreatedBy", fields: [createdBy], references: [id])
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stockMovements  StockMovement[]

  @@index([supplierItemId, warehouseId])
  @@index([estado])
  @@index([companyId])
  @@index([materialRequestId])
  @@index([productionOrderId])
  @@index([workOrderId])
  @@map("stock_reservations")
}

enum StockReservationStatus {
  ACTIVA
  CONSUMIDA_PARCIAL
  CONSUMIDA
  LIBERADA
  EXPIRADA
}

enum StockReservationType {
  SOLICITUD_MATERIAL
  ORDEN_PRODUCCION
  ORDEN_TRABAJO
  MANUAL
}

// Solicitud de Material
model MaterialRequest {
  id       Int                   @id @default(autoincrement())
  numero   String                @db.VarChar(50)
  tipo     MaterialRequestType
  estado   MaterialRequestStatus @default(BORRADOR)
  urgencia Priority              @default(MEDIUM)

  // Referencias (mutuamente excluyentes según tipo)
  workOrderId       Int?
  productionOrderId Int?
  proyectoId        Int?

  solicitanteId  Int
  destinatarioId Int? // Persona que recibirá

  warehouseId Int? // Depósito preferido (opcional)

  fechaSolicitud  DateTime  @default(now())
  fechaNecesidad  DateTime?
  fechaAprobacion DateTime?
  aprobadoPor     Int?

  motivo String?
  notas  String?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items        MaterialRequestItem[]
  reservations StockReservation[]
  despachos    Despacho[]

  workOrder       WorkOrder?       @relation(fields: [workOrderId], references: [id])
  productionOrder ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  proyecto        Project?         @relation(fields: [proyectoId], references: [id])
  solicitante     User             @relation("MaterialRequestSolicitante", fields: [solicitanteId], references: [id])
  destinatario    User?            @relation("MaterialRequestDestinatario", fields: [destinatarioId], references: [id])
  warehouse       Warehouse?       @relation(fields: [warehouseId], references: [id])
  aprobadoByUser  User?            @relation("MaterialRequestAprobadoPor", fields: [aprobadoPor], references: [id])
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, numero])
  @@index([companyId, estado])
  @@index([workOrderId])
  @@index([productionOrderId])
  @@index([solicitanteId])
  @@map("material_requests")
}

model MaterialRequestItem {
  id        Int @id @default(autoincrement())
  requestId Int

  // Referencia polimórfica (validar que solo uno esté seteado)
  itemType       InventoryItemType
  supplierItemId Int?
  toolId         Int?

  cantidadSolicitada Decimal  @db.Decimal(15, 4)
  cantidadAprobada   Decimal? @db.Decimal(15, 4)
  cantidadReservada  Decimal  @default(0) @db.Decimal(15, 4)
  cantidadDespachada Decimal  @default(0) @db.Decimal(15, 4)
  unidad             String   @db.VarChar(50)
  notas              String?

  request      MaterialRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  supplierItem SupplierItem?   @relation(fields: [supplierItemId], references: [id])
  tool         Tool?           @relation(fields: [toolId], references: [id])

  @@index([requestId])
  @@index([supplierItemId])
  @@index([toolId])
  @@map("material_request_items")
}

enum MaterialRequestType {
  OT_MANTENIMIENTO
  OP_PRODUCCION
  PROYECTO
  INTERNO
}

enum MaterialRequestStatus {
  BORRADOR
  PENDIENTE_APROBACION
  APROBADA
  PARCIALMENTE_DESPACHADA
  DESPACHADA
  CANCELADA
  RECHAZADA
}

enum InventoryItemType {
  TOOL
  SUPPLIER_ITEM
}

// Vale de Salida / Despacho
model Despacho {
  id     Int            @id @default(autoincrement())
  numero String         @db.VarChar(50)
  tipo   DespachoType
  estado DespachoStatus @default(BORRADOR)

  // Origen
  materialRequestId Int?
  warehouseId       Int

  // Destino (según tipo)
  workOrderId       Int?
  productionOrderId Int?
  destinatarioId    Int?

  fechaCreacion  DateTime  @default(now())
  fechaDespacho  DateTime?
  fechaRecepcion DateTime?

  despachadorId Int
  receptorId    Int?

  // Firma como archivo (NO base64 en DB)
  firmaUrl  String?   @db.VarChar(500)
  firmaHash String?   @db.VarChar(64)
  firmadoAt DateTime?

  notas String?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items          DespachoItem[]
  stockMovements StockMovement[]
  devoluciones   DevolucionMaterial[]

  materialRequest MaterialRequest? @relation(fields: [materialRequestId], references: [id])
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id])
  workOrder       WorkOrder?       @relation(fields: [workOrderId], references: [id])
  productionOrder ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  despachador     User             @relation("DespachoDespachador", fields: [despachadorId], references: [id])
  destinatario    User?            @relation("DespachoDestinatario", fields: [destinatarioId], references: [id])
  receptor        User?            @relation("DespachoReceptor", fields: [receptorId], references: [id])
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, numero])
  @@index([companyId, estado])
  @@index([workOrderId])
  @@index([productionOrderId])
  @@index([fechaDespacho])
  @@index([warehouseId])
  @@map("despachos")
}

model DespachoItem {
  id         Int @id @default(autoincrement())
  despachoId Int

  itemType       InventoryItemType
  supplierItemId Int?
  toolId         Int?

  // Ubicación específica de donde salió
  stockLocationId Int?
  lote            String? @db.VarChar(100)

  cantidadSolicitada Decimal @db.Decimal(15, 4)
  cantidadDespachada Decimal @db.Decimal(15, 4)
  unidad             String  @db.VarChar(50)

  // Costo al momento del despacho (congelado)
  costoUnitario    Decimal? @db.Decimal(15, 4)
  costoTotal       Decimal? @db.Decimal(15, 2)
  metodoAsignacion String?  @db.VarChar(20) // FIFO, FEFO, MANUAL

  notas String?

  // Referencias a movimientos generados
  stockMovementId Int?
  toolMovementId  Int?

  despacho      Despacho       @relation(fields: [despachoId], references: [id], onDelete: Cascade)
  supplierItem  SupplierItem?  @relation(fields: [supplierItemId], references: [id])
  tool          Tool?          @relation(fields: [toolId], references: [id])
  stockLocation StockLocation? @relation(fields: [stockLocationId], references: [id])

  @@index([despachoId])
  @@index([supplierItemId])
  @@index([toolId])
  @@map("despacho_items")
}

enum DespachoType {
  ENTREGA_OT
  ENTREGA_OP
  ENTREGA_PERSONA
  CONSUMO_INTERNO
}

enum DespachoStatus {
  BORRADOR
  EN_PREPARACION
  LISTO_DESPACHO
  DESPACHADO
  RECIBIDO
  CANCELADO
}

// Devolución de Material
model DevolucionMaterial {
  id     Int              @id @default(autoincrement())
  numero String           @db.VarChar(50)
  tipo   DevolucionType
  estado DevolucionStatus @default(BORRADOR)

  // Referencia al despacho original (opcional)
  despachoOrigenId Int?
  warehouseId      Int // A qué depósito vuelve

  // Quien devuelve
  devolvienteId Int

  motivo String
  notas  String?

  fechaDevolucion DateTime?
  recibidoPor     Int?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items          DevolucionMaterialItem[]
  stockMovements StockMovement[]

  despachoOrigen Despacho? @relation(fields: [despachoOrigenId], references: [id])
  warehouse      Warehouse @relation(fields: [warehouseId], references: [id])
  devolviente    User      @relation("DevolucionDevolviente", fields: [devolvienteId], references: [id])
  recibidoByUser User?     @relation("DevolucionRecibidoPor", fields: [recibidoPor], references: [id])
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, numero])
  @@index([companyId, estado])
  @@index([despachoOrigenId])
  @@index([warehouseId])
  @@map("devoluciones_material")
}

model DevolucionMaterialItem {
  id           Int @id @default(autoincrement())
  devolucionId Int

  itemType       InventoryItemType
  supplierItemId Int?
  toolId         Int?

  cantidad   Decimal @db.Decimal(15, 4)
  estadoItem String? @db.VarChar(50) // Bueno, Dañado, etc.

  stockMovementId Int?

  devolucion   DevolucionMaterial @relation(fields: [devolucionId], references: [id], onDelete: Cascade)
  supplierItem SupplierItem?      @relation(fields: [supplierItemId], references: [id])
  tool         Tool?              @relation(fields: [toolId], references: [id])

  @@index([devolucionId])
  @@index([supplierItemId])
  @@index([toolId])
  @@map("devolucion_material_items")
}

enum DevolucionType {
  SOBRANTE_OT
  SOBRANTE_OP
  NO_UTILIZADO
  DEFECTUOSO
}

enum DevolucionStatus {
  BORRADOR
  PENDIENTE_REVISION
  ACEPTADA
  RECHAZADA
}

// Scope de usuario por depósito
model UserWarehouseScope {
  id          Int      @id @default(autoincrement())
  userId      Int
  warehouseId Int
  canView     Boolean  @default(true)
  canOperate  Boolean  @default(false)
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([userId, warehouseId])
  @@map("user_warehouse_scopes")
}

// Configuración de producción para consumo de stock
model ProductionStockConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  defaultWarehouseId   Int?
  stockConsumptionMode StockConsumptionMode @default(ON_REPORT)
  allowNegativeStock   Boolean              @default(false)
  reserveOnRelease     Boolean              @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company          Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  defaultWarehouse Warehouse? @relation("ProductionDefaultWarehouse", fields: [defaultWarehouseId], references: [id])

  @@map("production_stock_configs")
}

enum StockConsumptionMode {
  ON_RELEASE // Reserva al liberar OP
  ON_REPORT // Consume al reportar producción
  MANUAL // El usuario decide cuándo
}

// ===== COMPRAS IMPROVEMENTS =====

// Notificaciones de Compras
model ComprasNotification {
  id        Int       @id @default(autoincrement())
  type      String
  companyId Int
  userId    Int?
  title     String
  message   String
  priority  String    @default("normal")
  data      Json      @default("{}")
  read      Boolean   @default(false)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([companyId, userId])
  @@index([companyId, read])
  @@index([createdAt(sort: Desc)])
  @@map("compras_notifications")
}

// Workflows de Aprobación
model ApprovalWorkflow {
  id          Int      @id @default(autoincrement())
  companyId   Int
  name        String
  description String?
  isActive    Boolean  @default(true)
  isEnabled   Boolean  @default(false)
  triggerType String
  conditions  Json     @default("[]")
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  levels    ApprovalWorkflowLevel[]
  instances ApprovalInstance[]

  @@index([companyId, isActive])
  @@map("approval_workflows")
}

model ApprovalWorkflowLevel {
  id              Int     @id @default(autoincrement())
  workflowId      Int
  level           Int
  approverType    String
  approverIds     Int[]
  escalationHours Int?
  requireAll      Boolean @default(false)

  workflow ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@map("approval_workflow_levels")
}

model ApprovalInstance {
  id           Int       @id @default(autoincrement())
  companyId    Int
  workflowId   Int
  entityType   String
  entityId     Int
  requesterId  Int
  status       String    @default("PENDING")
  currentLevel Int       @default(1)
  createdAt    DateTime  @default(now())
  completedAt  DateTime?

  workflow ApprovalWorkflow @relation(fields: [workflowId], references: [id])
  actions  ApprovalAction[]

  @@index([companyId, status])
  @@index([entityType, entityId])
  @@map("approval_instances")
}

model ApprovalAction {
  id         Int      @id @default(autoincrement())
  instanceId Int
  level      Int
  userId     Int
  action     String
  comments   String?
  createdAt  DateTime @default(now())

  instance ApprovalInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@map("approval_actions")
}

model ApprovalDelegation {
  id          Int      @id @default(autoincrement())
  companyId   Int
  delegatorId Int
  delegateeId Int
  validFrom   DateTime
  validUntil  DateTime
  createdAt   DateTime @default(now())

  @@index([companyId, delegateeId])
  @@index([validFrom, validUntil])
  @@map("approval_delegations")
}

// =====================================================
// CONTRATOS DE SERVICIOS Y SEGUROS
// =====================================================

enum ServiceContractType {
  SEGURO_MAQUINARIA // Seguro de máquina/equipo
  SEGURO_VEHICULO // Seguro de vehículo
  SEGURO_INSTALACIONES // Seguro de planta/instalaciones
  SEGURO_RESPONSABILIDAD // Seguro de responsabilidad civil
  SERVICIO_TECNICO // Servicio técnico externo
  MANTENIMIENTO_PREVENTIVO // Contrato de mantenimiento
  CALIBRACION // Servicios de calibración
  CERTIFICACION // Certificaciones (ISO, etc.)
  ALQUILER_EQUIPO // Alquiler de equipos
  LICENCIA_SOFTWARE // Licencias de software
  CONSULTORIA // Servicios de consultoría
  VIGILANCIA // Seguridad y vigilancia
  LIMPIEZA // Servicios de limpieza
  TRANSPORTE // Contratos de transporte/logística
  OTRO // Otros servicios
}

enum ServiceContractStatus {
  BORRADOR // En creación
  ACTIVO // Vigente
  POR_VENCER // Próximo a vencer (30 días)
  VENCIDO // Venció y no se renovó
  SUSPENDIDO // Suspendido temporalmente
  CANCELADO // Cancelado definitivamente
  RENOVADO // Se generó nuevo contrato
}

enum ServicePaymentFrequency {
  UNICO // Pago único
  MENSUAL
  BIMESTRAL
  TRIMESTRAL
  CUATRIMESTRAL
  SEMESTRAL
  ANUAL
}

model ServiceContract {
  id          Int                   @id @default(autoincrement())
  numero      String                @db.VarChar(50) // Número de contrato/póliza
  nombre      String                @db.VarChar(200) // Nombre descriptivo
  descripcion String?
  tipo        ServiceContractType
  estado      ServiceContractStatus @default(BORRADOR)

  // Proveedor del servicio
  proveedorId Int
  proveedor   suppliers @relation(fields: [proveedorId], references: [id])

  // Vigencia
  fechaInicio    DateTime  @db.Date
  fechaFin       DateTime? @db.Date // Null = indefinido
  diasAviso      Int       @default(30) // Días antes de vencimiento para avisar
  renovacionAuto Boolean   @default(false)

  // Costos
  montoTotal     Decimal?                @db.Decimal(15, 2) // Monto total del contrato
  frecuenciaPago ServicePaymentFrequency @default(MENSUAL)
  montoPeriodo   Decimal?                @db.Decimal(15, 2) // Monto por período
  moneda         String                  @default("ARS") @db.VarChar(3)

  // Vinculaciones opcionales
  machineId Int? // Si es servicio/seguro de máquina
  machine   Machine? @relation("MachineServiceContracts", fields: [machineId], references: [id], onDelete: SetNull)

  // Datos adicionales del seguro
  polizaNumero  String?  @db.VarChar(100) // Número de póliza (seguros)
  aseguradora   String?  @db.VarChar(200) // Nombre de aseguradora
  cobertura     String? // Detalle de cobertura
  sumaAsegurada Decimal? @db.Decimal(15, 2)
  deducible     Decimal? @db.Decimal(15, 2)
  franquicia    Decimal? @db.Decimal(15, 2)

  // Contactos
  contactoNombre   String? @db.VarChar(200)
  contactoTelefono String? @db.VarChar(50)
  contactoEmail    String? @db.VarChar(200)

  // Documentos adjuntos (URLs o paths)
  documentos Json? // Array de { nombre, url, tipo }

  // Notas
  notas String?

  // Multi-tenant
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Auditoría
  createdById Int
  createdBy   User     @relation("ServiceContractCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  pagos   ServicePayment[]
  alertas ServiceContractAlert[]

  @@unique([companyId, numero])
  @@index([companyId, estado])
  @@index([companyId, tipo])
  @@index([proveedorId])
  @@index([machineId])
  @@index([fechaFin])
  @@map("service_contracts")
}

model ServicePayment {
  id         Int             @id @default(autoincrement())
  contractId Int
  contract   ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Período que cubre
  periodoDesde DateTime @db.Date
  periodoHasta DateTime @db.Date

  // Monto
  monto  Decimal @db.Decimal(15, 2)
  moneda String  @default("ARS") @db.VarChar(3)

  // Estado del pago
  estado           String    @default("PENDIENTE") // PENDIENTE, PAGADO, VENCIDO
  fechaVencimiento DateTime  @db.Date
  fechaPago        DateTime?

  // Referencia a factura (si se vinculó)
  facturaId Int?

  // Notas
  notas String?

  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractId])
  @@index([companyId, estado])
  @@index([fechaVencimiento])
  @@map("service_payments")
}

model ServiceContractAlert {
  id         Int             @id @default(autoincrement())
  contractId Int
  contract   ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  tipo        String // VENCIMIENTO, PAGO_PENDIENTE, RENOVACION
  mensaje     String
  fechaAlerta DateTime
  enviada     Boolean   @default(false)
  enviadaAt   DateTime?

  companyId Int
  createdAt DateTime @default(now())

  @@index([contractId])
  @@index([companyId, enviada])
  @@index([fechaAlerta])
  @@map("service_contract_alerts")
}

// ════════════════════════════════════════════════════════════════════════════════
// CONFIGURACIÓN AVANZADA DE MÓDULOS ERP
// ════════════════════════════════════════════════════════════════════════════════

// ═══ CONFIGURACIÓN AVANZADA DE COMPRAS ═══
model PurchaseAdvancedConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Módulos habilitados
  moduloContratosCompra     Boolean @default(false) @map("modulo_contratos_compra")
  moduloSupplierPerformance Boolean @default(false) @map("modulo_supplier_performance")
  moduloRfqLicitaciones     Boolean @default(false) @map("modulo_rfq_licitaciones")
  moduloImportaciones       Boolean @default(false) @map("modulo_importaciones")
  moduloVmi                 Boolean @default(false) @map("modulo_vmi")
  moduloMuestras            Boolean @default(false) @map("modulo_muestras")
  moduloAutoPo              Boolean @default(false) @map("modulo_auto_po")
  moduloDropShipping        Boolean @default(false) @map("modulo_drop_shipping")
  moduloBlanketOrders       Boolean @default(false) @map("modulo_blanket_orders")

  // Configuración RFQ
  rfqDiasVigencia                   Int     @default(15) @map("rfq_dias_vigencia")
  rfqMinimoProveedores              Int     @default(3) @map("rfq_minimo_proveedores")
  rfqRequiereAprobacionAdjudicacion Boolean @default(true) @map("rfq_requiere_aprobacion_adjudicacion")

  // Configuración Auto-PO
  autoPoHabilitado         Boolean @default(false) @map("auto_po_habilitado")
  autoPoStockMinimoTrigger Boolean @default(true) @map("auto_po_stock_minimo_trigger")
  autoPoRequiereAprobacion Boolean @default(true) @map("auto_po_requiere_aprobacion")

  // Configuración Supplier Performance
  spmHabilitado             Boolean @default(false) @map("spm_habilitado")
  spmPeriodoEvaluacionMeses Int     @default(3) @map("spm_periodo_evaluacion_meses")
  spmPesoCalidad            Decimal @default(40) @map("spm_peso_calidad") @db.Decimal(5, 2)
  spmPesoEntrega            Decimal @default(40) @map("spm_peso_entrega") @db.Decimal(5, 2)
  spmPesoPrecio             Decimal @default(20) @map("spm_peso_precio") @db.Decimal(5, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation("PurchaseAdvancedConfig", fields: [companyId], references: [id], onDelete: Cascade)

  @@map("purchase_config")
}

// ═══ CONFIGURACIÓN AVANZADA DE TESORERÍA ═══
model TreasuryConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Módulos habilitados
  moduloCashFlowForecast   Boolean @default(false) @map("modulo_cash_flow_forecast")
  moduloMultiMoneda        Boolean @default(false) @map("modulo_multi_moneda")
  moduloInversiones        Boolean @default(false) @map("modulo_inversiones")
  moduloDeuda              Boolean @default(false) @map("modulo_deuda")
  moduloReconciliacionAuto Boolean @default(false) @map("modulo_reconciliacion_auto")
  moduloPagosMasivos       Boolean @default(false) @map("modulo_pagos_masivos")
  moduloGarantiasBancarias Boolean @default(false) @map("modulo_garantias_bancarias")
  moduloFactoring          Boolean @default(false) @map("modulo_factoring")

  // Configuración Multi-moneda
  monedaBase              String  @default("ARS") @map("moneda_base") @db.VarChar(10)
  multiMonedaHabilitado   Boolean @default(false) @map("multi_moneda_habilitado")
  autoUpdateExchangeRates Boolean @default(false) @map("auto_update_exchange_rates")
  exchangeRateApiProvider String? @map("exchange_rate_api_provider") @db.VarChar(50)

  // Configuración Cash Flow Forecast
  forecastPeriodoDias               Int     @default(90) @map("forecast_periodo_dias")
  forecastIncluirVentasProyectadas  Boolean @default(true) @map("forecast_incluir_ventas_proyectadas")
  forecastIncluirComprasProyectadas Boolean @default(true) @map("forecast_incluir_compras_proyectadas")

  // Configuración Reconciliación Automática
  reconciliacionAutoHabilitada    Boolean @default(false) @map("reconciliacion_auto_habilitada")
  reconciliacionMatchingThreshold Decimal @default(0.99) @map("reconciliacion_matching_threshold") @db.Decimal(5, 2)
  reconciliacionMlEnabled         Boolean @default(false) @map("reconciliacion_ml_enabled")
  reconciliationPatterns          Json?   @map("reconciliation_patterns") // ML learned patterns for matching

  // Configuración Pagos Masivos
  pagosMasivosFormato            String  @default("AFIP") @map("pagos_masivos_formato") @db.VarChar(50)
  pagosMasivosRequiereAprobacion Boolean @default(true) @map("pagos_masivos_requiere_aprobacion")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("treasury_config")
}

// ═══ CONFIGURACIÓN MÓDULOS GENERALES ═══
model GeneralConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Módulos habilitados
  moduloCrm               Boolean @default(false) @map("modulo_crm")
  moduloBiAvanzado        Boolean @default(false) @map("modulo_bi_avanzado")
  moduloProyectos         Boolean @default(false) @map("modulo_proyectos")
  moduloRrhhCompleto      Boolean @default(false) @map("modulo_rrhh_completo")
  moduloDms               Boolean @default(false) @map("modulo_dms")
  moduloQualityManagement Boolean @default(false) @map("modulo_quality_management")
  moduloCompliance        Boolean @default(false) @map("modulo_compliance")
  moduloActivosFijos      Boolean @default(false) @map("modulo_activos_fijos")
  moduloMobility          Boolean @default(false) @map("modulo_mobility")

  // Configuración CRM
  crmPipelineEtapas  String? @map("crm_pipeline_etapas")
  crmAutoSeguimiento Boolean @default(false) @map("crm_auto_seguimiento")
  crmDiasSeguimiento Int     @default(7) @map("crm_dias_seguimiento")

  // Configuración BI
  biConstructorReportes Boolean @default(false) @map("bi_constructor_reportes")
  biAlertasAutomaticas  Boolean @default(false) @map("bi_alertas_automaticas")
  biReportesProgramados Boolean @default(false) @map("bi_reportes_programados")

  // Configuración Proyectos
  proyectosTimeTracking                  Boolean @default(false) @map("proyectos_time_tracking")
  proyectosFacturacion                   Boolean @default(false) @map("proyectos_facturacion")
  proyectosRequiereAprobacionPresupuesto Boolean @default(true) @map("proyectos_requiere_aprobacion_presupuesto")

  // Configuración Quality
  qualityIso9001      Boolean @default(false) @map("quality_iso9001")
  qualityAutoNcr      Boolean @default(false) @map("quality_auto_ncr")
  qualityRequiereCapa Boolean @default(true) @map("quality_requiere_capa")

  // Configuración RRHH
  rrhhPortalEmpleado        Boolean @default(false) @map("rrhh_portal_empleado")
  rrhhEvaluacionesDesempeno Boolean @default(false) @map("rrhh_evaluaciones_desempeno")
  rrhhGestionVacaciones     Boolean @default(false) @map("rrhh_gestion_vacaciones")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("general_config")
}

// ═══ CONFIGURACIÓN DE INTEGRACIONES ═══
model IntegrationConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Integraciones habilitadas
  integracionAfip           Boolean @default(false) @map("integracion_afip")
  integracionBancos         Boolean @default(false) @map("integracion_bancos")
  integracionEcommerce      Boolean @default(false) @map("integracion_ecommerce")
  integracionMarketplaces   Boolean @default(false) @map("integracion_marketplaces")
  integracionTransportistas Boolean @default(false) @map("integracion_transportistas")
  integracionContabilidad   Boolean @default(false) @map("integracion_contabilidad")
  integracionPagos          Boolean @default(false) @map("integracion_pagos")
  integracionCrmExterno     Boolean @default(false) @map("integracion_crm_externo")
  integracionBiExterno      Boolean @default(false) @map("integracion_bi_externo")
  integracionWhatsapp       Boolean @default(false) @map("integracion_whatsapp")

  // Configuración AFIP
  afipCuit     String? @map("afip_cuit") @db.VarChar(20)
  afipWsUrl    String? @map("afip_ws_url") @db.VarChar(500)
  afipAmbiente String  @default("HOMOLOGACION") @map("afip_ambiente") @db.VarChar(20)

  // Configuración Bancos
  bancoProvider   String? @map("banco_provider") @db.VarChar(50)
  bancoApiKey     String? @map("banco_api_key") @db.VarChar(500)
  bancoAutoImport Boolean @default(false) @map("banco_auto_import")

  // Configuración E-commerce
  ecommercePlatform    String? @map("ecommerce_platform") @db.VarChar(50)
  ecommerceApiUrl      String? @map("ecommerce_api_url") @db.VarChar(500)
  ecommerceApiKey      String? @map("ecommerce_api_key") @db.VarChar(500)
  ecommerceSyncStock   Boolean @default(true) @map("ecommerce_sync_stock")
  ecommerceSyncPrecios Boolean @default(true) @map("ecommerce_sync_precios")

  // Configuración Marketplaces
  mercadolibreEnabled      Boolean @default(false) @map("mercadolibre_enabled")
  mercadolibreClientId     String? @map("mercadolibre_client_id") @db.VarChar(200)
  mercadolibreClientSecret String? @map("mercadolibre_client_secret") @db.VarChar(200)

  // Configuración Transportistas
  transportistaProvider  String? @map("transportista_provider") @db.VarChar(50)
  transportistaApiKey    String? @map("transportista_api_key") @db.VarChar(500)
  transportistaAutoLabel Boolean @default(false) @map("transportista_auto_label")

  // Configuración WhatsApp
  whatsappApiUrl      String? @map("whatsapp_api_url") @db.VarChar(500)
  whatsappApiToken    String? @map("whatsapp_api_token") @db.VarChar(500)
  whatsappTemplateIds String? @map("whatsapp_template_ids")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("integration_config")
}

// ═══ CONFIGURACIÓN DE INTELIGENCIA ARTIFICIAL ═══
model AIConfig {
  id        Int @id @default(autoincrement())
  companyId Int @unique

  // Funcionalidades de IA habilitadas
  aiDemandForecasting      Boolean @default(false) @map("ai_demand_forecasting")
  aiPriceOptimization      Boolean @default(false) @map("ai_price_optimization")
  aiSmartReorder           Boolean @default(false) @map("ai_smart_reorder")
  aiInvoiceOcr             Boolean @default(false) @map("ai_invoice_ocr")
  aiDocumentClassification Boolean @default(false) @map("ai_document_classification")
  aiChatbot                Boolean @default(false) @map("ai_chatbot")
  aiFraudDetection         Boolean @default(false) @map("ai_fraud_detection")
  aiSentimentAnalysis      Boolean @default(false) @map("ai_sentiment_analysis")
  aiPredictiveMaintenance  Boolean @default(false) @map("ai_predictive_maintenance")
  aiQualityPrediction      Boolean @default(false) @map("ai_quality_prediction")

  // Configuración general de IA
  aiProvider String  @default("OPENAI") @map("ai_provider") @db.VarChar(50)
  aiApiKey   String? @map("ai_api_key") @db.VarChar(500)
  aiModel    String  @default("gpt-4") @map("ai_model") @db.VarChar(100)

  // Configuración Demand Forecasting
  forecastPeriodoDias     Int     @default(90) @map("forecast_periodo_dias")
  forecastAutoAjusteStock Boolean @default(false) @map("forecast_auto_ajuste_stock")

  // Configuración Price Optimization
  priceOptimizationObjetivo           String  @default("MARGEN") @map("price_optimization_objetivo") @db.VarChar(50)
  priceOptimizationCompetenciaEnabled Boolean @default(false) @map("price_optimization_competencia_enabled")

  // Configuración OCR
  ocrAutoProcesamiento  Boolean @default(false) @map("ocr_auto_procesamiento")
  ocrRequiereValidacion Boolean @default(true) @map("ocr_requiere_validacion")

  // Configuración Chatbot
  chatbotIdiomas           String? @default("es,en") @map("chatbot_idiomas")
  chatbotHorarioDisponible String? @map("chatbot_horario_disponible") @db.VarChar(100)

  // Configuración Fraud Detection
  fraudScoreThreshold Decimal @default(0.75) @map("fraud_score_threshold") @db.Decimal(5, 2)
  fraudAutoBloqueo    Boolean @default(false) @map("fraud_auto_bloqueo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("ai_config")
}

// ═════════════════════════════════════════════════════════════════════════════
// AI CHATBOT
// ═════════════════════════════════════════════════════════════════════════════

model ChatSession {
  id            String   @id @db.VarChar(255)
  companyId     Int      @map("company_id")
  userId        Int?     @map("user_id")
  clientId      String?  @map("client_id")
  language      String   @default("es") @db.VarChar(10)
  createdAt     DateTime @default(now()) @map("created_at")
  lastMessageAt DateTime @default(now()) @map("last_message_at")
  metadata      Json     @default("{}") @db.JsonB

  company  Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  client   Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  messages ChatMessage[]

  @@index([companyId])
  @@index([userId])
  @@index([clientId])
  @@index([lastMessageAt(sort: Desc)])
  @@map("chat_sessions")
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  sessionId String   @map("session_id") @db.VarChar(255)
  role      String   @db.VarChar(20)
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  metadata  Json     @default("{}") @db.JsonB

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt(sort: Desc)])
  @@map("chat_messages")
}

model ClientBalanceSnapshot {
  id          Int      @id @default(autoincrement())
  clientId    String
  companyId   Int
  periodo     String   @db.VarChar(7) // "YYYY-MM"
  balance     Decimal  @db.Decimal(15, 2) // Saldo al cierre del periodo
  totalDebe   Decimal  @default(0) @db.Decimal(15, 2) // Total facturado en el periodo
  totalHaber  Decimal  @default(0) @db.Decimal(15, 2) // Total cobrado + NC en el periodo
  movimientos Int      @default(0) // Cantidad de movimientos en el periodo
  createdAt   DateTime @default(now())

  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([clientId, companyId, periodo])
  @@index([companyId, periodo])
  @@index([clientId])
  @@map("ClientBalanceSnapshot")
}

model Feedback {
  id            Int       @id @default(autoincrement())
  type          String    @db.VarChar(20) // problema, mejora, nueva-idea
  priority      String    @default("media") @db.VarChar(10) // baja, media, alta
  status        String    @default("pendiente") @db.VarChar(20) // pendiente, en-progreso, completado, rechazado
  title         String    @db.VarChar(150)
  description   String    @db.Text
  adminResponse String?   @db.Text @map("admin_response")
  read          Boolean   @default(false)
  userId        Int       @map("user_id")
  companyId     Int       @map("company_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  resolvedAt    DateTime? @map("resolved_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("feedback")
}

// ═════════════════════════════════════════════════════════════════
// Feature Flags
// ═════════════════════════════════════════════════════════════════

model FeatureFlag {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  enabled   Boolean  @default(false)
  companyId Int?     @map("company_id")
  userId    Int?     @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, companyId, userId])
  @@index([name])
  @@index([companyId])
  @@index([userId])
  @@map("feature_flags")
}
